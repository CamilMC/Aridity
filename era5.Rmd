---
title: "ERA5"
author: "Camille"
date: "2024-02-07"
output:
  html_document:
    toc: true
    toc_float: true
    number_sections: true
    code_folding: hide
---
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = F, warning = F, error = F, fig.align = "center", collapse = T)
```

```{r libraries}
library(raster)

library(plyr)
library(dplyr)

library(ggplot2)
library(ggpmisc)

library(viridisLite)
library(colorspace)
library(RColorBrewer)

library(sf)
library(stringr)

#display.brewer.pal(n = 11, name ="RdYlGn")
colorvec <- brewer.pal(n = 11, name ="RdYlGn")
```

Notes on ERA5
https://confluence.ecmwf.int/display/CKB/ERA5%3A+data+documentation

2m temperature: K
Surface solar radiation downwards: J/m2 --> x 86400 to obtain W/m2
Evaporation and potential evaporation: m of water equivalent
Precipitation: m of water per day -> x 1000 to obtain kg/m2/day

https://cds.climate.copernicus.eu/cdsapp#!/dataset/reanalysis-era5-single-levels-monthly-means?tab=overview
Mean surface sensible heat flux: transfer of heat between the Earth's surface and the atmosphere through the effects of turbulent air motion. ECWF convention for vertical fluxes is positive downwards. 

# Data

## Land mask

### Land mask from IPCC

```{r land-masks}
land_mask <- raster("Masks/land_sea_mask_1degree.nc4") 
plot(land_mask)
land_mask.df <- as.data.frame(land_mask, xy = T) %>% setNames(c("lon","lat","lm")) # 0 if ocean, 1 if land


elev <- raster("Worldclim/wc2.1_10m/wc2.1_10m_elev.tif") 
elev.df <- elev %>% projectRaster(to = land_mask) %>% as.data.frame(xy = T) %>% setNames(c("lon","lat", "z"))


ipcc_regions <- shapefile("Masks/IPCC-WGI-reference-regions-v4.shp") %>% spTransform(crs("EPSG:4326")) 

ipcc_regions.raster <- ipcc_regions %>% rasterize(land_mask)
ipcc_regions.df <- as.data.frame(ipcc_regions.raster, xy = T) %>% setNames(c("lon","lat","Continent","Type","Name","Acronym"))
```

### Comparison with ERA5

```{r land-mask-era5}
lmera <- raster("ERA5/land-sea-mask.nc") %>% rotate() 
lmera.df <- as.data.frame(lmera, xy = T) %>% setNames(c("lon","lat","lm")) # 0 if ocean, 1 if land

ggplot() + geom_tile(data = subset(lmera.df, lm != 0), aes(x = lon, y = lat, fill = "ERA5"), alpha = 0.5) +
  geom_tile(data = subset(land_mask.df, lm != 0), aes(x = lon, y = lat, fill = "IPCC"), alpha = 0.6) +
  scale_fill_manual(values = c(colorvec[1], colorvec[5]))+
  theme_void()+
  theme(legend.position = "bottom")

```

## ERA5

```{r load-rasters, eval = F}
# pr <- raster("ERA5/total-precipitation.nc") %>% stack() %>%  raster::stackApply(indices = 1, fun = mean, na.rm = T) %>%  raster::rotate() %>%
#    aggregate(fact = 4, fun = mean) %>%
#   projectRaster(land_mask)
# pr.df <- as.data.frame(pr, xy = T) %>% setNames(c("lon","lat","pr"))
# write.table(pr.df, "ERA5/pr.df.txt") # in m of water equivalent 

mpr <- raster("ERA5/mean_rates.nc", varname = "mtpr") %>%
  stack() %>% 
  aggregate(fact = 4, fun = mean) %>%
  raster::rotate() %>% projectRaster(land_mask) %>%
    raster::stackApply(indices = 1, fun = mean, na.rm = T)

mpr.df <- as.data.frame(mpr, xy = T) %>% setNames(c("lon","lat","mpr"))

write.table(mpr.df, "ERA5/mpr.df.txt")



tas <- raster("ERA5/temperature-2m.nc") %>%
  stack() %>%
  aggregate(fact = 4, fun = mean) %>%
  raster::rotate() %>%
  projectRaster(land_mask) %>%
  raster::stackApply(indices = 1, fun = mean, na.rm = T)

tas.df <- as.data.frame(tas, xy = T) %>% setNames(c("lon","lat","tas"))

write.table(tas.df, "ERA5/tas.df.txt")

tdew <- raster("ERA5/2m-dewpoint.nc", varname = "d2m")  %>% 
  stack() %>% 
  aggregate(fact = 4, fun = mean) %>%
  raster::rotate() %>%
  projectRaster(land_mask) %>% 
  raster::stackApply(indices = 1, fun = mean, na.rm = T)

tdew.df <- as.data.frame(tdew, xy = T) %>% setNames(c("lon","lat","tdew"))
write.table(tdew.df, "ERA5/tdew.df.txt")

ssrd <- raster("ERA5/surface-short-wave-solar-radiation-downwards.nc") %>%
  stack() %>%
  aggregate(fact = 4, fun = mean) %>%
  raster::rotate() %>%
  projectRaster(land_mask) %>%
  raster::stackApply(indices = 1, fun = mean, na.rm = T)

ssrd.df <- as.data.frame(ssrd, xy = T) %>% setNames(c("lon","lat","ssrd"))
write.table(ssrd.df, "ERA5/ssrd.df.txt")

wind <- raster("ERA5/wind10m.nc", varname = "si10") %>%
  stack() %>%
  aggregate(fact = 4, fun = mean) %>%
  raster::rotate() %>%
  projectRaster(land_mask) %>%
  raster::stackApply(indices = 1, fun = mean, na.rm = T)

wind.df <- as.data.frame(wind, xy = T) %>% 
  setNames(c("lon","lat","sfcWind")) # m/s
write.table(wind.df, "ERA5/wind.df.txt")

# Evaporation in m of water equivalent
# evaporation <- raster("ERA5/evaporation.nc") %>% stack() %>%  raster::stackApply(indices = 1, fun = mean, na.rm = T) %>%  raster::rotate() %>% aggregate(fact = 4, fun = mean) %>% projectRaster(land_mask)
# evaporation.df <- as.data.frame(evaporation, xy = T) %>% setNames(c("lon","lat","evap"))
# write.table(evaporation.df, "ERA5/evaporation.df.txt")

# mevap <- raster("ERA5/mean_rates.nc", varname = "mer") %>% stack() %>%  raster::stackApply(indices = 1, fun = mean, na.rm = T) %>%  raster::rotate() %>% aggregate(fact = 4, fun = mean) %>% projectRaster(land_mask)
# mevap.df <- as.data.frame(mevap, xy = T) %>% setNames(c("lon","lat","mevap"))
# write.table(mevap.df, "ERA5/mevap.df.txt")

# mpevap <- raster("ERA5/mean-potential-evaporation-rate.nc") %>% stack() %>%  raster::stackApply(indices = 1, fun = mean, na.rm = T) %>%  raster::rotate() %>% aggregate(fact = 4, fun = mean) %>% projectRaster(land_mask)
# mpevap.df <- as.data.frame(mpevap, xy = T) %>% setNames(c("lon","lat","mpevap"))
# write.table(mpevap.df, "ERA5/mpevap.df.txt")

# pot.evaporation <- raster("ERA5/potential-evaporation.nc") %>% stack() %>%  raster::stackApply(indices = 1, fun = mean, na.rm = T) %>%  raster::rotate() %>% aggregate(fact = 4, fun = mean) %>% projectRaster(land_mask)
# pevap.df <- as.data.frame(pot.evaporation, xy = T) %>% setNames(c("lon","lat","pevap"))
# write.table(pevap.df, "ERA5/pevap.df.txt")

# slhf <- raster("ERA5/surface_latent_heat_flux.nc", varname = "slhf") %>% stack() %>%  raster::stackApply(indices = 1, fun = mean, na.rm = T) %>%  raster::rotate() %>% aggregate(fact = 4, fun = mean) %>% projectRaster(land_mask)
# slhf.df <- as.data.frame(slhf, xy = T) %>% setNames(c("lon","lat","slhf"))
# write.table(slhf.df, "ERA5/slhf.df.txt")
# 
# 
# sshf <- raster("ERA5/surface_sensible_heat_flux.nc", varname = "sshf") %>% stack() %>%  raster::stackApply(indices = 1, fun = mean, na.rm = T) %>%  raster::rotate() %>% aggregate(fact = 4, fun = mean) %>% projectRaster(land_mask)
# sshf.df <- as.data.frame(slhf, xy = T) %>% setNames(c("lon","lat","sshf"))
# write.table(sshf.df, "ERA5/sshf.df.txt")

mslhf <- raster("ERA5/mean_rates.nc", varname = "mslhf") %>%
  stack() %>%
  aggregate(fact = 4, fun = mean) %>% 
  raster::rotate() %>%
  projectRaster(land_mask) %>%
     raster::stackApply(indices = 1, fun = mean, na.rm = T)

mslhf.df <- as.data.frame(mslhf, xy = T) %>% setNames(c("lon","lat","mslhf"))
write.table(mslhf.df, "ERA5/mslhf.df.txt")


msshf <- raster("ERA5/mean_rates.nc", varname = "msshf") %>%
  stack() %>%
  aggregate(fact = 4, fun = mean) %>%
  raster::rotate() %>% 
  projectRaster(land_mask) %>%
     raster::stackApply(indices = 1, fun = mean, na.rm = T)

msshf.df <- as.data.frame(msshf, xy = T) %>% setNames(c("lon","lat","msshf"))
write.table(msshf.df, "ERA5/msshf.df.txt")

msr <- raster("ERA5/mean-net-SW-LW-radiation-flux.nc", varname = "msnswrf") %>%
  stack() %>% 
  aggregate(fact = 4, fun = mean) %>% 
  raster::rotate() %>% 
  projectRaster(land_mask) %>%
    raster::stackApply(indices = 1, fun = mean, na.rm = T) 

msr.df <- as.data.frame(msr, xy = T) %>% setNames(c("lon","lat","msr"))
write.table(msr.df, "ERA5/msr.df.txt")


mlr <- raster("ERA5/mean-net-SW-LW-radiation-flux.nc", varname = "msnlwrf") %>%
  stack() %>% 
  aggregate(fact = 4, fun = mean) %>%
  raster::rotate() %>% 
  projectRaster(land_mask) %>%
  raster::stackApply(indices = 1, fun = mean, na.rm = T) 

mlr.df <- as.data.frame(mlr, xy = T) %>% setNames(c("lon","lat","mlr"))
write.table(mlr.df, "ERA5/mlr.df.txt")
```

```{r make-tas-min, eval = F}
tas_jan <- raster("ERA5/temperature-2m.nc") %>% stack(bands = seq(from = 1, to = 349, by = 12)) %>%  raster::stackApply(indices = 1, fun = mean, na.rm = T) %>%  raster::rotate() %>% projectRaster(land_mask)

tas_jan.df <- as.data.frame(tas_jan, xy = T) %>% setNames(c("lon","lat","tas_01"))

tas_fev <- raster("ERA5/temperature-2m.nc") %>% stack(bands = seq(from = 2, to = 350, by = 12)) %>%  raster::stackApply(indices = 1, fun = mean, na.rm = T) %>%  raster::rotate() %>% projectRaster(land_mask)

tas_fev.df <- as.data.frame(tas_fev, xy = T) %>% setNames(c("lon","lat","tas_02"))

tas_mar <- raster("ERA5/temperature-2m.nc") %>% stack(bands = seq(from = 3, to = 351, by = 12)) %>%  raster::stackApply(indices = 1, fun = mean, na.rm = T) %>%  raster::rotate() %>% projectRaster(land_mask)

tas_mar.df <- as.data.frame(tas_mar, xy = T) %>% setNames(c("lon","lat","tas_03"))

tas_apr <- raster("ERA5/temperature-2m.nc") %>% stack(bands = seq(from = 4, to = 352, by = 12)) %>%  raster::stackApply(indices = 1, fun = mean, na.rm = T) %>%  raster::rotate() %>% projectRaster(land_mask)

tas_apr.df <- as.data.frame(tas_apr, xy = T) %>% setNames(c("lon","lat","tas_04"))

tas_may <- raster("ERA5/temperature-2m.nc") %>% stack(bands = seq(from = 5, to = 353, by = 12)) %>%  raster::stackApply(indices = 1, fun = mean, na.rm = T) %>%  raster::rotate() %>% projectRaster(land_mask)

tas_may.df <- as.data.frame(tas_may, xy = T) %>% setNames(c("lon","lat","tas_05"))

tas_jun <- raster("ERA5/temperature-2m.nc") %>% stack(bands = seq(from = 6, to = 354, by = 12)) %>%  raster::stackApply(indices = 1, fun = mean, na.rm = T) %>%  raster::rotate() %>% projectRaster(land_mask)

tas_jun.df <- as.data.frame(tas_jun, xy = T) %>% setNames(c("lon","lat","tas_06"))

tas_jul <- raster("ERA5/temperature-2m.nc") %>% stack(bands = seq(from = 7, to = 355, by = 12)) %>%  raster::stackApply(indices = 1, fun = mean, na.rm = T) %>%  raster::rotate() %>% projectRaster(land_mask)

tas_jul.df <- as.data.frame(tas_jul, xy = T) %>% setNames(c("lon","lat","tas_07"))

tas_aug <- raster("ERA5/temperature-2m.nc") %>% stack(bands = seq(from = 8, to = 356, by = 12)) %>%  raster::stackApply(indices = 1, fun = mean, na.rm = T) %>%  raster::rotate() %>% projectRaster(land_mask)

tas_aug.df <- as.data.frame(tas_aug, xy = T) %>% setNames(c("lon","lat","tas_08"))

tas_sep <- raster("ERA5/temperature-2m.nc") %>% stack(bands = seq(from = 9, to = 357, by = 12)) %>%  raster::stackApply(indices = 1, fun = mean, na.rm = T) %>%  raster::rotate() %>% projectRaster(land_mask)

tas_sep.df <- as.data.frame(tas_sep, xy = T) %>% setNames(c("lon","lat","tas_09"))

tas_oct <- raster("ERA5/temperature-2m.nc") %>% stack(bands = seq(from = 10, to = 358, by = 12)) %>%  raster::stackApply(indices = 1, fun = mean, na.rm = T) %>%  raster::rotate() %>% projectRaster(land_mask)

tas_oct.df <- as.data.frame(tas_oct, xy = T) %>% setNames(c("lon","lat","tas_10"))

tas_nov <- raster("ERA5/temperature-2m.nc") %>% stack(bands = seq(from = 11, to = 359, by = 12)) %>%  raster::stackApply(indices = 1, fun = mean, na.rm = T) %>%  raster::rotate() %>% projectRaster(land_mask)

tas_nov.df <- as.data.frame(tas_nov, xy = T) %>% setNames(c("lon","lat","tas_11"))

tas_dec <- raster("ERA5/temperature-2m.nc") %>% stack(bands = seq(from = 12, to = 3360, by = 12)) %>%  raster::stackApply(indices = 1, fun = mean, na.rm = T) %>%  raster::rotate() %>% projectRaster(land_mask)

tas_dec.df <- as.data.frame(tas_dec, xy = T) %>% setNames(c("lon","lat","tas_12"))

```

```{r merge-tas-month, eval = F}
tas_month <- tas_jan.df %>% 
  merge(tas_fev.df, by =c("lon","lat")) %>%
  merge(tas_mar.df, by =c("lon","lat")) %>%
  merge(tas_apr.df, by =c("lon","lat")) %>%
  merge(tas_may.df, by =c("lon","lat")) %>%
  merge(tas_jun.df, by =c("lon","lat")) %>%
  merge(tas_jul.df, by =c("lon","lat")) %>%
  merge(tas_aug.df, by =c("lon","lat")) %>%
  merge(tas_sep.df, by =c("lon","lat")) %>%
  merge(tas_oct.df, by =c("lon","lat")) %>%
  merge(tas_nov.df, by =c("lon","lat")) %>%
  merge(tas_dec.df, by =c("lon","lat"))

tas_month$tas_min <- apply(select(tas_month,c("tas_01", "tas_02", "tas_03", "tas_04", "tas_05", "tas_06", "tas_07", "tas_08", "tas_09", "tas_10", "tas_11", "tas_12")), 1, FUN = min, na.rm = T)

write.table(tas_month, "ERA5/tas_month.txt")
```

```{r merge-dfs, eval = T}
# pr.df <- read.table("ERA5/pr.df.txt")
mpr.df <- read.table("ERA5/mpr.df.txt")
tas.df <- read.table("ERA5/tas.df.txt")
#tas_month.df <- read.table("ERA5/tas_month.txt")
tdew.df <- read.table("ERA5/tdew.df.txt")
ssrd.df <- read.table("ERA5/ssrd.df.txt")
wind.df <- read.table("ERA5/wind.df.txt")
#evaporation.df <- read.table("ERA5/evaporation.df.txt")
#mevap.df <- read.table("ERA5/mevap.df.txt")
#pevap.df <- read.table("ERA5/pevap.df.txt")
#mpevap.df <- read.table("ERA5/mpevap.df.txt")
#slhf.df <- read.table("ERA5/slhf.df.txt")
#sshf.df <- read.table("ERA5/sshf.df.txt")
mslhf.df <- read.table("ERA5/mslhf.df.txt")
msshf.df <- read.table("ERA5/msshf.df.txt")
msr.df <- read.table("ERA5/msr.df.txt")
mlr.df <- read.table("ERA5/mlr.df.txt")

era5 <- mpr.df %>% # in m of water equivalent
#  merge(pr.df, by = c("lon","lat")) %>% # in kg/m2/s
  merge(tas.df, by = c("lon","lat")) %>% # in K
  merge(tdew.df, by = c("lon","lat")) %>% # in K
  merge(ssrd.df, by = c("lon","lat")) %>% # in J/m2
  merge(wind.df, by = c("lon","lat")) %>% # in m/s
 # merge(evaporation.df, by = c("lon","lat")) %>% # in m of water equivalent
  #merge(mevap.df, by = c("lon","lat")) %>% # in kg/m2/s
  #merge(pevap.df, by = c("lon","lat")) %>% # in m of water equivalent
  #merge(mpevap.df, by = c("lon","lat")) %>% # in kg/m2/s 
  #merge(slhf.df, by = c("lon","lat")) %>% # in J/m2, accumulated over 1 day: divide by (60*60*24) to get W/m2
  #merge(sshf.df, by = c("lon","lat")) %>% # in J/m2, accumulated over 1 day: divide by (60*60*24) to get W/m2
  merge(mslhf.df, by = c("lon","lat")) %>% # in W/m2
  merge(msshf.df, by = c("lon","lat")) %>% # in W/m2
  merge(msr.df, by = c("lon","lat")) %>% # in W/m2
  merge(mlr.df, by = c("lon","lat")) %>% # in W/m2
  merge(elev.df, by = c("lon","lat")) %>% # in m
  merge(ipcc_regions.df, by = c("lon","lat")) %>%
  merge(land_mask.df, by = c("lon","lat")) %>%
  filter(lm == 1) %>%
  mutate(model = "historical", period = "1970_2000", source = "ERA5")



write.table(era5, "era5.txt")
```

## Maps

```{r load-data}
era5 <- read.table("era5.txt")
```

```{r comparison-heat-fluxes-solar-radiation, eval = F}
ggplot(era5) + 
  geom_boxplot(aes(x = "sshf", y = sshf, col = "sshf")) +
  geom_boxplot(aes(x = "slhf", y = slhf, col = "slhf")) +
  geom_boxplot(aes(x = "msshf", y = sshf, col = "msshf")) +
  geom_boxplot(aes(x = "mslhf", y = slhf, col = "mslhf")) +
  geom_boxplot(aes(x = "ssrd", y = ssrd, col = "ssrd")) +
  theme_minimal()

ggplot(era5) + 
  geom_boxplot(aes(x = "sshf", y = sshf, col = "sshf")) +
  geom_boxplot(aes(x = "msshf", y = sshf, col = "msshf")) +
  theme_minimal()

ggplot(era5)+geom_point(aes(x=sshf, y = msshf))+geom_abline(intercept = 0, slope = 1, col = "red")
ggplot(era5)+geom_point(aes(x=sshf/(60*60*24), y = msshf), size = 0.5)+
  geom_abline(intercept = 0, slope = 1, col = "red")

ggplot(era5)+geom_raster(aes(x = lon, y = lat, fill = msshf - sshf/(60*60*24)))+ 
  scale_fill_continuous_diverging() + theme_minimal() + theme(legend.position = "bottom")

ggplot(era5)+geom_raster(aes(x = lon, y = lat, fill = mslhf - slhf/(60*60*24)))+ 
  scale_fill_continuous_diverging() + theme_minimal() + theme(legend.position = "bottom")


ggplot(era5)+geom_raster(aes(x = lon, y = lat, fill = mpr - pr))+ 
  scale_fill_continuous_diverging() + theme_minimal() + theme(legend.position = "bottom")

ggplot(era5)+geom_point(aes(x=msshf+mslhf, y = msr+mlr))

ggplot(era5)+geom_raster(aes(x = lon, y = lat, fill = (mlr+msr)+(msshf+sshf)))+ 
  scale_fill_continuous_diverging(guide = "legend", name = "Soil heat flux W/m2") + theme_minimal() + theme(legend.position = "bottom")

```

```{r variable-maps, eval = F}

par(mfcol = c(2,6))

ggplot(data = era5) + geom_raster(aes(x=lon, y = lat,  fill = tas-273.15))+
    scale_fill_continuous_divergingx(palette = "RdYlBu", rev = T, mid = 0, limits = c(-60,40))+
    labs(fill = "2m air temperature, °C")+
    theme_void()+
    theme(legend.position = "bottom")

ggplot(data = era5) + geom_raster(aes(x=lon, y = lat,  fill = mpr*60*60*24*365))+
    scale_fill_continuous_sequential(palette = "Purple-Blue", rev = T, limits = c(0,10000))+
    labs(fill = "Mean precipitation rate, mm/y")+
    theme_void()+
    theme(legend.position = "bottom")
 
ggplot(data = era5) + geom_raster(aes(x=lon, y = lat,  fill = -mpevap*60*60*24*365))+
    scale_fill_continuous_sequential(palette = "Purple-Blue", rev = T, limits = c(-100, 4500))+
    labs(fill = "Mean potential\nevaporation rate, mm/y")+
    theme_void()+
    theme(legend.position = "bottom")
  
ggplot(data = era5) + geom_raster(aes(x=lon, y = lat,  fill = -mevap*60*60*24*365))+
    scale_fill_continuous_sequential(palette = "Purple-Blue", rev = T, limits = c(0,3000))+
    labs(fill = "Mean evaporation rate, mm/y")+
    theme_void()+
    theme(legend.position = "bottom")
 
ggplot(data = era5) + geom_raster(aes(x=lon, y = lat,  fill = - msshf))+
    scale_fill_continuous_divergingx(palette = "RdYlBu", rev = T, limits = c(-60,400), na.value = "black")+
    labs(fill = "Mean surface sensible heat flux, W/m2")+
    theme_void()+
    theme(legend.position = "bottom")
  
   
ggplot(data = era5) + geom_raster(aes(x=lon, y = lat,  fill = - mslhf))+
    scale_fill_continuous_divergingx(palette = "RdYlBu", rev = T, limits = c(-60,400), na.value = "black")+
    labs(fill = "Mean surface latent heat flux, W/m2")+
    theme_void()+
    theme(legend.position = "bottom")
  
ggplot(data = era5) + geom_raster(aes(x=lon, y = lat,  fill = msr))+
    scale_fill_continuous_divergingx(palette = "RdYlBu", rev = T, limits = c(-60,400), na.value = "black")+
    labs(fill = "Mean net shortwave radiation, W/m2")+
    theme_void()+
    theme(legend.position = "bottom")

ggplot(data = era5) + geom_raster(aes(x=lon, y = lat,  fill = ssrd/(60*60*24)))+
    scale_fill_continuous_divergingx(palette = "RdYlBu", rev = T, limits = c(-60,400), na.value = "black")+
    labs(fill = "Downwards shortwave radiation, W/m2")+
    theme_void()+
    theme(legend.position = "bottom")
  
   
ggplot(data = era5) + geom_raster(aes(x=lon, y = lat,  fill = - mlr))+
    scale_fill_continuous_divergingx(palette = "RdYlBu", rev = T, limits = c(-60,400), na.value = "black")+
    labs(fill = "Mean net longwave radiation, W/m2")+
    theme_void()+
    theme(legend.position = "bottom")

ggplot(data = era5) + geom_raster(aes(x=lon, y = lat,  fill = - (msshf +mslhf)))+
    scale_fill_continuous_divergingx(palette = "RdYlBu", rev = T, limits = c(-60,400), na.value = "black")+
    labs(fill = "Mean surface heat flux, W/m2")+
    theme_void()+
    theme(legend.position = "bottom")

ggplot(data = era5) + geom_raster(aes(x=lon, y = lat,  fill =  (msr +mlr)))+
    scale_fill_continuous_divergingx(palette = "RdYlBu", rev = T, limits = c(-60,400), na.value = "black")+
    labs(fill = "Mean surface shortwave and longwave radiation, W/m2")+
    theme_void()+
    theme(legend.position = "bottom")
  
ggplot(data = era5) + geom_raster(aes(x=lon, y = lat,  fill = msshf/mslhf))+
    scale_fill_continuous_divergingx(palette = "RdYlBu", rev = T, limits = c(-30,50), na.value = "black")+
    labs(fill = "Bowen ratio (sensible/latent heat flux)")+
    theme_void()+
    theme(legend.position = "bottom")
  
ggplot(data = era5) + geom_raster(aes(x=lon, y = lat,  fill = mslhf/(mslhf+msshf)))+
    scale_fill_continuous_divergingx(palette = "RdYlBu", rev = T, limits = c(-1,3), na.value = "black")+
    labs(fill = "Fraction évaporative (latent/(sensible + latent))")+
    theme_void()+
    theme(legend.position = "bottom")


```

# De Martonne Aridity Index 

```{r colors}
#display.brewer.pal(n = 11, name ="RdYlBu")
colorvec <- brewer.pal(n = 11, name ="RdYlBu")

col.martonne <- c("Desert" = colorvec[2], "Arid"= colorvec[4],"Semi-arid"= colorvec[5], "Temperate" = colorvec[8], "Humid"= colorvec[10],"Forest"= colorvec[11])
col.cat <- c("Hyperarid" = colorvec[2], "Arid"= colorvec[4],"Semi-arid"= colorvec[5], "Dry subhumid" = colorvec[8], "Humid"= colorvec[10])
```

```{r aridity-index-martonne}

# Martonne
era5$AIm <- with(era5,mpr*60*60*24*365/(tas-273.15+10)) # convert pr to mm/y, tas to Ceslsius
breaks.martonne <- c(0,5,10,20,"30","40",Inf)
cat.martonne <- c("[0,5]" = "Desert", "(5,10]"= "Arid", "(10,20]" = "Semi-arid","(20,30]" = "Temperate", "(30,40]" = "Humid", "(40,Inf]" = "Forest")

era5$cat.AIm <- era5$AIm %>% cut(breaks.martonne, include.lowest = T) %>% revalue(cat.martonne)

ggplot() + geom_raster(data = era5, aes(x=lon, y = lat,  fill = cat.AIm))+
  scale_fill_manual(values = col.martonne)+
  theme_void()+
  theme(legend.position = "bottom")
```

# FAO Aridity Index

https://www.fao.org/3/x0490E/x0490e0k.htm#annex%203.%20background%20on%20physical%20parameters%20used%20in%20evapotranspiration%20computatio 


## Rn is latent + sensible heat flux. AI = average P / average PET

```{r aridity-index-Rn-G}
#era5 <- read.table("era5.txt")

era5_AI <- era5 %>% mutate(Rn = -(msshf + mslhf) * 86400 * 1e-6, # Rn is actually Rn - G, the sum of sensible and latent heat fluxes. In W/m2, converted to MJ/m2/day
                          P =  101.3 * ((293-0.0065*z)/293)^(5.26),
                          ea = 0.61078*exp(17.27*(tdew-273.15)/((tdew-273.15)+237.3)), # Tetens 1930
                          es = 0.61078*exp(17.27*(tas-273.15)/((tas-273.15)+237.3)), 
                          delta = 4098*es/((tas-273.15)+237.3)^2, #slope vapor pressure
                          gamma =  0.00163*P/(2.501-52.6361e-3*(tas-273.15)), #psychrometric constant
                          ET0 = (0.408*delta*Rn+gamma*900/((tas-273.15)+273)*0.748*sfcWind*(es-ea))/(delta+gamma*(1+0.34*0.748*sfcWind)), # Wind speed at 10 m is converted to wind speed at 2 m by multiplying by 0.748
                          AI = mpr*60*60*24/(ET0))

breaks.unesco <- c(-0.03,0.03,0.2,0.5,0.65,Inf)
cat.unesco <- c("(-0.03,0.03]"= "Hyperarid", "(0.03,0.2]" = "Arid", "(0.2,0.5]" = "Semi-arid", "(0.5,0.65]" = "Dry subhumid","(0.65,Inf]" = "Humid")

era5_AI$cat.AI <- era5_AI$AI %>% cut(breaks = breaks.unesco) %>% 
  revalue(cat.unesco)

#write.table(era5, "era5_AI.txt")

ggplot() + geom_raster(data = era5_AI, aes(x=lon, y = lat,  fill = cat.AI))+
  scale_fill_manual(values = col.cat)+
  theme_void()+
  theme(legend.position = "bottom")

ggplot(subset(era5_AI, Name == "Mediterranean")) + geom_raster(aes(x=lon, y = lat,  fill = AI))+
    scale_fill_continuous_divergingx(palette = "RdYlBu", rev = F, mid = 0, limits = c(0,4))+
    theme_void()+
    theme(legend.position = "bottom")
```

```{r by-param, eval = F}
eraplot <- function(var = "tas"){
  if(var %in% c("tas","tdew","tas_min")){
  g <- ggplot(era5) + geom_raster(data = era5, aes(x=lon, y = lat,  fill = era5[,var]-273.15))+
    scale_fill_continuous_divergingx(palette = "RdYlBu", rev = T, mid = 0, limits = c(-60,40))+
    labs(title = var, fill = "°C")+
    theme_void()+ theme(legend.position = "bottom")
  }else if(var %in% c("mpr","mevap","mpevap")){
  g <- ggplot(era5) + geom_raster(aes(x=lon, y = lat,  fill = era5[,var]*60*60*24*365))+
    scale_fill_continuous_sequential(palette = "Purple-Blue", rev = T)+
    labs(title = var, fill = "mm/y")+
    theme_void()+
    theme(legend.position = "bottom")
  }else if(var %in% c("ssrd","mslhf","msshf","msr","mlr")){
  g <- ggplot(data = era5) + geom_raster(aes(x=lon, y = lat,  fill = - era5[,var]))+
    scale_fill_continuous_divergingx(palette = "RdYlBu", rev = T, limits = c(-60,400), na.value = "black")+
    labs(title = var, fill = "W/m2")+
    theme_void()+
    theme(legend.position = "bottom")
  }else if(var %in% c("Rn")){
  g <- ggplot(data = era5) + geom_raster(aes(x=lon, y = lat,  fill = - era5[,var]))+
    scale_fill_continuous_divergingx(palette = "RdYlBu", rev = T, na.value = "black")+
    labs(title = var, fill = "W/m2")+
    theme_void()+
    theme(legend.position = "bottom")
  }else if(var %in% c("ea","es")){
      g <- ggplot(data = era5) + geom_raster(aes(x=lon, y = lat, fill = era5[,var]))+
    scale_fill_continuous_divergingx(palette = "RdYlBu", rev = T, na.value = "black")+
    labs(title = var, fill = "kPa")+
    theme_void()+
    theme(legend.position = "bottom")
  }
  return(g)
}

cowplot::plot_grid(plotlist = list(
    eraplot("tas"),
    eraplot("mpr"),
    eraplot("ea"),
    eraplot("Rn")
))

```

## ET0 is calculated monthly before summing for annual PET

### test on 1970 

Check that calculating by month before summing, makes a difference compared to averaging the parameters for 30 years.


```{r load-raster-by-month-1970, eval = T}

mprm <- data.frame(lon = NA, lat = NA, mpr = NA, month = NA)
t2mm <- data.frame(lon = NA, lat = NA, t2m = NA, month = NA)
tdewm <- data.frame(lon = NA, lat = NA, tdew = NA, month = NA)
windm <- data.frame(lon = NA, lat = NA, wind = NA, month = NA)
mslhfm <- data.frame(lon = NA, lat = NA, mslhf = NA, month = NA)
msshfm <- data.frame(lon = NA, lat = NA, msshf = NA, month = NA)

for(i in 1:12){ # the 12 first layers correspond to the year 1970
  
mpr <- raster("ERA5/mean_rates.nc", varname = "mtpr", band = i) %>%
   aggregate(fact = 4, fun = mean) %>%
  raster::rotate() %>% projectRaster(land_mask) %>%
  as.data.frame(xy = T) %>% setNames(c("lon","lat","mpr")) %>%
  mutate(month = i)

mprm <<- rbind(mprm, mpr)

t2m <- raster("ERA5/temperature-2m.nc", band = i) %>%
  raster::rotate() %>%
  aggregate(fact = 4, fun = mean) %>%
  projectRaster(land_mask) %>%
  as.data.frame(xy = T) %>% setNames(c("lon","lat","t2m")) %>%
  mutate(month = i)

t2mm <<- rbind(t2mm, t2m)

tdew <- raster("ERA5/2m-dewpoint.nc", varname = "d2m", band = i)  %>% 
  raster::rotate() %>%
  aggregate(fact = 4, fun = mean) %>%
  projectRaster(land_mask) %>%
  as.data.frame(xy = T) %>% setNames(c("lon","lat","tdew")) %>%
  mutate(month = i)

tdewm <- rbind(tdewm, tdew)

wind <- raster("ERA5/wind10m.nc", varname = "si10", band = i) %>%
  raster::rotate() %>%
  aggregate(fact = 4, fun = mean) %>%
  projectRaster(land_mask) %>%
  as.data.frame(xy = T) %>% 
  setNames(c("lon","lat","wind")) %>%
  mutate(month = i)# m/s

windm <<- rbind(windm, wind) 

mslhf <- raster("ERA5/mean_rates.nc", varname = "mslhf", band = i) %>%
  raster::rotate() %>%
  aggregate(fact = 4, fun = mean) %>% 
  projectRaster(land_mask) %>% 
  as.data.frame(xy = T) %>% setNames(c("lon","lat","mslhf")) %>%
  mutate(month = i)

mslhfm <<- rbind(mslhfm, mslhf)

msshf <- raster("ERA5/mean_rates.nc", varname = "msshf", band = i) %>%
  raster::rotate() %>% 
  aggregate(fact = 4, fun = mean) %>%
  projectRaster(land_mask) %>%
  as.data.frame(xy = T) %>% setNames(c("lon","lat","msshf"))  %>%
  mutate(month = i)

msshfm <<- rbind(msshfm, msshf)
}


mon70 <- merge(mprm, t2mm, by = c("lon","lat","month")) %>% merge(tdewm, by = c("lon","lat","month")) %>% merge(windm, by = c("lon","lat","month")) %>% 
  merge(mslhfm, by = c("lon","lat","month")) %>% merge(msshfm, by = c("lon","lat","month")) %>% 
  merge(land_mask.df, by = c("lon","lat")) %>%
  merge(ipcc_regions.df, by = c("lon","lat")) %>%
  merge(elev.df, by = c("lon","lat"))
```

```{r ET-by-month-1970}
et0 <- mon70 %>% filter(lm == 1) %>% mutate(Rn = - (msshf + mslhf) * 86400 * 1e-6, #In W/m2, converted to MJ/m2/day
                        P = 101.3 * ((293-0.0065*z)/293)^(5.26),
                        ea = 0.61078*exp(17.27*(tdew-273.15)/((tdew-273.15)+237.3)), # Tetens 1930
                        es = 0.61078*exp(17.27*(t2m-273.15)/((t2m-273.15)+237.3)),
                        delta = 4098*es/((t2m-273.15)+237.3)^2,
                        gamma = 0.00163*P/(2.501-52.6361e-3*(t2m-273.15)),
                        ET0 = (0.408*delta*Rn+gamma*900/((t2m-273.15)+273)*0.748*wind*(es-ea))/(delta+gamma*(1+0.34*0.748*wind)),
                        AI = (mpr*60*60*24)/ET0)



breaks.unesco <- c(-0.03,0.03,0.2,0.5,0.65,Inf)
cat.unesco <- c("(-0.03,0.03]"= "Hyperarid", "(0.03,0.2]" = "Arid", "(0.2,0.5]" = "Semi-arid", "(0.5,0.65]" = "Dry subhumid","(0.65,Inf]" = "Humid")

et0$cat.AI <- et0$AI %>% cut(breaks = breaks.unesco) %>% 
  revalue(cat.unesco)


for(i in c(1:12)){

g <- ggplot(subset(et0, month == i)) + geom_tile(aes(x=lon, y = lat,  fill = cat.AI))+
  scale_fill_manual(values = col.cat)+
  labs(title = i)
  theme_void()+
  theme(legend.position = "bottom")

print(g)
}

et0_avg <- et0 %>% group_by(lon,lat,lm, Continent, Type, Name, Acronym, z) %>% summarise(AI = mean(AI, na.rm = T), ET0 = mean(ET0, na.rm = T), mpr = mean(mpr, na.rm = T))
et0_avg$cat.AI <- et0_avg$AI %>% cut(breaks = breaks.unesco) %>% 
  revalue(cat.unesco)
```

```{r ET-annual-1970}
et0_70 <- mon70 %>% filter(lm != 0) %>% group_by(lon,lat,lm, Continent, Type, Name, Acronym, z) %>% 
                summarise(mpr = mean(mpr, na.rm = T), t2m = mean(t2m, na.rm = T), tdew = mean(tdew, na.rm = T), 
                          wind = mean(wind, na.rm = T), msshf = mean(msshf, na.rm = T), mslhf = mean(mslhf, na.rm = T)) %>%
                 mutate(Rn = - (msshf + mslhf) * 86400 * 1e-6, #In W/m2, converted to MJ/m2/day
                        P = 101.3 * ((293-0.0065*z)/293)^(5.26),
                        ea = 0.61078*exp(17.27*(tdew-273.15)/((tdew-273.15)+237.3)), # Tetens 1930
                        es = 0.61078*exp(17.27*(t2m-273.15)/((t2m-273.15)+237.3)),
                        delta = 4098*es/((t2m-273.15)+237.3)^2,
                        gamma = 0.00163*P/(2.501-52.6361e-3*(t2m-273.15)),
                        ET0 = (0.408*delta*Rn+gamma*900/((t2m-273.15)+273)*0.748*wind*(es-ea))/(delta+gamma*(1+0.34*0.748*wind)),
                        AI = (mpr*60*60*24)/ET0,
                        month = 13) 

breaks.unesco <- c(-0.03,0.03,0.2,0.5,0.65,Inf)
cat.unesco <- c("(-0.03,0.03]"= "Hyperarid", "(0.03,0.2]" = "Arid", "(0.2,0.5]" = "Semi-arid", "(0.5,0.65]" = "Dry subhumid","(0.65,Inf]" = "Humid")

et0_70$cat.AI <- et0_70$AI %>% cut(breaks = breaks.unesco) %>% 
  revalue(cat.unesco)

ggplot(et0_70) + geom_raster(aes(x=lon, y = lat,  fill = cat.AI))+
  scale_fill_manual(values = col.cat)+
  theme_void()+
  theme(legend.position = "bottom")
```

```{r compare}
et0c <- merge(select(et0_avg, c("lon","lat","Continent","Type","Name", "mpr","ET0","AI","cat.AI")), 
              select(et0_70, c("lon","lat","Continent","Type","Name", "mpr","ET0","AI","cat.AI")), 
              by = c("lon","lat","Continent","Type","Name"))
# ETx is the mean of monthly calculated ET0 and AI
#ETy is the the AI calculated on mean pr and mean ET0*

ggplot(et0c, aes(x=ET0.x, y = ET0.y))+geom_point(aes(col = lat))+
  scale_color_viridis_c()+
  labs(x="mean(mpr_i/ET0_i)", y =" mean(mpr)/mean(ET0)")+
  geom_smooth(method = "lm", se=FALSE, color="black", formula = y ~ x)+
  stat_poly_eq() +
  theme_minimal()


ggplot(et0c) + geom_raster(aes(x=lon, y = lat,  fill = cat.AI.x))+
  scale_fill_manual(values = col.cat)+
  labs(title = "mean(pr/ET0)")+
  theme_void()+
  theme(legend.position = "bottom")

ggplot(et0c) + geom_raster(aes(x=lon, y = lat,  fill = cat.AI.y))+
  labs(title = "mean(pr)/mean(ET0)")+
  scale_fill_manual(values = col.cat)+
  theme_void()+
  theme(legend.position = "bottom")
```



### PET by month for the 30 years of the reference period

```{r load-raster-by-month, eval = F}

mprm <- data.frame(lon = NA, lat = NA, mpr = NA, month = NA)
t2mm <- data.frame(lon = NA, lat = NA, t2m = NA, month = NA)
tdewm <- data.frame(lon = NA, lat = NA, tdew = NA, month = NA)
windm <- data.frame(lon = NA, lat = NA, wind = NA, month = NA)
mslhfm <- data.frame(lon = NA, lat = NA, mslhf = NA, month = NA)
msshfm <- data.frame(lon = NA, lat = NA, msshf = NA, month = NA)

for(i in 1:372){
  
mpr <- raster("ERA5/mean_rates.nc", varname = "mtpr", band = i) %>%
  raster::rotate() %>% projectRaster(land_mask) %>%
  as.data.frame(xy = T) %>% setNames(c("lon","lat","mpr")) %>%
  mutate(month = i)

mprm <<- rbind(mprm, mpr)

t2m <- raster("ERA5/temperature-2m.nc", band = i) %>%
  raster::rotate() %>%
  aggregate(fact = 4, fun = mean) %>%
  projectRaster(land_mask) %>%
  as.data.frame(xy = T) %>% setNames(c("lon","lat","t2m")) %>%
  mutate(month = i)

t2mm <<- rbind(t2mm, t2m)

tdew <- raster("ERA5/2m-dewpoint.nc", varname = "d2m", band = i)  %>% 
  raster::rotate() %>%
  aggregate(fact = 4, fun = mean) %>%
  projectRaster(land_mask) %>%
  as.data.frame(xy = T) %>% setNames(c("lon","lat","tdew")) %>%
  mutate(month = i)

tdewm <- rbind(tdewm, tdew)

wind <- raster("ERA5/wind10m.nc", varname = "si10", band = i) %>%
  raster::rotate() %>%
  aggregate(fact = 4, fun = mean) %>%
  projectRaster(land_mask) %>%
  as.data.frame(xy = T) %>% 
  setNames(c("lon","lat","wind")) %>%
  mutate(month = i)# m/s

windm <<- rbind(windm, wind) 

mslhf <- raster("ERA5/mean_rates.nc", varname = "mslhf", band = i) %>%
  raster::rotate() %>%
  aggregate(fact = 4, fun = mean) %>% 
  projectRaster(land_mask) %>% 
  as.data.frame(xy = T) %>% setNames(c("lon","lat","mslhf")) %>%
  mutate(month = i)

mslhfm <<- rbind(mslhfm, mslhf)

msshf <- raster("ERA5/mean_rates.nc", varname = "msshf", band = i) %>%
  raster::rotate() %>% 
  aggregate(fact = 4, fun = mean) %>%
  projectRaster(land_mask) %>%
  as.data.frame(xy = T) %>% setNames(c("lon","lat","msshf"))  %>%
  mutate(month = i)

msshfm <<- rbind(msshfm, msshf)
}


mon1970_2000 <- merge(mprm, t2mm, by = c("lon","lat","month")) %>% merge(tdewm, by = c("lon","lat","month")) %>% merge(windm, by = c("lon","lat","month")) %>% 
  merge(mslhfm, by = c("lon","lat","month")) %>% merge(msshfm, by = c("lon","lat","month")) %>% 
  merge(land_mask.df, by = c("lon","lat")) %>%
  merge(ipcc_regions.df, by = c("lon","lat")) %>%
  merge(elev.df, by = c("lon","lat"))

write.table(mon1970_2000, "ERA5/mon1970_2000.txt")
```

```{r ET-by-month, eval = F}

mon1970_2000 <- read.table("ERA5/mon1970_2000.txt")

et0_1970_2000 <- mon1970_2000 %>% filter(lm != 0) %>% mutate(Rn = - (msshf + mslhf) * 86400 * 1e-6, #In W/m2, converted to MJ/m2/day
                        P = 101.3 * ((293-0.0065*z)/293)^(5.26),
                        ea = 0.61078*exp(17.27*(tdew-273.15)/((tdew-273.15)+237.3)), # Tetens 1930
                        es = 0.61078*exp(17.27*(t2m-273.15)/((t2m-273.15)+237.3)),
                        delta = 4098*es/((t2m-273.15)+237.3)^2,
                        gamma = 0.00163*P/(2.501-52.6361e-3*(t2m-273.15)),
                        ET0 = (0.408*delta*Rn+gamma*900/((t2m-273.15)+273)*0.748*wind*(es-ea))/(delta+gamma*(1+0.34*0.748*wind)),
                        AI = (mpr*60*60*24)/ET0)

breaks.unesco <- c(-0.03,0.03,0.2,0.5,0.65,Inf)
cat.unesco <- c("(-0.03,0.03]"= "Hyperarid", "(0.03,0.2]" = "Arid", "(0.2,0.5]" = "Semi-arid", "(0.5,0.65]" = "Dry subhumid","(0.65,Inf]" = "Humid")

et0_1970_2000$cat.AI <- et0_1970_2000$AI %>% cut(breaks = breaks.unesco) %>%  revalue(cat.unesco)

et0_ref <- et0_1970_2000 %>% group_by(lon,lat,lm, Continent, Type, Name, Acronym, z) %>% summarise(AI = mean(AI, na.rm = T), ET0 = mean(ET0, na.rm = T), mpr = mean(mpr, na.rm = T))
et0_ref$cat.AI <- et0_ref$AI %>% cut(breaks = breaks.unesco) %>% revalue(cat.unesco)

write.table(et0_ref, "ERA5/et0_ref.txt")
```

```{r plot-ref}
et0_ref <- read.table("ERA5/et0_ref.txt")

ggplot(et0_ref) + geom_raster(aes(x=lon, y = lat,  fill = cat.AI))+
  scale_fill_manual(values = col.cat)+
  labs(title = "mean(pr/ET0)")+
  theme_void()+
  theme(legend.position = "bottom")
```

```{r ET-annual-1970-2000, eval = F}
mon1970_2000 <- read.table("ERA5/mon1970_2000.txt")

et0_30y <- mon1970_2000 %>% filter(lm != 0) %>% group_by(lon,lat,lm, Continent, Type, Name, Acronym, z) %>% 
                summarise(mpr = mean(mpr, na.rm = T), t2m = mean(t2m, na.rm = T), tdew = mean(tdew, na.rm = T), 
                          wind = mean(wind, na.rm = T), msshf = mean(msshf, na.rm = T), mslhf = mean(mslhf, na.rm = T)) %>%
                 mutate(Rn = - (msshf + mslhf) * 86400 * 1e-6, #In W/m2, converted to MJ/m2/day
                        P = 101.3 * ((293-0.0065*z)/293)^(5.26),
                        ea = 0.61078*exp(17.27*(tdew-273.15)/((tdew-273.15)+237.3)), # Tetens 1930
                        es = 0.61078*exp(17.27*(t2m-273.15)/((t2m-273.15)+237.3)),
                        delta = 4098*es/((t2m-273.15)+237.3)^2,
                        gamma = 0.00163*P/(2.501-52.6361e-3*(t2m-273.15)),
                        ET0 = (0.408*delta*Rn+gamma*900/((t2m-273.15)+273)*0.748*wind*(es-ea))/(delta+gamma*(1+0.34*0.748*wind)),
                        AI = (mpr*60*60*24)/ET0) 

breaks.unesco <- c(-0.03,0.03,0.2,0.5,0.65,Inf)
cat.unesco <- c("(-0.03,0.03]"= "Hyperarid", "(0.03,0.2]" = "Arid", "(0.2,0.5]" = "Semi-arid", "(0.5,0.65]" = "Dry subhumid","(0.65,Inf]" = "Humid")

et0_30y$cat.AI <- et0_30y$AI %>% cut(breaks = breaks.unesco) %>% 
  revalue(cat.unesco)

write.table(et0_30y, "ERA5/et0_30y.txt")
```

```{r plot-mean-over-30y}
et0_30y <- read.table("ERA5/et0_30y.txt")

ggplot(et0_30y) + geom_raster(aes(x=lon, y = lat,  fill = cat.AI))+
  scale_fill_manual(values = col.cat)+
  theme_void()+
  theme(legend.position = "bottom")
```

```{r compare-et0-30y}
et0_all <- merge(et0_ref, select(et0_30y, names(et0_ref)), by = c("lon","lat","lm","Continent","Type","Name","Acronym","z"))

ggplot(data = et0_all, aes(x = ET0.x, y = ET0.y))+
  geom_point(aes(col =cat.AI.x))+
  geom_abline(slope = 1, intercept = 0)+
  stat_poly_eq()+scale_color_manual(values = col.cat) + theme_minimal()

ggplot(et0_all) + geom_raster(aes(x=lon, y = lat,  fill = cat.AI.x))+
  scale_fill_manual(values = col.cat)+
  theme_void()+
  theme(legend.position = "bottom")

ggplot(et0_all) + geom_raster(aes(x=lon, y = lat,  fill = cat.AI.y))+
  scale_fill_manual(values = col.cat)+
  theme_void()+
  theme(legend.position = "bottom")
```

```{r ET-by-month-1970-2000, eval = F}
mon1970_2000 <- read.table("ERA5/mon1970_2000.txt")

era5_bymonth <- mon1970_2000 %>% mutate(month2 = NA)
era5_bymonth$month2[which(era5_bymonth$month %in% seq(1,361,12))] <- 1
era5_bymonth$month2[which(era5_bymonth$month %in% seq(2,362,12))] <- 2
era5_bymonth$month2[which(era5_bymonth$month %in% seq(3,363,12))] <- 3
era5_bymonth$month2[which(era5_bymonth$month %in% seq(4,364,12))] <- 4
era5_bymonth$month2[which(era5_bymonth$month %in% seq(5,365,12))] <- 5
era5_bymonth$month2[which(era5_bymonth$month %in% seq(6,366,12))] <- 6
era5_bymonth$month2[which(era5_bymonth$month %in% seq(7,367,12))] <- 7
era5_bymonth$month2[which(era5_bymonth$month %in% seq(8,368,12))] <- 8
era5_bymonth$month2[which(era5_bymonth$month %in% seq(9,369,12))] <- 9
era5_bymonth$month2[which(era5_bymonth$month %in% seq(10,370,12))] <- 10
era5_bymonth$month2[which(era5_bymonth$month %in% seq(11,371,12))] <- 11
era5_bymonth$month2[which(era5_bymonth$month %in% seq(12,372,12))] <- 12


era5_bymonth <- era5_bymonth %>% filter(lm != 0) %>% group_by(lon,lat,lm, Continent, Type, Name, Acronym, z, month2) %>% 
                 summarise(mpr = mean(mpr, na.rm = T), t2m = mean(t2m, na.rm = T), tdew = mean(tdew, na.rm = T), 
                          wind = mean(wind, na.rm = T), msshf = mean(msshf, na.rm = T), mslhf = mean(mslhf, na.rm = T)) %>%
                 mutate(Rn = - (msshf + mslhf) * 86400 * 1e-6, #In W/m2, converted to MJ/m2/day
                        P = 101.3 * ((293-0.0065*z)/293)^(5.26),
                        ea = 0.61078*exp(17.27*(tdew-273.15)/((tdew-273.15)+237.3)), # Tetens 1930
                        es = 0.61078*exp(17.27*(t2m-273.15)/((t2m-273.15)+237.3)),
                        delta = 4098*es/((t2m-273.15)+237.3)^2,
                        gamma = 0.00163*P/(2.501-52.6361e-3*(t2m-273.15)),
                        ET0 = (0.408*delta*Rn+gamma*900/((t2m-273.15)+273)*0.748*wind*(es-ea))/(delta+gamma*(1+0.34*0.748*wind))*30, #mm/month
                        pr = mpr*60*60*24*30)

write.table(era5_bymonth, "ERA5/era5_bymonth.txt")

era5_AI <- era5_bymonth %>% group_by(lon,lat,lm, Continent, Type, Name, Acronym, z) %>% summarise(across(c(ET0, pr), sum), across(c(t2m,wind,ea,Rn), mean))
era5_AI$AI <- with(era5_AI, pr/ET0)
# find a way to sum the ETO and pr by month

breaks.unesco <- c(-Inf,0,0.03,0.2,0.5,0.65,Inf)
cat.unesco <- c("(0,0.03]"= "Hyperarid", "(0.03,0.2]" = "Arid", "(0.2,0.5]" = "Semi-arid", "(0.5,0.65]" = "Dry subhumid","(0.65, Inf]" = "Humid", "(-Inf,0]" = "Cold")
col.cat <- c("Hyperarid" = colorvec[2], "Arid"= colorvec[4],"Semi-arid"= colorvec[5], "Dry subhumid" = colorvec[8], "Humid"= colorvec[10], "Cold" = "powderblue")

era5_AI$cat.AI <- era5_AI$AI %>% cut(breaks = breaks.unesco) %>% revalue(cat.unesco)
era5_AI$cat.AI[which(era5_AI$ET0 < 400)] <- "Cold"
era5_AI$cat.AI %>% unique()

ggplot() + geom_raster(data = subset(era5_AI, lm == 1), aes(x=lon, y = lat,  fill = cat.AI))+
  geom_raster(data = subset(era5_AI, lm != 1), aes(x=lon, y = lat),  fill = "lightblue")+
  scale_fill_manual(values = col.cat, na.translate = F)+
  labs(fill = "")+
  ylim(-55,90)+
  theme_void()+
  theme(legend.position = "bottom")

ggplot() + geom_raster(data = era5_AI, aes(x=lon, y = lat,  fill = cat.AI))+
  scale_fill_manual(values = col.cat, na.translate = F)+
  labs(fill = "")+
  ylim(-55,90)+
  theme_void()+
  theme(legend.position = "bottom")

ggplot() + geom_raster(data = subset(era5_AI, lm == 1), aes(x=lon, y = lat,  fill = ET0))+
  geom_raster(data = subset(era5_AI, lm != 1), aes(x=lon, y = lat),  fill = "lightblue")+
  scale_fill_binned(type = "viridis", breaks = c(0,400,800,1200,1600))+
  labs(fill = "")+
  ylim(-55,90)+
  theme_void()+
  theme(legend.position = "top")

ggplot() + geom_raster(data = subset(era5_AI, lm == 1), aes(x=lon, y = lat,  fill = pr))+
  geom_raster(data = subset(era5_AI, lm != 1), aes(x=lon, y = lat),  fill = "lightblue")+
  scale_fill_binned(type = "viridis", breaks = c(0,400,800,1200,1600))+
  labs(fill = "")+
  ylim(-55,90)+
  theme_void()+
  theme(legend.position = "bottom")


write.table(era5_AI, "ERA5/era5_AI.txt")
```


# Daily means

## January 1985

```{r test-daily-mean, eval = F}

mprm <- data.frame(lon = NA, lat = NA, mpr = NA, month = NA)
t2mm <- data.frame(lon = NA, lat = NA, t2m = NA, month = NA)
tdewm <- data.frame(lon = NA, lat = NA, tdew = NA, month = NA)
uwindm <- data.frame(lon = NA, lat = NA, uwind = NA, month = NA)
vwindm <- data.frame(lon = NA, lat = NA, vwind = NA, month = NA)
mslhfm <- data.frame(lon = NA, lat = NA, mslhf = NA, month = NA)
msshfm <- data.frame(lon = NA, lat = NA, msshf = NA, month = NA)

for(i in 1:31){
  
mpr <- raster("ERA5/pr_compiler.nc", band = i) %>%
  raster::rotate() %>% projectRaster(land_mask) %>%
  as.data.frame(xy = T) %>% setNames(c("lon","lat","mpr")) %>%
  mutate(month = i)

mprm <<- rbind(mprm, mpr)

t2m <- raster("ERA5/t2m_compiler.nc", band = i) %>%
  raster::rotate() %>%
  aggregate(fact = 4, fun = mean) %>%
  projectRaster(land_mask) %>%
  as.data.frame(xy = T) %>% setNames(c("lon","lat","t2m")) %>%
  mutate(month = i)

t2mm <<- rbind(t2mm, t2m)

tdew <- raster("ERA5/d2m_compiler.nc", band = i)  %>% 
  raster::rotate() %>%
  aggregate(fact = 4, fun = mean) %>%
  projectRaster(land_mask) %>%
  as.data.frame(xy = T) %>% setNames(c("lon","lat","tdew")) %>%
  mutate(month = i)

tdewm <- rbind(tdewm, tdew)

uwind <- raster("ERA5/10m-u-wind_compiler.nc", band = i) %>%
  raster::rotate() %>%
  aggregate(fact = 4, fun = mean) %>%
  projectRaster(land_mask) %>%
  as.data.frame(xy = T) %>% 
  setNames(c("lon","lat","uwind")) %>%
  mutate(month = i)# m/s

uwindm <<- rbind(uwindm, uwind) 

vwind <- raster("ERA5/10m-v-wind_compiler.nc", band = i) %>%
  raster::rotate() %>%
  aggregate(fact = 4, fun = mean) %>%
  projectRaster(land_mask) %>%
  as.data.frame(xy = T) %>% 
  setNames(c("lon","lat","vwind")) %>%
  mutate(month = i)# m/s

vwindm <<- rbind(vwindm, vwind) 

mslhf <- raster("ERA5/mslhf_compiler.nc", band = i) %>%
  raster::rotate() %>%
  aggregate(fact = 4, fun = mean) %>% 
  projectRaster(land_mask) %>% 
  as.data.frame(xy = T) %>% setNames(c("lon","lat","mslhf")) %>%
  mutate(month = i)

mslhfm <<- rbind(mslhfm, mslhf)

msshf <- raster("ERA5/msshf_compiler.nc", band = i) %>%
  raster::rotate() %>% 
  aggregate(fact = 4, fun = mean) %>%
  projectRaster(land_mask) %>%
  as.data.frame(xy = T) %>% setNames(c("lon","lat","msshf"))  %>%
  mutate(month = i)

msshfm <<- rbind(msshfm, msshf)
}


jan1985 <- merge(mprm, t2mm, by = c("lon","lat","month")) %>% merge(tdewm, by = c("lon","lat","month"))  %>% merge(uwindm, by = c("lon","lat","month"))%>% merge(vwindm, by = c("lon","lat","month")) %>% 
  merge(mslhfm, by = c("lon","lat","month")) %>% merge(msshfm, by = c("lon","lat","month")) %>% 
  merge(land_mask.df, by = c("lon","lat")) %>%
  merge(ipcc_regions.df, by = c("lon","lat")) %>%
  merge(elev.df, by = c("lon","lat"))

write.table(jan1985, "ERA5/jan1985.txt")
```

```{r jan1985-ref}
jan1985 <- read.table("ERA5/jan1985.txt")
jan85_day <- jan1985 %>% filter(lm != 0) %>% mutate(Rn = - (msshf + mslhf) * 86400 * 1e-6, #In W/m2, converted to MJ/m2/day
                        wind = sqrt(uwind^2+vwind^2), #make wind from u and v components                                
                        P = 101.3 * ((293-0.0065*z)/293)^(5.26),
                        ea = 0.61078*exp(17.27*(tdew-273.15)/((tdew-273.15)+237.3)), # Tetens 1930
                        es = 0.61078*exp(17.27*(t2m-273.15)/((t2m-273.15)+237.3)),
                        delta = 4098*es/((t2m-273.15)+237.3)^2,
                        gamma = 0.00163*P/(2.501-52.6361e-3*(t2m-273.15)),
                        ET0 = (0.408*delta*Rn+gamma*900/((t2m-273.15)+273)*0.748*wind*(es-ea))/(delta+gamma*(1+0.34*0.748*wind)),
                        AI = (mpr*60*60*24)/ET0)

breaks.unesco <- c(-0.03,0.03,0.2,0.5,0.65,Inf)
cat.unesco <- c("(-0.03,0.03]"= "Hyperarid", "(0.03,0.2]" = "Arid", "(0.2,0.5]" = "Semi-arid", "(0.5,0.65]" = "Dry subhumid","(0.65,Inf]" = "Humid")

jan85_day$cat.AI <- jan85_day$AI %>% cut(breaks = breaks.unesco) %>%  revalue(cat.unesco)

jan85_ref <- jan85_day %>% group_by(lon,lat,lm, Continent, Type, Name, Acronym, z) %>% summarise(AI = mean(AI, na.rm = T), ET0 = mean(ET0, na.rm = T), mpr = mean(mpr, na.rm = T))
jan85_ref$cat.AI <- jan85_ref$AI %>% cut(breaks = breaks.unesco) %>% revalue(cat.unesco)

write.table(jan85_ref, "ERA5/jan85_ref.txt")
```

```{r jan1985-avg}
jan85_avg <- jan85_day %>% filter(lm != 0) %>% group_by(lon,lat,lm, Continent, Type, Name, Acronym, z) %>% 
                summarise(mpr = mean(mpr, na.rm = T), t2m = mean(t2m, na.rm = T), tdew = mean(tdew, na.rm = T), 
                          wind = mean(wind, na.rm = T), msshf = mean(msshf, na.rm = T), mslhf = mean(mslhf, na.rm = T)) %>%
                 mutate(Rn = - (msshf + mslhf) * 86400 * 1e-6, #In W/m2, converted to MJ/m2/day
                        P = 101.3 * ((293-0.0065*z)/293)^(5.26),
                        ea = 0.61078*exp(17.27*(tdew-273.15)/((tdew-273.15)+237.3)), # Tetens 1930
                        es = 0.61078*exp(17.27*(t2m-273.15)/((t2m-273.15)+237.3)),
                        delta = 4098*es/((t2m-273.15)+237.3)^2,
                        gamma = 0.00163*P/(2.501-52.6361e-3*(t2m-273.15)),
                        ET0 = (0.408*delta*Rn+gamma*900/((t2m-273.15)+273)*0.748*wind*(es-ea))/(delta+gamma*(1+0.34*0.748*wind)),
                        AI = (mpr*60*60*24)/ET0) 

breaks.unesco <- c(-0.03,0.03,0.2,0.5,0.65,Inf)
cat.unesco <- c("(-0.03,0.03]"= "Hyperarid", "(0.03,0.2]" = "Arid", "(0.2,0.5]" = "Semi-arid", "(0.5,0.65]" = "Dry subhumid","(0.65,Inf]" = "Humid")

jan85_avg$cat.AI <- jan85_avg$AI %>% cut(breaks = breaks.unesco) %>%  revalue(cat.unesco)

write.table(jan85_avg, "ERA5/jan85_avg.txt")
```

```{r compare-jan1985}
jan85_ref <- read.table("ERA5/jan85_ref.txt")
jan85_avg <- read.table("ERA5/jan85_avg.txt")
colorvec <- brewer.pal(n = 11, name ="RdYlBu")

col.cat <- c("Hyperarid" = colorvec[2], "Arid"= colorvec[4],"Semi-arid"= colorvec[5], "Dry subhumid" = colorvec[8], "Humid"= colorvec[10])

jan85_all <- merge(jan85_ref, select(jan85_avg, names(jan85_ref)), by = c("lon","lat","lm","Continent","Type","Name","Acronym","z"))

ggplot(jan85_all) + geom_tile(aes(x=lon, y = lat,  fill = cat.AI.x))+
  scale_fill_manual(values = col.cat)+
  theme_void()+
  theme(legend.position = "bottom")

ggplot(jan85_all) + geom_tile(aes(x=lon, y = lat,  fill = cat.AI.y))+
  scale_fill_manual(values = col.cat)+
  theme_void()+
  theme(legend.position = "bottom")

ggplot(data = jan85_all, aes(x = ET0.x, y = ET0.y))+geom_point(aes(col = cat.AI.x))+
  stat_poly_eq(label.x = "right", label.y = "bottom")+
  geom_abline(slope = 1, intercept = 0)+
  labs(x = "ET0 as mean(ET0_i)", y = "ET0 as ET0_avg")+
  scale_color_manual(values = col.cat) + theme_minimal()

ggplot(data = jan85_all, aes(x = ET0.x, y = ET0.y))+geom_point(aes(col = cat.AI.x))+
     stat_poly_eq(label.x = "right", label.y = "bottom")+
     annotate(x = 2, y = 8, geom = "label", label = paste("r = ", round(cor(jan85_all$ET0.x, jan85_all$ET0.y, use = "pairwise.complete"),4)))+
     geom_abline(slope = 1, intercept = 0)+
     labs(x = "ET0 as mean(ET0_i)", y = "ET0 as ET0_avg", title = "ET0 for january 1985", col = "")+
     scale_color_manual(values = col.cat) + theme_minimal()

ggplot(data = jan85_all, aes(x = mpr.x, y = mpr.y))+geom_point(aes(col = cat.AI.x))+
  stat_poly_eq(label.x = "right", label.y = "bottom")+
  geom_abline(slope = 1, intercept = 0)+
  labs(x = "pr as mean(pr_i)", y = "PR as pr_avg")+
  scale_color_manual(values = col.cat) + theme_minimal()

ggplot(jan85_all, aes(x = AI.x, y = AI.y))+geom_point(aes(col = cat.AI.x))+
  geom_abline(slope = 1, intercept = 0)+
  stat_poly_eq()+
  labs(x = "AI as mean(P/ET0)", y = "AI as mean(P)/mean(ET)")+
  lims(x = c(-1, 5), y = c(-1,5))+
  scale_color_manual(values = col.cat) + theme_minimal()



ggplot(subset(jan85_all, lm ==1)) + geom_tile(aes(x=lon, y = lat,  fill = ET0.y - ET0.x))+
  scale_fill_continuous_divergingx(palette = "RdYlBu", mid = 0, rev = T, name = "Diff ET0_avg - ET0_ref")+
  theme_void()+
  theme(legend.position = "bottom")

ggplot(subset(jan85_all, lat < 50 & lat > -50), aes(x = AI.x, y = AI.y))+geom_point(aes(col = lat), alpha = 0.5, shape = 1)+
  geom_abline(slope = 1, intercept = 0)+
  stat_poly_eq()+
  scale_color_continuous_divergingx(palette = "RdYlBu", mid = 0, rev = T, name = "latitude")+
  labs(x = "AI as mean(P/ET0)", y = "AI as mean(P)/mean(ET)")+ theme_minimal()

ggplot(jan85_all) + geom_boxplot(aes(x = "AI as mean(P/ET)", y = AI.x)) + geom_boxplot(aes(x = "AI as mean(P)/mean(ET)", y = AI.y))

ggplot(jan85_all) + geom_boxplot(aes(x = "AI as mean(P/ET)", y = AI.x)) + geom_boxplot(aes(x = "AI as mean(P)/mean(ET)", y = AI.y)) + ylim(-2.5e4, 5e4)

ggplot()+geom_boxplot(data = subset(jan85_all, AI.x > 0), aes(x="AI.x", y = AI.x))+
  geom_boxplot(data = subset(jan85_all, AI.x < 0), aes(x="AI.x", y = abs(AI.x)))+
  geom_boxplot(data = subset(jan85_all, AI.y > 0), aes(x="AI.y", y = AI.y))+
  geom_boxplot(data = subset(jan85_all, AI.y < 0), aes(x="AI.y", y = abs(AI.y)))+
  scale_y_continuous(trans = "log10")+
  theme_minimal()
```

## March 2023

```{r test-daily-mean-23, eval = F}

mprm <- data.frame(lon = NA, lat = NA, mpr = NA, month = NA)
t2mm <- data.frame(lon = NA, lat = NA, t2m = NA, month = NA)
tdewm <- data.frame(lon = NA, lat = NA, tdew = NA, month = NA)
uwindm <- data.frame(lon = NA, lat = NA, uwind = NA, month = NA)
vwindm <- data.frame(lon = NA, lat = NA, vwind = NA, month = NA)
mslhfm <- data.frame(lon = NA, lat = NA, mslhf = NA, month = NA)
msshfm <- data.frame(lon = NA, lat = NA, msshf = NA, month = NA)

for(i in 1:31){
  
mpr <- raster("ERA5/march2023/pr.nc", band = i) %>%
  raster::rotate() %>% projectRaster(land_mask) %>%
  as.data.frame(xy = T) %>% setNames(c("lon","lat","mpr")) %>%
  mutate(month = i)

mprm <<- rbind(mprm, mpr)

t2m <- raster("ERA5/march2023/t2m.nc", band = i) %>%
  raster::rotate() %>%
  aggregate(fact = 4, fun = mean) %>%
  projectRaster(land_mask) %>%
  as.data.frame(xy = T) %>% setNames(c("lon","lat","t2m")) %>%
  mutate(month = i)

t2mm <<- rbind(t2mm, t2m)

tdew <- raster("ERA5/march2023/d2m.nc", band = i)  %>% 
  raster::rotate() %>%
  aggregate(fact = 4, fun = mean) %>%
  projectRaster(land_mask) %>%
  as.data.frame(xy = T) %>% setNames(c("lon","lat","tdew")) %>%
  mutate(month = i)

tdewm <- rbind(tdewm, tdew)

uwind <- raster("ERA5/march2023/10m-u-wind.nc", band = i) %>%
  raster::rotate() %>%
  aggregate(fact = 4, fun = mean) %>%
  projectRaster(land_mask) %>%
  as.data.frame(xy = T) %>% 
  setNames(c("lon","lat","uwind")) %>%
  mutate(month = i)# m/s

uwindm <<- rbind(uwindm, uwind) 

vwind <- raster("ERA5/march2023/10m-v-wind.nc", band = i) %>%
  raster::rotate() %>%
  aggregate(fact = 4, fun = mean) %>%
  projectRaster(land_mask) %>%
  as.data.frame(xy = T) %>% 
  setNames(c("lon","lat","vwind")) %>%
  mutate(month = i)# m/s

vwindm <<- rbind(vwindm, vwind) 

mslhf <- raster("ERA5/march2023/mslhf.nc", band = i) %>%
  raster::rotate() %>%
  aggregate(fact = 4, fun = mean) %>% 
  projectRaster(land_mask) %>% 
  as.data.frame(xy = T) %>% setNames(c("lon","lat","mslhf")) %>%
  mutate(month = i)

mslhfm <<- rbind(mslhfm, mslhf)

msshf <- raster("ERA5/march2023/msshf.nc", band = i) %>%
  raster::rotate() %>% 
  aggregate(fact = 4, fun = mean) %>%
  projectRaster(land_mask) %>%
  as.data.frame(xy = T) %>% setNames(c("lon","lat","msshf"))  %>%
  mutate(month = i)

msshfm <<- rbind(msshfm, msshf)
}


mar2023 <- merge(mprm, t2mm, by = c("lon","lat","month")) %>% merge(tdewm, by = c("lon","lat","month"))  %>% merge(uwindm, by = c("lon","lat","month"))%>% merge(vwindm, by = c("lon","lat","month")) %>% 
  merge(mslhfm, by = c("lon","lat","month")) %>% merge(msshfm, by = c("lon","lat","month")) %>% 
  merge(land_mask.df, by = c("lon","lat")) %>%
  merge(ipcc_regions.df, by = c("lon","lat")) %>%
  merge(elev.df, by = c("lon","lat"))

write.table(mar2023, "ERA5/march2023/mar2023.txt")
```

```{r mar2023-ref}
mar2023 <- read.table("ERA5/march2023/mar2023.txt")
mar23_day <- mar2023 %>% filter(lm != 0) %>% mutate(Rn = - (msshf + mslhf) * 86400 * 1e-6, #In W/m2, converted to MJ/m2/day
                        wind = sqrt(uwind^2+vwind^2), #make wind from u and v components                                
                        P = 101.3 * ((293-0.0065*z)/293)^(5.26),
                        ea = 0.61078*exp(17.27*(tdew-273.15)/((tdew-273.15)+237.3)), # Tetens 1930
                        es = 0.61078*exp(17.27*(t2m-273.15)/((t2m-273.15)+237.3)),
                        delta = 4098*es/((t2m-273.15)+237.3)^2,
                        gamma = 0.00163*P/(2.501-52.6361e-3*(t2m-273.15)),
                        ET0 = (0.408*delta*Rn+gamma*900/((t2m-273.15)+273)*0.748*wind*(es-ea))/(delta+gamma*(1+0.34*0.748*wind)),
                        AI = (mpr*60*60*24)/ET0)

breaks.unesco <- c(-0.03,0.03,0.2,0.5,0.65,Inf)
cat.unesco <- c("(-0.03,0.03]"= "Hyperarid", "(0.03,0.2]" = "Arid", "(0.2,0.5]" = "Semi-arid", "(0.5,0.65]" = "Dry subhumid","(0.65,Inf]" = "Humid")

mar23_day$cat.AI <- mar23_day$AI %>% cut(breaks = breaks.unesco) %>%  revalue(cat.unesco)

mar23_ref <- mar23_day %>% group_by(lon,lat,lm, Continent, Type, Name, Acronym, z) %>% summarise(AI = mean(AI, na.rm = T), ET0 = mean(ET0, na.rm = T), mpr = mean(mpr, na.rm = T))
mar23_ref$cat.AI <- mar23_ref$AI %>% cut(breaks = breaks.unesco) %>% revalue(cat.unesco)

write.table(mar23_ref, "ERA5/mar23_ref.txt")
```

```{r mar2023-avg}
mar23_avg <- mar23_day %>% filter(lm != 0) %>% group_by(lon,lat,lm, Continent, Type, Name, Acronym, z) %>% 
                summarise(mpr = mean(mpr, na.rm = T), t2m = mean(t2m, na.rm = T), tdew = mean(tdew, na.rm = T), 
                          wind = mean(wind, na.rm = T), msshf = mean(msshf, na.rm = T), mslhf = mean(mslhf, na.rm = T)) %>%
                 mutate(Rn = - (msshf + mslhf) * 86400 * 1e-6, #In W/m2, converted to MJ/m2/day
                        P = 101.3 * ((293-0.0065*z)/293)^(5.26),
                        ea = 0.61078*exp(17.27*(tdew-273.15)/((tdew-273.15)+237.3)), # Tetens 1930
                        es = 0.61078*exp(17.27*(t2m-273.15)/((t2m-273.15)+237.3)),
                        delta = 4098*es/((t2m-273.15)+237.3)^2,
                        gamma = 0.00163*P/(2.501-52.6361e-3*(t2m-273.15)),
                        ET0 = (0.408*delta*Rn+gamma*900/((t2m-273.15)+273)*0.748*wind*(es-ea))/(delta+gamma*(1+0.34*0.748*wind)),
                        AI = (mpr*60*60*24)/ET0) 

breaks.unesco <- c(-0.03,0.03,0.2,0.5,0.65,Inf)
cat.unesco <- c("(-0.03,0.03]"= "Hyperarid", "(0.03,0.2]" = "Arid", "(0.2,0.5]" = "Semi-arid", "(0.5,0.65]" = "Dry subhumid","(0.65,Inf]" = "Humid")

mar23_avg$cat.AI <- mar23_avg$AI %>% cut(breaks = breaks.unesco) %>%  revalue(cat.unesco)

write.table(mar23_avg, "ERA5/march2023/mar23_avg.txt")
```

```{r compare-mar2023}

colorvec <- brewer.pal(n = 11, name ="RdYlBu")

col.cat <- c("Hyperarid" = colorvec[2], "Arid"= colorvec[4],"Semi-arid"= colorvec[5], "Dry subhumid" = colorvec[8], "Humid"= colorvec[10])

mar23_all <- merge(mar23_ref, select(mar23_avg, names(mar23_ref)), by = c("lon","lat","lm","Continent","Type","Name","Acronym","z"))

ggplot(mar23_all) + geom_tile(aes(x=lon, y = lat,  fill = cat.AI.x))+
  scale_fill_manual(values = col.cat)+
  theme_void()+
  theme(legend.position = "bottom")

ggplot(mar23_all) + geom_tile(aes(x=lon, y = lat,  fill = cat.AI.y))+
  scale_fill_manual(values = col.cat)+
  theme_void()+
  theme(legend.position = "bottom")

ggplot(data = mar23_all, aes(x = ET0.x, y = ET0.y))+geom_point(aes(col = cat.AI.x))+
     stat_poly_eq(label.x = "right", label.y = "bottom")+
     annotate(x = 2, y = 8, geom = "label", label = paste("r = ", round(cor(mar23_all$ET0.x, mar23_all$ET0.y, use = "pairwise.complete"),3)))+
     geom_abline(slope = 1, intercept = 0)+
     labs(x = "ET0 as mean(ET0_i)", y = "ET0 as ET0_avg", title = "ET0 for march 2023", col = "")+
     scale_color_manual(values = col.cat) + theme_minimal()

ggplot(data = mar23_all, aes(x = mpr.x, y = mpr.y))+geom_point(aes(col = cat.AI.x))+
  stat_poly_eq(label.x = "right", label.y = "bottom")+
  geom_abline(slope = 1, intercept = 0)+
  labs(x = "pr as mean(pr_i)", y = "PR as pr_avg")+
  scale_color_manual(values = col.cat) + theme_minimal()

ggplot(mar23_all, aes(x = AI.x, y = AI.y))+geom_point(aes(col = cat.AI.x))+
  geom_abline(slope = 1, intercept = 0)+
  stat_poly_eq()+
  labs(x = "AI as mean(P/ET0)", y = "AI as mean(P)/mean(ET)")+
  lims(x = c(-1, 5), y = c(-1,5))+
  scale_color_manual(values = col.cat) + theme_minimal()



ggplot(subset(mar23_all, lm ==1)) + geom_tile(aes(x=lon, y = lat,  fill = ET0.y - ET0.x))+
  scale_fill_continuous_divergingx(palette = "RdYlBu", mid = 0, rev = T, name = "Diff ET0_avg - ET0_ref")+
  theme_void()+
  theme(legend.position = "bottom")

ggplot(subset(mar23_all, lat < 50 & lat > -50), aes(x = AI.x, y = AI.y))+geom_point(aes(col = lat), alpha = 0.5, shape = 1)+
  geom_abline(slope = 1, intercept = 0)+
  stat_poly_eq()+
  scale_color_continuous_divergingx(palette = "RdYlBu", mid = 0, rev = T, name = "latitude")+
  labs(x = "AI as mean(P/ET0)", y = "AI as mean(P)/mean(ET)")+ theme_minimal()

ggplot(mar23_all) + geom_boxplot(aes(x = "AI as mean(P/ET)", y = AI.x)) + geom_boxplot(aes(x = "AI as mean(P)/mean(ET)", y = AI.y))

ggplot(mar23_all) + geom_boxplot(aes(x = "AI as mean(P/ET)", y = AI.x)) + geom_boxplot(aes(x = "AI as mean(P)/mean(ET)", y = AI.y)) + ylim(-2.5e4, 5e4)

ggplot()+geom_boxplot(data = subset(mar23_all, AI.x > 0), aes(x="AI.x", y = AI.x))+
  geom_boxplot(data = subset(mar23_all, AI.x < 0), aes(x="AI.x", y = abs(AI.x)))+
  geom_boxplot(data = subset(mar23_all, AI.y > 0), aes(x="AI.y", y = AI.y))+
  geom_boxplot(data = subset(mar23_all, AI.y < 0), aes(x="AI.y", y = abs(AI.y)))+
  scale_y_continuous(trans = "log10")+
  theme_minimal()
```


```{r exit}
knitr::knit_exit()
```

## Rn is latent + sensible heat flux, tmin used as tdew

```{r aridity-index-Rn, eval = F}
era5 <- read.table("era5.txt")

era5$Rn <- with(era5, -(msshf + mslhf)) * 86400 * 1e-6 # Rn is actually Rn - G, the sum of sensible and latent heat fluxes. In W/m2, converted to MJ/m2/day
era5$P <- with(era5, 101.3 * ((293-0.0065*z)/293)^(5.26))

era5$ea <- with(era5, 0.61078*exp(17.27*(tas_min-273.15)/((tas_min-273.15)+237.3))) # Tetens 1930

era5$es <- with(era5, 0.61078*exp(17.27*(tas-273.15)/((tas-273.15)+237.3)))


era5$delta <- with(era5, 4098*es/((tas-273.15)+237.3)^2) #slope vapor pressure

era5$gamma <- with(era5, 0.00163*P/(2.501-52.6361e-3*(tas-273.15))) #psychrometric constant

                      
era5$ET0 <-with(era5,               
                ((0.408*delta*Rn+gamma*900/((tas-273.15)+273)*0.748*sfcWind*(es-ea))/(delta+gamma*(1+0.34*0.748*sfcWind))))
# Wind speed at 10 m is converted to wind speed at 2 m by multiplying by 0.748

era5$AI <- with(era5, mpr*60*60*24/(ET0))

breaks.unesco <- c(-0.03,0.03,0.2,0.5,0.65,Inf)
cat.unesco <- c("(-0.03,0.03]"= "Hyperarid", "(0.03,0.2]" = "Arid", "(0.2,0.5]" = "Semi-arid", "(0.5,0.65]" = "Dry subhumid","(0.65,Inf]" = "Humid")

era5$cat.AI <- era5$AI %>% cut(breaks = breaks.unesco) %>% 
  revalue(cat.unesco)

ggplot() + geom_raster(data = era5, aes(x=lon, y = lat,  fill = cat.AI))+
  scale_fill_manual(values = col.cat)+
  theme_void()+
  theme(legend.position = "bottom")

ggplot(subset(era5, Name == "Mediterranean")) + geom_raster(aes(x=lon, y = lat,  fill = AI))+
    scale_fill_continuous_divergingx(palette = "RdYlBu", rev = F, mid = 0, limits = c(0,10))+
    theme_void()+
    theme(legend.position = "bottom")

cowplot::plot_grid(plotlist = list(
    eraplot("tas"),
    eraplot("mpr"),
    eraplot("ea"),
    eraplot("Rn")
))
```
 
 
## Rn is the sum of net shortwave and net longwave radiation
 
```{r aridity-index-Rns}
era5 <- read.table("era5.txt")

era5$Rn <- with(era5, (msr + mlr)) * 86400 * 1e-6 # Rn is the sum of net shortwave and net longwave radiation. G considered insignificant. In W/m2, converted to MJ/m2/day


era5$P <- with(era5, 101.3 * ((293-0.0065*z)/293)^(5.26))

era5$ea <- with(era5, 0.61078*exp(17.27*(tdew-273.15)/((tdew-273.15)+237.3))) # Tetens 1930
era5$es <- with(era5, 0.61078*exp(17.27*(tas-273.15)/((tas-273.15)+237.3)))

era5$delta <- with(era5, 4098*es/((tas-273.15)+237.3)^2) #slope vapor pressure

era5$gamma <- with(era5, 0.00163*P/(2.501-52.6361e-3*(tas-273.15))) #psychrometric constant

era5$ET0 <-with(era5,               
                ((0.408*delta*Rn+gamma*900/((tas-273.15)+273)*0.748*sfcWind*(es-ea))/(delta+gamma*(1+0.34*0.748*sfcWind))))
# Wind speed at 10 m is converted to wind speed at 2 m by multiplying by 0.748

era5$AI <- with(era5, mpr*60*60*24/(ET0))

breaks.unesco <- c(-0.03,0.03,0.2,0.5,0.65,Inf)
cat.unesco <- c("(-0.03,0.03]"= "Hyperarid", "(0.03,0.2]" = "Arid", "(0.2,0.5]" = "Semi-arid", "(0.5,0.65]" = "Dry subhumid","(0.65,Inf]" = "Humid")

era5$cat.AI <- era5$AI %>% cut(breaks = breaks.unesco) %>% 
  revalue(cat.unesco)

ggplot() + geom_raster(data = era5, aes(x=lon, y = lat,  fill = cat.AI))+
  scale_fill_manual(values = col.cat)+
  theme_void()+
  theme(legend.position = "bottom")

ggplot(subset(era5, Name == "Mediterranean")) + geom_raster(aes(x=lon, y = lat,  fill = AI))+
    scale_fill_continuous_divergingx(palette = "RdYlBu", rev = F, mid = 0, limits = c(0,4))+
    theme_void()+
    theme(legend.position = "bottom")

cowplot::plot_grid(plotlist = list(
    eraplot("tas"),
    eraplot("mpr"),
    eraplot("ea"),
    eraplot("Rn")
))

```

## Rn is only net downwards shortwave radiation
 
```{r aridity-index-ssrd}
era5 <- read.table("era5.txt")

era5$Rn <- with(era5, ssrd / 86400 * 86400 * 1e-6) # Rn is the sum of net shortwave and net longwave radiation. G considered insignificant. From J/m2 to W/m2 to MJ/m2/day


era5$P <- with(era5, 101.3 * ((293-0.0065*z)/293)^(5.26))

era5$ea <- with(era5, 0.61078*exp(17.27*(tdew-273.15)/((tdew-273.15)+237.3))) # Tetens 1930
era5$es <- with(era5, 0.61078*exp(17.27*(tas-273.15)/((tas-273.15)+237.3)))

era5$delta <- with(era5, 4098*es/((tas-273.15)+237.3)^2) #slope vapor pressure

era5$gamma <- with(era5, 0.00163*P/(2.501-52.6361e-3*(tas-273.15))) #psychrometric constant

era5$ET0 <-with(era5,               
                ((0.408*delta*Rn+gamma*900/((tas-273.15)+273)*0.748*sfcWind*(es-ea))/(delta+gamma*(1+0.34*0.748*sfcWind))))
# Wind speed at 10 m is converted to wind speed at 2 m by multiplying by 0.748

era5$AI <- with(era5, mpr*60*60*24/(ET0))

breaks.unesco <- c(-0.03,0.03,0.2,0.5,0.65,Inf)
cat.unesco <- c("(-0.03,0.03]"= "Hyperarid", "(0.03,0.2]" = "Arid", "(0.2,0.5]" = "Semi-arid", "(0.5,0.65]" = "Dry subhumid","(0.65,Inf]" = "Humid")

era5$cat.AI <- era5$AI %>% cut(breaks = breaks.unesco) %>% 
  revalue(cat.unesco)

ggplot() + geom_raster(data = era5, aes(x=lon, y = lat,  fill = cat.AI))+
  scale_fill_manual(values = col.cat)+
  theme_void()+
  theme(legend.position = "bottom")

```
,
## AI computed from potential evaporation in ERA5 

```{r aridity-index-mpevap}
era5$AIpvp <- with(era5, - mpr/mpevap)

breaks.unesco <- c(-Inf,0.03,0.2,0.5,0.65,Inf)
cat.unesco <- c("(-Inf,0.03]"= "Hyperarid", "(0.03,0.2]" = "Arid", "(0.2,0.5]" = "Semi-arid", "(0.5,0.65]" = "Dry subhumid","(0.65, Inf]" = "Humid")

era5$cat.AIpvp <- era5$AIpvp %>% cut(breaks = breaks.unesco) %>% 
  revalue(cat.unesco)

ggplot() + geom_raster(data = era5, aes(x=lon, y = lat,  fill = cat.AIpvp))+
  scale_fill_manual(values = col.cat)+
  theme_void()+
  theme(legend.position = "bottom")
```


