---
title: "wdc"
author: "Camille"
date: "2024-02-16"
output: 
  html_document:
    toc: true
    toc_float: true
    number_sections: true
    code_folding: hide
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = F, warning = F, error = F, fig.align = "center", collapse = T)
```

```{r libraries}
library(geodata)

library(ggplot2)
library(raster)

library(plyr)
library(dplyr)

library(RColorBrewer)

```
# Worldclim: réanalyse pour la période 1970-2000 -----

```{r dowload-wdc, eval = F}

worldclim_global(var = "prec", res = 10, path = ".")
worldclim_global(var = "tavg", res = 10, path = ".")
worldclim_global(var = "tmin", res = 10, path = ".")
worldclim_global(var = "tmax", res = 10, path = ".")
worldclim_global(var = "srad", res = 10, path = ".")
worldclim_global(var = "vapr", res = 10, path = ".")
worldclim_global(var = "elev", res = 10, path = ".")
worldclim_global(var = "wind", res = 10, path = ".")
worldclim_global(var = "bio", res = 10, path = ".")

```

```{r land-masks}
land_mask <- raster("Masks/land_sea_mask_1degree.nc4") 
land_mask.df <- as.data.frame(land_mask, xy = T) %>% setNames(c("lon","lat","lm")) # 0 if ocean, 1 if land


elev <- raster("Worldclim/wc2.1_10m/wc2.1_10m_elev.tif") 
elev.df <- elev %>% projectRaster(to = land_mask) %>% as.data.frame(xy = T) %>% setNames(c("lon","lat", "z"))


ipcc_regions <- shapefile("Masks/IPCC-WGI-reference-regions-v4.shp") %>% spTransform(crs("EPSG:4326")) 
ipcc_regions.raster <- ipcc_regions %>% rasterize(land_mask)
ipcc_regions.df <- as.data.frame(ipcc_regions.raster, xy = T) %>% setNames(c("lon","lat","Continent","Type","Name","Acronym"))
```

```{r create-wdc}
wdct <- raster("Worldclim/wc2.1_10m/wc2.1_10m_bio_1.tif") %>% 
  projectRaster(to = land_mask) %>% 
  as.data.frame(xy = T) %>% setNames(c("lon","lat","tas"))

list.tmin <- list.files(path = "Worldclim/wc2.1_10m", pattern = "wc2.1_10m_tmin_", full.names = T) 
wdctmin <- raster::stack(list.tmin) %>% 
  projectRaster(to = land_mask) %>% 
  as.data.frame(xy = T) %>%
  setNames(c("lon","lat","tmin_01","tmin_02","tmin_03","tmin_04","tmin_05","tmin_06","tmin_07","tmin_08","tmin_09","tmin_10","tmin_11","tmin_12"))

list.tmax <- list.files(path = "Worldclim/wc2.1_10m", pattern = "wc2.1_10m_tmax_", full.names = T) 
wdctmax <- raster::stack(list.tmax) %>% 
  projectRaster(to = land_mask) %>% 
  as.data.frame(xy = T) %>%
  setNames(c("lon","lat","tmax_01","tmax_02","tmax_03","tmax_04","tmax_05","tmax_06","tmax_07","tmax_08","tmax_09","tmax_10","tmax_11","tmax_12"))

list.tavg <- list.files(path = "Worldclim/wc2.1_10m", pattern = "wc2.1_10m_tavg_", full.names = T) 
wdctm <- raster::stack(list.tavg) %>% 
  projectRaster(to = land_mask) %>% 
  as.data.frame(xy = T) %>% setNames(c("lon","lat","tas_01","tas_02","tas_03","tas_04","tas_05","tas_06","tas_07","tas_08","tas_09","tas_10","tas_11","tas_12"))

wdcp <- raster("Worldclim/wc2.1_10m/wc2.1_10m_bio_12.tif") %>%
  projectRaster(to = land_mask) %>% 
  as.data.frame(xy = T) %>% setNames(c("lon","lat","pr"))

list.wind <- list.files(path = "Worldclim/wc2.1_10m/", pattern = "wc2.1_10m_wind", full.names = TRUE)
wdcw <- raster::stack(list.wind) %>% mean(na.rm = T) %>% 
  projectRaster(to = land_mask) %>% 
  as.data.frame(xy = T) %>% setNames(c("lon","lat","sfcWind"))

list.srad <- list.files(path = "Worldclim/wc2.1_10m/", pattern = "wc2.1_10m_srad", full.names = TRUE) # unit: kJ/m2/day. Consider that solar radiation constitute the only component of Rn (surface energy balance)
wdcr <- raster::stack(list.srad) %>% mean(na.rm = T) %>% 
  projectRaster(to = land_mask) %>% 
  as.data.frame(xy = T) %>% setNames(c("lon","lat","srad"))

list.vapr <- list.files(path = "Worldclim/wc2.1_10m/", pattern = "wc2.1_10m_vapr", full.names = TRUE) # unit: kJ/m2/day. Consider that solar radiation constitute the only component of Rn (surface energy balance)
wdcv <- raster::stack(list.vapr) %>% mean(na.rm = T) %>% 
  projectRaster(to = land_mask) %>% 
  as.data.frame(xy = T) %>% setNames(c("lon","lat","vapr"))


wdc <- wdct %>% 
  merge(wdctm, by = c("lon", "lat")) %>%
  merge(wdctmin, by = c("lon", "lat")) %>%
  merge(wdctmax, by = c("lon", "lat")) %>%
  merge(wdcp, by = c("lon", "lat")) %>%
  merge(wdcr, by = c("lon", "lat")) %>%
  merge(wdcw, by = c("lon", "lat")) %>%
  merge(wdcv, by = c("lon", "lat")) %>%
  mutate(model = "historical", period = "1970_2000", source = "Worldclim") %>%
  merge(land_mask.df, by = c("lon", "lat")) %>%
  merge(ipcc_regions.df, by = c("lon", "lat")) %>% 
  merge(elev.df, by = c("lon","lat")) %>%
  filter(lm == 1)

wdc$tmin <- apply(select(wdc,c("tmin_01", "tmin_02", "tmin_03", "tmin_04", "tmin_05", "tmin_06", "tmin_07", "tmin_08", "tmin_09", "tmin_10", "tmin_11", "tmin_12")), 1, FUN = mean, na.rm = T)

wdc$tmax <- apply(select(wdc,c("tmax_01", "tmax_02", "tmax_03", "tmax_04", "tmax_05", "tmax_06", "tmax_07", "tmax_08", "tmax_09", "tmax_10", "tmax_11", "tmax_12")), 1, FUN = mean, na.rm = T)

write.table(wdc,"wdc.txt")
```

# Aridity

```{r colors}
#display.brewer.pal(n = 11, name ="RdYlBu")
colorvec <- brewer.pal(n = 11, name ="RdYlBu")

col.martonne <- c("Desert" = colorvec[2], "Arid"= colorvec[4],"Semi-arid"= colorvec[5], "Temperate" = colorvec[8], "Humid"= colorvec[10],"Forest"= colorvec[11])
col.cat <- c("Hyperarid" = colorvec[2], "Arid"= colorvec[4],"Semi-arid"= colorvec[5], "Dry subhumid" = colorvec[8], "Humid"= colorvec[10])
```

# De Martonne Aridity Index

```{r aridity-index-martonne}

# Martonne
wdc$AIm <- with(wdc,pr/(tas+10)) # convert pr to mm/y, tas to Ceslsius
breaks.martonne <- c(0,5,10,20,"30","40",Inf)
cat.martonne <- c("[0,5]" = "Desert", "(5,10]"= "Arid", "(10,20]" = "Semi-arid","(20,30]" = "Temperate", "(30,40]" = "Humid", "(40,Inf]" = "Forest")

wdc$cat.AIm <- wdc$AIm %>% cut(breaks.martonne, include.lowest = T) %>% revalue(cat.martonne)

ggplot() + geom_raster(data = wdc, aes(x=lon, y = lat,  fill = cat.AIm))+
  scale_fill_manual(values = col.martonne)+
  theme_void()+
  theme(legend.position = "bottom")
```

## FAO Aridity index


### ea calculated from tmin

```{r aridity-index}
wdc$Rn <- with(wdc, srad * 1e-3)  # conversion from kJ/m2/day to MJ/m2/day
wdc$P <- with(wdc, 101.3 * ((293-0.0065*z)/293)^(5.26))

wdc$ea <- with(wdc, 0.61078*exp(17.27*(tmin)/((tmin)+237.3))) # Tetens 1930

#wdc$ea <- with(wdc, vapr)

wdc$es <- with(wdc, 0.61078*exp(17.27*(tas)/((tas)+237.3)))


wdc$delta <- with(wdc, 4098*es/((tas)+237.3)^2) #slope vapor pressure

wdc$gamma <- with(wdc, 0.00163*P/(2.501-52.6361e-3*(tas))) #psychrometric constant

                      
wdc$ET0 <-with(wdc,               
                ((0.408*delta*Rn+gamma*900/((tas)+273)*0.748*sfcWind*(es-ea))/(delta+gamma*(1+0.34*0.748*sfcWind))))
# Wind speed at 10 m is converted to wind speed at 2 m by multiplying by 0.748

wdc$AI <- with(wdc, pr/(ET0*365))

breaks.unesco <- c(-0,0.03,0.2,0.5,0.65,Inf)
cat.unesco <- c("(0,0.03]"= "Hyperarid", "(0.03,0.2]" = "Arid", "(0.2,0.5]" = "Semi-arid", "(0.5,0.65]" = "Dry subhumid","(0.65,Inf]" = "Humid")

wdc$cat.AI <- wdc$AI %>% cut(breaks = breaks.unesco) %>% 
  revalue(cat.unesco)

write.table(wdc, "wdc_AI.txt")

ggplot() + geom_raster(data = wdc, aes(x=lon, y = lat,  fill = cat.AI))+
  scale_fill_manual(values = col.cat)+
  theme_void()+
  theme(legend.position = "bottom")
```

### ea calculated from vapr

```{r aridity-index-vapr}
wdc$Rn <- with(wdc, srad * 1e-3)  # conversion from kJ/m2/day to MJ/m2/day
wdc$P <- with(wdc, 101.3 * ((293-0.0065*z)/293)^(5.26))

#wdc$ea <- with(wdc, 0.61078*exp(17.27*(tmin)/((tmin)+237.3))) # Tetens 1930

wdc$ea <- with(wdc, vapr)

wdc$es <- with(wdc, 0.61078*exp(17.27*(tas)/((tas)+237.3)))


wdc$delta <- with(wdc, 4098*es/((tas)+237.3)^2) #slope vapor pressure

wdc$gamma <- with(wdc, 0.00163*P/(2.501-52.6361e-3*(tas))) #psychrometric constant

                      
wdc$ET0 <-with(wdc,               
                ((0.408*delta*Rn+gamma*900/((tas)+273)*0.748*sfcWind*(es-ea))/(delta+gamma*(1+0.34*0.748*sfcWind))))
# Wind speed at 10 m is converted to wind speed at 2 m by multiplying by 0.748

wdc$AI <- with(wdc, pr/(ET0*365))

breaks.unesco <- c(0,0.03,0.2,0.5,0.65,Inf)
cat.unesco <- c("(0,0.03]"= "Hyperarid", "(0.03,0.2]" = "Arid", "(0.2,0.5]" = "Semi-arid", "(0.5,0.65]" = "Dry subhumid","(0.65,Inf]" = "Humid")

wdc$cat.AI <- wdc$AI %>% cut(breaks = breaks.unesco) %>% 
  revalue(cat.unesco)

ggplot() + geom_raster(data = wdc, aes(x=lon, y = lat,  fill = cat.AI))+
 # geom_raster(data = subset(wdc, Rn < 0), aes(x=lon, y = lat), fill = "gray20")+
  scale_fill_manual(values = col.cat)+
  theme_void()+
  theme(legend.position = "bottom")
```