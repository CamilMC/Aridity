---
title: "Visualisation awi"
output: 
  html_document:
    toc: true
    toc_float: true
    number_sections: true
    code_folding: hide
date: "2023-12-17"
bibliography: AI.bib
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = F, warning = F, error = F, fig.align = "center", collapse = T)
```

```{r libraries}
library(raster)

library(plyr)
library(dplyr)

library(ggplot2)
library(viridisLite)
library(colorspace)
library(RColorBrewer)

library(sf)
library(stringr)

#display.brewer.pal(n = 11, name ="RdYlBu")
colorvec <- brewer.pal(n = 11, name ="RdYlBu")
```

# Data

CMIP6

For solar radiation: to do well I should use the balance between:
11 - surface_downwelling_longwave_flux_in_air rlds in W m-2
12 - surface_upwelling_longwave_flux_in_air rlus W m-2
13 - surface_downwelling_shortwave_flux_in_air rsds W m-2
14 - surface_upwelling_shortwave_flux_in_air rsus W m-2

and for G (neglected here)

9 surface_upward_latent_heat_flux hfls W m-2
10 surface_upward_sensible_heat_flux hfss W m-2 

ERA5 corresponding variables are

The "Surface net solar radiation" exists and 


```{r land-masks}
land_mask <- raster("Masks/land_sea_mask_1degree.nc4") 
land_mask.df <- as.data.frame(land_mask, xy = T) %>% setNames(c("lon","lat","lm")) # 0 if ocean, 1 if land


elev <- raster("Worldclim/wc2.1_10m/wc2.1_10m_elev.tif") 
elev.df <- elev %>% projectRaster(to = land_mask) %>% as.data.frame(xy = T) %>% setNames(c("lon","lat", "z"))


ipcc_regions <- shapefile("Masks/IPCC-WGI-reference-regions-v4.shp") %>% spTransform(crs("EPSG:4326")) 
ipcc_regions.raster <- ipcc_regions %>% rasterize(land_mask)
ipcc_regions.df <- as.data.frame(ipcc_regions.raster, xy = T) %>% setNames(c("lon","lat","Continent","Type","Name","Acronym"))

```

```{r data-month}
ts_january <- read.table("CMIP6/ts/ts.all_january.txt") %>% select(!month) %>% dplyr::rename(ts_01 = ts)
ts_february <- read.table("CMIP6/ts/ts.all_february.txt") %>% select(!month) %>% dplyr::rename(ts_02 = ts)
ts_march <- read.table("CMIP6/ts/ts.all_march.txt") %>% select(!month) %>% dplyr::rename(ts_03 = ts)
ts_april <- read.table("CMIP6/ts/ts.all_april.txt") %>% select(!month) %>% dplyr::rename(ts_04 = ts)
ts_may <- read.table("CMIP6/ts/ts.all_may.txt") %>% select(!month) %>% dplyr::rename(ts_05 = ts)
ts_june <- read.table("CMIP6/ts/ts.all_june.txt") %>% select(!month) %>% dplyr::rename(ts_06 = ts)
ts_july <- read.table("CMIP6/ts/ts.all_july.txt") %>% select(!month) %>% dplyr::rename(ts_07 = ts)
ts_august <- read.table("CMIP6/ts/ts.all_august.txt") %>% select(!month) %>% dplyr::rename(ts_08 = ts)
ts_september <- read.table("CMIP6/ts/ts.all_september.txt") %>% select(!month) %>% dplyr::rename(ts_09 = ts)
ts_october <- read.table("CMIP6/ts/ts.all_october.txt") %>% select(!month) %>% dplyr::rename(ts_10 = ts)
ts_november <- read.table("CMIP6/ts/ts.all_november.txt") %>% select(!month) %>% dplyr::rename(ts_11 = ts)
ts_december <- read.table("CMIP6/ts/ts.all_december.txt") %>% select(!month) %>% dplyr::rename(ts_12 = ts)

ts_month <- ts_january %>% 
  merge(ts_february, by =c("lon","lat","model","period","lm","Continent","Type","Name","Acronym","source")) %>%
  merge(ts_march, by =c("lon","lat","model","period","lm","Continent","Type","Name","Acronym","source")) %>%
  merge(ts_april, by =c("lon","lat","model","period","lm","Continent","Type","Name","Acronym","source")) %>%
  merge(ts_may, by =c("lon","lat","model","period","lm","Continent","Type","Name","Acronym","source")) %>%
  merge(ts_june, by =c("lon","lat","model","period","lm","Continent","Type","Name","Acronym","source")) %>%
  merge(ts_july, by =c("lon","lat","model","period","lm","Continent","Type","Name","Acronym","source")) %>%
  merge(ts_august, by =c("lon","lat","model","period","lm","Continent","Type","Name","Acronym","source")) %>%
  merge(ts_september, by =c("lon","lat","model","period","lm","Continent","Type","Name","Acronym","source")) %>%
  merge(ts_october, by =c("lon","lat","model","period","lm","Continent","Type","Name","Acronym","source")) %>%
  merge(ts_november, by =c("lon","lat","model","period","lm","Continent","Type","Name","Acronym","source")) %>%
  merge(ts_december, by =c("lon","lat","model","period","lm","Continent","Type","Name","Acronym","source"))

ts_month$ts_min <- apply(select(ts_month,c("ts_01", "ts_02", "ts_03", "ts_04", "ts_05", "ts_06", "ts_07", "ts_08", "ts_09", "ts_10", "ts_11", "ts_12")), 1, FUN = min, na.rm = T)

write.table(ts_month, "CMIP6/ts/ts_month.txt")
```

```{r test-months, eval = F}
for(i in unique(ts.all_annual$model)){
  df <- ts_january %>% subset(model == i)
  for(j in unique(df$period)){
    g <- ggplot(data = subset(df, period == j)) + geom_raster(aes(x=lon, y = lat,  fill = ts_01-273.15))+
      scale_fill_continuous_divergingx(palette = "RdYlBu", rev = T, mid = 0, limits = c(-60,40))+
      labs(title = paste(i, j, sep = ","), fill = "")+
      theme_void()+
      theme(legend.position = "bottom")
    print(g)
  }
}

for(i in unique(ts.all_annual$model)){
  df <- ts_february %>% subset(model == i)
  for(j in unique(df$period)){
    g <- ggplot(data = subset(df, period == j)) + geom_raster(aes(x=lon, y = lat,  fill = ts_02-273.15))+
      scale_fill_continuous_divergingx(palette = "RdYlBu", rev = T, mid = 0, limits = c(-60,40))+
      labs(title = paste(i, j, sep = ","), fill = "")+
      theme_void()+
      theme(legend.position = "bottom")
    print(g)
  }
}

for(i in unique(ts.all_annual$model)){
  df <- ts_march %>% subset(model == i)
  for(j in unique(df$period)){
    g <- ggplot(data = subset(df, period == j)) + geom_raster(aes(x=lon, y = lat,  fill = ts_03-273.15))+
      scale_fill_continuous_divergingx(palette = "RdYlBu", rev = T, mid = 0, limits = c(-60,40))+
      labs(title = paste(i, j, sep = ","), fill = "")+
      theme_void()+
      theme(legend.position = "bottom")
    print(g)
  }
}

for(i in unique(ts.all_annual$model)){
  df <- ts_april %>% subset(model == i)
  for(j in unique(df$period)){
    g <- ggplot(data = subset(df, period == j)) + geom_raster(aes(x=lon, y = lat,  fill = ts_04-273.15))+
      scale_fill_continuous_divergingx(palette = "RdYlBu", rev = T, mid = 0, limits = c(-60,40))+
      labs(title = paste(i, j, sep = ","), fill = "")+
      theme_void()+
      theme(legend.position = "bottom")
    print(g)
  }
}

for(i in unique(ts.all_annual$model)){
  df <- ts_may %>% subset(model == i)
  for(j in unique(df$period)){
    g <- ggplot(data = subset(df, period == j)) + geom_raster(aes(x=lon, y = lat,  fill = ts_05-273.15))+
      scale_fill_continuous_divergingx(palette = "RdYlBu", rev = T, mid = 0, limits = c(-60,40))+
      labs(title = paste(i, j, sep = ","), fill = "")+
      theme_void()+
      theme(legend.position = "bottom")
    print(g)
  }
}

for(i in unique(ts.all_annual$model)){
  df <- ts_june %>% subset(model == i)
  for(j in unique(df$period)){
    g <- ggplot(data = subset(df, period == j)) + geom_raster(aes(x=lon, y = lat,  fill = ts_06-273.15))+
      scale_fill_continuous_divergingx(palette = "RdYlBu", rev = T, mid = 0, limits = c(-60,40))+
      labs(title = paste(i, j, sep = ","), fill = "")+
      theme_void()+
      theme(legend.position = "bottom")
    print(g)
  }
}

for(i in unique(ts.all_annual$model)){
  df <- ts_july %>% subset(model == i)
  for(j in unique(df$period)){
    g <- ggplot(data = subset(df, period == j)) + geom_raster(aes(x=lon, y = lat,  fill = ts_07-273.15))+
      scale_fill_continuous_divergingx(palette = "RdYlBu", rev = T, mid = 0, limits = c(-60,40))+
      labs(title = paste(i, j, sep = ","), fill = "")+
      theme_void()+
      theme(legend.position = "bottom")
    print(g)
  }
}

for(i in unique(ts.all_annual$model)){
  df <- ts_august %>% subset(model == i)
  for(j in unique(df$period)){
    g <- ggplot(data = subset(df, period == j)) + geom_raster(aes(x=lon, y = lat,  fill = ts_08-273.15))+
      scale_fill_continuous_divergingx(palette = "RdYlBu", rev = T, mid = 0, limits = c(-60,40))+
      labs(title = paste(i, j, sep = ","), fill = "")+
      theme_void()+
      theme(legend.position = "bottom")
    print(g)
  }
}

for(i in unique(ts.all_annual$model)){
  df <- ts_september %>% subset(model == i)
  for(j in unique(df$period)){
    g <- ggplot(data = subset(df, period == j)) + geom_raster(aes(x=lon, y = lat,  fill = ts_09-273.15))+
      scale_fill_continuous_divergingx(palette = "RdYlBu", rev = T, mid = 0, limits = c(-60,40))+
      labs(title = paste(i, j, sep = ","), fill = "")+
      theme_void()+
      theme(legend.position = "bottom")
    print(g)
  }
}

for(i in unique(ts.all_annual$model)){
  df <- ts_october %>% subset(model == i)
  for(j in unique(df$period)){
    g <- ggplot(data = subset(df, period == j)) + geom_raster(aes(x=lon, y = lat,  fill = ts_10-273.15))+
      scale_fill_continuous_divergingx(palette = "RdYlBu", rev = T, mid = 0, limits = c(-60,40))+
      labs(title = paste(i, j, sep = ","), fill = "")+
      theme_void()+
      theme(legend.position = "bottom")
    print(g)
  }
}

for(i in unique(ts.all_annual$model)){
  df <- ts_november %>% subset(model == i)
  for(j in unique(df$period)){
    g <- ggplot(data = subset(df, period == j)) + geom_raster(aes(x=lon, y = lat,  fill = ts_11-273.15))+
      scale_fill_continuous_divergingx(palette = "RdYlBu", rev = T, mid = 0, limits = c(-60,40))+
      labs(title = paste(i, j, sep = ","), fill = "")+
      theme_void()+
      theme(legend.position = "bottom")
    print(g)
  }
}

for(i in unique(ts.all_annual$model)){
  df <- ts_december %>% subset(model == i)
  for(j in unique(df$period)){
    g <- ggplot(data = subset(df, period == j)) + geom_raster(aes(x=lon, y = lat,  fill = ts_12-273.15))+
      scale_fill_continuous_divergingx(palette = "RdYlBu", rev = T, mid = 0, limits = c(-60,40))+
      labs(title = paste(i, j, sep = ","), fill = "")+
      theme_void()+
      theme(legend.position = "bottom")
    print(g)
  }
}
```

```{r tas-month}
tas_january <- read.table("CMIP6/tas/tas.all_january.txt") %>% select(!month) %>% dplyr::rename(tas_01 = tas)
tas_february <- read.table("CMIP6/tas/tas.all_february.txt") %>% select(!month) %>% dplyr::rename(tas_02 = tas)
tas_march <- read.table("CMIP6/tas/tas.all_march.txt") %>% select(!month) %>% dplyr::rename(tas_03 = tas)
tas_april <- read.table("CMIP6/tas/tas.all_april.txt") %>% select(!month) %>% dplyr::rename(tas_04 = tas)
tas_may <- read.table("CMIP6/tas/tas.all_may.txt") %>% select(!month) %>% dplyr::rename(tas_05 = tas)
tas_june <- read.table("CMIP6/tas/tas.all_june.txt") %>% select(!month) %>% dplyr::rename(tas_06 = tas)
tas_july <- read.table("CMIP6/tas/tas.all_july.txt") %>% select(!month) %>% dplyr::rename(tas_07 = tas)
tas_august <- read.table("CMIP6/tas/tas.all_august.txt") %>% select(!month) %>% dplyr::rename(tas_08 = tas)
tas_september <- read.table("CMIP6/tas/tas.all_september.txt") %>% select(!month) %>% dplyr::rename(tas_09 = tas)
tas_october <- read.table("CMIP6/tas/tas.all_october.txt") %>% select(!month) %>% dplyr::rename(tas_10 = tas)
tas_november <- read.table("CMIP6/tas/tas.all_november.txt") %>% select(!month) %>% dplyr::rename(tas_11 = tas)
tas_december <- read.table("CMIP6/tas/tas.all_december.txt") %>% select(!month) %>% dplyr::rename(tas_12 = tas)

tas_month <- tas_january %>% 
  merge(tas_february, by =c("lon","lat","model","period","lm","Continent","Type","Name","Acronym","source")) %>%
  merge(tas_march, by =c("lon","lat","model","period","lm","Continent","Type","Name","Acronym","source")) %>%
  merge(tas_april, by =c("lon","lat","model","period","lm","Continent","Type","Name","Acronym","source")) %>%
  merge(tas_may, by =c("lon","lat","model","period","lm","Continent","Type","Name","Acronym","source")) %>%
  merge(tas_june, by =c("lon","lat","model","period","lm","Continent","Type","Name","Acronym","source")) %>%
  merge(tas_july, by =c("lon","lat","model","period","lm","Continent","Type","Name","Acronym","source")) %>%
  merge(tas_august, by =c("lon","lat","model","period","lm","Continent","Type","Name","Acronym","source")) %>%
  merge(tas_september, by =c("lon","lat","model","period","lm","Continent","Type","Name","Acronym","source")) %>%
  merge(tas_october, by =c("lon","lat","model","period","lm","Continent","Type","Name","Acronym","source")) %>%
  merge(tas_november, by =c("lon","lat","model","period","lm","Continent","Type","Name","Acronym","source")) %>%
  merge(tas_december, by =c("lon","lat","model","period","lm","Continent","Type","Name","Acronym","source"))

tas_month$tas_min <- apply(select(tas_month,c("tas_01", "tas_02", "tas_03", "tas_04", "tas_05", "tas_06", "tas_07", "tas_08", "tas_09", "tas_10", "tas_11", "tas_12")), 1, FUN = min, na.rm = T)

write.table(tas_month, "CMIP6/tas/tas_month.txt")
```

```{r test-months, eval = F}
for(i in unique(tas.all_annual$model)){
  df <- tas_january %>% subset(model == i)
  for(j in unique(df$period)){
    g <- ggplot(data = subset(df, period == j)) + geom_raster(aes(x=lon, y = lat,  fill = tas_01-273.15))+
      scale_fill_continuous_divergingx(palette = "RdYlBu", rev = T, mid = 0, limits = c(-60,40))+
      labs(title = paste(i, j, sep = ","), fill = "")+
      theme_void()+
      theme(legend.position = "bottom")
    print(g)
  }
}

for(i in unique(tas.all_annual$model)){
  df <- tas_february %>% subset(model == i)
  for(j in unique(df$period)){
    g <- ggplot(data = subset(df, period == j)) + geom_raster(aes(x=lon, y = lat,  fill = tas_02-273.15))+
      scale_fill_continuous_divergingx(palette = "RdYlBu", rev = T, mid = 0, limits = c(-60,40))+
      labs(title = paste(i, j, sep = ","), fill = "")+
      theme_void()+
      theme(legend.position = "bottom")
    print(g)
  }
}

for(i in unique(tas.all_annual$model)){
  df <- tas_march %>% subset(model == i)
  for(j in unique(df$period)){
    g <- ggplot(data = subset(df, period == j)) + geom_raster(aes(x=lon, y = lat,  fill = tas_03-273.15))+
      scale_fill_continuous_divergingx(palette = "RdYlBu", rev = T, mid = 0, limits = c(-60,40))+
      labs(title = paste(i, j, sep = ","), fill = "")+
      theme_void()+
      theme(legend.position = "bottom")
    print(g)
  }
}

for(i in unique(tas.all_annual$model)){
  df <- tas_april %>% subset(model == i)
  for(j in unique(df$period)){
    g <- ggplot(data = subset(df, period == j)) + geom_raster(aes(x=lon, y = lat,  fill = tas_04-273.15))+
      scale_fill_continuous_divergingx(palette = "RdYlBu", rev = T, mid = 0, limits = c(-60,40))+
      labs(title = paste(i, j, sep = ","), fill = "")+
      theme_void()+
      theme(legend.position = "bottom")
    print(g)
  }
}

for(i in unique(tas.all_annual$model)){
  df <- tas_may %>% subset(model == i)
  for(j in unique(df$period)){
    g <- ggplot(data = subset(df, period == j)) + geom_raster(aes(x=lon, y = lat,  fill = tas_05-273.15))+
      scale_fill_continuous_divergingx(palette = "RdYlBu", rev = T, mid = 0, limits = c(-60,40))+
      labs(title = paste(i, j, sep = ","), fill = "")+
      theme_void()+
      theme(legend.position = "bottom")
    print(g)
  }
}

for(i in unique(tas.all_annual$model)){
  df <- tas_june %>% subset(model == i)
  for(j in unique(df$period)){
    g <- ggplot(data = subset(df, period == j)) + geom_raster(aes(x=lon, y = lat,  fill = tas_06-273.15))+
      scale_fill_continuous_divergingx(palette = "RdYlBu", rev = T, mid = 0, limits = c(-60,40))+
      labs(title = paste(i, j, sep = ","), fill = "")+
      theme_void()+
      theme(legend.position = "bottom")
    print(g)
  }
}

for(i in unique(tas.all_annual$model)){
  df <- tas_july %>% subset(model == i)
  for(j in unique(df$period)){
    g <- ggplot(data = subset(df, period == j)) + geom_raster(aes(x=lon, y = lat,  fill = tas_07-273.15))+
      scale_fill_continuous_divergingx(palette = "RdYlBu", rev = T, mid = 0, limits = c(-60,40))+
      labs(title = paste(i, j, sep = ","), fill = "")+
      theme_void()+
      theme(legend.position = "bottom")
    print(g)
  }
}

for(i in unique(tas.all_annual$model)){
  df <- tas_august %>% subset(model == i)
  for(j in unique(df$period)){
    g <- ggplot(data = subset(df, period == j)) + geom_raster(aes(x=lon, y = lat,  fill = tas_08-273.15))+
      scale_fill_continuous_divergingx(palette = "RdYlBu", rev = T, mid = 0, limits = c(-60,40))+
      labs(title = paste(i, j, sep = ","), fill = "")+
      theme_void()+
      theme(legend.position = "bottom")
    print(g)
  }
}

for(i in unique(tas.all_annual$model)){
  df <- tas_september %>% subset(model == i)
  for(j in unique(df$period)){
    g <- ggplot(data = subset(df, period == j)) + geom_raster(aes(x=lon, y = lat,  fill = tas_09-273.15))+
      scale_fill_continuous_divergingx(palette = "RdYlBu", rev = T, mid = 0, limits = c(-60,40))+
      labs(title = paste(i, j, sep = ","), fill = "")+
      theme_void()+
      theme(legend.position = "bottom")
    print(g)
  }
}

for(i in unique(tas.all_annual$model)){
  df <- tas_october %>% subset(model == i)
  for(j in unique(df$period)){
    g <- ggplot(data = subset(df, period == j)) + geom_raster(aes(x=lon, y = lat,  fill = tas_10-273.15))+
      scale_fill_continuous_divergingx(palette = "RdYlBu", rev = T, mid = 0, limits = c(-60,40))+
      labs(title = paste(i, j, sep = ","), fill = "")+
      theme_void()+
      theme(legend.position = "bottom")
    print(g)
  }
}

for(i in unique(tas.all_annual$model)){
  df <- tas_november %>% subset(model == i)
  for(j in unique(df$period)){
    g <- ggplot(data = subset(df, period == j)) + geom_raster(aes(x=lon, y = lat,  fill = tas_11-273.15))+
      scale_fill_continuous_divergingx(palette = "RdYlBu", rev = T, mid = 0, limits = c(-60,40))+
      labs(title = paste(i, j, sep = ","), fill = "")+
      theme_void()+
      theme(legend.position = "bottom")
    print(g)
  }
}

for(i in unique(tas.all_annual$model)){
  df <- tas_december %>% subset(model == i)
  for(j in unique(df$period)){
    g <- ggplot(data = subset(df, period == j)) + geom_raster(aes(x=lon, y = lat,  fill = tas_12-273.15))+
      scale_fill_continuous_divergingx(palette = "RdYlBu", rev = T, mid = 0, limits = c(-60,40))+
      labs(title = paste(i, j, sep = ","), fill = "")+
      theme_void()+
      theme(legend.position = "bottom")
    print(g)
  }
}
```

```{r data}
tas.all_annual <- read.table("CMIP6/tas/tas.all_annual.txt")
ts.all_annual <- read.table("CMIP6/ts/ts.all_annual.txt")
pr.all_annual <- read.table("CMIP6/pr/pr.all_annual.txt")
rsds.all_annual <- read.table("CMIP6/rsds/rsds.all_annual.txt") # units: W/m2
sfcWind.all_annual <- read.table("CMIP6/sfcWind/sfcWind.all_annual.txt")
ts_month <- read.table("CMIP6/ts/ts_month.txt")
tas_month <- read.table("CMIP6/tas/tas_month.txt")
```



```{r proba-models}
v<-NULL
v2<-NULL
for (N in 10:100) {
  v<-c(v,sum(sapply(floor(2*N/3):N,function(i) choose(N,i)*(1/2)^N*2)))# proba d'avoir 2/3 de même signe à partir de N modèles, lorsque N change
  v2<-c(v2,sum(sapply(floor(2*N/3):N,function(i) choose(N,i)*(1/2)^N)))# proba d'avoir 2/3 de signe >0 à partir de N modèles, lorsque N change
}


plot(10:100,v,type="l",ylab="Proba(>2/3 models...)",xlab="Nb of models")
lines(10:100,v2,col="red")

legend("topright",c("même signe","signe >0"),col=c("black","red"),lty=1)

v<-NULL
v2<-NULL
for (N in 10:100) {
  v<-c(v,sum(sapply(floor(3*N/4):N,function(i) choose(N,i)*(1/2)^N*2)))# proba d'avoir 3/4 de même signe à partir de N modèles, lorsque N change
  v2<-c(v2,sum(sapply(floor(3*N/4):N,function(i) choose(N,i)*(1/2)^N)))# proba d'avoir 3/4 de signe >0 à partir de N modèles, lorsque N change
}


plot(10:100,v,type="l",ylab="Proba(>3/4 models...)",xlab="Nb of models")
lines(10:100,v2,col="red")

legend("topright",c("même signe","signe >0"),col=c("black","red"),lty=1)

v<-NULL
v2<-NULL
for (N in 10:100) {
  v<-c(v,sum(sapply(floor(4*N/5):N,function(i) choose(N,i)*(1/2)^N*2)))# proba d'avoir 4/5 de même signe à partir de N modèles, lorsque N change
  v2<-c(v2,sum(sapply(floor(4*N/5):N,function(i) choose(N,i)*(1/2)^N)))# proba d'avoir 4/5 de signe >0 à partir de N modèles, lorsque N change
}


plot(10:100,v,type="l",ylab="Proba(>4/5 models...)",xlab="Nb of models")
lines(10:100,v2,col="red")

legend("topright",c("même signe","signe >0"),col=c("black","red"),lty=1)
```

```{r test-evsp}
et0 <- raster("CMIP6/ET0/evspsbl_Amon_AWI-CM-1-1-MR_historical_r1i1p1f1_gn_185001-185012.nc")
plot(et0*60*60*24*365)
et0.df <- as.data.frame(et0, xy = T) %>% setNames(c("lon","lat","et0"))

pr <- raster("CMIP6/pr/pr_Amon_AWI-CM-1-1-MR_historical_r1i1p1f1_gn_185001-185012.nc")
plot(pr*60*60*24*365)
pr.df <- as.data.frame(pr, xy = T) %>% setNames(c("lon","lat","pr"))

awi <- merge(et0.df, pr.df, by = c("lon","lat"))
awi$AI <- with(awi, pr/et0)
awi$cat.AI <- awi$AI %>% cut(breaks = breaks.unesco) %>% 
  revalue(cat.unesco)

ggplot(data = awi) + geom_raster(aes(x=lon, y = lat,  fill = cat.AI))+
  scale_fill_manual(values = col.cat)+
  labs(title = "Test ET0", fill = "")+
  theme_void()+
  theme(legend.position = "bottom")
```


# Worldclim: réanalyse pour la période 1970-2000 -----

```{r standalone-plots-wordlclim}
world.df <- readRDS("Worldclim/world.df.rds")

world.df$P <-  with(world.df, 101.3 * ((293-0.0065*z)/293)^(5.26)) #atm P based on Burman et al. 1987

world.df$tmax <- apply(dplyr::select(world.df, c("tmax_01", "tmax_02", "tmax_03", "tmax_04", "tmax_05", "tmax_06", "tmax_07", "tmax_08", "tmax_09", "tmax_10", "tmax_11", "tmax_12")), 1, max, na.rm = T)
world.df$tmin <- apply(dplyr::select(world.df, c("tmin_01", "tmin_02", "tmin_03", "tmin_04", "tmin_05", "tmin_06", "tmin_07", "tmin_08", "tmin_09", "tmin_10", "tmin_11", "tmin_12")), 1, min, na.rm = T)
world.df$Rn <- apply(dplyr::select(world.df, c("srad_01", "srad_02", "srad_03", "srad_04", "srad_05", "srad_06", "srad_07", "srad_08", "srad_09", "srad_10", "srad_11", "srad_12")), 1, mean, na.rm = T)
world.df$u2 <- apply(dplyr::select(world.df, c("u_01", "u_02", "u_03", "u_04", "u_05", "u_06", "u_07", "u_08", "u_09", "u_10", "u_11", "u_12")), 1, mean, na.rm = T)

world.df$es <- with(world.df, ifelse(temp > 0, 0.61078*exp(17.27*temp/(temp+237.3)),  0.61078*exp(21.875*temp/(temp+265.5)))) # saturation vapor pressure Monteith-Unsworth pour >0, Murray pour T < 0
world.df$delta <- with(world.df, 4098*es/(temp+237.3)^2) #slope vapor pressure
world.df$gamma <- with(world.df, 0.00163*P/(2.501-52.6361e-3*temp)) #psychrometric constant
world.df$ea <- with(world.df, with(world.df, ifelse(tmin > 0, 0.61078*exp(17.27*tmin/(tmin+237.3)),  0.61078*exp(21.875*tmin/(tmin+265.5))))) # actual vapor pressur; when relative humidity is not availabmle, ea is obtained by estimating that when the air temp is close to Tmin, it is nearly saturated
world.df$ET0 <-with(world.df, (0.408*delta*Rn*1e-3+gamma*900/(temp+273)*u2*(es-ea)/(delta+gamma*(1+0.34*u2)))) # Evapotranspiration, G considered to be negligible. in mm/day
world.df$AIu <- with(world.df, pre/(ET0*365))

breaks.unesco <- c(-Inf,0.03,0.2,0.5,0.65,Inf)
cat.unesco <- c("(-Inf,0.03]"= "Hyperarid", "(0.03,0.2]" = "Arid", "(0.2,0.5]" = "Semi-arid", "(0.5,0.65]" = "Dry subhumid","(0.65, Inf]" = "Humid")
col.cat <- c("Hyperarid" = colorvec[2], "Arid"= colorvec[4],"Semi-arid"= colorvec[5], "Dry subhumid" = colorvec[8], "Humid"= colorvec[10])

world.df$cat.AIu <- world.df$AIu %>% cut(breaks = breaks.unesco) %>% # otherwise regions in  which pre = 0 are excluded 
  revalue(cat.unesco)

ggplot() + geom_raster(data = world.df, aes(x=lon, y = lat,  fill = cat.AIu))+
  scale_fill_manual(values = col.cat)+
  labs(title = "Worldclim, tmin is tmin")+
  theme_void()+
  theme(legend.position = "bottom")

world.df$tmin <- apply(dplyr::select(world.df, c("tmean_01", "tmean_02", "tmean_03", "tmean_04", "tmean_05", "tmean_06", "tmean_07", "tmean_08", "tmean_09", "tmean_10", "tmean_11", "tmean_12")), 1, min, na.rm = T)
world.df$es <- with(world.df, ifelse(temp > 0, 0.61078*exp(17.27*temp/(temp+237.3)),  0.61078*exp(21.875*temp/(temp+265.5)))) # saturation vapor pressure Monteith-Unsworth pour >0, Murray pour T < 0
world.df$delta <- with(world.df, 4098*es/(temp+237.3)^2) #slope vapor pressure
world.df$gamma <- with(world.df, 0.00163*P/(2.501-52.6361e-3*temp)) #psychrometric constant
world.df$ea <- with(world.df, with(world.df, ifelse(tmin > 0, 0.61078*exp(17.27*tmin/(tmin+237.3)),  0.61078*exp(21.875*tmin/(tmin+265.5))))) # actual vapor pressur; when relative humidity is not availabmle, ea is obtained by estimating that when the air temp is close to Tmin, it is nearly saturated
world.df$ET0 <-with(world.df, (0.408*delta*Rn*1e-3+gamma*900/(temp+273)*u2*(es-ea)/(delta+gamma*(1+0.34*u2)))) # Evapotranspiration, G considered to be negligible. in mm/day
world.df$AIu <- with(world.df, pre/(ET0*365))

breaks.unesco <- c(-Inf,0.03,0.2,0.5,0.65,Inf)
cat.unesco <- c("(-Inf,0.03]"= "Hyperarid", "(0.03,0.2]" = "Arid", "(0.2,0.5]" = "Semi-arid", "(0.5,0.65]" = "Dry subhumid","(0.65, Inf]" = "Humid")
col.cat <- c("Hyperarid" = colorvec[2], "Arid"= colorvec[4],"Semi-arid"= colorvec[5], "Dry subhumid" = colorvec[8], "Humid"= colorvec[10])

world.df$cat.AIu <- world.df$AIu %>% cut(breaks = breaks.unesco) %>% # otherwise regions in  which pre = 0 are excluded 
  revalue(cat.unesco)

ggplot() + geom_raster(data = world.df, aes(x=lon, y = lat,  fill = cat.AIu))+
  scale_fill_manual(values = col.cat)+
  labs(title = "Worldclim, tmin is min(tmean)")+
  theme_void()+
  theme(legend.position = "bottom")

ggplot() + geom_raster(data = subset(clim, source =="Worldclim"), aes(x=lon, y = lat,  fill = cat.AIu))+
  scale_fill_manual(values = col.cat)+
  labs(title = "Worldclim, tmin is min(ts)")+
  theme_void()+
  theme(legend.position = "bottom")
```



```{r worldclim}
wdct <- raster("Worldclim/wc2.1_10m/wc2.1_10m_bio_1.tif") %>% 
  projectRaster(to = land_mask) %>% 
  as.data.frame(xy = T) %>% setNames(c("lon","lat","tas"))

list.tavg <- list.files(path = "Worldclim/wc2.1_10m", pattern = "wc2.1_10m_tavg_", full.names = T) 
wdctm <- raster::stack(list.tavg) %>% 
  projectRaster(to = land_mask) %>% 
  as.data.frame(xy = T) %>% setNames(c("lon","lat","tas_01","tas_02","tas_03","tas_04","tas_05","tas_06","tas_07","tas_08","tas_09","tas_10","tas_11","tas_12"))

wdcp <- raster("Worldclim/wc2.1_10m/wc2.1_10m_bio_12.tif") %>%
  projectRaster(to = land_mask) %>% 
  as.data.frame(xy = T) %>% setNames(c("lon","lat","pr"))

list.wind <- list.files(path = "Worldclim/wc2.1_10m/", pattern = "wc2.1_10m_wind", full.names = TRUE)
wdcw <- raster::stack(list.wind) %>% mean(na.rm = T) %>% 
  projectRaster(to = land_mask) %>% 
  as.data.frame(xy = T) %>% setNames(c("lon","lat","sfcWind"))

list.rsds <- list.files(path = "Worldclim/wc2.1_10m/", pattern = "wc2.1_10m_srad", full.names = TRUE) # unit: kJ/m2/day
wdcr <- raster::stack(list.rsds) %>% mean(na.rm = T) %>% 
  projectRaster(to = land_mask) %>% 
  as.data.frame(xy = T) %>% setNames(c("lon","lat","rsds"))

wdc <- wdct %>% 
  merge(wdctm, by = c("lon", "lat")) %>%
  merge(wdcp, by = c("lon", "lat")) %>%
  merge(wdcr, by = c("lon", "lat")) %>%
  merge(wdcw, by = c("lon", "lat")) %>%
  mutate(model = "historical", period = "1970_2000", source = "Worldclim") %>%
  merge(land_mask.df, by = c("lon", "lat")) %>%
  merge(ipcc_regions.df, by = c("lon", "lat")) %>% 
  merge(elev.df, by = c("lon","lat")) %>%
  filter(lm == 1)

wdc$tas_min <- apply(select(wdc,c("tas_01", "tas_02", "tas_03", "tas_04", "tas_05", "tas_06", "tas_07", "tas_08", "tas_09", "tas_10", "tas_11", "tas_12")), 1, FUN = min, na.rm = T)

# same units as cmip6
wdc$tas <- wdc$tas+273.15
wdc$tas_01 <- wdc$tas_01+273.15
wdc$tas_02 <- wdc$tas_02+273.15
wdc$tas_03 <- wdc$tas_03+273.15
wdc$tas_04 <- wdc$tas_04+273.15
wdc$tas_05 <- wdc$tas_05+273.15
wdc$tas_06 <- wdc$tas_06+273.15
wdc$tas_07 <- wdc$tas_07+273.15
wdc$tas_08 <- wdc$tas_08+273.15
wdc$tas_09 <- wdc$tas_09+273.15
wdc$tas_10 <- wdc$tas_10+273.15
wdc$tas_11 <- wdc$tas_11+273.15
wdc$tas_12 <- wdc$tas_12+273.15
wdc$tas_min <- wdc$tas_min+273.15

wdc$pr <- wdc$pr / (60*60*24*365)  # conversion from mm/year to kg/m2/s 
wdc$rsds <-wdc$rsds * 1000/86400 # conversion from kJ/m2/day to W/m2 (1 J = 1 W.s)

write.table(wdc,"wdc.txt")
```

# Boxplots of ts, pr, rsds and sfcWind from CMIP6 compared to Worldclim -----

```{r all_future}
ggplot()+geom_boxplot(data = subset(ts.all_annual, period == "1970_2000"), aes(x=source, y = tas-273, col = source))+
  geom_boxplot(data = wdcttt, aes(x="Worldclim", y = ts, col = "Worldclim"))+
  scale_color_viridis_d(option = "A", end = 0.8)+
  labs(x = "", y = "Average annual temperature, °C") + theme_minimal()

ggplot()+geom_boxplot(data = subset(pr.all_annual, period == "1970_2000"), aes(x=source, y = pr*60*60*24*365, col = source))+ #
  geom_boxplot(data = wdcppp, aes(x="Worldclim", y = pr, col = "Worldclim"))+
  scale_color_viridis_d(option = "A", end = 0.8)+
  labs(x = "", y = "Average annual precipitation, mm") + theme_minimal()

ggplot()+geom_boxplot(data = subset(rsds.all_annual, period == "1970_2000"), aes(x=source, y = rsds, col = source))+
  geom_boxplot(data = wdcrrr, aes(x="Worldclim", y = rsds*1000/86400, col = "Worldclim"))+ 
  scale_color_viridis_d(option = "A", end = 0.8)+
  labs(x = "", y = "Average annual precipitation, kJ/m2/d") + theme_minimal()

ggplot()+geom_boxplot(data = subset(sfcWind.all_annual, period == "1970_2000"), aes(x=source, y = sfcWind, col = source))+
  geom_boxplot(data = wdcwww, aes(x="Worldclim", y = sfcWind, col = "Worldclim"))+
  scale_color_viridis_d(option = "A", end = 0.8)+
  labs(x = "", y = "Average annual wind speed, m/s") + theme_minimal()

```

# Aridity index

```{r merge}
cmip6 <- ts.all_annual %>% 
  merge(ts_month, by = c("lon","lat","model","period","lm", "Continent","Type","Name","Acronym","source")) %>%
  merge(tas.all_annual, by = c("lon","lat","model","period","lm", "Continent","Type","Name","Acronym","source")) %>%
  merge(tas_month, by = c("lon","lat","model","period","lm", "Continent","Type","Name","Acronym","source")) %>%
  merge(pr.all_annual, by = c("lon","lat","model","period","lm", "Continent","Type","Name","Acronym","source")) %>%
  merge(rsds.all_annual, by = c("lon","lat","model","period","lm", "Continent","Type","Name","Acronym","source")) %>%
  merge(sfcWind.all_annual, by = c("lon","lat","model","period","lm", "Continent","Type","Name","Acronym","source"))

wdc <- mutate(wdc, ts = NA, ts_01 = NA, ts_02 = NA, ts_03 = NA, ts_04 = NA, ts_05 = NA, ts_06 = NA,
              ts_07 = NA, ts_08 = NA, ts_09 = NA, ts_10 = NA, ts_11 = NA, ts_12 = NA, ts_min = NA)

era5 <- mutate(era5, ts = NA, ts_01 = NA, ts_02 = NA, ts_03 = NA, ts_04 = NA, ts_05 = NA , ts_06 = NA, ts_07 = NA, ts_08 = NA, ts_09 = NA, ts_10 = NA, ts_11 = NA, ts_12 = NA, ts_min = NA)

clim <- cmip6 %>%
  rbind(select(wdc, names(cmip6))) %>%
  rbind(select(era5, names(cmip6))) %>% 
  merge(elev.df, by = c("lon","lat"))
  
# as minimum temperature we use the minimum monthly average
```

```{r boxplot}
ggplot(subset(clim, period == "1970_2000")) + geom_boxplot(aes(x= source, y = pr))
ggplot(subset(clim, period == "1970_2000")) + geom_boxplot(aes(x= source, y = tas))
ggplot(subset(clim, period == "1970_2000")) + geom_boxplot(aes(x= source, y = ts))
ggplot(subset(clim, period == "1970_2000")) + geom_boxplot(aes(x= source, y = rsds))
ggplot(subset(clim, period == "1970_2000")) + geom_boxplot(aes(x= source, y = sfcWind))
```


```{r aridity-index-tas}

# Martonne
clim$AIm <- with(clim,pr*60*60*24*365/(tas-273.15+10)) # pr in mm/y, tas in Ceslsius
breaks.martonne <- c(0,5,10,20,"30","40",Inf)
cat.martonne <- c("[0,5]" = "Desert", "(5,10]"= "Arid", "(10,20]" = "Semi-arid","(20,30]" = "Temperate", "(30,40]" = "Humid", "(40,Inf]" = "Forest")

clim$cat.AIm <- clim$AIm %>% cut(breaks.martonne, include.lowest = T) %>% revalue(cat.martonne)

# Unesco

clim$P <- with(clim, 101.3 * ((293-0.0065*z)/293)^(5.26))
clim$es <- with(clim, ifelse((tas-273.15) > 0, 0.61078*exp(17.27*(tas-273.15)/((tas-273.15)+237.3)),  0.61078*exp(21.875*(tas-273.15)/((tas-273.15)+265.5)))) # saturation vapor pressure Monteith-Unsworth pour >0, Murray pour T < 0
clim$delta <- with(clim, 4098*es/((tas-273.15)+237.3)^2) #slope vapor pressure
clim$gamma <- with(clim, 0.00163*P/(2.501-52.6361e-3*(tas-273.15))) #psychrometric constant
clim$ea <- with(clim, with(clim, ifelse((tas_min-273.15) > 0, 0.61078*exp(17.27*(tas_min-273.15)/((tas_min-273.15)+237.3)),  0.61078*exp(21.875*(tas_min-273.15)/((tas_min-273.15)+265.5))))) # actual vapor pressur; when relative humidity is not availabmle, ea is obtained by estimating that when the air temp is close to Tmin, it is nearly saturated
clim$ET0 <-with(clim, ((0.408*delta*(rsds*86400*1e-6)+gamma*900/((tas-273.15)+273)*sfcWind*(es-ea))/(delta+gamma*(1+0.34*sfcWind)))) # Evapotranspiration, G considered to be negligible. in mm/day. Irradiation is in W/m2 and is converted to MJ/m2/day
clim$AIu <- with(clim, pr*60*60*24*365/(ET0*365))

breaks.unesco <- c(-Inf,0.03,0.2,0.5,0.65,Inf)
cat.unesco <- c("(-Inf,0.03]"= "Hyperarid", "(0.03,0.2]" = "Arid", "(0.2,0.5]" = "Semi-arid", "(0.5,0.65]" = "Dry subhumid","(0.65, Inf]" = "Humid")

# save
clim$cat.AIu <- clim$AIu %>% cut(breaks = breaks.unesco) %>% 
  revalue(cat.unesco)

write.table(clim, "clim.txt")
```

```{r clim-summary}
clim_sum <- clim %>% 
  subset(source != "Wordlclim") %>%
  group_by(lon, lat, model, period) %>% 
  dplyr::summarise(tas = mean(tas, na.rm = T), pr = mean(pr, na.rm = T), AIm = mean(AIm, na.rm = T), AIu = mean(AIu, na.rm = T))

breaks.unesco <- c(-Inf,0.03,0.2,0.5,0.65,Inf)
cat.unesco <- c("(-Inf,0.03]"= "Hyperarid", "(0.03,0.2]" = "Arid", "(0.2,0.5]" = "Semi-arid", "(0.5,0.65]" = "Dry subhumid","(0.65, Inf]" = "Humid")

clim_sum$cat.AIu <- clim_sum$AIu %>% cut(breaks = breaks.unesco) %>% 
  revalue(cat.unesco)

cat.martonne <- c("(0,5]" = "Desert", "(5,10]"= "Arid", "(10,20]" = "Semi-arid","(20,30]" = "Temperate", "(30,40]" = "Humid", "(40,Inf]" = "Forest")
clim_sum$cat.AIm <- clim_sum$AIm %>% cut(breaks = c(0,5,10,20,"30","40",Inf)) %>% 
  revalue(cat.martonne)

write.table(clim_sum, "clim_sum.txt")

clim_med <- clim %>% subset(source != "Wordlclim") %>% group_by(lon, lat, model, period) %>% dplyr::summarise(ts = median(tas, na.rm = T), pr = median(pr, na.rm = T), AIm = median(AIm, na.rm = T), AIu = median(AIu, na.rm = T))
clim_med$cat.AIu <- clim_med$AIu %>% cut(breaks = breaks.unesco) %>% 
  revalue(cat.unesco)
clim_med$cat.AIm <- clim_med$AIm %>% cut(breaks = breaks.martonne) %>% 
  revalue(cat.martonne)
write.table(clim_med, "clim_med.txt")
```

```{r load-clim-data}
clim <- read.table("clim.txt")
clim_sum <- read.table("clim_sum.txt")
clim_med <- read.table("clim_med.txt")

col.martonne <- c("Desert" = colorvec[2], "Arid"= colorvec[4],"Semi-arid"= colorvec[5], "Temperate" = colorvec[8], "Humid"= colorvec[10],"Forest"= colorvec[11])
col.cat <- c("Hyperarid" = colorvec[2], "Arid"= colorvec[4],"Semi-arid"= colorvec[5], "Dry subhumid" = colorvec[8], "Humid"= colorvec[10])
```

```{r plot}
ggplot() + geom_raster(data = subset(clim_sum, period == "1970_2000" & AIm >= 0), aes(x=lon, y = lat,  fill = cat.AIm))+
  geom_raster(data = subset(clim_sum, period == "1970_2000" & AIm < 0), aes(x=lon, y = lat), fill = "gray60")+
  scale_fill_manual(values = col.martonne)+
  theme_void()+
  theme(legend.position = "bottom")

ggplot() + geom_raster(data = subset(clim_med, period == "1970_2000" & AIm >= 0), aes(x=lon, y = lat,  fill = cat.AIm))+
  geom_raster(data = subset(clim_med, period == "1970_2000" & AIm < 0), aes(x=lon, y = lat), fill = "gray60")+
  scale_fill_manual(values = col.martonne)+
  theme_void()+
  theme(legend.position = "bottom")

ggplot() + geom_raster(data = subset(clim_sum, period == "1970_2000" ), aes(x=lon, y = lat,  fill = cat.AIu))+
  scale_fill_manual(values = col.cat)+
  theme_void()+
  theme(legend.position = "bottom")

ggplot() + geom_raster(data = subset(clim_med, period == "1970_2000" ), aes(x=lon, y = lat,  fill = cat.AIu))+
  scale_fill_manual(values = col.cat)+
  theme_void()+
  theme(legend.position = "bottom")
```

# Proportion of each category of aridiy by region ---- 

```{r Compare-plots}
wAIu <-  subset(clim, period == "1970_2000") %>% 
       select(c("lon","lat","source","AIu")) %>%
      reshape(direction = "wide", idvar = c("lon","lat"), v.names = "AIu", timevar = "source")

wAIu$AIu.CMIP6 <- rowMeans(wAIu[,3:11])

breaks.unesco <- c(-Inf,0.03,0.2,0.5,0.65,Inf)
cat.unesco <- c("(-Inf,0.03]"= "Hyperarid", "(0.03,0.2]" = "Arid", "(0.2,0.5]" = "Semi-arid", "(0.5,0.65]" = "Dry subhumid","(0.65, Inf]" = "Humid")

wAIu$cat.AIu.CMIP6 <- wAIu$AIu.CMIP6 %>% cut(breaks = breaks.unesco) %>% 
  revalue(cat.unesco)

wAIu$cat.AIu.Worldclim <- wAIu$AIu.Worldclim %>% cut(breaks = breaks.unesco) %>% 
  revalue(cat.unesco)

wAIu$cat.AIu.ERA5 <- wAIu$AIu.ERA5 %>% cut(breaks = breaks.unesco) %>% 
  revalue(cat.unesco)

ggplot(data = wAIu) + geom_raster(aes(x=lon, y = lat,  fill = cat.AIu.CMIP6))+
    scale_fill_manual(values = col.cat)+
    labs(title = "CMIP6, 1970-2000", fill = "")+
    theme_void()+
    theme(legend.position = "bottom")

ggplot(data = wAIu) + geom_raster(aes(x=lon, y = lat,  fill = cat.AIu.Worldclim))+
    scale_fill_manual(values = col.cat)+
    labs(title = "Worldclim, 1970-2000", fill = "")+
    theme_void()+
    theme(legend.position = "bottom")

ggplot(data = wAIu) + geom_raster(aes(x=lon, y = lat,  fill = cat.AIu.ERA5))+
    scale_fill_manual(values = col.cat)+
    labs(title = "ERA5, 1970-2000", fill = "")+
    theme_void()+
    theme(legend.position = "bottom")

```
Problème avec z qui est NA dans de nombreuses régions (N.Eastern Africa)

```{r proportion-category}
cmip6_ref <- clim %>% filter(period == "1970_2000" & source != "Worldclim" & source != "ERA5") %>%
   group_by(lon, lat, Name, Acronym) %>% 
  dplyr::summarise(AIu = mean(AIu, na.rm = T)) %>%
  mutate(source = "CMIP6")

ref <- clim %>% subset(period == "1970_2000" & source %in% c("Worldclim", "ERA5")) %>% 
       select(c("lon","lat", "Name","Acronym", "source","AIu"))
     
calib <- rbind(cmip6_ref, ref)

breaks.unesco <- c(-Inf,0.03,0.2,0.5,0.65,Inf)
cat.unesco <- c("(-Inf,0.03]"= "Hyperarid", "(0.03,0.2]" = "Arid", "(0.2,0.5]" = "Semi-arid", "(0.5,0.65]" = "Dry subhumid","(0.65, Inf]" = "Humid")

calib$cat.AIu <-  calib$AIu %>% cut(breaks = breaks.unesco) %>% 
  revalue(cat.unesco)

ggplot(data = subset(calib, source == "Worldclim")) + geom_raster(aes(x=lon, y = lat,  fill = cat.AIu))+
    scale_fill_manual(values = col.cat)+
    labs(title = "Wordclim, 1970-2000", fill = "")+
    theme_void()+
    theme(legend.position = "bottom")

ggplot(data = subset(calib, source == "ERA5")) + geom_raster(aes(x=lon, y = lat,  fill = cat.AIu))+
    scale_fill_manual(values = col.cat)+
    labs(title = "ERA5, 1970-2000", fill = "")+
    theme_void()+
    theme(legend.position = "bottom")

ggplot(data = subset(calib, source == "CMIP6")) + geom_raster(aes(x=lon, y = lat,  fill = cat.AIu))+
    scale_fill_manual(values = col.cat)+
    labs(title = "CMIP6, 1970-2000", fill = "")+
    theme_void()+
    theme(legend.position = "bottom")

table_calib <- calib %>%
  group_by(Name, source) %>%
  summarise(hyperarid = sum(cat.AIu == "Hyperarid"), 
            arid = sum(cat.AIu == "Arid"), 
            semi.arid = sum(cat.AIu == "Semi-arid"),
            dry.subhumid = sum(cat.AIu == "Dry subhumid"),
            humid = sum(cat.AIu == "Humid"),
            na = sum(is.na(cat.AIu)),
            total = n())

ggplot(subset(table_calib, total > 10 & !is.na(hyperarid)), aes(x = Name))+
  geom_col(aes(y = hyperarid, fill = "Hyperarid"))+
  geom_col(aes(y = arid, fill = "Arid"))+
  geom_col(aes(y = semi.arid, fill = "Semi-arid"))+
  geom_col(aes(y = dry.subhumid, fill = "Dry subhumid"))+
  geom_col(aes(y = humid, fill = "Humid"))+
  scale_fill_manual(values = col.cat)+
  theme_minimal()+
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5))+
  facet_grid(rows = vars(source), switch = "y")+
  labs(x = "IPCC Region", y = "Count", fill = "Aridity\ncategory")



```

# Plots for AI -----


## By source

```{r AIm-by-source}
for(i in unique(clim$source)){
  plottitle <- paste(i, "historical, 1970-2000", sep = ", ")
  g <- ggplot(data = filter(clim, period == "1970_2000" & source == i)) + geom_raster(aes(x=lon, y = lat,  fill = cat.AIm))+
    scale_fill_manual(values = col.martonne)+
    labs(title = paste(i, "Historical, 1970-2000", sep = ","), fill = "")+
    theme_void()+
    theme(legend.position = "bottom")
  print(g)
}
```

```{r AIu-by-source}
for(i in unique(clim$source)){
  plottitle <- paste(i, "historical, 1970-2000", sep = ", ")
  g <- ggplot(data = filter(clim, period == "1970_2000" & source == i)) + geom_raster(aes(x=lon, y = lat,  fill = cat.AIu))+
    scale_fill_manual(values = col.cat)+
    labs(title = paste(i, "Historical, 1970-2000", sep = ","), fill = "")+
    theme_void()+
    theme(legend.position = "bottom")
  print(g)
}
```

## Multimodel average ----

```{r mean-by-period-SSP245}
ggplot(data = subset(clim_sum, period == "1850_1880")) + geom_raster(aes(x=lon, y = lat,  fill = cat.AIu))+
  scale_fill_manual(values = col.cat)+
  labs(title = "Historical, 1850-1880", fill = "")+
  theme_void()+
  theme(legend.position = "bottom")

ggplot(data = subset(clim_sum, period == "1970_2000")) + geom_raster(aes(x=lon, y = lat,  fill = cat.AIu))+
  scale_fill_manual(values = col.cat)+
  labs(title = "Historical, 1970-2000", fill = "")+
  theme_void()+
  theme(legend.position = "bottom")

# ggplot(data = subset(clim_sum, period == "1985_2015")) + geom_raster(aes(x=lon, y = lat,  fill = cat.AIu))+
#     scale_fill_manual(values = col.cat)+
#     labs(title = "Historical, 1985-2015", fill = "")+
#     theme_void()

ggplot(data = subset(clim_sum, period == "2030_2060" & model == "SSP245")) + geom_raster(aes(x=lon, y = lat,  fill = cat.AIu))+
  scale_fill_manual(values = col.cat)+
  labs(title = "SSP245, 2030-2060", fill = "")+
  theme_void()+
  theme(legend.position = "bottom")

ggplot(data = subset(clim_sum, period == "2070_2100" & model == "SSP245")) + geom_raster(aes(x=lon, y = lat,  fill = cat.AIu))+
  scale_fill_manual(values = col.cat)+
  labs(title = "SSP245, 2070-2100", fill = "")+
  theme_void()+
  theme(legend.position = "bottom")
```
```{r mean-by-period-SSP370}
ggplot(data = subset(clim_sum, period == "1850_1880")) + geom_raster(aes(x=lon, y = lat,  fill = cat.AIu))+
  scale_fill_manual(values = col.cat)+
  labs(title = "Historical, 1850-1880", fill = "")+
  theme_void()+
  theme(legend.position = "bottom")

ggplot(data = subset(clim_sum, period == "1970_2000")) + geom_raster(aes(x=lon, y = lat,  fill = cat.AIu))+
  scale_fill_manual(values = col.cat)+
  labs(title = "Historical, 1970-2000", fill = "")+
  theme_void()+
  theme(legend.position = "bottom")

# ggplot(data = subset(clim_sum, period == "1985_2015")) + geom_raster(aes(x=lon, y = lat,  fill = cat.AIu))+
#     scale_fill_manual(values = col.cat)+
#     labs(title = "Historical, 1985-2015", fill = "")+
#     theme_void()

ggplot(data = subset(clim_sum, period == "2030_2060" & model == "SSP370")) + geom_raster(aes(x=lon, y = lat,  fill = cat.AIu))+
  scale_fill_manual(values = col.cat)+
  labs(title = "SSP370, 2030-2060", fill = "")+
  theme_void()+
  theme(legend.position = "bottom")

ggplot(data = subset(clim_sum, period == "2070_2100" & model == "SSP370")) + geom_raster(aes(x=lon, y = lat,  fill = cat.AIu))+
  scale_fill_manual(values = col.cat)+
  labs(title = "SSP370, 2070-2100", fill = "")+
  theme_void()+
  theme(legend.position = "bottom")
```
```{r mean-by-period-SSP585}
ggplot(data = subset(clim_sum, period == "1850_1880")) + geom_raster(aes(x=lon, y = lat,  fill = cat.AIu))+
  scale_fill_manual(values = col.cat)+
  labs(title = "Historical, 1850-1880", fill = "")+
  theme_void()+
  theme(legend.position = "bottom")

ggplot(data = subset(clim_sum, period == "1970_2000")) + geom_raster(aes(x=lon, y = lat,  fill = cat.AIu))+
  scale_fill_manual(values = col.cat)+
  labs(title = "Historical, 1970-2000", fill = "")+
  theme_void()+
  theme(legend.position = "bottom")

# ggplot(data = subset(clim_sum, period == "1985_2015")) + geom_raster(aes(x=lon, y = lat,  fill = cat.AIu))+
#     scale_fill_manual(values = col.cat)+
#     labs(title = "Historical, 1985-2015", fill = "")+
#     theme_void()

ggplot(data = subset(clim_sum, period == "2030_2060" & model == "SSP585")) + geom_raster(aes(x=lon, y = lat,  fill = cat.AIu))+
  scale_fill_manual(values = col.cat)+
  labs(title = "SSP585, 2030-2060", fill = "")+
  theme_void()+
  theme(legend.position = "bottom")

ggplot(data = subset(clim_sum, period == "2070_2100" & model == "SSP585")) + geom_raster(aes(x=lon, y = lat,  fill = cat.AIu))+
  scale_fill_manual(values = col.cat)+
  labs(title = "SSP585, 2070-2100", fill = "")+
  theme_void()+
  theme(legend.position = "bottom")
```

# Plots for ts ----

## By source


```{r plot-1850_1880-ts-by-model}
for(i in unique(clim$source)){
  plottitle <- paste(i, "historical, 1850-1880", sep = ", ")
  g <- ggplot(data = filter(clim, period == "1850_1880" & source == i)) + geom_raster(aes(x=lon, y = lat,  fill = ts-273.15))+
    scale_fill_continuous_divergingx(palette = "RdYlBu", rev = T, mid = 0, limits = c(-60,40))+
    labs(title = plottitle, fill = "")+
    theme_void()+
    theme(legend.position = "bottom")
  print(g)
}

```

```{r plot-historical-ts-by-model}
for(i in unique(clim$source)){
  plottitle <- paste(i, "historical, 1970-2000", sep = ", ")
  g <- ggplot(data = filter(clim, period == "1970_2000" & source == i)) + geom_raster(aes(x=lon, y = lat,  fill = ts-273.15))+
    scale_fill_continuous_divergingx(palette = "RdYlBu", rev = T, mid = 0, limits = c(-60,40))+
    labs(title = plottitle, fill = "")+
    theme_void()+
    theme(legend.position = "bottom")
  print(g)
}
```
```{r plot-historical-1985-2015-ts-by-model}
for(i in unique(clim$source)){
  plottitle <- paste(i, "historical, 1985-2015", sep = ", ")
  g <- ggplot(data = filter(clim, period == "1985_2015" & source == i)) + geom_raster(aes(x=lon, y = lat,  fill = ts-273.15))+
    scale_fill_continuous_divergingx(palette = "RdYlBu", rev = T, mid = 0, limits = c(-60,40))+
    labs(title = plottitle, fill = "")+
    theme_void()+
    theme(legend.position = "bottom")
  print(g)
}
```

```{r plot-SSP245-2030-2060-ts-by-model}
for(i in unique(clim$source)){
  plottitle <- paste(i, "SSP245, 2030-2060", sep = ", ")
  g <- ggplot(data = filter(clim, period == "2030_2060" & source == i)) + geom_raster(aes(x=lon, y = lat,  fill = ts-273.15))+
    scale_fill_continuous_divergingx(palette = "RdYlBu", rev = T, mid = 0, limits = c(-60,40))+
    labs(title = plottitle, fill = "")+
    theme_void()+
    theme(legend.position = "bottom")
  print(g)
}
```

```{r plot-SSP245-ts-by-model}
for(i in unique(clim$source)){
  plottitle <- paste(i, "SSP245, 2070-2100", sep = ", ")
  g <- ggplot(data = filter(clim, period == "2070_2100" & source == i)) + geom_raster(aes(x=lon, y = lat,  fill = ts-273.15))+
    scale_fill_continuous_divergingx(palette = "RdYlBu", rev = T, mid = 0, limits = c(-60,40))+
    labs(title = plottitle, fill = "")+
    theme_void()+
    theme(legend.position = "bottom")
  print(g)
}
```

```{r plot-SSP370-2030-2060-ts-by-model}
for(i in unique(clim$source)){
  plottitle <- paste(i, "SSP370, 2030-2060", sep = ", ")
  g <- ggplot(data = filter(clim, period == "2030_2060" & source == i & model == "SSP370")) + geom_raster(aes(x=lon, y = lat,  fill = ts-273.15))+
    scale_fill_continuous_divergingx(palette = "RdYlBu", rev = T, mid = 0, limits = c(-60,40))+
    labs(title = plottitle, fill = "")+
    theme_void()+
    theme(legend.position = "bottom")
  print(g)
}
```

```{r plot-SSP370-ts-by-model}
for(i in unique(clim$source)){
  plottitle <- paste(i, "SSP370, 2070-2100", sep = ", ")
  g <- ggplot(data = filter(clim, period == "2070_2100" & source == i & model == "SSP370")) + geom_raster(aes(x=lon, y = lat,  fill = ts-273.15))+
    scale_fill_continuous_divergingx(palette = "RdYlBu", rev = T, mid = 0, limits = c(-60,40))+
    labs(title = plottitle, fill = "")+
    theme_void()+
    theme(legend.position = "bottom")
  print(g)
}
```
```{r plot-SSP585-2030-2060-ts-by-model}
for(i in unique(clim$source)){
  plottitle <- paste(i, "SSP585, 2030-2060", sep = ", ")
  g <- ggplot(data = filter(clim, period == "2030_2060" & source == i & model == "SSP585")) + geom_raster(aes(x=lon, y = lat,  fill = ts-273.15))+
    scale_fill_continuous_divergingx(palette = "RdYlBu", rev = T, mid = 0, limits = c(-60,40))+
    labs(title = plottitle, fill = "")+
    theme_void()+
    theme(legend.position = "bottom")
  print(g)
}
```

```{r plot-SSP585-ts-by-model}
for(i in unique(clim$source)){
  plottitle <- paste(i, "SSP585, 2070-2100", sep = ", ")
  g <- ggplot(data = filter(clim, period == "2070_2100" & source == i & model == "SSP585")) + geom_raster(aes(x=lon, y = lat,  fill = ts-273.15))+
    scale_fill_continuous_divergingx(palette = "RdYlBu", rev = T, mid = 0, limits = c(-60,40))+
    labs(title = plottitle, fill = "")+
    theme_void()+
    theme(legend.position = "bottom")
  print(g)
}
```
## Multimodel average

```{r mean-by-period-SSP245-ts}
ggplot(data = subset(clim_sum, period == "1850_1880")) + geom_raster(aes(x=lon, y = lat,  fill = ts-273.15))+
  scale_fill_distiller(type = "div", palette = 7, direction = -1, limits = c(-60,35))+
  labs(title = "Historical, 1850-1880", fill = "Average annual surface temperature, °C")+
  theme_void()+
  theme(legend.position = "bottom")

ggplot(data = subset(clim_sum, period == "1970_2000")) + geom_raster(aes(x=lon, y = lat,  fill = ts-273.15))+
  scale_fill_distiller(type = "div", palette = 7, direction = -1, limits = c(-60,35))+
  labs(title = "Historical, 1970-2000", fill = "Average annual surface temperature, °C")+
  theme_void()+
  theme(legend.position = "bottom")

ggplot(data = subset(clim_sum, period == "2030_2060" & model == "SSP245")) + geom_raster(aes(x=lon, y = lat,  fill = ts-273.15))+
  scale_fill_distiller(type = "div", palette = 7, direction = -1, limits = c(-60,35))+
  labs(title = "SSP245, 2030-2060", fill = "Average annual surface temperature, °C")+
  theme_void()+
  theme(legend.position = "bottom")

ggplot(data = subset(clim_sum, period == "2070_2100" & model == "SSP245")) + geom_raster(aes(x=lon, y = lat,  fill = ts-273.15))+
  scale_fill_distiller(type = "div", palette = 7, direction = -1, limits = c(-60,35))+
  labs(title = "SSP245, 2030-2060", fill = "Average annual surface temperature, °C")+
  theme_void()+
  theme(legend.position = "bottom")
```

```{r mean-by-period-SSP370-ts}
ggplot(data = subset(clim_sum, period == "1850_1880")) + geom_raster(aes(x=lon, y = lat,  fill = ts-273.15))+
  scale_fill_distiller(type = "div", palette = 7, direction = -1, limits = c(-60,35))+
  labs(title = "Historical, 1850-1880", fill = "Average annual surface temperature, °C")+
  theme_void()+
  theme(legend.position = "bottom")

ggplot(data = subset(clim_sum, period == "1970_2000")) + geom_raster(aes(x=lon, y = lat,  fill = ts-273.15))+
  scale_fill_distiller(type = "div", palette = 7, direction = -1, limits = c(-60,35))+
  labs(title = "Historical, 1970-2000", fill = "Average annual surface temperature, °C")+
  theme_void()+
  theme(legend.position = "bottom")

ggplot(data = subset(clim_sum, period == "2030_2060" & model == "SSP370")) + geom_raster(aes(x=lon, y = lat,  fill = ts-273.15))+
  scale_fill_distiller(type = "div", palette = 7, direction = -1, limits = c(-60,35))+
  labs(title = "SSP370, 2030-2060", fill = "Average annual surface temperature, °C")+
  theme_void()+
  theme(legend.position = "bottom")

ggplot(data = subset(clim_sum, period == "2070_2100" & model == "SSP370")) + geom_raster(aes(x=lon, y = lat,  fill = ts-273.15))+
  scale_fill_distiller(type = "div", palette = 7, direction = -1, limits = c(-60,35))+
  labs(title = "SSP370, 2030-2060", fill = "Average annual surface temperature, °C")+
  theme_void()+
  theme(legend.position = "bottom")
```

```{r mean-by-period-SSP585-ts}
ggplot(data = subset(clim_sum, period == "1850_1880")) + geom_raster(aes(x=lon, y = lat,  fill = ts-273.15))+
  scale_fill_distiller(type = "div", palette = 7, direction = -1, limits = c(-60,35))+
  labs(title = "Historical, 1850-1880", fill = "Average annual surface temperature, °C")+
  theme_void()+
  theme(legend.position = "bottom")

ggplot(data = subset(clim_sum, period == "1970_2000")) + geom_raster(aes(x=lon, y = lat,  fill = ts-273.15))+
  scale_fill_distiller(type = "div", palette = 7, direction = -1, limits = c(-60,35))+
  labs(title = "Historical, 1970-2000", fill = "Average annual surface temperature, °C")+
  theme_void()+
  theme(legend.position = "bottom")

ggplot(data = subset(clim_sum, period == "2030_2060" & model == "SSP585")) + geom_raster(aes(x=lon, y = lat,  fill = ts-273.15))+
  scale_fill_distiller(type = "div", palette = 7, direction = -1, limits = c(-60,35))+
  labs(title = "SSP585, 2030-2060", fill = "Average annual surface temperature, °C")+
  theme_void()+
  theme(legend.position = "bottom")

ggplot(data = subset(clim_sum, period == "2070_2100" & model == "SSP585")) + geom_raster(aes(x=lon, y = lat,  fill = ts-273.15))+
  scale_fill_distiller(type = "div", palette = 7, direction = -1, limits = c(-60,35))+
  labs(title = "SSP585, 2030-2060", fill = "Average annual surface temperature, °C")+
  theme_void()+
  theme(legend.position = "bottom")
```

# Plots for pr ----

## By source

```{r plot-1850_1880-pr-by-model}
for(i in unique(clim$source)){
  plottitle <- paste(i, "historical, 1850-1880", sep = ", ")
  g <- ggplot(data = filter(clim, period == "1850_1880" & source == i)) + geom_raster(aes(x=lon, y = lat,  fill = pr*60*60*24*365))+
    scale_fill_continuous_sequential(palette = "Purple-Blue", rev = T, limits = c(0,8000))+
    labs(title = plottitle, fill = "")+
    theme_void()+
    theme(legend.position = "bottom")
  print(g)
}
```

```{r plot-historical-pr-by-model}
for(i in unique(clim$source)){
  plottitle <- paste(i, "historical, 1970-2000", sep = ", ")
  g <- ggplot(data = filter(clim, period == "1970_2000" & source == i)) + geom_raster(aes(x=lon, y = lat,  fill = pr*60*60*24*365))+
    scale_fill_continuous_sequential(palette = "Purple-Blue", rev = T, limits = c(0,8000))+
    labs(title = plottitle, fill = "")+
    theme_void()+
    theme(legend.position = "bottom")
  print(g)
}
```
```{r plot-SSP245-2030-2060-pr-by-model}
for(i in unique(clim$source)){
  plottitle <- paste(i, "SSP245, 2030-2060", sep = ", ")
  g <- ggplot(data = filter(clim, period == "2030_2060" & source == i)) + geom_raster(aes(x=lon, y = lat,  fill = pr*60*60*24*365))+
    scale_fill_continuous_sequential(palette = "Purple-Blue", rev = T, limits = c(0,8000))+
    labs(title = plottitle, fill = "")+
    theme_void()+
    theme(legend.position = "bottom")
  print(g)
}
```

```{r plot-SSP245-pr-by-model}
for(i in unique(clim$source)){
  plottitle <- paste(i, "SSP245, 2070-2100", sep = ", ")
  g <- ggplot(data = filter(clim, period == "2070_2100" & source == i)) + geom_raster(aes(x=lon, y = lat,  fill = pr*60*60*24*365))+
    scale_fill_continuous_sequential(palette = "Purple-Blue", rev = T, limits = c(0,8000))+
    labs(title = plottitle, fill = "")+
    theme_void()+
    theme(legend.position = "bottom")
  print(g)
}
```

```{r plot-SSP370-2030-2060-pr-by-model}
for(i in unique(clim$source)){
  plottitle <- paste(i, "SSP370, 2030-2060", sep = ", ")
  g <- ggplot(data = filter(clim, period == "2030_2060" & source == i & model == "SSP370")) + geom_raster(aes(x=lon, y = lat,  fill = pr*60*60*24*365))+
    scale_fill_continuous_sequential(palette = "Purple-Blue", rev = T, limits = c(0,8000))+
    labs(title = plottitle, fill = "")+
    theme_void()+
    theme(legend.position = "bottom")
  print(g)
}
```

```{r plot-SSP370-pr-by-model}
for(i in unique(clim$source)){
  plottitle <- paste(i, "SSP370, 2070-2100", sep = ", ")
  g <- ggplot(data = filter(clim, period == "2070_2100" & source == i & model == "SSP370")) + geom_raster(aes(x=lon, y = lat,  fill = pr*60*60*24*365))+
    scale_fill_continuous_sequential(palette = "Purple-Blue", rev = T, limits = c(0,8000))+
    labs(title = plottitle, fill = "")+
    theme_void()+
    theme(legend.position = "bottom")
  print(g)
}
```
```{r plot-SSP585-2030-2060-pr-by-model}
for(i in unique(clim$source)){
  plottitle <- paste(i, "SSP585, 2030-2060", sep = ", ")
  g <- ggplot(data = filter(clim, period == "2030_2060" & source == i & model == "SSP585")) + geom_raster(aes(x=lon, y = lat,  fill = pr*60*60*24*365))+
    scale_fill_continuous_sequential(palette = "Purple-Blue", rev = T, limits = c(0,8000))+
    labs(title = plottitle, fill = "")+
    theme_void()+
    theme(legend.position = "bottom")
  print(g)
}
```

```{r plot-SSP585-pr-by-model}
for(i in unique(clim$source)){
  plottitle <- paste(i, "SSP585, 2070-2100", sep = ", ")
  g <- ggplot(data = filter(clim, period == "2070_2100" & source == i & model == "SSP585")) + geom_raster(aes(x=lon, y = lat,  fill = pr*60*60*24*365))+
    scale_fill_continuous_sequential(palette = "Purple-Blue", rev = T, limits = c(0,8000))+
    labs(title = plottitle, fill = "")+
    theme_void()+
    theme(legend.position = "bottom")
  print(g)
}
```

## Multimodal average

```{r mean-by-period-SSP245-pr}
ggplot(data = subset(clim_sum, period == "1850_1880")) + geom_raster(aes(x=lon, y = lat,  fill = pr*60*60*24*365))+
  scale_fill_distiller(type = "seq", palette = 1, direction = 1, na.value = "white")+
  labs(title = "Historical, 1850-1880", fill = "Average annual precipitation, mm")+
  theme_void()+
  theme(legend.position = "bottom") 


ggplot(data = subset(clim_sum, period == "1970_2000")) + geom_raster(aes(x=lon, y = lat,   fill = pr*60*60*24*365))+
  scale_fill_distiller(type = "seq", palette = 1, direction = 1, na.value = "white")+
  labs(title = "Historical, 1970-2000", fill = "Average annual precipitation, mm")+
  theme_void()+
  theme(legend.position = "bottom") 

ggplot(data = subset(clim_sum, period == "2030_2060" & model == "SSP245")) + geom_raster(aes(x=lon, y = lat, fill = pr*60*60*24*365))+
  scale_fill_distiller(type = "seq", palette = 1, direction = 1, na.value = "white")+
  labs(title = "SSP245, 2030-2060", fill = "Average annual precipitation, mm")+
  theme_void()+
  theme(legend.position = "bottom") 

ggplot(data = subset(clim_sum, period == "2070_2100" & model == "SSP245")) + geom_raster(aes(x=lon, y = lat,   fill = pr*60*60*24*365))+
  scale_fill_distiller(type = "seq", palette = 1, direction = 1, na.value = "white")+
  labs(title = "SSP245, 2070-21000", fill = "Average annual precipitation, mm")+
  theme_void()+
  theme(legend.position = "bottom") 
```

```{r mean-by-period-SSP370-pr}
ggplot(data = subset(clim_sum, period == "1850_1880")) + geom_raster(aes(x=lon, y = lat,  fill = pr*60*60*24*365))+
  scale_fill_distiller(type = "seq", palette = 1, direction = 1, na.value = "white")+
  labs(title = "Historical, 1850-1880", fill = "Average annual precipitation, mm")+
  theme_void()+
  theme(legend.position = "bottom") 


ggplot(data = subset(clim_sum, period == "1970_2000")) + geom_raster(aes(x=lon, y = lat,   fill = pr*60*60*24*365))+
  scale_fill_distiller(type = "seq", palette = 1, direction = 1, na.value = "white")+
  labs(title = "Historical, 1970-2000", fill = "Average annual precipitation, mm")+
  theme_void()+
  theme(legend.position = "bottom") 

ggplot(data = subset(clim_sum, period == "2030_2060" & model == "SSP370")) + geom_raster(aes(x=lon, y = lat, fill = pr*60*60*24*365))+
  scale_fill_distiller(type = "seq", palette = 1, direction = 1, na.value = "white")+
  labs(title = "SSP370, 2030-2060", fill = "Average annual precipitation, mm")+
  theme_void()+
  theme(legend.position = "bottom") 

ggplot(data = subset(clim_sum, period == "2070_2100" & model == "SSP370")) + geom_raster(aes(x=lon, y = lat,   fill = pr*60*60*24*365))+
  scale_fill_distiller(type = "seq", palette = 1, direction = 1, na.value = "white")+
  labs(title = "SSP370, 2070-21000", fill = "Average annual precipitation, mm")+
  theme_void()+
  theme(legend.position = "bottom") 
```

```{r mean-by-period-SSP585-pr}
ggplot(data = subset(clim_sum, period == "1850_1880")) + geom_raster(aes(x=lon, y = lat,  fill = pr*60*60*24*365))+
  scale_fill_distiller(type = "seq", palette = 1, direction = 1, na.value = "white")+
  labs(title = "Historical, 1850-1880", fill = "Average annual precipitation, mm")+
  theme_void()+
  theme(legend.position = "bottom") 


ggplot(data = subset(clim_sum, period == "1970_2000")) + geom_raster(aes(x=lon, y = lat,   fill = pr*60*60*24*365))+
  scale_fill_distiller(type = "seq", palette = 1, direction = 1, na.value = "white")+
  labs(title = "Historical, 1970-2000", fill = "Average annual precipitation, mm")+
  theme_void()+
  theme(legend.position = "bottom") 

ggplot(data = subset(clim_sum, period == "2030_2060" & model == "SSP585")) + geom_raster(aes(x=lon, y = lat, fill = pr*60*60*24*365))+
  scale_fill_distiller(type = "seq", palette = 1, direction = 1, na.value = "white")+
  labs(title = "SSP585, 2030-2060", fill = "Average annual precipitation, mm")+
  theme_void()+
  theme(legend.position = "bottom") 

ggplot(data = subset(clim_sum, period == "2070_2100" & model == "SSP585")) + geom_raster(aes(x=lon, y = lat,   fill = pr*60*60*24*365))+
  scale_fill_distiller(type = "seq", palette = 1, direction = 1, na.value = "white")+
  labs(title = "SSP585, 2070-21000", fill = "Average annual precipitation, mm")+
  theme_void()+
  theme(legend.position = "bottom") 
```


# Plots for rsds ----

## By source

```{r plot-1850_1880-rsds-by-model}
for(i in unique(clim$source)){
  plottitle <- paste(i, "historical, 1850-1880", sep = ", ")
  g <- ggplot(data = filter(clim, period == "1850_1880" & source == i)) + geom_raster(aes(x=lon, y = lat,  fill = rsds*86400*1e-6))+
    scale_fill_continuous_sequential(palette = "Sunset", rev = T, limits = c(0,30))+
    labs(title = plottitle, fill = "")+
    theme_void()+
    theme(legend.position = "bottom")
  print(g)
}
```

```{r plot-historical-rsds-by-model}
for(i in unique(clim$source)){
  plottitle <- paste(i, "historical, 1970-2000", sep = ", ")
  g <- ggplot(data = filter(clim, period == "1970_2000" & source == i)) + geom_raster(aes(x=lon, y = lat,  fill = rsds*86400*1e-6))+
    scale_fill_continuous_sequential(palette = "Sunset", rev = T, limits = c(0,30))+
    labs(title = plottitle, fill = "")+
    theme_void()+
    theme(legend.position = "bottom")
  print(g)
}
```

```{r plot-SSP245-2030-2060-rsds-by-model}
for(i in unique(clim$source)){
  plottitle <- paste(i, "SSP245, 2030-2060", sep = ", ")
  g <- ggplot(data = filter(clim, period == "2030_2060" & source == i)) + geom_raster(aes(x=lon, y = lat,  fill = rsds*86400*1e-6))+
    scale_fill_continuous_sequential(palette = "Sunset", rev = T, limits = c(0,30))+
    labs(title = plottitle, fill = "")+
    theme_void()+
    theme(legend.position = "bottom")
  print(g)
}
```

```{r plot-SSP245-rsds-by-model}
for(i in unique(clim$source)){
  plottitle <- paste(i, "SSP245, 2070-2100", sep = ", ")
  g <- ggplot(data = filter(clim, period == "2070_2100" & source == i)) + geom_raster(aes(x=lon, y = lat,  fill = rsds*86400*1e-6))+
    scale_fill_continuous_sequential(palette = "Sunset", rev = T, limits = c(0,30))+
    labs(title = plottitle, fill = "")+
    theme_void()+
    theme(legend.position = "bottom")
  print(g)
}
```

```{r plot-SSP370-2030-2060-rsds-by-model}
for(i in unique(clim$source)){
  plottitle <- paste(i, "SSP370, 2030-2060", sep = ", ")
  g <- ggplot(data = filter(clim, period == "2030_2060" & source == i & model == "SSP370")) + geom_raster(aes(x=lon, y = lat,  fill = rsds*86400*1e-6))+
    scale_fill_continuous_sequential(palette = "Sunset", rev = T, limits = c(0,30))+
    labs(title = plottitle, fill = "")+
    theme_void()+
    theme(legend.position = "bottom")
  print(g)
}
```

```{r plot-SSP370-rsds-by-model}
for(i in unique(clim$source)){
  plottitle <- paste(i, "SSP370, 2070-2100", sep = ", ")
  g <- ggplot(data = filter(clim, period == "2070_2100" & source == i & model == "SSP370")) + geom_raster(aes(x=lon, y = lat,  fill = rsds*86400*1e-6))+
    scale_fill_continuous_sequential(palette = "Sunset", rev = T, limits = c(0,30))+
    labs(title = plottitle, fill = "")+
    theme_void()+
    theme(legend.position = "bottom")
  print(g)
}
```
```{r plot-SSP585-2030-2060-rsds-by-model}
for(i in unique(clim$source)){
  plottitle <- paste(i, "SSP585, 2030-2060", sep = ", ")
  g <- ggplot(data = filter(clim, period == "2030_2060" & source == i & model == "SSP585")) + geom_raster(aes(x=lon, y = lat,  fill = rsds*86400*1e-6))+
    scale_fill_continuous_sequential(palette = "Sunset", rev = T, limits = c(0,30))+
    labs(title = plottitle, fill = "")+
    theme_void()+
    theme(legend.position = "bottom")
  print(g)
}
```

```{r plot-SSP585-rsds-by-model}
for(i in unique(clim$source)){
  plottitle <- paste(i, "SSP585, 2070-2100", sep = ", ")
  g <- ggplot(data = filter(clim, period == "2070_2100" & source == i & model == "SSP585")) + geom_raster(aes(x=lon, y = lat,  fill = rsds*86400*1e-6))+
    scale_fill_continuous_sequential(palette = "Sunset", rev = T, limits = c(0,30))+
    labs(title = plottitle, fill = "")+
    theme_void()+
    theme(legend.position = "bottom")
  print(g)
}
```

## Multimodal average

```{r mean-by-period-SSP245-rsds}
ggplot(data = subset(clim_sum, period == "1850_1880")) + geom_raster(aes(x=lon, y = lat,  fill = rsds*86400*1e-6))+
  scale_fill_distiller(type = "seq", palette = 1, direction = 1, na.value = "white")+
  labs(title = "Historical, 1850-1880", fill = "Average annual precipitation, mm")+
  theme_void()+
  theme(legend.position = "bottom") 


ggplot(data = subset(clim_sum, period == "1970_2000")) + geom_raster(aes(x=lon, y = lat,   fill = rsds*86400*1e-6))+
  scale_fill_distiller(type = "seq", palette = 1, direction = 1, na.value = "white")+
  labs(title = "Historical, 1970-2000", fill = "Average annual precipitation, mm")+
  theme_void()+
  theme(legend.position = "bottom") 

ggplot(data = subset(clim_sum, period == "2030_2060" & model == "SSP245")) + geom_raster(aes(x=lon, y = lat, fill = rsds*86400*1e-6))+
  scale_fill_distiller(type = "seq", palette = 1, direction = 1, na.value = "white")+
  labs(title = "SSP245, 2030-2060", fill = "Average annual precipitation, mm")+
  theme_void()+
  theme(legend.position = "bottom") 

ggplot(data = subset(clim_sum, period == "2070_2100" & model == "SSP245")) + geom_raster(aes(x=lon, y = lat,   fill = rsds*86400*1e-6))+
  scale_fill_distiller(type = "seq", palette = 1, direction = 1, na.value = "white")+
  labs(title = "SSP245, 2070-21000", fill = "Average annual precipitation, mm")+
  theme_void()+
  theme(legend.position = "bottom") 
```

```{r mean-by-period-SSP370-rsds}
ggplot(data = subset(clim_sum, period == "1850_1880")) + geom_raster(aes(x=lon, y = lat,  fill = rsds*86400*1e-6))+
  scale_fill_distiller(type = "seq", palette = 1, direction = 1, na.value = "white")+
  labs(title = "Historical, 1850-1880", fill = "Average annual precipitation, mm")+
  theme_void()+
  theme(legend.position = "bottom") 


ggplot(data = subset(clim_sum, period == "1970_2000")) + geom_raster(aes(x=lon, y = lat,   fill = rsds*86400*1e-6))+
  scale_fill_distiller(type = "seq", palette = 1, direction = 1, na.value = "white")+
  labs(title = "Historical, 1970-2000", fill = "Average annual precipitation, mm")+
  theme_void()+
  theme(legend.position = "bottom") 

ggplot(data = subset(clim_sum, period == "2030_2060" & model == "SSP370")) + geom_raster(aes(x=lon, y = lat, fill = rsds*86400*1e-6))+
  scale_fill_distiller(type = "seq", palette = 1, direction = 1, na.value = "white")+
  labs(title = "SSP370, 2030-2060", fill = "Average annual precipitation, mm")+
  theme_void()+
  theme(legend.position = "bottom") 

ggplot(data = subset(clim_sum, period == "2070_2100" & model == "SSP370")) + geom_raster(aes(x=lon, y = lat,   fill = rsds*86400*1e-6))+
  scale_fill_distiller(type = "seq", palette = 1, direction = 1, na.value = "white")+
  labs(title = "SSP370, 2070-21000", fill = "Average annual precipitation, mm")+
  theme_void()+
  theme(legend.position = "bottom") 
```

```{r mean-by-period-SSP585-rsds}
ggplot(data = subset(clim_sum, period == "1850_1880")) + geom_raster(aes(x=lon, y = lat,  fill = rsds*86400*1e-6))+
  scale_fill_distiller(type = "seq", palette = 1, direction = 1, na.value = "white")+
  labs(title = "Historical, 1850-1880", fill = "Average annual precipitation, mm")+
  theme_void()+
  theme(legend.position = "bottom") 


ggplot(data = subset(clim_sum, period == "1970_2000")) + geom_raster(aes(x=lon, y = lat,   fill = rsds*86400*1e-6))+
  scale_fill_distiller(type = "seq", palette = 1, direction = 1, na.value = "white")+
  labs(title = "Historical, 1970-2000", fill = "Average annual precipitation, mm")+
  theme_void()+
  theme(legend.position = "bottom") 

ggplot(data = subset(clim_sum, period == "2030_2060" & model == "SSP585")) + geom_raster(aes(x=lon, y = lat, fill = rsds*86400*1e-6))+
  scale_fill_distiller(type = "seq", palette = 1, direction = 1, na.value = "white")+
  labs(title = "SSP585, 2030-2060", fill = "Average annual precipitation, mm")+
  theme_void()+
  theme(legend.position = "bottom") 

ggplot(data = subset(clim_sum, period == "2070_2100" & model == "SSP585")) + geom_raster(aes(x=lon, y = lat,   fill = rsds*86400*1e-6))+
  scale_fill_distiller(type = "seq", palette = 1, direction = 1, na.value = "white")+
  labs(title = "SSP585, 2070-21000", fill = "Average annual precipitation, mm")+
  theme_void()+
  theme(legend.position = "bottom") 
```


# Plots for sfcWind ----

## By source

```{r plot-1850_1880-sfcWind-by-model}
for(i in unique(clim$source)){
  plottitle <- paste(i, "historical, 1850-1880", sep = ", ")
  g <- ggplot(data = filter(clim, period == "1850_1880" & source == i)) + geom_raster(aes(x=lon, y = lat,  fill = sfcWind))+
    # scale_fill_continuous_sequential(palette = "Sunset", rev = T, limits = c(0,30))+
    labs(title = plottitle, fill = "")+
    theme_void()+
    theme(legend.position = "bottom")
  print(g)
}
```

```{r plot-historical-sfcWind-by-model}
for(i in unique(clim$source)){
  plottitle <- paste(i, "historical, 1970-2000", sep = ", ")
  g <- ggplot(data = filter(clim, period == "1970_2000" & source == i)) + geom_raster(aes(x=lon, y = lat,  fill = sfcWind))+
    scale_fill_continuous_sequential(palette = "Sunset", rev = T, limits = c(0,30))+
    labs(title = plottitle, fill = "")+
    theme_void()+
    theme(legend.position = "bottom")
  print(g)
}
```

```{r plot-SSP245-2030-2060-sfcWind-by-model}
for(i in unique(clim$source)){
  plottitle <- paste(i, "SSP245, 2030-2060", sep = ", ")
  g <- ggplot(data = filter(clim, period == "2030_2060" & source == i)) + geom_raster(aes(x=lon, y = lat,  fill = sfcWind))+
    scale_fill_continuous_sequential(palette = "Sunset", rev = T, limits = c(0,30))+
    labs(title = plottitle, fill = "")+
    theme_void()+
    theme(legend.position = "bottom")
  print(g)
}
```

```{r plot-SSP245-sfcWind-by-model}
for(i in unique(clim$source)){
  plottitle <- paste(i, "SSP245, 2070-2100", sep = ", ")
  g <- ggplot(data = filter(clim, period == "2070_2100" & source == i)) + geom_raster(aes(x=lon, y = lat,  fill = sfcWind))+
    scale_fill_continuous_sequential(palette = "Sunset", rev = T, limits = c(0,30))+
    labs(title = plottitle, fill = "")+
    theme_void()+
    theme(legend.position = "bottom")
  print(g)
}
```

```{r plot-SSP370-2030-2060-sfcWind-by-model}
for(i in unique(clim$source)){
  plottitle <- paste(i, "SSP370, 2030-2060", sep = ", ")
  g <- ggplot(data = filter(clim, period == "2030_2060" & source == i & model == "SSP370")) + geom_raster(aes(x=lon, y = lat,  fill = sfcWind))+
    scale_fill_continuous_sequential(palette = "Sunset", rev = T, limits = c(0,30))+
    labs(title = plottitle, fill = "")+
    theme_void()+
    theme(legend.position = "bottom")
  print(g)
}
```

```{r plot-SSP370-sfcWind-by-model}
for(i in unique(clim$source)){
  plottitle <- paste(i, "SSP370, 2070-2100", sep = ", ")
  g <- ggplot(data = filter(clim, period == "2070_2100" & source == i & model == "SSP370")) + geom_raster(aes(x=lon, y = lat,  fill = sfcWind))+
    scale_fill_continuous_sequential(palette = "Sunset", rev = T, limits = c(0,30))+
    labs(title = plottitle, fill = "")+
    theme_void()+
    theme(legend.position = "bottom")
  print(g)
}
```
```{r plot-SSP585-2030-2060-sfcWind-by-model}
for(i in unique(clim$source)){
  plottitle <- paste(i, "SSP585, 2030-2060", sep = ", ")
  g <- ggplot(data = filter(clim, period == "2030_2060" & source == i & model == "SSP585")) + geom_raster(aes(x=lon, y = lat,  fill = sfcWind))+
    scale_fill_continuous_sequential(palette = "Sunset", rev = T, limits = c(0,30))+
    labs(title = plottitle, fill = "")+
    theme_void()+
    theme(legend.position = "bottom")
  print(g)
}
```

```{r plot-SSP585-sfcWind-by-model}
for(i in unique(clim$source)){
  plottitle <- paste(i, "SSP585, 2070-2100", sep = ", ")
  g <- ggplot(data = filter(clim, period == "2070_2100" & source == i & model == "SSP585")) + geom_raster(aes(x=lon, y = lat,  fill = sfcWind))+
    scale_fill_continuous_sequential(palette = "Sunset", rev = T, limits = c(0,30))+
    labs(title = plottitle, fill = "")+
    theme_void()+
    theme(legend.position = "bottom")
  print(g)
}
```

## Multimodal average

```{r mean-by-period-SSP245-sfcWind}
ggplot(data = subset(clim_sum, period == "1850_1880")) + geom_raster(aes(x=lon, y = lat,  fill = sfcWind))+
  scale_fill_distiller(type = "seq", palette = 1, direction = 1, na.value = "white")+
  labs(title = "Historical, 1850-1880", fill = "Average annual precipitation, mm")+
  theme_void()+
  theme(legend.position = "bottom") 


ggplot(data = subset(clim_sum, period == "1970_2000")) + geom_raster(aes(x=lon, y = lat,   fill = sfcWind))+
  scale_fill_distiller(type = "seq", palette = 1, direction = 1, na.value = "white")+
  labs(title = "Historical, 1970-2000", fill = "Average annual precipitation, mm")+
  theme_void()+
  theme(legend.position = "bottom") 

ggplot(data = subset(clim_sum, period == "2030_2060" & model == "SSP245")) + geom_raster(aes(x=lon, y = lat, fill = sfcWind))+
  scale_fill_distiller(type = "seq", palette = 1, direction = 1, na.value = "white")+
  labs(title = "SSP245, 2030-2060", fill = "Average annual precipitation, mm")+
  theme_void()+
  theme(legend.position = "bottom") 

ggplot(data = subset(clim_sum, period == "2070_2100" & model == "SSP245")) + geom_raster(aes(x=lon, y = lat,   fill = sfcWind))+
  scale_fill_distiller(type = "seq", palette = 1, direction = 1, na.value = "white")+
  labs(title = "SSP245, 2070-21000", fill = "Average annual precipitation, mm")+
  theme_void()+
  theme(legend.position = "bottom") 
```

```{r mean-by-period-SSP370-sfcWind}
ggplot(data = subset(clim_sum, period == "1850_1880")) + geom_raster(aes(x=lon, y = lat,  fill = sfcWind))+
  scale_fill_distiller(type = "seq", palette = 1, direction = 1, na.value = "white")+
  labs(title = "Historical, 1850-1880", fill = "Average annual precipitation, mm")+
  theme_void()+
  theme(legend.position = "bottom") 


ggplot(data = subset(clim_sum, period == "1970_2000")) + geom_raster(aes(x=lon, y = lat,   fill = sfcWind))+
  scale_fill_distiller(type = "seq", palette = 1, direction = 1, na.value = "white")+
  labs(title = "Historical, 1970-2000", fill = "Average annual precipitation, mm")+
  theme_void()+
  theme(legend.position = "bottom") 

ggplot(data = subset(clim_sum, period == "2030_2060" & model == "SSP370")) + geom_raster(aes(x=lon, y = lat, fill = sfcWind))+
  scale_fill_distiller(type = "seq", palette = 1, direction = 1, na.value = "white")+
  labs(title = "SSP370, 2030-2060", fill = "Average annual precipitation, mm")+
  theme_void()+
  theme(legend.position = "bottom") 

ggplot(data = subset(clim_sum, period == "2070_2100" & model == "SSP370")) + geom_raster(aes(x=lon, y = lat,   fill = sfcWind))+
  scale_fill_distiller(type = "seq", palette = 1, direction = 1, na.value = "white")+
  labs(title = "SSP370, 2070-21000", fill = "Average annual precipitation, mm")+
  theme_void()+
  theme(legend.position = "bottom") 
```

```{r mean-by-period-SSP585-sfcWind}
ggplot(data = subset(clim_sum, period == "1850_1880")) + geom_raster(aes(x=lon, y = lat,  fill = sfcWind))+
  scale_fill_distiller(type = "seq", palette = 1, direction = 1, na.value = "white")+
  labs(title = "Historical, 1850-1880", fill = "Average annual precipitation, mm")+
  theme_void()+
  theme(legend.position = "bottom") 


ggplot(data = subset(clim_sum, period == "1970_2000")) + geom_raster(aes(x=lon, y = lat,   fill = sfcWind))+
  scale_fill_distiller(type = "seq", palette = 1, direction = 1, na.value = "white")+
  labs(title = "Historical, 1970-2000", fill = "Average annual precipitation, mm")+
  theme_void()+
  theme(legend.position = "bottom") 

ggplot(data = subset(clim_sum, period == "2030_2060" & model == "SSP585")) + geom_raster(aes(x=lon, y = lat, fill = sfcWind))+
  scale_fill_distiller(type = "seq", palette = 1, direction = 1, na.value = "white")+
  labs(title = "SSP585, 2030-2060", fill = "Average annual precipitation, mm")+
  theme_void()+
  theme(legend.position = "bottom") 

ggplot(data = subset(clim_sum, period == "2070_2100" & model == "SSP585")) + geom_raster(aes(x=lon, y = lat,   fill = sfcWind))+
  scale_fill_distiller(type = "seq", palette = 1, direction = 1, na.value = "white")+
  labs(title = "SSP585, 2070-21000", fill = "Average annual precipitation, mm")+
  theme_void()+
  theme(legend.position = "bottom") 
```

# Plots AI martonne

## By source

```{r plot-historical-AIm-by-model}
for(i in unique(clim$source)){
  plottitle <- paste(i, "historical, 1970-2000", sep = ", ")
  g <- ggplot(data = filter(clim, period == "1970_2000" & source == i)) + geom_raster(aes(x=lon, y = lat,  fill = cat.AIm))+
    scale_fill_manual(values = col.martonne, na.value = "gray")+
    labs(title = plottitle, fill = "")+
    theme_void()+
    theme(legend.position = "bottom")
  print(g)
}
```

```{r plot-SSP370-AIm-by-model}
for(i in unique(clim$source)){
  plottitle <- paste(i, "SSP370, 2070-2100", sep = ", ")
  g <- ggplot(data = filter(clim, period == "2070_2100" & model == "SSP370" & source == i)) + geom_raster(aes(x=lon, y = lat,  fill = cat.AIm))+
    scale_fill_manual(values = col.martonne, na.value = "gray")+
    labs(title = plottitle, fill = "")+
    theme_void()+
    theme(legend.position = "bottom")
  print(g)
}
``` 

## Multimodel average 

```{r mean-by-period-SSP370}
ggplot(data = subset(clim_sum, period == "1850_1880")) + geom_raster(aes(x=lon, y = lat,  fill = cat.AIm))+
  scale_fill_manual(values = col.martonne, na.value = "gray")+
  labs(title = "Historical, 1850-1880", fill = "")+
  theme_void()+
  theme(legend.position = "bottom")

ggplot(data = subset(clim_sum, period == "1970_2000")) + geom_raster(aes(x=lon, y = lat,  fill = cat.AIm))+
  scale_fill_manual(values = col.martonne, na.value = "gray")+
  labs(title = "Historical, 1970-2000", fill = "")+
  theme_void()+
  theme(legend.position = "bottom")

# ggplot(data = subset(clim_sum, period == "1985_2015")) + geom_raster(aes(x=lon, y = lat,  fill = cat.AIu))+
#     scale_fill_manual(values = col.cat)+
#     labs(title = "Historical, 1985-2015", fill = "")+
#     theme_void()

ggplot(data = subset(clim_sum, period == "2030_2060" & model == "SSP370")) + geom_raster(aes(x=lon, y = lat,  fill = cat.AIm))+
  scale_fill_manual(values = col.martonne, na.value = "gray")+
  labs(title = "SSP370, 2030-2060", fill = "")+
  theme_void()+
  theme(legend.position = "bottom")

ggplot(data = subset(clim_sum, period == "2070_2100" & model == "SSP370")) + geom_raster(aes(x=lon, y = lat,  fill = cat.AIm))+
  scale_fill_manual(values = col.martonne, na.value = "gray")+
  labs(title = "SSP370, 2070-2100", fill = "")+
  theme_void()+
  theme(legend.position = "bottom")
```


# One sample t test comparisaon with Worldclim

```{r data}
clim <- read.table("clim.txt")
clim_sum <- read.table("clim_sum.txt")
#clim_med <- read.table("clim_med.txt")

col.martonne <- c("Desert" = colorvec[2], "Arid"= colorvec[4],"Semi-arid"= colorvec[5], "Temperate" = colorvec[8], "Humid"= colorvec[10],"Forest"= colorvec[11])
col.cat <- c("Hyperarid" = colorvec[2], "Arid"= colorvec[4],"Semi-arid"= colorvec[5], "Dry subhumid" = colorvec[8], "Humid"= colorvec[10])
```

```{r ostt-function}
ostt <- function(v){
  x <- v[3:12]
  y <- v[13]
  p <- ifelse(is.na(y) == F,  t.test(x,mu = y ,na.action(na.omit))$p.value, NA)
  return(p)
} 
```

```{r one-sample-t-test-AIu}

wAIu <-  subset(clim, period == "1970_2000") %>% 
       select(c("lon","lat","source","AIu")) %>%
      reshape(direction = "wide", idvar = c("lon","lat"), v.names = "AIu", timevar = "source")

# sp <- sample_n(wAIu, 10)
# apply(sp[,3:12], 1, hist)

wAIu$pval <- apply(wAIu, 1, ostt)
table(wAIu$pval < 0.05)

ggplot() + geom_raster(data = subset(clim_sum, period == "1970_2000"), aes(x=lon, y = lat,  fill = cat.AIu))+
  geom_point(data = filter(wAIu, pval > 0.05), aes(x = lon, y = lat), col = "black", shape = ".", alpha = 0.5)+
  scale_fill_manual(values = col.cat)+
  labs(title = "CMIP6, T-test")+
  theme_void()+
  theme(legend.position = "bottom")

ggplot() + geom_raster(data = subset(clim, period == "1970_2000" & source == "Worldclim"), aes(x=lon, y = lat,  fill = cat.AIu))+
  geom_point(data = filter(wAIu, pval > 0.05), aes(x = lon, y = lat), col = "black", shape = ".", alpha = 0.5)+
  scale_fill_manual(values = col.cat)+
  labs(title = "Worldclim, T-test")+
  theme_void()+
  theme(legend.position = "bottom")
```

```{r one-sample-t-test-AIm}

wAIm <-  subset(clim, period == "1970_2000") %>% 
       select(c("lon","lat","source","AIm")) %>%
      reshape(direction = "wide", idvar = c("lon","lat"), v.names = "AIm", timevar = "source")

wAIm$pval <- apply(wAIm, 1, ostt)
table(wAIm$pval < 0.05)

ggplot() + geom_raster(data = subset(clim_sum, period == "1970_2000"), aes(x=lon, y = lat,  fill = cat.AIm))+
  geom_point(data = filter(wAIm, pval < 0.05), aes(x = lon, y = lat), col = "black", shape = ".")+
  scale_fill_manual(values = col.martonne)+
  theme_void()+
  theme(legend.position = "bottom")
```

```{r one-sample-t-test-ts}

wts <-  subset(clim, period == "1970_2000") %>% 
       select(c("lon","lat","source","ts")) %>%
      reshape(direction = "wide", idvar = c("lon","lat"), v.names = "ts", timevar = "source") 

wts$pval <- apply(wts, 1, ostt)

wts$ts.CMIP6 <- rowMeans(dplyr::select(wts, c("ts.AWI", "ts.BCC", "ts.CAMS", "ts.CESM", "ts.CMCC", "ts.CNRM", "ts.FGOALS", "ts.INM", "ts.MPI", "ts.MRI")), na.rm = T)

ggplot() + geom_raster(data =  wts, aes(x=lon, y = lat,  fill = ts.CMIP6-273.15))+
  geom_point(data = filter(wts, pval > 0.05), aes(x = lon, y = lat), col = "black", shape = ".")+
 scale_fill_continuous_divergingx(palette = "RdYlBu", rev = T, mid = 0, limits = c(-60,40), name = "Temperature, Celsius")+
  theme_void()+
  theme(legend.position = "bottom")

ggplot() + geom_raster(data = wts, aes(x=lon, y = lat,  fill = ts.Worldclim-273.15))+
  geom_point(data = filter(wts, pval > 0.05), aes(x = lon, y = lat), col = "black", shape = ".")+
 scale_fill_continuous_divergingx(palette = "RdYlBu", rev = T, mid = 0, limits = c(-60,40), name = "Temperature, Celsius")+
  theme_void()+
  theme(legend.position = "bottom")

ggplot() + geom_raster(data = wts, aes(x=lon, y = lat,  fill = ts.CMIP6-ts.Worldclim))+
  geom_point(data = filter(wts, pval > 0.05), aes(x = lon, y = lat), col = "black", shape = ".", alpha = 0.5)+
  scale_fill_continuous_divergingx(palette = "RdYlBu", rev = T, mid = 0, name = "Difference CMIP6 - Worldclim")+
  theme_void()+
  theme(legend.position = "bottom")

for(i in c("ts.AWI", "ts.BCC", "ts.CAMS", "ts.CESM", "ts.CMCC", "ts.CNRM", "ts.FGOALS", "ts.INM", "ts.MPI", "ts.MRI", "ts.CMIP6")){
  plottitle <- paste("Difference", i, "and ts.Worldclim", sep = " ")
  g <- ggplot(data = wts) + geom_raster(aes(x=lon, y = lat,  fill = wts[, i] - ts.Worldclim))+
    scale_fill_continuous_divergingx(palette = "RdYlBu", rev = T, mid = 0, limits = c(-35,25))+
    labs(title = plottitle, fill = "")+
    theme_void()+
    theme(legend.position = "bottom")
  print(g)
}


for(i in c("ts.AWI", "ts.BCC", "ts.CAMS", "ts.CESM", "ts.CMCC", "ts.CNRM", "ts.FGOALS", "ts.INM", "ts.MPI", "ts.MRI", "ts.CMIP6")){
  plottitle <- paste("Relative biais between", i, "and pr.Worldclim", sep = " ")
  
  df <- wts
  df$rbiais <- (df[, i] - df[,"ts.Worldclim"])/df[,"ts.Worldclim"] * 100
  df$cat.rbiais <- cut(df$rbiais, breaks = c(-100, -50, -10, 0,10,50,100,200,500,1000,Inf))
  
  
  g <- ggplot(data = df) + geom_raster(aes(x=lon, y = lat,  fill = cat.rbiais))+
      geom_point(data = filter(wpr, pval > 0.05), aes(x = lon, y = lat), col = "black", shape = ".", alpha = 0.5)+
    scale_fill_manual(values = c("#FDAE61","#FEE090","#FFFFBF","#E0F3F8","#ABD9E9","#74ADD1","#4575B4","#313695","#6959CD","#473C8B"))+
    labs(title = plottitle, fill = "")+
    theme_void()+
    theme(legend.position = "bottom")
  
   print(g)

}


ggplot(wts) + geom_density(aes(x = ts.CMIP6, fill = "CMIP6"), alpha = 0.5) +
   geom_density(aes(x = ts.Worldclim, fill = "Worldclim"),  alpha = 0.5)+
  scale_fill_manual(values = c("#ABD9E9","#FDAE61"))+
  labs(x = "pr", fill = "")+
  theme_minimal()


set.seed(1000)
kernel_test_pixel <- sample_n(subset(wts, lat < 75 & lat > -75), 9)
kernel_test_pixel$col <- colorvec[-c(6:7)]

ggplot(kernel_test_pixel) + 
  borders() +
  geom_point(aes(x=lon, y = lat, col = col), size = 2) +
  scale_color_identity()+
  theme_bw()


dplot <- function(x){
  y <- t(x)
  plot(density(as.numeric(y[3:12])-273.15), main = paste("lon = ", y[1], ", lat = ",y[2],sep = ""))
  abline(v = as.numeric(y[13])-273.15, col = y[16])
}

par(mfrow = c(3,3))
apply(kernel_test_pixel, 1, dplot)

par(mfrow = c(1,1))
corrplot::corrplot(cor(wts[3:13], use = "pairwise.complete.obs"), 
                   method = "number", number.cex = 0.5, type = "lower", corrplot::COL2("RdYlBu",20), col.lim = c(0.7,1))

par(mfrow = c(1,2))
apply(wts[3:13]-273.15,2,mean, na.rm = T) %>% barplot()
apply(wts[3:13], 2 ,function(x) (mean(x, na.rm = T) - mean(wts[,13], na.rm = T))/mean(wts[,13], na.rm = T)*100) %>% barplot()
```

```{r one-sample-t-test-pr}

wpr <-  subset(clim, period == "1970_2000") %>% 
       select(c("lon","lat","source","pr")) %>%
      reshape(direction = "wide", idvar = c("lon","lat"), v.names = "pr", timevar = "source")

wpr$pval <- apply(wpr, 1, ostt)

wpr$pr.CMIP6 <- rowMeans(dplyr::select(wpr, c("pr.AWI", "pr.BCC", "pr.CAMS", "pr.CESM", "pr.CMCC", "pr.CNRM", "pr.FGOALS", "pr.INM", "pr.MPI", "pr.MRI")), na.rm = T)

ggplot() + geom_raster(data =  subset(clim_sum, period == "1970_2000"), aes(x=lon, y = lat,  fill = pr*60*60*24*365))+
  geom_point(data = filter(wpr, pval > 0.05), aes(x = lon, y = lat), col = "black", shape = ".")+
  scale_fill_continuous_sequential(palette = "Purple-Blue", rev = T, limits = c(0,8000), name = "Precipitations, mm/y")+
  theme_void()+
  theme(legend.position = "bottom")

for(i in c("pr.AWI", "pr.BCC", "pr.CAMS", "pr.CESM", "pr.CMCC", "pr.CNRM", "pr.FGOALS", "pr.INM", "pr.MPI", "pr.MRI", "pr.CMIP6")){
  plottitle <- paste("Difference", i, "and pr.Worldclim", sep = " ")
  g <- ggplot(data = wpr) + geom_raster(aes(x=lon, y = lat,  fill = (wpr[, i] - pr.Worldclim)*60*60*24*365))+
      geom_point(data = filter(wpr, pval > 0.05), aes(x = lon, y = lat), col = "black", shape = ".", alpha = 0.5)+
     scale_fill_continuous_divergingx(palette = "RdYlBu", rev = F, mid = 0, name = "Difference in precipitations,\n mm/y")+
  # scale_fill_continuous_sequential(palette = "Purple-Blue", rev = T, name = "Precipitations, mm/y")+
    labs(title = plottitle, fill = "")+
    theme_void()+
    theme(legend.position = "bottom")
  print(g)
}

for(i in c("pr.AWI", "pr.BCC", "pr.CAMS", "pr.CESM", "pr.CMCC", "pr.CNRM", "pr.FGOALS", "pr.INM", "pr.MPI", "pr.MRI", "pr.CMIP6")){
  plottitle <- paste("Relative biais between", i, "and pr.Worldclim", sep = " ")
  
  df <- wpr
  df$rbiais <- (df[, i] - df[,"pr.Worldclim"])/df[,"pr.Worldclim"] * 100
  df$cat.rbiais <- cut(df$rbiais, breaks = c(-100, -50, -10, 0,10,50,100,200,500,1000,Inf))
  
  
  g <- ggplot(data = df) + geom_raster(aes(x=lon, y = lat,  fill = cat.rbiais))+
      geom_point(data = filter(wpr, pval > 0.05), aes(x = lon, y = lat), col = "black", shape = ".", alpha = 0.5)+
    scale_fill_manual(values = c("#FDAE61","#FEE090","#FFFFBF","#E0F3F8","#ABD9E9","#74ADD1","#4575B4","#313695","#6959CD","#473C8B"))+
    labs(title = plottitle, fill = "")+
    theme_void()+
    theme(legend.position = "bottom")
  
   print(g)

}

for(i in c("pr.AWI", "pr.BCC", "pr.CAMS", "pr.CESM", "pr.CMCC", "pr.CNRM", "pr.FGOALS", "pr.INM", "pr.MPI", "pr.MRI", "pr.CMIP6")){
  
gd <- ggplot(wpr) + geom_density(aes(x = wpr[,i], fill = "CMIP6"), alpha = 0.5) +
   geom_density(aes(x = wpr[,"pr.Worldclim"], fill = "Worldclim"),  alpha = 0.5)+
  scale_fill_manual(values = c("#ABD9E9","#FDAE61"))+
  labs(x = "pr", fill = "", title = i)+
  theme_minimal()
print(gd)
}

set.seed(1)
kernel_test <- sample_n(wpr, 5000)
ggplot(kernel_test) + geom_density(aes(x = pr.CMIP6, fill = "CMIP6"), alpha = 0.5) +
   geom_density(aes(x = pr.Worldclim, fill = "Worldclim"),  alpha = 0.5)+
  scale_fill_manual(values = c("#ABD9E9","#FDAE61"))+
  labs(x = "pr", fill = "")+
  theme_minimal()

set.seed(50)
kernel_test <- sample_n(wpr, 5000)
ggplot(kernel_test) + geom_density(aes(x = pr.CMIP6, fill = "CMIP6"), alpha = 0.5) +
   geom_density(aes(x = pr.Worldclim, fill = "Worldclim"),  alpha = 0.5)+
  scale_fill_manual(values = c("#ABD9E9","#FDAE61"))+
  labs(x = "pr", fill = "")+
  theme_minimal()





set.seed(1000)
kernel_test_pixel <- sample_n(subset(wpr, lat < 75 & lat > -75), 9)
kernel_test_pixel$col <- colorvec[-c(6:7)]

ggplot(kernel_test_pixel) + 
  borders() +
  geom_point(aes(x=lon, y = lat, col = col), size = 2) +
  scale_color_identity()+
  theme_bw()




dplot <- function(x){
  y <- t(x)
  plot(density(as.numeric(y[3:12])*60*60*24*365), main = paste("lon = ", y[1], ", lat = ",y[2],sep = ""))
  abline(v = as.numeric(y[13])*60*60*24*365, col = y[16])
}

par(mfrow = c(3,3))
apply(kernel_test_pixel, 1, dplot)


corrplot::corrplot(cor(wpr[3:13], use = "pairwise.complete.obs"), 
                   method = "number", number.cex = 0.5, type = "lower", corrplot::COL2("RdYlBu",20), col.lim = c(0.7,1))

apply(wpr[3:13]*60*60*24*365,2,mean, na.rm = T) %>% barplot()
apply(wpr[3:13], 2 ,function(x) (mean(x, na.rm = T) - mean(wpr[,13], na.rm = T))/mean(wpr[,13], na.rm = T)*100) %>% barplot()

```

```{r one-sample-t-test-sfcWind}

wsw <-  subset(clim, period == "1970_2000") %>% 
       select(c("lon","lat","source","sfcWind")) %>%
      reshape(direction = "wide", idvar = c("lon","lat"), v.names = "sfcWind", timevar = "source") 

wsw$pval <- apply(wsw, 1, ostt)

wsw$sfcWind.CMIP6 <- rowMeans(dplyr::select(wsw, c("sfcWind.AWI", "sfcWind.BCC", "sfcWind.CAMS", "sfcWind.CESM", "sfcWind.CMCC", "sfcWind.CNRM", "sfcWind.FGOALS", "sfcWind.INM", "sfcWind.MPI", "sfcWind.MRI")), na.rm = T)

ggplot() + geom_raster(data =  wsw, aes(x=lon, y = lat,  fill = sfcWind.CMIP6))+
  geom_point(data = filter(wsw, pval > 0.05), aes(x = lon, y = lat), col = "black", shape = ".")+
 scale_fill_continuous_divergingx(palette = "RdYlBu", rev = T, mid = 0, name = "Temperature, Celsius")+
  theme_void()+
  theme(legend.position = "bottom")

ggplot() + geom_raster(data = wsw, aes(x=lon, y = lat,  fill = sfcWind.Worldclim))+
  geom_point(data = filter(wsw, pval > 0.05), aes(x = lon, y = lat), col = "black", shape = ".")+
 scale_fill_continuous_divergingx(palette = "RdYlBu", rev = T, mid = 0, name = "Temperature, Celsius")+
  theme_void()+
  theme(legend.position = "bottom")

ggplot() + geom_raster(data = wsw, aes(x=lon, y = lat,  fill = sfcWind.CMIP6-sfcWind.Worldclim))+
  geom_point(data = filter(wsw, pval > 0.05), aes(x = lon, y = lat), col = "black", shape = ".", alpha = 0.5)+
  scale_fill_continuous_divergingx(palette = "RdYlBu", rev = T, mid = 0, name = "Difference CMIP6 - Worldclim")+
  theme_void()+
  theme(legend.position = "bottom")

for(i in c("sfcWind.AWI", "sfcWind.BCC", "sfcWind.CAMS", "sfcWind.CESM", "sfcWind.CMCC", "sfcWind.CNRM", "sfcWind.FGOALS", "sfcWind.INM", "sfcWind.MPI", "sfcWind.MRI", "sfcWind.CMIP6")){
  plottitle <- paste("Difference", i, "and sfcWind.Worldclim", sep = " ")
  g <- ggplot(data = wsw) + geom_raster(aes(x=lon, y = lat,  fill = wsw[, i] - sfcWind.Worldclim))+
    scale_fill_continuous_divergingx(palette = "RdYlBu", rev = T, mid = 0)+
    labs(title = plottitle, fill = "")+
    theme_void()+
    theme(legend.position = "bottom")
  print(g)
}


for(i in c("sfcWind.AWI", "sfcWind.BCC", "sfcWind.CAMS", "sfcWind.CESM", "sfcWind.CMCC", "sfcWind.CNRM", "sfcWind.FGOALS", "sfcWind.INM", "sfcWind.MPI", "sfcWind.MRI", "sfcWind.CMIP6")){
  plottitle <- paste("Relative biais between", i, "and sfcWind.Worldclim", sep = " ")
  
  df <- wsw
  df$rbiais <- (df[, i] - df[,"sfcWind.Worldclim"])/df[,"sfcWind.Worldclim"] * 100
  df$cat.rbiais <- cut(df$rbiais, breaks = c(-100, -50, -10, 0,10,50,100,200,500,1000,Inf))
  
  
  g <- ggplot(data = df) + geom_raster(aes(x=lon, y = lat,  fill = cat.rbiais))+
      geom_point(data = filter(wpr, pval > 0.05), aes(x = lon, y = lat), col = "black", shape = ".", alpha = 0.5)+
    scale_fill_manual(values = c("#FDAE61","#FEE090","#FFFFBF","#E0F3F8","#ABD9E9","#74ADD1","#4575B4","#313695","#6959CD","#473C8B"))+
    labs(title = plottitle, fill = "")+
    theme_void()+
    theme(legend.position = "bottom")
  
   print(g)

}


ggplot(wsw) + geom_density(aes(x = sfcWind.CMIP6, fill = "CMIP6"), alpha = 0.5) +
   geom_density(aes(x = sfcWind.Worldclim, fill = "Worldclim"),  alpha = 0.5)+
  scale_fill_manual(values = c("#ABD9E9","#FDAE61"))+
  labs(x = "pr", fill = "")+
  theme_minimal()


set.seed(1000)
kernel_test_pixel <- sample_n(subset(wsw, lat < 75 & lat > -75), 9)
kernel_test_pixel$col <- colorvec[-c(6:7)]

ggplot(kernel_test_pixel) + 
  borders() +
  geom_point(aes(x=lon, y = lat, col = col), size = 2) +
  scale_color_identity()+
  theme_bw()


dplot <- function(x){
  y <- t(x)
  plot(density(as.numeric(y[3:12])), main = paste("lon = ", y[1], ", lat = ",y[2],sep = ""))
  abline(v = as.numeric(y[13]), col = y[16])
}

par(mfrow = c(3,3))
apply(kernel_test_pixel, 1, dplot)

par(mfrow = c(1,1))
corrplot::corrplot(cor(wsw[3:13], use = "pairwise.complete.obs"), 
                   method = "number", number.cex = 0.5, type = "lower", corrplot::COL2("RdYlBu",20), col.lim = c(-1,1))

par(mfrow = c(1,2))
apply(wsw[3:13],2,mean, na.rm = T) %>% barplot()
apply(wsw[3:13], 2 ,function(x) (mean(x, na.rm = T) - mean(wsw[,13], na.rm = T))/mean(wsw[,13], na.rm = T)*100) %>% barplot()
```
```{r one-sample-t-test-rsds}

wrsds <-  subset(clim, period == "1970_2000") %>% 
       select(c("lon","lat","source","rsds")) %>%
      reshape(direction = "wide", idvar = c("lon","lat"), v.names = "rsds", timevar = "source")

wrsds$pval <- apply(wrsds, 1, ostt)

wrsds$rsds.CMIP6 <- rowMeans(dplyr::select(wrsds, c("rsds.AWI", "rsds.BCC", "rsds.CAMS", "rsds.CESM", "rsds.CMCC", "rsds.CNRM", "rsds.FGOALS", "rsds.INM", "rsds.MPI", "rsds.MRI")), na.rm = T)

ggplot() + geom_raster(data =  subset(clim_sum, period == "1970_2000"), aes(x=lon, y = lat,  fill = rsds))+
  geom_point(data = filter(wrsds, pval > 0.05), aes(x = lon, y = lat), col = "black", shape = ".")+
  scale_fill_continuous_sequential(palette = "Purple-Blue", rev = T, limits = c(0,8000), name = "Irradiation")+
  theme_void()+
  theme(legend.position = "bottom")

for(i in c("rsds.AWI", "rsds.BCC", "rsds.CAMS", "rsds.CESM", "rsds.CMCC", "rsds.CNRM", "rsds.FGOALS", "rsds.INM", "rsds.MPI", "rsds.MRI", "rsds.CMIP6")){
  plottitle <- paste("Difference", i, "and rsds.Worldclim", sep = " ")
  g <- ggplot(data = wrsds) + geom_raster(aes(x=lon, y = lat,  fill = (wrsds[, i] - rsds.Worldclim)))+
      geom_point(data = filter(wrsds, pval > 0.05), aes(x = lon, y = lat), col = "black", shape = ".", alpha = 0.5)+
     scale_fill_continuous_divergingx(palette = "RdYlBu", rev = F, mid = 0, name = "Difference in irradiation")+
  # scale_fill_continuous_sequential(palette = "Purple-Blue", rev = T, name = "Precipitations, mm/y")+
    labs(title = plottitle, fill = "")+
    theme_void()+
    theme(legend.position = "bottom")
  print(g)
}

for(i in c("rsds.AWI", "rsds.BCC", "rsds.CAMS", "rsds.CESM", "rsds.CMCC", "rsds.CNRM", "rsds.FGOALS", "rsds.INM", "rsds.MPI", "rsds.MRI", "rsds.CMIP6")){
  plottitle <- paste("Relative biais between", i, "and rsds.Worldclim", sep = " ")
  
  df <- wrsds
  df$rbiais <- (df[, i] - df[,"rsds.Worldclim"])/df[,"rsds.Worldclim"] * 100
  df$cat.rbiais <- cut(df$rbiais, breaks = c(-100, -50, -10, 0,10,50,100,200,500,1000,Inf))
  
  
  g <- ggplot(data = df) + geom_raster(aes(x=lon, y = lat,  fill = cat.rbiais))+
      geom_point(data = filter(wrsds, pval > 0.05), aes(x = lon, y = lat), col = "black", shape = ".", alpha = 0.5)+
    scale_fill_manual(values = c("#FDAE61","#FEE090","#FFFFBF","#E0F3F8","#ABD9E9","#74ADD1","#4575B4","#313695","#6959CD","#473C8B"))+
    labs(title = plottitle, fill = "")+
    theme_void()+
    theme(legend.position = "bottom")
  
   print(g)

}

for(i in c("rsds.AWI", "rsds.BCC", "rsds.CAMS", "rsds.CESM", "rsds.CMCC", "rsds.CNRM", "rsds.FGOALS", "rsds.INM", "rsds.MPI", "rsds.MRI", "rsds.CMIP6")){
  
gd <- ggplot(wrsds) + geom_density(aes(x = wrsds[,i], fill = "CMIP6"), alpha = 0.5) +
   geom_density(aes(x = wrsds[,"rsds.Worldclim"], fill = "Worldclim"),  alpha = 0.5)+
  scale_fill_manual(values = c("#ABD9E9","#FDAE61"))+
  labs(x = "rsds", fill = "", title = i)+
  theme_minimal()
print(gd)
}

set.seed(1)
kernel_test <- sample_n(wrsds, 5000)
ggplot(kernel_test) + geom_density(aes(x = rsds.CMIP6, fill = "CMIP6"), alpha = 0.5) +
   geom_density(aes(x = rsds.Worldclim, fill = "Worldclim"),  alpha = 0.5)+
  scale_fill_manual(values = c("#ABD9E9","#FDAE61"))+
  labs(x = "rsds", fill = "")+
  theme_minimal()

set.seed(50)
kernel_test <- sample_n(wrsds, 5000)
ggplot(kernel_test) + geom_density(aes(x = rsds.CMIP6, fill = "CMIP6"), alpha = 0.5) +
   geom_density(aes(x = rsds.Worldclim, fill = "Worldclim"),  alpha = 0.5)+
  scale_fill_manual(values = c("#ABD9E9","#FDAE61"))+
  labs(x = "rsds", fill = "")+
  theme_minimal()





set.seed(1000)
kernel_test_pixel <- sample_n(subset(wrsds, lat < 75 & lat > -75), 9)
kernel_test_pixel$col <- colorvec[-c(6:7)]

ggplot(kernel_test_pixel) + 
  borders() +
  geom_point(aes(x=lon, y = lat, col = col), size = 2) +
  scale_color_identity()+
  theme_bw()




dplot <- function(x){
  y <- t(x)
  plot(density(as.numeric(y[3:12])*60*60*24*365), main = paste("lon = ", y[1], ", lat = ",y[2],sep = ""))
  abline(v = as.numeric(y[13])*60*60*24*365, col = y[16])
}

par(mfrow = c(3,3))
apply(kernel_test_pixel, 1, dplot)


corrplot::corrplot(cor(wrsds[3:13], use = "pairwise.complete.obs"), 
                   method = "number", number.cex = 0.5, type = "lower", corrplot::COL2("RdYlBu",20), col.lim = c(0.7,1))

apply(wrsds[3:13]*60*60*24*365,2,mean, na.rm = T) %>% barplot()
apply(wrsds[3:13], 2 ,function(x) (mean(x, na.rm = T) - mean(wrsds[,13], na.rm = T))/mean(wrsds[,13], na.rm = T)*100) %>% barplot()

```

# Non parametric one sample wilcoxon test with Worldclim

```{r ostt-function}
oswt <- function(v){
  x <- v[3:12]
  y <- v[13]
  p <- ifelse(is.na(y) == F,  wilcox.test(x,mu = y ,na.action(na.omit))$p.value, NA)
  return(p)
} 
```

```{r one-sample-t-test-AIu}

wAIu <-  subset(clim, period == "1970_2000") %>% 
       select(c("lon","lat","source","AIu")) %>%
      reshape(direction = "wide", idvar = c("lon","lat"), v.names = "AIu", timevar = "source")

wAIu$pval <- apply(wAIu, 1, oswt)
table(wAIu$pval < 0.05)

ggplot() + geom_raster(data = subset(clim_sum, period == "1970_2000"), aes(x=lon, y = lat,  fill = cat.AIu))+
  geom_point(data = filter(wAIu, pval < 0.05), aes(x = lon, y = lat), col = "black", shape = ".", alpha = 0.5)+
  scale_fill_manual(values = col.cat)+
  labs(title = "CMIP6, Wilcox")+
  theme_void()+
  theme(legend.position = "bottom")

ggplot() + geom_raster(data = subset(clim, period == "1970_2000" & source == "Worldclim"), aes(x=lon, y = lat,  fill = cat.AIu))+
  geom_point(data = filter(wAIu, pval < 0.05), aes(x = lon, y = lat), col = "black", shape = ".", alpha = 0.5)+
  scale_fill_manual(values = col.cat)+
  labs(title = "Worldclim, Wilcox")+
  theme_void()+
  theme(legend.position = "bottom")
```

```{r one-sample-t-test-AIm}

wAIm <-  subset(clim, period == "1970_2000") %>% 
       select(c("lon","lat","source","AIm")) %>%
      reshape(direction = "wide", idvar = c("lon","lat"), v.names = "AIm", timevar = "source")

wAIm$pval <- apply(wAIm, 1, oswt)

table(wAIm$pval < 0.05)

ggplot() + geom_raster(data = subset(clim_sum, period == "1970_2000"), aes(x=lon, y = lat,  fill = cat.AIm))+
  geom_point(data = filter(wAIm, pval < 0.05), aes(x = lon, y = lat), col = "black", shape = ".", alpha = 0.5)+
  scale_fill_manual(values = col.martonne, na.value = "gray70")+
  theme_void()+
  theme(legend.position = "bottom")
```

```{r one-sample-t-test-ts}

wts <- subset(clim, period == "1970_2000") %>% 
       select(c("lon","lat","source","ts")) %>%
      reshape(direction = "wide", idvar = c("lon","lat"), v.names = "ts", timevar = "source")

wts$pval <- apply(wts, 1, oswt)

ggplot() + geom_raster(data =  subset(clim_sum, period == "1970_2000"), aes(x=lon, y = lat,  fill = ts-273.15))+
  geom_point(data = filter(wts, pval < 0.05), aes(x = lon, y = lat), col = "black", shape = ".", alpha = 0.5)+
 scale_fill_continuous_divergingx(palette = "RdYlBu", rev = T, mid = 0, limits = c(-60,40), name = "Temperature, Celsius")+
  theme_void()+
  theme(legend.position = "bottom")
```

```{r one-sample-t-test-pr}

wpr <-  subset(clim, period == "1970_2000") %>% 
       select(c("lon","lat","source","pr")) %>%
      reshape(direction = "wide", idvar = c("lon","lat"), v.names = "pr", timevar = "source")

wpr$pval <- apply(wpr, 1, ostt)

ggplot() + geom_raster(data =  subset(clim_sum, period == "1970_2000"), aes(x=lon, y = lat,  fill = pr*60*60*24*365))+
  geom_point(data = filter(wpr, pval > 0.05), aes(x = lon, y = lat), col = "black", shape = ".", alpha = 0.5)+
scale_fill_continuous_sequential(palette = "Purple-Blue", rev = T, limits = c(0,8000), name = "Precipitations, mm/y")+
  theme_void()+
  theme(legend.position = "bottom")

ggplot() + geom_raster(data =  subset(clim_sum, period == "1970_2000"), aes(x=lon, y = lat,  fill = pr*60*60*24*365))+
  geom_point(data = filter(wpr, pval > 0.05), aes(x = lon, y = lat), col = "black", shape = ".", alpha = 0.5)+
scale_fill_continuous_sequential(palette = "Purple-Blue", rev = T, limits = c(0,8000), name = "Precipitations, mm/y")+
  theme_void()+
  theme(legend.position = "bottom")
```

# Categorical comparison

```{r comparison-categories-AIu}

wcatAIu <-  subset(clim, period == "1970_2000") %>% 
       select(c("lon","lat","source","cat.AIu")) %>%
      reshape(direction = "wide", idvar = c("lon","lat"), v.names = "cat.AIu", timevar = "source")

ccat <- function(v){
  x <- v[3:12]  %>% t() %>% as.vector()
  y <- v[[13]]  %>% as.character()
  p <- sum(grepl(y, x) == TRUE)
  return(p)
} 

wcatAIu$prop <- apply(wcatAIu, 1, ccat)

ggplot() + geom_raster(data = subset(clim_sum, period == "1970_2000"), aes(x=lon, y = lat,  fill = cat.AIu))+
  geom_point(data = filter(wcatAIu, prop > 8), aes(x = lon, y = lat), col = "black", shape = ".", alpha = 0.5)+
  scale_fill_manual(values = col.cat)+
  labs(title = "CMIP6")+
  theme_void()+
  theme(legend.position = "bottom")

ggplot() + geom_raster(data = subset(clim, period == "1970_2000" & source == "Worldclim"), aes(x=lon, y = lat,  fill = cat.AIu))+
  geom_point(data = filter(wcatAIu, prop > 8), aes(x = lon, y = lat), col = "black", shape = ".", alpha = 0.5)+
  scale_fill_manual(values = col.cat)+
  labs(title = "Worldclim")+
  theme_void()+
  theme(legend.position = "bottom")
```

```{r comparison-categories-AIm}

wcatAIm <-  subset(clim, period == "1970_2000") %>% 
       select(c("lon","lat","source","cat.AIm")) %>%
      reshape(direction = "wide", idvar = c("lon","lat"), v.names = "cat.AIm", timevar = "source")

ccat <- function(v){
  x <- v[3:12]  %>% t() %>% as.vector()
  y <- v[[13]]  %>% as.character()
  p <- sum(grepl(y, x) == TRUE)
  return(p)
} 

wcatAIm$prop <- apply(wcatAIm, 1, ccat)

ggplot() + geom_raster(data = subset(clim_sum, period == "1970_2000"), aes(x=lon, y = lat,  fill = cat.AIm))+
  geom_point(data = filter(wcatAIu, prop > 8), aes(x = lon, y = lat), col = "gray70", shape = ".")+
  scale_fill_manual(values = col.martonne)+
  theme_void()+
  theme(legend.position = "bottom")
```