---
title: "test AI"
output: 
  html_document:
    toc: true
    toc_float: true
    number_sections: true
    code_folding: hide
date: "2023-09-13"
bibliography: AI.bib

---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = F, warning = F, error = F, fig.align = "center", collapse = T)
```

```{r libraries}


library(raster)
library(sf)
library(ggplot2)
library(ggpubr)
library(viridisLite)
library(lemon)

library(geodata)
library(plyr)
library(dplyr)
library(stringr)

library(reshape2)

library(lubridate)
```

# Download worldclim

```{r dowload-worldclim, eval = F}
worldclim_country("Côte d'Ivoire", var = "prec", res = 0.5, path = ".") # average monthly precipitation in Ivory Coast, reference period 1970-2000). Res: 1km
worldclim_country("France", var = "prec", res = 0.5, path = ".") # average monthly precipitation in France, reference period 1970-2000). Res: 1km

worldclim_country("Côte d'Ivoire", var = "tavg", res = 0.5, path = ".") # average monthly temperature in Ivory Coast, reference period 1970-2000)
worldclim_country("France", var = "tavg", res = 0.5, path = ".") # average monthly temperature in France, reference period 1970-2000)

worldclim_country("Côte d'Ivoire", var = "tmin", res = 0.5, path = ".") # monthly minimum temperature in Ivory Coast, reference period 1970-2000)
worldclim_country("France", var = "tmin", res = 0.5, path = ".") # monthly minimum temperature in France, reference period 1970-2000)

worldclim_country("Côte d'Ivoire", var = "tmax", res = 0.5, path = ".") # monthly minimum temperature in Ivory Coast, reference period 1970-2000)
worldclim_country("France", var = "tmax", res = 0.5, path = ".") # monthly minimum temperature in Ivory Coast, reference period 1970-2000)


worldclim_country("Côte d'Ivoire", var = "srad", res = 0.5, path = ".") # average monthly solar radiation in Ivory Coast, reference period 1970-2000)
worldclim_country("France", var = "srad", res = 0.5, path = ".") # average monthly solar radiation in France, reference period 1970-2000)

worldclim_country("Côte d'Ivoire", var = "bio", res = 0.5, path = ".") # Bioclimatic variablesreference period 1970-2000)
worldclim_country("France", var = "bio", res = 0.5, path = ".") # Bioclimatic variables France, reference period 1970-2000)

worldclim_country("Côte d'Ivoire", var = "elev", res = 0.5, path = ".") # elevation in Ivory Coast, reference period 1970-2000
worldclim_country("France", var = "elev", res = 0.5, path = ".") # elevation in France, reference period 1970-2000

worldclim_country("Côte d'Ivoire", var = "wind", res = 0.5, path = ".") # elevation in Ivory Coast, reference period 1970-2000
worldclim_country("France", var = "wind", res = 0.5, path = ".") # elevation in France, reference period 1970-2000

worldclim_global(var = "prec", res = 10, path = ".")
worldclim_global(var = "tavg", res = 10, path = ".")
worldclim_global(var = "tmin", res = 10, path = ".")
worldclim_global(var = "tmax", res = 10, path = ".")
worldclim_global(var = "srad", res = 10, path = ".")
worldclim_global(var = "elev", res = 10, path = ".")
worldclim_global(var = "wind", res = 10, path = ".")
worldclim_global(var = "bio", res = 10, path = ".")
```

```{r merge-france, eval = F}
monthly.tavg <- raster::stack("Worldclim/wc2.1_country/FRA_wc2.1_30s_tavg.tif") %>% as("SpatialPixelsDataFrame") %>% as.data.frame() %>% 
  setNames( c("tmean_01","tmean_02","tmean_03","tmean_04","tmean_05","tmean_06","tmean_07","tmean_08","tmean_09","tmean_10","tmean_11","tmean_12","lon","lat"))

monthly.tmax <- raster::stack("Worldclim/wc2.1_country/FRA_wc2.1_30s_tmax.tif") %>% as("SpatialPixelsDataFrame") %>% as.data.frame() %>%
  setNames(c("tmax_01","tmax_02","tmax_03","tmax_04","tmax_05","tmax_06","tmax_07","tmax_08","tmax_09","tmax_10","tmax_11","tmax_12","lon","lat"))

monthly.tmin <- raster::stack("Worldclim/wc2.1_country/FRA_wc2.1_30s_tmin.tif") %>% as("SpatialPixelsDataFrame") %>% as.data.frame() %>%
  setNames(c("tmin_01","tmin_02","tmin_03","tmin_04","tmin_05","tmin_06","tmin_07","tmin_08","tmin_09","tmin_10","tmin_11","tmin_12","lon","lat"))

monthly.p <- raster::stack("Worldclim/wc2.1_country/FRA_wc2.1_30s_prec.tif") %>% as("SpatialPixelsDataFrame") %>% as.data.frame() %>%
  setNames(c("pre_01","pre_02","pre_03","pre_04","pre_05","pre_06","pre_07","pre_08","pre_09","pre_10","pre_11","pre_12","lon","lat"))

annual.p <- raster("Worldclim/wc2.1_country/FRA_wc2.1_30s_bio.tif", band = 12) %>% as("SpatialPixelsDataFrame") %>% as.data.frame() %>% setNames(c("pre","lon","lat"))

annual.t<- raster("Worldclim/wc2.1_country/FRA_wc2.1_30s_bio.tif", band = 1) %>% as("SpatialPixelsDataFrame") %>% as.data.frame() %>%
  setNames(c("temp","lon","lat"))

elev <- raster("Worldclim/wc2.1_country/FRA_wc2.1_30s_elev.tif") %>% as("SpatialPixelsDataFrame") %>% as.data.frame() %>% setNames(c("z","lon","lat"))

annual.wind <- raster::stack("Worldclim/wc2.1_country/FRA_wc2.1_30s_wind.tif") %>% mean(na.rm = T) %>% as("SpatialPixelsDataFrame") %>% as.data.frame() %>% setNames(c("u2","lon","lat"))

annual.srad <- raster::stack("Worldclim/wc2.1_country/FRA_wc2.1_30s_srad.tif") %>% raster::mean(na.rm = T) %>% as("SpatialPixelsDataFrame") %>% as.data.frame() %>% setNames(c("Rn","lon","lat")) #Rn en kJ/m2/day

fra <- monthly.tavg %>% merge(monthly.tmax, by = c("lon","lat")) %>% merge(monthly.tmin, by = c("lon","lat")) %>% 
  merge(monthly.p, by = c("lon","lat")) %>% merge(annual.p, by = c("lon","lat"))  %>% merge(annual.t, by = c("lon","lat")) %>% 
  merge(annual.wind, by = c("lon","lat")) %>% merge(annual.srad, by = c("lon","lat")) %>%
  merge(elev, by = c("lon","lat"))

saveRDS(fra, "Worldclim/fra.rds")
``` 

```{r merge-civ, eval = F}
monthly.tavg <- raster::stack("Worldclim/wc2.1_country/CIV_wc2.1_30s_tavg.tif") %>% as("SpatialPixelsDataFrame") %>% as.data.frame() %>% 
  setNames( c("tmean_01","tmean_02","tmean_03","tmean_04","tmean_05","tmean_06","tmean_07","tmean_08","tmean_09","tmean_10","tmean_11","tmean_12","lon","lat"))

monthly.tmax <- raster::stack("Worldclim/wc2.1_country/CIV_wc2.1_30s_tmax.tif") %>% as("SpatialPixelsDataFrame") %>% as.data.frame() %>%
  setNames(c("tmax_01","tmax_02","tmax_03","tmax_04","tmax_05","tmax_06","tmax_07","tmax_08","tmax_09","tmax_10","tmax_11","tmax_12","lon","lat"))

monthly.tmin <- raster::stack("Worldclim/wc2.1_country/CIV_wc2.1_30s_tmin.tif") %>% as("SpatialPixelsDataFrame") %>% as.data.frame() %>%
  setNames(c("tmin_01","tmin_02","tmin_03","tmin_04","tmin_05","tmin_06","tmin_07","tmin_08","tmin_09","tmin_10","tmin_11","tmin_12","lon","lat"))

monthly.p <- raster::stack("Worldclim/wc2.1_country/CIV_wc2.1_30s_prec.tif") %>% as("SpatialPixelsDataFrame") %>% as.data.frame() %>%
  setNames(c("pre_01","pre_02","pre_03","pre_04","pre_05","pre_06","pre_07","pre_08","pre_09","pre_10","pre_11","pre_12","lon","lat"))

annual.p <- raster("Worldclim/wc2.1_country/CIV_wc2.1_30s_bio.tif", band = 12) %>% as("SpatialPixelsDataFrame") %>% as.data.frame() %>% setNames(c("pre","lon","lat"))

annual.t<- raster("Worldclim/wc2.1_country/CIV_wc2.1_30s_bio.tif", band = 1) %>% as("SpatialPixelsDataFrame") %>% as.data.frame() %>%
  setNames(c("temp","lon","lat"))

elev <- raster("Worldclim/wc2.1_country/CIV_wc2.1_30s_elev.tif") %>% as("SpatialPixelsDataFrame") %>% as.data.frame() %>% setNames(c("z","lon","lat"))

annual.wind <- raster::stack("Worldclim/wc2.1_country/CIV_wc2.1_30s_wind.tif") %>% mean(na.rm = T) %>% as("SpatialPixelsDataFrame") %>% as.data.frame() %>% setNames(c("u2","lon","lat"))

annual.srad <- raster::stack("Worldclim/wc2.1_country/CIV_wc2.1_30s_srad.tif") %>% raster::mean(na.rm = T) %>% as("SpatialPixelsDataFrame") %>% as.data.frame() %>% setNames(c("Rn","lon","lat")) #Rn en kJ/m2/day
 
civ <- monthly.tavg %>% merge(monthly.tmax, by = c("lon","lat")) %>% merge(monthly.tmin, by = c("lon","lat")) %>% 
  merge(monthly.p, by = c("lon","lat")) %>% merge(annual.p, by = c("lon","lat"))  %>% merge(annual.t, by = c("lon","lat")) %>% 
  merge(annual.wind, by = c("lon","lat")) %>% merge(annual.srad, by = c("lon","lat")) %>%
  merge(elev, by = c("lon","lat"))

saveRDS(civ, "Worldclim/civ.rds")
```

```{r merge-world, eval = F}

list.prec <- list.files(path = "Worldclim/wc2.1_10m", pattern = "wc2.1_10m_prec_", full.names = T) 
monthly.prec <- raster::stack(list.prec) %>% as("SpatialPixelsDataFrame") %>% as.data.frame() %>%
  setNames(c("pre_01","pre_02","pre_03","pre_04","pre_05","pre_06","pre_07","pre_08","pre_09","pre_10","pre_11","pre_12","lon","lat"))

list.tavg <- list.files(path = "Worldclim/wc2.1_10m", pattern = "wc2.1_10m_tavg_", full.names = T) 
monthly.tavg <- raster::stack(list.tavg) %>% as("SpatialPixelsDataFrame") %>% as.data.frame() %>% 
  setNames(c("tmean_01","tmean_02","tmean_03","tmean_04","tmean_05","tmean_06","tmean_07","tmean_08","tmean_09","tmean_10","tmean_11","tmean_12","lon","lat"))

list.tmax <- list.files(path = "Worldclim/wc2.1_10m", pattern = "wc2.1_10m_tmax_", full.names = T) 
monthly.tmax <- raster::stack(list.tmax) %>% as("SpatialPixelsDataFrame") %>% as.data.frame() %>%
  setNames(c("tmax_01","tmax_02","tmax_03","tmax_04","tmax_05","tmax_06","tmax_07","tmax_08","tmax_09","tmax_10","tmax_11","tmax_12","lon","lat"))

list.tmin <- list.files(path = "Worldclim/wc2.1_10m", pattern = "wc2.1_10m_tmin_", full.names = T) 
monthly.tmin <- raster::stack(list.tmin) %>% as("SpatialPixelsDataFrame") %>% as.data.frame() %>%
  setNames(c("tmin_01","tmin_02","tmin_03","tmin_04","tmin_05","tmin_06","tmin_07","tmin_08","tmin_09","tmin_10","tmin_11","tmin_12","lon","lat"))

list.pre <- list.files(path = "Worldclim/wc2.1_10m", pattern = "wc2.1_10m_prec_", full.names = T) 
monthly.p <- raster::stack(list.pre) %>% as("SpatialPixelsDataFrame") %>% as.data.frame() %>%
  setNames(c("pre_01","pre_02","pre_03","pre_04","pre_05","pre_06","pre_07","pre_08","pre_09","pre_10","pre_11","pre_12","lon","lat"))

annual.p <- raster("Worldclim/wc2.1_10m/wc2.1_10m_bio_12.tif") %>% as("SpatialPixelsDataFrame") %>% as.data.frame() %>%
  setNames(c("pre","lon","lat"))

annual.t<- raster("Worldclim/wc2.1_10m/wc2.1_10m_bio_1.tif") %>% as("SpatialPixelsDataFrame") %>% as.data.frame() %>%
  setNames(c("temp","lon","lat"))

elev <- raster("Worldclim/wc2.1_10m/wc2.1_10m_elev.tif") %>% as("SpatialPixelsDataFrame") %>% as.data.frame() %>% setNames(c("z","lon","lat"))

list.wind <- list.files(path = "Worldclim/wc2.1_10m", pattern = "wc2.1_10m_wind_", full.names = T) 
monthly.wind <- raster::stack(list.wind) %>% as("SpatialPixelsDataFrame") %>% as.data.frame() %>%
  setNames(c("u_01","u_02","u_03","u_04","u_05","u_06","u_07","u_08","u_09","u_10","u_11","u_12","lon","lat"))

list.srad <- list.files(path = "Worldclim/wc2.1_10m", pattern = "wc2.1_10m_srad_", full.names = T) 
monthly.srad <- raster::stack(list.srad) %>% as("SpatialPixelsDataFrame") %>% as.data.frame() %>%
  setNames(c("srad_01","srad_02","srad_03","srad_04","srad_05","srad_06","srad_07","srad_08","srad_09","srad_10","srad_11","srad_12","lon","lat"))

world.df <- monthly.tavg %>% merge(monthly.tmax, by = c("lon","lat")) %>% merge(monthly.tmin, by = c("lon","lat")) %>% 
  merge(monthly.p, by = c("lon","lat")) %>% merge(annual.p, by = c("lon","lat"))  %>% merge(annual.t, by = c("lon","lat")) %>% 
  merge(monthly.wind, by = c("lon","lat")) %>% merge(monthly.srad, by = c("lon","lat")) %>%
   merge(elev, by = c("lon","lat"))

saveRDS(world.df, "Worldclim/world.df.rds")
```


```{r load-data}
fra <- readRDS("Worldclim/fra.rds")
civ <- readRDS("Worldclim/civ.rds")
world.df <- readRDS("Worldclim/world.df.rds")

colorvec <- viridis(n = 8, direction = -1)
```

# Définition de l'aridité

L’aridité (aridity) désigne une tendance de long-terme et désigne des régions sèches où les ressources en eau sont limitées. Une sécheresse (drought), au contraire, désigne un épisode temporaire de déficit en eau. Une sécheresse commence toujours par un déficit de pluie (sécheresse atmosphérique), mais peut ensuite évoluer en sécheresse hydrologique si elle affecte le niveau de nappes phréatiques et des cours d’eau ; ou encore en sécheresse écologique si cela affecte le niveau d’humidité des sols. Si on considère les impacts sur les activités humaines, on peut également parler de sécheresse agricole ou de sécheresse socio-économique @Heffernan2013. 

*Définition IPCC : The state of a long-term climatic feature characterised by low average precipitation or available water in a region. Aridity generally arises from widespread persistent atmospheric subsidence or anticyclonic conditions, and from more localised subsidence in the lee side of mountains (adapted from Ogallo and Gbeckor-Kove, 1989).* [@Moller2022]

Les premières classifications climatiques ont été effectuées durant la seoncde moitié du 19e siècle, à partir d’une description de la végétation et des précipitations [@Wallen1967; @Rubel2011]. Cette classification intéresse à la fois les botanistes/agronomes, et les météorologistes. Les premiers s’intéressent aux EFFETS du climat sur la végétation, les seconds s’intéressent aux ORIGINES du climat. Les indices d’aridités, censés faciliter la catégorisation des régions, sont nés de cette interaction. Les premiers indices sont donc assez intuitifs, fondés sur les données disponibles : les précipitations et la température. Plus tard, la notion d’évaporation puis d’évapotranspiration seront introduites [@Wallen1967]. La forte dépendance de l’évapotranspiration à la température explique que des indices utilisant la température soient toujours considérés comme pertinents. 


# Lang Rain Factor, 1920

Le facteur de précipitation de Lang consiste simplement dans le ratio $I=P/T$. P en mm et T en °C. 

Il sert à décrire, en se basant sur des paramètres facilement accessibles, les zones climatiques telles qu’exposées par les phytogéographes. Malgré l’incohérence des unités, ce facteur montre bien que l’efficacité des précipitations augmente avec P et diminue avec T [@Thornthwaite1948]. 

```{r categories-lang}
breaks.lang <- c(0,20,40,60,100,160,Inf)
cat.lang <- c("(0,20]"= "Deserts", "(20,40]" = "Arid", "(40,60]" = "Semi-arid", "(60,100]" = "Semi-humid","(100,160]" = "Humid", "(160,Inf]"="Hyper humid")
col.cat <- c("Deserts" = colorvec[1], "Arid"= colorvec[2],"Semi-arid"= colorvec[3], "Semi-humid" = colorvec[4], "Humid"= colorvec[5],"Hyper humid"= colorvec[6])
```

Detailed in @Thornthwaite1948 and [here]<https://iast.univ-setif.dz/documents/Cours/Cours6BioclimatologieL2GAT21.pdf> 

```{r lang-civ }
lang.civ <- civ %>% mutate(RF = pre/temp)

lang.civ$cat.AI <- cut(lang.civ$RF, breaks = breaks.lang) %>% revalue(cat.lang)

g1c <- ggplot(lang.civ)+geom_raster(aes(x = lon, y = lat, fill = RF))+
    borders(regions = "Ivory Coast")+
  labs(title = "Lang Rain Factor, Ivory Coast", fill = "")+scale_fill_viridis_c(direction = -1,lim = c(-0, 200))+theme_void(base_size = 10)+theme(legend.position = "bottom")

g2c <- ggplot(lang.civ)+geom_raster(aes(x = lon, y = lat, fill = cat.AI))+
    borders(regions = "Ivory Coast")+
  labs(title = "Lang Rain Factor, Ivory Coast", fill = "")+
  scale_fill_manual(values = col.cat)+theme_void(base_size = 10)+theme(legend.position = "bottom")
```

```{r lang-france}
lang.fra <- fra %>% mutate(RF = pre/temp)

lang.fra$cat.AI <- cut(lang.fra$RF, breaks = breaks.lang) %>% revalue(cat.lang)

g1f <- ggplot(lang.fra)+geom_raster(aes(x = lon, y = lat, fill = RF))+
    borders(regions = "France")+
  labs(title = "Lang Rain Factor, France", fill = "")+scale_fill_viridis_c(direction = -1, lim = c(-0, 200))+theme_void(base_size = 10)+theme(legend.position = "bottom")

g2f <- ggplot(lang.fra)+geom_raster(aes(x = lon, y = lat, fill = cat.AI))+
    borders(regions = "France")+
  labs(title = "Lang Rain Factor, France", fill = "")+
  scale_fill_manual(values = col.cat)+theme_void(base_size = 10)+theme(legend.position = "bottom")
```

```{r ggarrange, fig.dim = c(8,4)}
ggarrange(g1f,g1c, common.legend = T, legend = "bottom")
ggarrange(g2f, g2c, common.legend = T, legend = "bottom")
```

```{r lang-world}
lang.w <- world.df %>% mutate(RF = pre/temp)

lang.w$cat.AI <- cut(lang.w$RF, breaks = breaks.lang) %>% revalue(cat.lang)

ggplot(lang.w)+geom_raster(aes(x = lon, y = lat, fill = RF))+
  labs(title = "Lang Rain Factor", fill = "")+scale_fill_viridis_c(direction = -1, lim = c(-0, 500))+theme_void(base_size = 10)+theme(legend.position = "bottom")

ggplot(lang.w)+geom_raster(aes(x = lon, y = lat, fill = cat.AI))+
  labs(title = "Lang Rain Factor", fill = "")+
  scale_fill_manual(values = col.cat)+theme_void(base_size = 10)+theme(legend.position = "bottom")

saveRDS(lang.w, "Worldclim/lang.w.rds")
```

# De Martonne, 1926

Dans une communication en 1926, De Martonne présente son indice d’aridité fondé sur un ratio entre les précipitations et la température [@Martonne1926], similaire à l’indice de Lang, mais qui peut être utilisé pour des températures annuelles négatives. Les seuils de cet indice sont définis en comparant la répartition géographique de l’indice avec celle des zones « sans écoulement ».  

$A_m=  P/(T+10)$

Avec P en cm et T en degrés celsius. 

Tableau: https://lbusett.github.io/insert_table/ 

Am	Zone	Irrigation	Exemple
< 5	Désert		Le Caire, Lima, Port Nolloth
5 < Am < 10	Zone aride	Irrigation indispensable	Dueim, Brakfontein
10 < Am < 20	Zone semi-aride	Irrigation nécessaire	Lahore, Kayes, Salta
20 < Am < 30	Zone tempérée	Irrigation utile	
30 < Am < 40	Zone humide	Irrigation inutile, drainage parfois nécessaire	
> 40	Forêt 		


Définition: @Martonne1926
Usage et détails: @Baltas2007.

```{r categories-martonne}
breaks.baltas <- c(0,5,10,20,24,28,35,55,Inf)
cat.baltas <- c("[0,5]" = "Desert", "(5,10]"= "Dry", "(10,20]" = "Semi-dry","(20,24]" = "Mediterranean", "(24,28]" = "Semi-humid", "(28,35]" = "Humid","(35,55]" = "Very humid (a)", "(55,Inf]" = "Very humid (b)")
col.baltas <- c("Desert" = colorvec[1],"Dry" = colorvec[2], "Semi-dry"= colorvec[3],"Meditarranean"= colorvec[4], "Semi-humid" = colorvec[5], "Humid"= colorvec[6],"Very humid (a)"= colorvec[7], "Very humid (b)" = colorvec[8])

breaks.martonne <- c(0,5,10,20,"30","40",Inf)
cat.martonne <- c("[0,5]" = "Desert", "(5,10]"= "Arid", "(10,20]" = "Semi-arid","(20,30]" = "Temperate", "(30,40]" = "Humid", "(40,Inf]" = "Forest")
col.martonne <- c("Desert" = colorvec[1], "Arid"= colorvec[2],"Semi-arid"= colorvec[3], "Temperate" = colorvec[4], "Humid"= colorvec[5],"Forest"= colorvec[6])

```

```{r martonne-civ}
martonne.civ <- civ %>% mutate(Am = pre/(temp+10)) # pre en mm
martonne.civ$cat.baltas <- martonne.civ$Am %>% cut(breaks.baltas, include.lowest = T) %>% revalue(cat.baltas)
martonne.civ$cat.martonne <- martonne.civ$Am %>% cut(breaks.martonne, include.lowest = T) %>% revalue(cat.martonne)

g1c <- ggplot(martonne.civ)+geom_raster(aes(x = lon, y = lat, fill = Am))+
    borders(regions = "Ivory Coast")+
  labs(title = "De Martonne Aridity Index, Ivory Coast", fill = "")+
  scale_fill_viridis_c(direction = -1)+
  theme_void(base_size = 10)+theme(legend.position = "bottom")+guides(fill = guide_legend(nrow = 1))

g2c <- ggplot(martonne.civ)+ geom_raster(aes(x = lon, y = lat, fill = cat.baltas))+
    borders(regions = "Ivory Coast")+
  labs(title = "De Martonne Aridity Index, Ivory Coast\nBaltas categories", fill = "")+
  scale_fill_manual(values = col.baltas)+
  theme_void(base_size = 10)+theme(legend.position = "bottom")+guides(fill = guide_legend(nrow = 2))

g3c <- ggplot(martonne.civ)+ geom_raster(aes(x = lon, y = lat, fill = cat.martonne))+
    borders(regions = "Ivory Coast")+
  labs(title = "De Martonne Aridity Index, Ivory Coast\nMartonne categories", fill = "")+
  scale_fill_manual(values = col.martonne)+
  theme_void(base_size = 10)+theme(legend.position = "bottom")+guides(fill = guide_legend(nrow = 2))
```

```{r martonne-fra}
martonne.fra <- fra %>% mutate(Am = pre/(temp+10)) # pre en mm
martonne.fra$cat.baltas <- martonne.fra$Am %>% cut(breaks.baltas, include.lowest = T) %>% revalue(cat.baltas)
martonne.fra$cat.martonne <- martonne.fra$Am %>% cut(breaks.martonne, include.lowest = T) %>% revalue(cat.martonne)

g1f <- ggplot(martonne.fra)+geom_raster(aes(x = lon, y = lat, fill = Am))+
    borders(regions = "France")+
  labs(title = "De Martonne Aridity Index, France", fill = "")+
  scale_fill_viridis_c(direction = -1, lim = c(0,100))+
  theme_void(base_size = 10)+theme(legend.position = "bottom")+guides(fill = guide_legend(nrow = 1))

g2f <- ggplot(martonne.fra)+geom_raster(aes(x = lon, y = lat, fill = cat.baltas))+
    borders(regions = "France")+
  labs(title = "De Martonne Aridity Index, France", fill = "")+
  scale_fill_manual(values = col.baltas)+
  theme_void(base_size = 10)+theme(legend.position = "bottom")+guides(fill = guide_legend(nrow = 2))

g3f <- ggplot(martonne.fra)+geom_raster(aes(x = lon, y = lat, fill = cat.martonne))+
    borders(regions = "France")+
  labs(title = "De Martonne Aridity Index, France", fill = "")+
  scale_fill_manual(values = col.martonne)+
  theme_void(base_size = 10)+theme(legend.position = "bottom")+guides(fill = guide_legend(nrow = 2))

```

```{r plot-mart, fig.dim = c(8,4)}
ggarrange(g1f,g1c, common.legend = T, legend = "bottom")
ggarrange(g2f,g2c, common.legend = T, legend = "bottom")
ggarrange(g3f,g3c, common.legend = T, legend = "bottom")
```

```{r martonne-world}
martonne.w <- world.df %>% mutate(Am = pre/(temp+10)) # pre en mm
martonne.w$cat.baltas <- martonne.w$Am %>% cut(breaks.baltas, include.lowest = T) %>% revalue(cat.baltas)
martonne.w$cat.martonne <- martonne.w$Am %>% cut(breaks.martonne, include.lowest = T) %>% revalue(cat.martonne)

ggplot(martonne.w)+geom_raster(aes(x = lon, y = lat, fill = Am))+
  labs(title = "De Martonne Aridity Index", fill = "")+
  scale_fill_viridis_c(direction = -1, lim = c(0, 200))+theme_void(base_size = 10)+theme(legend.position = "bottom")+guides(fill = guide_legend(nrow = 1))

ggplot(martonne.w)+geom_raster(aes(x = lon, y = lat, fill = cat.baltas))+
  labs(title = "De Martonne Aridity Index\n Baltas categories", fill = "")+
  scale_fill_manual(values = col.baltas)+theme_void(base_size = 10)+theme(legend.position = "bottom")+guides(fill = guide_legend(nrow = 2))

ggplot(martonne.w)+geom_raster(aes(x = lon, y = lat, fill = cat.martonne))+
  labs(title = "De Martonne Aridity Index\n Martonne categories", fill = "")+
  scale_fill_manual(values = col.martonne)+theme_void(base_size = 10)+theme(legend.position = "bottom")+guides(fill = guide_legend(nrow = 2))

saveRDS(martonne.w, "Worldclim/martonne.w.rds")
```

Autres usages:

•	Comparaison des indices d’aridité dans le Nord de l’Algérie, Derdous et al. 20219. Obj : « accurate climate classification in Northern Algeria ».
•	@Mustafa2018 : aridity trend in Kurdistan
•	@Tabari2014: aridity trends in Iran and impact on regional agriculture
•	@Baltas2007 : assessing climate in Northern Greece
•	Bahmani et al. 2021: De Martonne, Pinna, UNEP: aridity in the Sirvan River Basin Iran
•	Ahma et al. 2018, Moral et al. 2016: De Martonne, Pinna, FAO indeces to assess the spatial distribution of aridity in Ethiopia and Spain.
•	@Croitoru2013: De Martonne and Pinna combinative; spatial patterns of aridity in Romania


# Emberger, 1930

Emberger est un botaniste. En comparant la végétation du sud de la France et celle du Maroc, notamment les chênes verts, il se rend compte que les mêmes arbres n’occupent pas forcément le même étage d’altitude. Il synthétise le climat à l’aide d’un quotient pluviométrique qui prend en compte les précipitations annuelles et les extrêmes de température12. Cela permet de prendre en compte les interactions entre les températures minimum et la disponibilité de l’eau.  Ainsi, les régions telles que le Moyen et Grand Atlas peuvent supporter une végétation de type méditerranéenne, car elles sont plus sèches @Marres1972. 

La formule est définie dans @Emberger1930 et expliquée dans @Marres1972. 

Q=  (P×100)/(2×((M+m)/2)×(M-m))
P : précipitations annuelles, mm
M : moyenne des maxima de température du mois le plus chaud ; °C
M : moyenne des minima de température du mois le plus froid ; °C
Indice	Zone
< 10	Hyper arid
10-45	Aride
45-70	Semi Aride
70-110	Subhumid
110-150	Humid
>150 	Hyper humid


Détails sur le calcul: 
La température max utilisée est la température moyenne du mois le plus chaud, et inversement pour la température minimum, ici en degrés. Plusieurs versions de la formule existent dans la littérature. Les fonctions R prédéfinies utilisent 100P/(T2-t2) en K, alors que  @Baldy1972 au Liban utilise un facteur 1000 et Marres parle en °C. @Shaban2019 utilisent des °C. 

```{r categories-emberger}
breaks.emberger <- c(-Inf, 0,10,45,70,110,150, +Inf)
cat.emberger <- c("(-Inf,0]" = NA,"(0,10]"= "Hyperarid", "(10,45]" = "Arid", "(45,70]" = "Semi-arid", "(70,110]" = "Subhumid","(110,150]" = "Humid","(150, Inf]" = "Hyper-humid")
col.cat <- c("Hyperarid" = colorvec[1], "Arid"= colorvec[2],"Semi-arid"= colorvec[3], "Subhumid" = colorvec[4], "Humid"= colorvec[5],"Hyper-humid"= colorvec[6])
```

```{r emberger-civ }

emberger.civ <- civ 
emberger.civ$tmax <- apply(dplyr::select(civ, c("tmean_01", "tmean_02", "tmean_03", "tmean_04", "tmean_05", "tmean_06", "tmean_07", "tmean_08", "tmean_09", "tmean_10", "tmean_11", "tmean_12")), 1, max, na.rm = T)
emberger.civ$tmin <- apply(dplyr::select(civ, c("tmean_01", "tmean_02", "tmean_03", "tmean_04", "tmean_05", "tmean_06", "tmean_07", "tmean_08", "tmean_09", "tmean_10", "tmean_11", "tmean_12")), 1, min, na.rm = T)
emberger.civ$Em <- with(emberger.civ, pre*100/(tmax^2-tmin^2)) # Formulation from Marres1972. 

g1c <- ggplot(emberger.civ)+geom_raster(aes(x = lon, y = lat, fill = Em))+
    borders(regions = "Ivory Coast")+
  labs(fill = "Em")+scale_fill_viridis_c(direction = -1)+theme_void(base_size = 10)+theme(legend.position = "bottom")

emberger.civ$cat.AI <- cut(emberger.civ$Em, breaks = breaks.emberger) %>% revalue(cat.emberger)

g2c <- ggplot(emberger.civ)+geom_raster(aes(x = lon, y = lat, fill = cat.AI))+
    borders(regions = "Ivory Coast")+
  labs(title = "Emberger Aridity Index", fill = "")+scale_fill_manual(values = col.cat)+theme_void(base_size = 10)+
  theme(legend.position = "bottom")+guides(fill = guide_legend(nrow = 1))

```

```{r emberger-fra }

emberger.fra <- fra 
emberger.fra$tmax <- apply(dplyr::select(fra, c("tmean_01", "tmean_02", "tmean_03", "tmean_04", "tmean_05", "tmean_06", "tmean_07", "tmean_08", "tmean_09", "tmean_10", "tmean_11", "tmean_12")), 1, max, na.rm = T)
emberger.fra$tmin <- apply(dplyr::select(fra, c("tmean_01", "tmean_02", "tmean_03", "tmean_04", "tmean_05", "tmean_06", "tmean_07", "tmean_08", "tmean_09", "tmean_10", "tmean_11", "tmean_12")), 1, min, na.rm = T)
emberger.fra$Em <- with(emberger.fra, pre*100/(tmax^2-tmin^2)) # Formulation from Marres1972. 

g1f <- ggplot(emberger.fra)+geom_raster(aes(x = lon, y = lat, fill = Em))+
    borders(regions = "France")+
  labs(fill = "Em")+scale_fill_viridis_c(direction = -1)+theme_void(base_size = 10)+theme(legend.position = "bottom")

emberger.fra$cat.AI <- cut(emberger.fra$Em, breaks = breaks.emberger) %>% revalue(cat.emberger)

g2f <- ggplot(emberger.fra)+geom_raster(aes(x = lon, y = lat, fill = cat.AI))+
    borders(regions = "France")+
  labs(title = "Emberger Aridity Index", fill = "")+scale_fill_manual(values = col.cat)+theme_void(base_size = 10)+theme(legend.position = "bottom")+guides(fill = guide_legend(nrow = 2))

```
```{r plot-emberger, fig.dim = c(8,4)}
ggarrange(g1f,g1c, common.legend = T, legend = "bottom")
ggarrange(g2f,g2c, common.legend = T, legend = "bottom")
```

```{r emberger-w}
emberger.w <- world.df

emberger.w$tmax <-apply(dplyr::select(world.df, c("tmean_01", "tmean_02", "tmean_03", "tmean_04", "tmean_05", "tmean_06", "tmean_07", "tmean_08", "tmean_09", "tmean_10", "tmean_11", "tmean_12")), 1, max, na.rm = T)
emberger.w$tmin <- apply(dplyr::select(world.df, c("tmean_01", "tmean_02", "tmean_03", "tmean_04", "tmean_05", "tmean_06", "tmean_07", "tmean_08", "tmean_09", "tmean_10", "tmean_11", "tmean_12")), 1, min, na.rm = T)
emberger.w$Em <- with(emberger.w, pre*100/(tmax^2-tmin^2)) # Formulation from Marres1972. 


ggplot(emberger.w)+geom_raster(aes(x = lon, y = lat, fill = Em))+
  labs(fill = "Em")+scale_fill_viridis_c(direction = -1)+theme_void(base_size = 10)+theme(legend.position = "bottom")

emberger.w$cat.AI <- cut(emberger.w$Em, breaks = breaks.emberger) %>% revalue(cat.emberger)

ggplot(emberger.w)+geom_raster(aes(x = lon, y = lat, fill = cat.AI))+
  labs(title = "Emberger Aridity Index", fill = "")+scale_fill_manual(values = col.cat)+theme_void(base_size = 10)+theme(legend.position = "bottom")+guides(fill = guide_legend(nrow = 2))

saveRDS(emberger.w, "Worldclim/emberger.w.rds")
```

Encore une fois, ne fonctionne pas si la température annuelle moyenne (ou tmax-tmin) est < 0: l'indice devient négatif

# Ångström, 1936

Angström note que les indices d’aridité fondés sur des rapports de précipitation et de température n’ont pas de sens physique [@Angstrom1936]. Il souhaite intégrer la notion d’évaporation dans l’indice, mais celle-ci est difficile à estimer. En utilisant des données expérimentales de certaines rivières suédoises, il exprime l’intensité des précipitations annuelles en fonction de la température. 

Il note la similitude de l’indice avec celui de De Martonne. Utilisation des mêmes seuils ?

```{r categories-angstrom}
breaks.angstrom <- c(0,20,40,60,100,160,Inf)
cat.angstrom <- c("[0,20]"= "Deserts", "(20,40]" = "Arid", "(40,60]" = "Semi-arid", "(60,100]" = "Semi-humid","(100,160]" = "Humid", "(160,Inf]"= "Hyper-humid")
col.cat <- c("Deserts" = colorvec[1], "Arid"= colorvec[2],"Semi-arid"= colorvec[3], "Semi-humid" = colorvec[4], "Humid"= colorvec[5],"Hyper-humid"= colorvec[6])
```

```{r angstrom-civ}
ang.civ <- civ %>% mutate(AI = pre/(1.07^temp))

ang.civ$cat.AI <- ang.civ$AI %>% cut(breaks = breaks.angstrom, include.lowest = T) %>% revalue(cat.angstrom)

g1c <- ggplot(ang.civ)+geom_raster(aes(x = lon, y = lat, fill = AI))+
    borders(regions = "Ivory Coast")+
  labs(title = "Ångström Aridity Index", fill = "")+scale_fill_viridis_c(direction = -1)+theme_void(base_size = 10)+theme(legend.position = "bottom")+guides(fill = guide_legend(nrow = 1))

g2c <- ggplot(ang.civ)+geom_raster(aes(x = lon, y = lat, fill = cat.AI))+
    borders(regions = "Ivory Coast")+
  labs(title = "Ångström Aridity Index", fill = "")+scale_fill_manual(values = col.cat)+theme_void(base_size = 10)+theme(legend.position = "bottom")+guides(fill = guide_legend(nrow = 1))
```

```{r angstrom-fra}
ang.fra <- fra %>% mutate(AI = pre/(1.07^temp))

ang.fra$cat.AI <- ang.fra$AI %>% cut(breaks = breaks.angstrom) %>% 
  revalue(cat.angstrom)

g1f <- ggplot(ang.fra)+geom_raster(aes(x = lon, y = lat, fill = AI))+
  borders(regions = "France")+
  labs(title = "Ångström Aridity Index", fill = "")+scale_fill_viridis_c(direction = -1)+
  theme_void(base_size = 10)+theme(legend.position = "bottom")+guides(fill = guide_legend(nrow = 1))

g2f <- ggplot(ang.fra)+geom_raster(aes(x = lon, y = lat, fill = cat.AI))+
  borders(regions = "France")+
  labs(title = "Ångström Aridity Index", fill = "")+
  scale_fill_manual(values = col.cat)+
  theme_void(base_size = 10)+theme(legend.position = "bottom")+guides(fill = guide_legend(nrow = 1))
```

```{r plot-angstrom, fig.dim = c(8,4)}
ggarrange(g1f,g1c, common.legend = T, legend = "bottom")
ggarrange(g2f,g2c, common.legend = T, legend = "bottom")
```

```{r angstrom-world }

ang.w <- world.df %>% mutate(AI = pre/(1.07^temp))

ang.w$cat.AI <- ang.w$AI %>% cut(breaks = breaks.angstrom, include.lowest = T) %>% revalue(cat.angstrom)

ggplot(ang.w)+geom_raster(aes(x = lon, y = lat, fill = AI))+
  labs(title = "Ångström Aridity Index", fill = "")+
  scale_fill_viridis_c(direction = -1)+theme_void(base_size = 10)+
  theme(legend.position = "bottom")+guides(fill = guide_legend(nrow = 1))

ggplot(ang.w)+geom_raster(aes(x = lon, y = lat, fill = cat.AI))+
  labs(title = "Ångström Aridity Index", fill = "")+
  scale_fill_manual(values = col.cat)+
  theme_void(base_size = 10)+theme(legend.position = "bottom")+guides(fill = guide_legend(nrow = 1))

saveRDS(ang.w, "Worldclim/ang.w.rds")

```

# UNESCO, 1979 

AI, défini comme le rapport entre la demande en eau (évapotranspiration) et la ressource en eau (précipitation), sur une moyenne de 30 ans. Il est largement dépendant de la manière dont est calculée la valeur moyenne de l’évapotranspiration. Dans l’équation de référence, définie par la FAO17, l’évapotranspiration est calculée selon l’équation de Penman-Monteith en fonction du niveau de radiation solaire, du vent, de la pression de vapeur saturante, etc. L’évapotranspiration potentielle utilisée comme référence correspond à l’évapotranspiration d’une surface de référence, couverte d’une hypothétique céréale de 12 cm, bien arrosée. Cette référence est critiquée notamment parce qu’elle tendrait à surestimer l’évapotranspiration dans un contexte de changement climatique, ne prenant pas en compte l’augmentation de la concentration en CO2 de l’atmosphère et l’augmentation de l’efficacité d’usage de l’eau des plantes @Greve2019. 

La formule de Penman-Monteith @FAO1998 pour l’évapotranspiration est :

$ET_0=(0.408∆(R_n-G)+γ 900/(T+273) u_2 (e_s-e_a ))/(∆+γ(1+0.34u_2 ) )$

Avec : 
•	ET0 reference evapotrasnpiration mm/day
•	Rn net radiation at the crop surface MJ/m2/day
•	G soil heat flux density MJ/m2/day
•	T mean daily air temperature °C
•	u2 wind speed at 2 m height m/s
•	es saturation vapour pressure kPa
•	ea actual vapour pressure kPa
•	es-ea saturation vapour pressure deficit kPa
•	Δ slope vapour pressure constant ka/°C
•	γ psychrometric constant kPa/°C


Indice	Zone
AI < 0.03	Hyper-aride
0.03 < AI < 0.2	Aride
0.2 < AI < 0.5	Semi-aride
0.5 < AI < 0.65	Aride subhumide

Autres usages:
•	Ahma et al. 2018, Moral et al. 2016: De Martonne, Pinna, FAO indeces to assess the spatial distribution of aridity in Ethiopia and Spain.
•	@Greve2019 : how will the index evolve with climate change?



More details:

Index established by @UNESCO1979, used and detailed by @Tsakiris2005

Formulas available at: https://www.fao.org/3/x0490E/x0490e0k.htm#annex%203.%20background%20on%20physical%20parameters%20used%20in%20evapotranspiration%20computatio 

```{r categories-unesco}
breaks.unesco <- c(0,0.03,0.2,0.5,0.75,Inf)
cat.unesco <- c("[0,0.03]"= "Hyperarid", "(0.03,0.2]" = "Arid", "(0.2,0.5]" = "Semi-arid", "(0.5,0.75]" = "Dry subhumid","(0.75,Inf]" = "Humid")
col.cat <- c("Hyperarid" = colorvec[1], "Arid"= colorvec[2],"Semi-arid"= colorvec[3], "Dry subhumid" = colorvec[4], "Humid"= colorvec[5])
```

```{r PM-perso-civ} 
unesco.civ <- civ %>% mutate(P = 101.3 * ((293-0.0065*z)/293)^(5.26)) #atm P based on Burman et al. 1987

unesco.civ$tmax <- apply(dplyr::select(civ, c("tmax_01", "tmax_02", "tmax_03", "tmax_04", "tmax_05", "tmax_06", "tmax_07", "tmax_08", "tmax_09", "tmax_10", "tmax_11", "tmax_12")), 1, max, na.rm = T)
unesco.civ$tmin <- apply(dplyr::select(civ, c("tmin_01", "tmin_02", "tmin_03", "tmin_04", "tmin_05", "tmin_06", "tmin_07", "tmin_08", "tmin_09", "tmin_10", "tmin_11", "tmin_12")), 1, min, na.rm = T)

unesco.civ$es <- with(unesco.civ, ifelse(temp > 0, 0.61078*exp(17.27*temp/(temp+237.3)),  0.61078*exp(21.875*temp/(temp+265.5)))) # saturation vapor pressure Monteith-Unsworth pour >0, Murray pour T < 0
unesco.civ$delta <- with(unesco.civ, 4098*es/(temp+237.3)^2) #slope vapor pressure
unesco.civ$gamma <- with(unesco.civ, 0.00163*P/(2.501-52.6361e-3*temp)) #psychrometric constant
unesco.civ$ea <- with(unesco.civ, with(unesco.civ, ifelse(tmin > 0, 0.61078*exp(17.27*tmin/(tmin+237.3)),  0.61078*exp(21.875*tmin/(tmin+265.5))))) # actual vapor pressur; when relative humidity is not availabmle, ea is obtained by estimating that when the air temp is close to Tmin, it is nearly saturated
unesco.civ$ET0 <-with(unesco.civ, (0.408*delta*Rn*1e-3+gamma*900/(temp+273)*u2*(es-ea)/(delta+gamma*(1+0.34*u2)))) # Evapotranspiration, G considered to be negligible. in mm/day
unesco.civ$AI_FAO <- with(unesco.civ, pre/(ET0*365))

unesco.civ$cat.AI_FAO <- unesco.civ$AI_FAO %>% cut(breaks = breaks.unesco, include.lowest = T) %>% 
  revalue(cat.unesco)

g1c <- ggplot(unesco.civ)+geom_raster(aes(x = lon, y = lat, fill = AI_FAO))+
  borders(regions = "Ivory Coast")+
  labs(title = "Unesco Aridity Index", fill = "")+
  scale_fill_viridis_c(direction = -1)+
  theme_void(base_size = 10)+theme(legend.position = "bottom")+guides(fill = guide_legend(nrow = 2))

g2c <- ggplot(unesco.civ)+geom_raster(aes(x = lon, y = lat, fill = cat.AI_FAO))+
  borders(regions = "Ivory Coast")+
  labs(title = "Unesco Aridity Index", fill = "")+
  scale_fill_manual(values = col.cat)+
  theme_void(base_size = 10)+theme(legend.position = "bottom")+guides(fill = guide_legend(nrow = 2))

```

```{r PM-perso-fra} 
unesco.fra <- fra %>% mutate(P = 101.3 * ((293-0.0065*z)/293)^(5.26)) #atm P based on Burman et al. 1987

unesco.fra$tmax <- apply(dplyr::select(fra, c("tmax_01", "tmax_02", "tmax_03", "tmax_04", "tmax_05", "tmax_06", "tmax_07", "tmax_08", "tmax_09", "tmax_10", "tmax_11", "tmax_12")), 1, max, na.rm = T)
unesco.fra$tmin <- apply(dplyr::select(fra, c("tmin_01", "tmin_02", "tmin_03", "tmin_04", "tmin_05", "tmin_06", "tmin_07", "tmin_08", "tmin_09", "tmin_10", "tmin_11", "tmin_12")), 1, min, na.rm = T)

unesco.fra$es <- with(unesco.fra, ifelse(temp > 0, 0.61078*exp(17.27*temp/(temp+237.3)),  0.61078*exp(21.875*temp/(temp+265.5)))) # saturation vapor pressure Monteith-Unsworth pour >0, Murray pour T < 0
unesco.fra$delta <- with(unesco.fra, 4098*es/(temp+237.3)^2) #slope vapor pressure
unesco.fra$gamma <- with(unesco.fra, 0.00163*P/(2.501-52.6361e-3*temp)) #psychrometric constant
unesco.fra$ea <- with(unesco.fra, with(unesco.fra, ifelse(tmin > 0, 0.61078*exp(17.27*tmin/(tmin+237.3)),  0.61078*exp(21.875*tmin/(tmin+265.5))))) # actual vapor pressur; when relative humidity is not availabmle, ea is obtained by estimating that when the air temp is close to Tmin, it is nearly saturated
unesco.fra$ET0 <-with(unesco.fra, (0.408*delta*Rn*1e-3+gamma*900/(temp+273)*u2*(es-ea)/(delta+gamma*(1+0.34*u2)))) # Evapotranspiration, G considered to be negligible. in mm/day
unesco.fra$AI_FAO <- with(unesco.fra, pre/(ET0*365))

unesco.fra$cat.AI_FAO <- unesco.fra$AI_FAO %>% cut(breaks = breaks.unesco) %>% 
  revalue(cat.unesco)

g1f <- ggplot(unesco.fra)+geom_raster(aes(x = lon, y = lat, fill = AI_FAO))+
    borders(regions = "France")+
  labs(title = "Unesco Aridity Index", fill = "")+
  scale_fill_viridis_c(direction = -1)+
  theme_void(base_size = 10)+theme(legend.position = "bottom")+guides(fill = guide_legend(nrow = 1))

g2f <- ggplot(unesco.fra)+geom_raster(aes(x = lon, y = lat, fill = cat.AI_FAO))+
  borders(regions = "France")+
  labs(title = "Unesco Aridity Index", fill = "")+
    scale_fill_manual(values = col.cat)+
  theme_void(base_size = 10)+theme(legend.position = "bottom")+guides(fill = guide_legend(nrow = 1))
```

```{r plot-unesco, fig.dim = c(8,4)}
ggarrange(g1f,g1c, common.legend = T, legend = "bottom")
ggarrange(g2f,g2c, common.legend = T, legend = "bottom")
```
```{r PM-perso-world} 
unesco.w <- world.df %>% mutate(P = 101.3 * ((293-0.0065*z)/293)^(5.26)) #atm P based on Burman et al. 1987

unesco.w$tmax <- apply(dplyr::select(world.df, c("tmax_01", "tmax_02", "tmax_03", "tmax_04", "tmax_05", "tmax_06", "tmax_07", "tmax_08", "tmax_09", "tmax_10", "tmax_11", "tmax_12")), 1, max, na.rm = T)
unesco.w$tmin <- apply(dplyr::select(world.df, c("tmin_01", "tmin_02", "tmin_03", "tmin_04", "tmin_05", "tmin_06", "tmin_07", "tmin_08", "tmin_09", "tmin_10", "tmin_11", "tmin_12")), 1, min, na.rm = T)
unesco.w$Rn <- apply(dplyr::select(world.df, c("srad_01", "srad_02", "srad_03", "srad_04", "srad_05", "srad_06", "srad_07", "srad_08", "srad_09", "srad_10", "srad_11", "srad_12")), 1, mean, na.rm = T)
unesco.w$u2 <- apply(dplyr::select(world.df, c("u_01", "u_02", "u_03", "u_04", "u_05", "u_06", "u_07", "u_08", "u_09", "u_10", "u_11", "u_12")), 1, mean, na.rm = T)

unesco.w$es <- with(unesco.w, ifelse(temp > 0, 0.61078*exp(17.27*temp/(temp+237.3)),  0.61078*exp(21.875*temp/(temp+265.5)))) # saturation vapor pressure Monteith-Unsworth pour >0, Murray pour T < 0
unesco.w$delta <- with(unesco.w, 4098*es/(temp+237.3)^2) #slope vapor pressure
unesco.w$gamma <- with(unesco.w, 0.00163*P/(2.501-52.6361e-3*temp)) #psychrometric constant
unesco.w$ea <- with(unesco.w, with(unesco.w, ifelse(tmin > 0, 0.61078*exp(17.27*tmin/(tmin+237.3)),  0.61078*exp(21.875*tmin/(tmin+265.5))))) # actual vapor pressur; when relative humidity is not availabmle, ea is obtained by estimating that when the air temp is close to Tmin, it is nearly saturated
unesco.w$ET0 <-with(unesco.w, (0.408*delta*Rn*1e-3+gamma*900/(temp+273)*u2*(es-ea)/(delta+gamma*(1+0.34*u2)))) # Evapotranspiration, G considered to be negligible. in mm/day
unesco.w$AI_FAO <- with(unesco.w, pre/(ET0*365))

unesco.w$cat.AI_FAO <- unesco.w$AI_FAO %>% cut(breaks = breaks.unesco, include.lowest = T) %>% # otherwise regions in  which pre = 0 are excluded 
  revalue(cat.unesco)

ggplot(unesco.w)+geom_raster(aes(x = lon, y = lat, fill = AI_FAO))+
  labs(title = "Unesco Aridity Index", fill = "")+
  scale_fill_viridis_c(direction = -1)+
  theme_void(base_size = 10)+theme(legend.position = "bottom")+guides(fill = guide_legend(nrow = 1))

ggplot(unesco.w)+geom_raster(aes(x = lon, y = lat, fill = cat.AI_FAO))+
  labs(title = "Unesco Aridity Index)", fill = "")+
  scale_fill_manual(values = col.cat)+
  theme_void(base_size = 10)+theme(legend.position = "bottom")+guides(fill = guide_legend(nrow = 1))

saveRDS(unesco.w, "Worldclim/unesco.w.rds")
```

# UNEP (Thornthwaite)

## Définition 

Comme précédemment, l’aridité est définie comme le rapport entre les précipitations et l’évapotranspiration potentielle. Ici, l’évapotranspiration est calculée selon la formule de Thornthwaite, qui l’exprime en fonction de la température moyenne. 
E_p=16×L/12×N/30×((10×T_a)/I)^a
	L est la durée du jour en h
	N le nombre de jours dans le mois
	Ta la température annuelle moyenne
I est la somme des « indices de chaleur » mensuels :
I= ∑▒(T_a/5)^1.514 
Et a est une fonction de I :
a=6.75×〖10〗^(-7)×I^3-7.71×〖10〗^(-5)×I^2+1.79×〖10〗^(-2)×I+0.49


## Usages

•	World atlas of desertification19 (also 1992 when the index was defined)
•	Sarlak and mahmood agha 2018: Lang, De Martonne, UNEP and Erinc aridity index, spatiotemporal variabtions of aridity in Irak.
•	@Kumar2021 : frequency of droughts depending on aridity regions


## Détails de calcul

1. Extraire la température mensuelle pur les 12 mois. 
2. calculer tho pour chaque point. Résultat: PET par mois
3. Additionner les PET pour obtenir annual PET. 

Catégorisation @Tsakiris2005

```{r categories-unep}
breaks.unep <- c(0,0.05,0.2,0.5,0.65,Inf)
cat.unep <- c("[0,0.05]"= "Hyperarid", "(0.05,0.2]" = "Arid", "(0.2,0.5]" = "Semi-arid", "(0.5,0.65]" = "Dry subhumid","(0.65,Inf]" = "Humid")
col.cat <- c("Hyperarid" = colorvec[1], "Arid"= colorvec[2],"Semi-arid"= colorvec[3], "Dry subhumid" = colorvec[4], "Humid"= colorvec[5])
```

```{r thornthwaite-civ-by-hand }
thorn.civ <- mutate(civ, i_01 = (tmean_01/5)^1.514,
                    i_02 = (tmean_02/5)^1.514,
                    i_03 = (tmean_03/5)^1.514,
                    i_04 = (tmean_04/5)^1.514,
                    i_05 = (tmean_05/5)^1.514,
                    i_06 = (tmean_06/5)^1.514,
                    i_07 = (tmean_07/5)^1.514,
                    i_08 = (tmean_08/5)^1.514,
                    i_09 = (tmean_09/5)^1.514,
                    i_10 = (tmean_10/5)^1.514,
                    i_11 = (tmean_11/5)^1.514,
                    i_12 = (tmean_12/5)^1.514,
                    I = i_01+i_02+i_03+i_04+i_05+i_06+i_07+i_08+i_09+i_10+i_11+i_12,
                    a = (6.751e-7)*I^3 - (7.7e-5)*I^2 + 0.01729*I + 0.49239,
                    e_01 = 16* geosphere::daylength(lat,"2000-01-15")/12* 31 /30*(10*tmean_01/I)^a, #Ep = 16 * L/12 * N/30 * (10T/I) ^a, L is length of daylight, N number of days in month
                    e_02 = 16* geosphere::daylength(lat,"2000-02-15")/12* 28 /30*(10*tmean_02/I)^a,
                    e_03 = 16* geosphere::daylength(lat,"2000-03-15")/12* 31 /30*(10*tmean_03/I)^a,
                    e_04 = 16* geosphere::daylength(lat,"2000-04-15")/12* 30 /30*(10*tmean_04/I)^a,
                    e_05 = 16* geosphere::daylength(lat,"2000-05-15")/12* 31 /30*(10*tmean_05/I)^a,
                    e_06 = 16* geosphere::daylength(lat,"2000-06-15")/12* 30 /30*(10*tmean_06/I)^a,
                    e_07 = 16* geosphere::daylength(lat,"2000-07-15")/12* 31 /30*(10*tmean_07/I)^a,
                    e_08 = 16* geosphere::daylength(lat,"2000-08-15")/12* 31 /30*(10*tmean_08/I)^a,
                    e_09 = 16* geosphere::daylength(lat,"2000-09-15")/12* 30 /30*(10*tmean_09/I)^a,
                    e_10 = 16* geosphere::daylength(lat,"2000-10-15")/12* 31 /30*(10*tmean_10/I)^a,
                    e_11 = 16* geosphere::daylength(lat,"2000-11-15")/12* 30 /30*(10*tmean_11/I)^a,
                    e_12 = 16* geosphere::daylength(lat,"2000-12-15")/12* 31 /30*(10*tmean_12/I)^a,
                    ET = e_01+e_02+e_03+e_04+e_05+e_06+e_07+e_08+e_09+e_10+e_11,e_12, # en mm
                    AI = pre/ET)

thorn.civ$cat.AI <- cut(thorn.civ$AI, breaks = breaks.unep) %>% revalue(cat.unep) # cuts from Tsakiris2005

g1c <- ggplot(thorn.civ)+geom_raster(aes(x = lon, y = lat, fill = AI))+
    borders(regions = "Ivory Coast")+
  labs(title = "UNEP Aridity Index", fill = "")+
  scale_fill_viridis_c(direction = -1)+
  theme_void(base_size = 10)+theme(legend.position = "bottom")+guides(fill = guide_legend(nrow = 1))

g2c <- ggplot(thorn.civ)+geom_raster(aes(x = lon, y = lat, fill = cat.AI))+
  borders(regions = "Ivory Coast")+
  labs(title = "UNEP AI (Thornthwaite)", fill = "")+
  scale_fill_manual(values = col.cat)+
  theme_void(base_size = 10)+theme(legend.position = "bottom")+guides(fill = guide_legend(nrow = 1))
```

```{r thornthwaite-fra-by-hand }
thorn.fra <- mutate(fra, i_01 = (tmean_01/5)^1.514,
                    i_02 = (tmean_02/5)^1.514,
                    i_03 = (tmean_03/5)^1.514,
                    i_04 = (tmean_04/5)^1.514,
                    i_05 = (tmean_05/5)^1.514,
                    i_06 = (tmean_06/5)^1.514,
                    i_07 = (tmean_07/5)^1.514,
                    i_08 = (tmean_08/5)^1.514,
                    i_09 = (tmean_09/5)^1.514,
                    i_10 = (tmean_10/5)^1.514,
                    i_11 = (tmean_11/5)^1.514,
                    i_12 = (tmean_12/5)^1.514,
                    I = i_01+i_02+i_03+i_04+i_05+i_06+i_07+i_08+i_09+i_10+i_11+i_12,
                    a = (6.751e-7)*I^3 - (7.7e-5)*I^2 + 0.01729*I + 0.49239,
                    e_01 = 16* geosphere::daylength(lat,"2000-01-15")/12* 31 /30*(10*tmean_01/I)^a, #Ep = 16 * L/12 * N/30 * (10T/I) ^a, L is length of daylight, N number of days in month
                    e_02 = 16* geosphere::daylength(lat,"2000-02-15")/12* 28 /30*(10*tmean_02/I)^a,
                    e_03 = 16* geosphere::daylength(lat,"2000-03-15")/12* 31 /30*(10*tmean_03/I)^a,
                    e_04 = 16* geosphere::daylength(lat,"2000-04-15")/12* 30 /30*(10*tmean_04/I)^a,
                    e_05 = 16* geosphere::daylength(lat,"2000-05-15")/12* 31 /30*(10*tmean_05/I)^a,
                    e_06 = 16* geosphere::daylength(lat,"2000-06-15")/12* 30 /30*(10*tmean_06/I)^a,
                    e_07 = 16* geosphere::daylength(lat,"2000-07-15")/12* 31 /30*(10*tmean_07/I)^a,
                    e_08 = 16* geosphere::daylength(lat,"2000-08-15")/12* 31 /30*(10*tmean_08/I)^a,
                    e_09 = 16* geosphere::daylength(lat,"2000-09-15")/12* 30 /30*(10*tmean_09/I)^a,
                    e_10 = 16* geosphere::daylength(lat,"2000-10-15")/12* 31 /30*(10*tmean_10/I)^a,
                    e_11 = 16* geosphere::daylength(lat,"2000-11-15")/12* 30 /30*(10*tmean_11/I)^a,
                    e_12 = 16* geosphere::daylength(lat,"2000-12-15")/12* 31 /30*(10*tmean_12/I)^a,
                    ET = e_01+e_02+e_03+e_04+e_05+e_06+e_07+e_08+e_09+e_10+e_11,e_12, # en mm
                    AI = pre/ET)

thorn.fra$cat.AI <- cut(thorn.fra$AI, breaks = breaks.unep) %>% revalue(cat.unep) # cuts from Tsakiris2005

g1f <- ggplot(thorn.fra)+geom_raster(aes(x = lon, y = lat, fill = AI))+
    borders(regions = "France")+
  labs(title = "UNEP Aridity Index", fill = "")+
  scale_fill_viridis_c(direction = -1)+
  theme_void(base_size = 10)+theme(legend.position = "bottom")+guides(fill = guide_legend(nrow = 1))

g2f <- ggplot(thorn.fra)+geom_raster(aes(x = lon, y = lat, fill = cat.AI))+
  borders(regions = "France")+
  labs(title = "UNEP AI (Thornthwaite)", fill = "")+
  scale_fill_manual(values = col.cat)+
  theme_void(base_size = 10)+theme(legend.position = "bottom")+guides(fill = guide_legend(nrow = 1))
```

```{r plot-unep, fig.dim = c(8,4)}
ggarrange(g1f,g1c, common.legend = T, legend = "bottom")
ggarrange(g2f,g2c, common.legend = T, legend = "bottom")
```

```{r thornthwaite-w-by-hand }
thorn.w <- mutate(world.df, 
                    i_01 = (tmean_01/5)^1.514,
                    i_02 = (tmean_02/5)^1.514,
                    i_03 = (tmean_03/5)^1.514,
                    i_04 = (tmean_04/5)^1.514,
                    i_05 = (tmean_05/5)^1.514,
                    i_06 = (tmean_06/5)^1.514,
                    i_07 = (tmean_07/5)^1.514,
                    i_08 = (tmean_08/5)^1.514,
                    i_09 = (tmean_09/5)^1.514,
                    i_10 = (tmean_10/5)^1.514,
                    i_11 = (tmean_11/5)^1.514,
                    i_12 = (tmean_12/5)^1.514,
                    I = i_01+i_02+i_03+i_04+i_05+i_06+i_07+i_08+i_09+i_10+i_11+i_12,
                    a = (6.751e-7)*I^3 - (7.7e-5)*I^2 + 0.01729*I + 0.49239,
                    e_01 = 16* geosphere::daylength(lat,"2000-01-15")/12* 31 /30*(10*tmean_01/I)^a, #Ep = 16 * L/12 * N/30 * (10T/I) ^a, L is length of daylight, N number of days in month
                    e_02 = 16* geosphere::daylength(lat,"2000-02-15")/12* 28 /30*(10*tmean_02/I)^a,
                    e_03 = 16* geosphere::daylength(lat,"2000-03-15")/12* 31 /30*(10*tmean_03/I)^a,
                    e_04 = 16* geosphere::daylength(lat,"2000-04-15")/12* 30 /30*(10*tmean_04/I)^a,
                    e_05 = 16* geosphere::daylength(lat,"2000-05-15")/12* 31 /30*(10*tmean_05/I)^a,
                    e_06 = 16* geosphere::daylength(lat,"2000-06-15")/12* 30 /30*(10*tmean_06/I)^a,
                    e_07 = 16* geosphere::daylength(lat,"2000-07-15")/12* 31 /30*(10*tmean_07/I)^a,
                    e_08 = 16* geosphere::daylength(lat,"2000-08-15")/12* 31 /30*(10*tmean_08/I)^a,
                    e_09 = 16* geosphere::daylength(lat,"2000-09-15")/12* 30 /30*(10*tmean_09/I)^a,
                    e_10 = 16* geosphere::daylength(lat,"2000-10-15")/12* 31 /30*(10*tmean_10/I)^a,
                    e_11 = 16* geosphere::daylength(lat,"2000-11-15")/12* 30 /30*(10*tmean_11/I)^a,
                    e_12 = 16* geosphere::daylength(lat,"2000-12-15")/12* 31 /30*(10*tmean_12/I)^a,
                    ET = e_01+e_02+e_03+e_04+e_05+e_06+e_07+e_08+e_09+e_10+e_11,e_12, # en mm
                    AI = pre/ET)

thorn.w$cat.AI <- cut(thorn.w$AI, breaks = breaks.unep, include.lowest = T) %>% revalue(cat.unep) # cuts from Tsakiris2005

ggplot(thorn.w)+geom_raster(aes(x = lon, y = lat, fill = AI))+
  labs(title = "UNEP Aridity Index", fill = "")+
  scale_fill_viridis_c(direction = -1)+
  theme_void(base_size = 10)+theme(legend.position = "bottom")+guides(fill = guide_legend(nrow = 1))

ggplot(thorn.w)+geom_raster(aes(x = lon, y = lat, fill = cat.AI))+
  labs(title = "UNEP AI (Thornthwaite)", fill = "")+
  scale_fill_manual(values = col.cat)+
  theme_void(base_size = 10)+theme(legend.position = "bottom")+guides(fill = guide_legend(nrow = 1))

saveRDS(thorn.w,"Worldclim/thorn.w.rds")
```

NA pour températures annuelles moyennes < 0, car les indices de chaleur mensuels sont calculés à partir de la température moyenne mensuelle élevé à la puissance 1.514

# AI with Hargreave evapotranspiration 

Hargreaves formula: @Hargreaves1985

Ra formula: https://www.agraria.unirc.it/documentazione/materiale_didattico/1462_2016_412_24509.pdf

```{r categories-har}
breaks.har <- c(0,0.05,0.2,0.5,0.65,Inf)
cat.har <- c("[0,0.05]"= "Hyperarid", "(0.05,0.2]" = "Arid", "(0.2,0.5]" = "Semi-arid", "(0.5,0.65]" = "Dry subhumid","(0.65,Inf]" = "Humid")
col.cat <- c("Hyperarid" = colorvec[1], "Arid"= colorvec[2],"Semi-arid"= colorvec[3], "Dry subhumid" = colorvec[4], "Humid"= colorvec[5])
```

```{r hargreaves-civ-by-hand}
hg.civ <- civ %>% mutate(psi = pi/180*lat, # latitude in radian
                    delta_01 = 0.409 * sin(2*pi/365*yday("2000-01-15")-1.39), #solar declination
                    delta_02 = 0.409 * sin(2*pi/365*yday("2000-02-15")-1.39), #solar declination
                    delta_03 = 0.409 * sin(2*pi/365*yday("2000-03-15")-1.39), #solar declination
                    delta_04 = 0.409 * sin(2*pi/365*yday("2000-04-15")-1.39), #solar declination
                    delta_05 = 0.409 * sin(2*pi/365*yday("2000-05-15")-1.39), #solar declination
                    delta_06 = 0.409 * sin(2*pi/365*yday("2000-06-15")-1.39), #solar declination
                    delta_07 = 0.409 * sin(2*pi/365*yday("2000-07-15")-1.39), #solar declination                    
                    delta_08 = 0.409 * sin(2*pi/365*yday("2000-08-15")-1.39), #solar declination
                    delta_09 = 0.409 * sin(2*pi/365*yday("2000-09-15")-1.39), #solar declination                    
                    delta_10 = 0.409 * sin(2*pi/365*yday("2000-10-15")-1.39), #solar declination
                    delta_11 = 0.409 * sin(2*pi/365*yday("2000-11-15")-1.39), #solar declination                    
                    delta_12 = 0.409 * sin(2*pi/365*yday("2000-12-15")-1.39), #solar declination                    
                    ws_01 = acos(-tan(psi)*tan(delta_01)), #sunset hour angle
                    ws_02 = acos(-tan(psi)*tan(delta_02)), #sunset hour angle
                    ws_03 = acos(-tan(psi)*tan(delta_03)), #sunset hour angle                    
                    ws_04 = acos(-tan(psi)*tan(delta_04)), #sunset hour angle                    
                    ws_05 = acos(-tan(psi)*tan(delta_05)), #sunset hour angle                    
                    ws_06 = acos(-tan(psi)*tan(delta_06)), #sunset hour angle                    
                    ws_07 = acos(-tan(psi)*tan(delta_07)), #sunset hour angle                    
                    ws_08 = acos(-tan(psi)*tan(delta_08)), #sunset hour angle
                    ws_09 = acos(-tan(psi)*tan(delta_09)), #sunset hour angle                    
                    ws_10 = acos(-tan(psi)*tan(delta_10)), #sunset hour angle
                    ws_11 = acos(-tan(psi)*tan(delta_11)), #sunset hour angle
                    ws_12 = acos(-tan(psi)*tan(delta_12)), #sunset hour angle                    
                    dr_01 = 1+0.033*cos(2*pi/365*yday("2000-01-15")), # inverse relative distance Earth-Sun
                    dr_02 = 1+0.033*cos(2*pi/365*yday("2000-02-15")), # inverse relative distance Earth-Sun
                    dr_03 = 1+0.033*cos(2*pi/365*yday("2000-03-15")), # inverse relative distance Earth-Sun                    
                    dr_04 = 1+0.033*cos(2*pi/365*yday("2000-04-15")), # inverse relative distance Earth-Sun                    
                    dr_05 = 1+0.033*cos(2*pi/365*yday("2000-05-15")), # inverse relative distance Earth-Sun                    
                    dr_06 = 1+0.033*cos(2*pi/365*yday("2000-06-15")), # inverse relative distance Earth-Sun                    
                    dr_07 = 1+0.033*cos(2*pi/365*yday("2000-07-15")), # inverse relative distance Earth-Sun                    
                    dr_08 = 1+0.033*cos(2*pi/365*yday("2000-08-15")), # inverse relative distance Earth-Sun
                    dr_09 = 1+0.033*cos(2*pi/365*yday("2000-09-15")), # inverse relative distance Earth-Sun                    
                    dr_10 = 1+0.033*cos(2*pi/365*yday("2000-10-15")), # inverse relative distance Earth-Sun                    
                    dr_11 = 1+0.033*cos(2*pi/365*yday("2000-11-15")), # inverse relative distance Earth-Sun                    
                    dr_12 = 1+0.033*cos(2*pi/365*yday("2000-12-15")), # inverse relative distance Earth-Sun                    
                    Ra_01 = 24*60/pi * 0.0820 * dr_01 * ((ws_01*sin(psi)*sin(delta_01))+cos(psi)*cos(delta_01)*sin(ws_01)), # external radiation MJ/m2/day
                    Ra_02 = 24*60/pi * 0.0820 * dr_02 * ((ws_01*sin(psi)*sin(delta_02))+cos(psi)*cos(delta_02)*sin(ws_02)), # external radiation MJ/m2/day                
                    Ra_03 = 24*60/pi * 0.0820 * dr_03 * ((ws_01*sin(psi)*sin(delta_03))+cos(psi)*cos(delta_03)*sin(ws_03)), # external radiation MJ/m2/day              
                    Ra_04 = 24*60/pi * 0.0820 * dr_04 * ((ws_01*sin(psi)*sin(delta_04))+cos(psi)*cos(delta_04)*sin(ws_04)), # external radiation MJ/m2/day                
                    Ra_05 = 24*60/pi * 0.0820 * dr_05 * ((ws_01*sin(psi)*sin(delta_05))+cos(psi)*cos(delta_05)*sin(ws_05)), # external radiation MJ/m2/day    
                    Ra_06 = 24*60/pi * 0.0820 * dr_06 * ((ws_01*sin(psi)*sin(delta_06))+cos(psi)*cos(delta_06)*sin(ws_06)), # external radiation MJ/m2/day                
                    Ra_07 = 24*60/pi * 0.0820 * dr_07 * ((ws_01*sin(psi)*sin(delta_07))+cos(psi)*cos(delta_07)*sin(ws_07)), # external radiation MJ/m2/day  
                    Ra_08 = 24*60/pi * 0.0820 * dr_08 * ((ws_01*sin(psi)*sin(delta_08))+cos(psi)*cos(delta_08)*sin(ws_08)), # external radiation MJ/m2/day
                    Ra_09 = 24*60/pi * 0.0820 * dr_09 * ((ws_01*sin(psi)*sin(delta_09))+cos(psi)*cos(delta_09)*sin(ws_09)), # external radiation MJ/m2/day              
                    Ra_10 = 24*60/pi * 0.0820 * dr_10 * ((ws_01*sin(psi)*sin(delta_10))+cos(psi)*cos(delta_10)*sin(ws_10)), # external radiation MJ/m2/day
                    Ra_11 = 24*60/pi * 0.0820 * dr_11 * ((ws_01*sin(psi)*sin(delta_11))+cos(psi)*cos(delta_11)*sin(ws_11)), # external radiation MJ/m2/day
                    Ra_12 = 24*60/pi * 0.0820 * dr_12 * ((ws_01*sin(psi)*sin(delta_12))+cos(psi)*cos(delta_12)*sin(ws_12)), # external radiation MJ/m2/day
                    e_01 = 0.00023*0.408*Ra_01*sqrt(tmax_01-tmin_01)*(tmean_01+17.8), #ET for January
                    e_02 = 0.00023*0.408*Ra_02*sqrt(tmax_02-tmin_02)*(tmean_02+17.8), #ET for January
                    e_03 = 0.00023*0.408*Ra_03*sqrt(tmax_03-tmin_03)*(tmean_03+17.8), #ET for January
                    e_04 = 0.00023*0.408*Ra_04*sqrt(tmax_04-tmin_04)*(tmean_04+17.8), #ET for January
                    e_05 = 0.00023*0.408*Ra_05*sqrt(tmax_05-tmin_05)*(tmean_05+17.8), #ET for January
                    e_06 = 0.00023*0.408*Ra_06*sqrt(tmax_06-tmin_06)*(tmean_06+17.8), #ET for January
                    e_07 = 0.00023*0.408*Ra_07*sqrt(tmax_07-tmin_07)*(tmean_07+17.8), #ET for January
                    e_08 = 0.00023*0.408*Ra_08*sqrt(tmax_08-tmin_08)*(tmean_08+17.8), #ET for January
                    e_09 = 0.00023*0.408*Ra_09*sqrt(tmax_09-tmin_09)*(tmean_09+17.8), #ET for January
                    e_10 = 0.00023*0.408*Ra_10*sqrt(tmax_10-tmin_10)*(tmean_10+17.8), #ET for January
                    e_11 = 0.00023*0.408*Ra_11*sqrt(tmax_11-tmin_11)*(tmean_11+17.8), #ET for January
                    e_12 = 0.00023*0.408*Ra_12*sqrt(tmax_12-tmin_12)*(tmean_12+17.8), #ET for January
                    MAI_01 = pre_01/e_01, #monthly moisture availability index
                    MAI_02 = pre_02/e_02,
                    MAI_03 = pre_03/e_03,
                    MAI_04 = pre_04/e_04,
                    MAI_05 = pre_05/e_05,
                    MAI_06 = pre_06/e_06,
                    MAI_07 = pre_07/e_07,
                    MAI_08 = pre_08/e_08,
                    MAI_09 = pre_09/e_09,
                    MAI_10 = pre_10/e_10,
                    MAI_11 = pre_11/e_11,
                    MAI_12 = pre_12/e_12,
                    ET = (e_01+e_02+e_03+e_04+e_05+e_06+e_07+e_08+e_09+e_10+e_11+e_12)*365, # en mm/daye_01/p_01
                    AI = pre/ET)

# Classification from Hargreaves 1974

hg.civ$cat.AI <- with(hg.civ, 
                         ifelse(MAI_01 > 0.34 & MAI_02 > 0.34 & MAI_03 > 0.34 & MAI_04 > 0.34 & MAI_05 > 0.34 |
                           MAI_02 > 0.34 & MAI_03 > 0.34 & MAI_04 > 0.34 & MAI_05 > 0.34 & MAI_06 > 0.34 |
                           MAI_03 > 0.34 & MAI_04 > 0.34 & MAI_05 > 0.34 & MAI_06 > 0.34 & MAI_07 > 0.34 |
                           MAI_04 > 0.34 & MAI_05 > 0.34 & MAI_06 > 0.34 & MAI_07 > 0.34 & MAI_08 > 0.34 |
                           MAI_05 > 0.34 & MAI_06 > 0.34 & MAI_07 > 0.34 & MAI_08 > 0.34 & MAI_09 > 0.34 |
                           MAI_06 > 0.34 & MAI_07 > 0.34 & MAI_08 > 0.34 & MAI_09 > 0.34 & MAI_10 > 0.34 |
                           MAI_07 > 0.34 & MAI_08 > 0.34 & MAI_09 > 0.34 & MAI_10 > 0.34 & MAI_11 > 0.34 |
                           MAI_08 > 0.34 & MAI_09 > 0.34 & MAI_10 > 0.34 & MAI_11 > 0.34 & MAI_12 > 0.34 |
                           MAI_09 > 0.34 & MAI_10 > 0.34 & MAI_11 > 0.34 & MAI_12 > 0.34 & MAI_01 > 0.34 |
                           MAI_10 > 0.34 & MAI_11 > 0.34 & MAI_12 > 0.34 & MAI_01 > 0.34 & MAI_02 > 0.34 |
                           MAI_11 > 0.34 & MAI_12 > 0.34 & MAI_01 > 0.34 & MAI_02 > 0.34 & MAI_03 > 0.34 |
                           MAI_12 > 0.34 & MAI_01 > 0.34 & MAI_02 > 0.34 & MAI_03 > 0.34 & MAI_04 > 0.34,
                           "Wet-dry", 
                           ifelse(MAI_01 > 0.34 & MAI_02 > 0.34 & MAI_03 > 0.34|
                                  MAI_02 > 0.34 & MAI_03 > 0.34 & MAI_04 > 0.34|
                                  MAI_03 > 0.34 & MAI_04 > 0.34 & MAI_05 > 0.34|
                                  MAI_04 > 0.34 & MAI_05 > 0.34 & MAI_06 > 0.34|
                                  MAI_05 > 0.34 & MAI_06 > 0.34 & MAI_07 > 0.34|
                                  MAI_06 > 0.34 & MAI_07 > 0.34 & MAI_08 > 0.34|
                                  MAI_07 > 0.34 & MAI_08 > 0.34 & MAI_09 > 0.34|
                                  MAI_08 > 0.34 & MAI_09 > 0.34 & MAI_10 > 0.34|
                                  MAI_09 > 0.34 & MAI_10 > 0.34 & MAI_11 > 0.34|
                                  MAI_10 > 0.34 & MAI_11 > 0.34 & MAI_12 > 0.34|
                                  MAI_11 > 0.34 & MAI_12 > 0.34 & MAI_01 > 0.34|
                                  MAI_12 > 0.34 & MAI_01 > 0.34 & MAI_02 > 0.34,
                            "Semi-arid",
                            ifelse(MAI_01 > 0.34 & MAI_02 > 0.34| 
                                  MAI_02 > 0.34 & MAI_04 > 0.34|
                                  MAI_03 > 0.34 & MAI_04 > 0.34|
                                  MAI_04 > 0.34 & MAI_05 > 0.34|
                                  MAI_05 > 0.34 & MAI_06 > 0.34|
                                  MAI_06 > 0.34 & MAI_07 > 0.34|
                                  MAI_07 > 0.34 & MAI_08 > 0.34|
                                  MAI_08 > 0.34 & MAI_09 > 0.34|
                                  MAI_09 > 0.34 & MAI_10 > 0.34|
                                  MAI_10 > 0.34 & MAI_11 > 0.34|
                                  MAI_11 > 0.34 & MAI_12 > 0.34|
                                  MAI_12 > 0.34 & MAI_01 > 0.34,
                                "Arid",
                               ifelse(MAI_01 < 0.33 & MAI_02 < 0.33 & MAI_03 < 0.33 & MAI_04 < 0.33 & MAI_05 < 0.33 & MAI_06 < 0.33  & 
                                      MAI_07 < 0.33 & MAI_08 < 0.33 & MAI_09 < 0.33 & MAI_10 < 0.33 & MAI_11 < 0.33 & MAI_12< 0.33, 
                                      "Very Arid",
                                      NA)))))
                         

g0c <- ggplot(hg.civ)+geom_raster(aes(x = lon, y = lat, fill = cat.AI))+
  borders(regions = "Ivory Coast")+
  labs(title = "AI (Hargreaves)", fill = "")+
  scale_fill_viridis_d(direction = -1, na.translate = F)+
  theme_void(base_size = 10)+theme(legend.position = "bottom")+guides(fill = guide_legend(nrow = 1))

g01c <- ggplot(hg.civ)+geom_raster(aes(x = lon, y = lat, fill = AI))+
  borders(regions = "Ivory Coast")+
  labs(title = "AI (Hargreaves)", fill = "")+
  scale_fill_viridis_c(direction = -1)+
  theme_void(base_size = 10)+theme(legend.position = "bottom")+guides(fill = guide_legend(nrow = 1))

hg.civ$cat.AI2 <- cut(hg.civ$AI, breaks = breaks.har, include.lowest = T) %>% revalue(cat.har) # cuts from Tsakiris2005

g1c <- ggplot(hg.civ)+geom_raster(aes(x = lon, y = lat, fill = cat.AI2))+
  borders(regions = "Ivory Coast")+
  labs(title = "AI (Hargreaves)", fill = "")+
  scale_fill_manual(values = col.cat)+
  theme_void(base_size = 10)+theme(legend.position = "bottom")+guides(fill = guide_legend(nrow = 1))

```

```{r hargreaves-fra-by-hand }
hg.fra <- fra %>% mutate(psi = pi/180*lat, # latitude in radian
                    delta_01 = 0.409 * sin(2*pi/365*yday("2000-01-15")-1.39), #solar declination
                    delta_02 = 0.409 * sin(2*pi/365*yday("2000-02-15")-1.39), #solar declination
                    delta_03 = 0.409 * sin(2*pi/365*yday("2000-03-15")-1.39), #solar declination
                    delta_04 = 0.409 * sin(2*pi/365*yday("2000-04-15")-1.39), #solar declination
                    delta_05 = 0.409 * sin(2*pi/365*yday("2000-05-15")-1.39), #solar declination
                    delta_06 = 0.409 * sin(2*pi/365*yday("2000-06-15")-1.39), #solar declination
                    delta_07 = 0.409 * sin(2*pi/365*yday("2000-07-15")-1.39), #solar declination                    
                    delta_08 = 0.409 * sin(2*pi/365*yday("2000-08-15")-1.39), #solar declination
                    delta_09 = 0.409 * sin(2*pi/365*yday("2000-09-15")-1.39), #solar declination                    
                    delta_10 = 0.409 * sin(2*pi/365*yday("2000-10-15")-1.39), #solar declination
                    delta_11 = 0.409 * sin(2*pi/365*yday("2000-11-15")-1.39), #solar declination                    
                    delta_12 = 0.409 * sin(2*pi/365*yday("2000-12-15")-1.39), #solar declination                    
                    ws_01 = acos(-tan(psi)*tan(delta_01)), #sunset hour angle
                    ws_02 = acos(-tan(psi)*tan(delta_02)), #sunset hour angle
                    ws_03 = acos(-tan(psi)*tan(delta_03)), #sunset hour angle                    
                    ws_04 = acos(-tan(psi)*tan(delta_04)), #sunset hour angle                    
                    ws_05 = acos(-tan(psi)*tan(delta_05)), #sunset hour angle                    
                    ws_06 = acos(-tan(psi)*tan(delta_06)), #sunset hour angle                    
                    ws_07 = acos(-tan(psi)*tan(delta_07)), #sunset hour angle                    
                    ws_08 = acos(-tan(psi)*tan(delta_08)), #sunset hour angle
                    ws_09 = acos(-tan(psi)*tan(delta_09)), #sunset hour angle                    
                    ws_10 = acos(-tan(psi)*tan(delta_10)), #sunset hour angle
                    ws_11 = acos(-tan(psi)*tan(delta_11)), #sunset hour angle
                    ws_12 = acos(-tan(psi)*tan(delta_12)), #sunset hour angle                    
                    dr_01 = 1+0.033*cos(2*pi/365*yday("2000-01-15")), # inverse relative distance Earth-Sun
                    dr_02 = 1+0.033*cos(2*pi/365*yday("2000-02-15")), # inverse relative distance Earth-Sun
                    dr_03 = 1+0.033*cos(2*pi/365*yday("2000-03-15")), # inverse relative distance Earth-Sun                    
                    dr_04 = 1+0.033*cos(2*pi/365*yday("2000-04-15")), # inverse relative distance Earth-Sun                    
                    dr_05 = 1+0.033*cos(2*pi/365*yday("2000-05-15")), # inverse relative distance Earth-Sun                    
                    dr_06 = 1+0.033*cos(2*pi/365*yday("2000-06-15")), # inverse relative distance Earth-Sun                    
                    dr_07 = 1+0.033*cos(2*pi/365*yday("2000-07-15")), # inverse relative distance Earth-Sun                    
                    dr_08 = 1+0.033*cos(2*pi/365*yday("2000-08-15")), # inverse relative distance Earth-Sun
                    dr_09 = 1+0.033*cos(2*pi/365*yday("2000-09-15")), # inverse relative distance Earth-Sun                    
                    dr_10 = 1+0.033*cos(2*pi/365*yday("2000-10-15")), # inverse relative distance Earth-Sun                    
                    dr_11 = 1+0.033*cos(2*pi/365*yday("2000-11-15")), # inverse relative distance Earth-Sun                    
                    dr_12 = 1+0.033*cos(2*pi/365*yday("2000-12-15")), # inverse relative distance Earth-Sun                    
                    Ra_01 = 24*60/pi * 0.0820 * dr_01 * ((ws_01*sin(psi)*sin(delta_01))+cos(psi)*cos(delta_01)*sin(ws_01)), # external radiation MJ/m2/day
                    Ra_02 = 24*60/pi * 0.0820 * dr_02 * ((ws_01*sin(psi)*sin(delta_02))+cos(psi)*cos(delta_02)*sin(ws_02)), # external radiation MJ/m2/day                
                    Ra_03 = 24*60/pi * 0.0820 * dr_03 * ((ws_01*sin(psi)*sin(delta_03))+cos(psi)*cos(delta_03)*sin(ws_03)), # external radiation MJ/m2/day              
                    Ra_04 = 24*60/pi * 0.0820 * dr_04 * ((ws_01*sin(psi)*sin(delta_04))+cos(psi)*cos(delta_04)*sin(ws_04)), # external radiation MJ/m2/day                
                    Ra_05 = 24*60/pi * 0.0820 * dr_05 * ((ws_01*sin(psi)*sin(delta_05))+cos(psi)*cos(delta_05)*sin(ws_05)), # external radiation MJ/m2/day    
                    Ra_06 = 24*60/pi * 0.0820 * dr_06 * ((ws_01*sin(psi)*sin(delta_06))+cos(psi)*cos(delta_06)*sin(ws_06)), # external radiation MJ/m2/day                
                    Ra_07 = 24*60/pi * 0.0820 * dr_07 * ((ws_01*sin(psi)*sin(delta_07))+cos(psi)*cos(delta_07)*sin(ws_07)), # external radiation MJ/m2/day  
                    Ra_08 = 24*60/pi * 0.0820 * dr_08 * ((ws_01*sin(psi)*sin(delta_08))+cos(psi)*cos(delta_08)*sin(ws_08)), # external radiation MJ/m2/day
                    Ra_09 = 24*60/pi * 0.0820 * dr_09 * ((ws_01*sin(psi)*sin(delta_09))+cos(psi)*cos(delta_09)*sin(ws_09)), # external radiation MJ/m2/day              
                    Ra_10 = 24*60/pi * 0.0820 * dr_10 * ((ws_01*sin(psi)*sin(delta_10))+cos(psi)*cos(delta_10)*sin(ws_10)), # external radiation MJ/m2/day
                    Ra_11 = 24*60/pi * 0.0820 * dr_11 * ((ws_01*sin(psi)*sin(delta_11))+cos(psi)*cos(delta_11)*sin(ws_11)), # external radiation MJ/m2/day
                    Ra_12 = 24*60/pi * 0.0820 * dr_12 * ((ws_01*sin(psi)*sin(delta_12))+cos(psi)*cos(delta_12)*sin(ws_12)), # external radiation MJ/m2/day
                    e_01 = 0.00023*0.408*Ra_01*sqrt(tmax_01-tmin_01)*(tmean_01+17.8), #ET for January
                    e_02 = 0.00023*0.408*Ra_02*sqrt(tmax_02-tmin_02)*(tmean_02+17.8), #ET for January
                    e_03 = 0.00023*0.408*Ra_03*sqrt(tmax_03-tmin_03)*(tmean_03+17.8), #ET for January
                    e_04 = 0.00023*0.408*Ra_04*sqrt(tmax_04-tmin_04)*(tmean_04+17.8), #ET for January
                    e_05 = 0.00023*0.408*Ra_05*sqrt(tmax_05-tmin_05)*(tmean_05+17.8), #ET for January
                    e_06 = 0.00023*0.408*Ra_06*sqrt(tmax_06-tmin_06)*(tmean_06+17.8), #ET for January
                    e_07 = 0.00023*0.408*Ra_07*sqrt(tmax_07-tmin_07)*(tmean_07+17.8), #ET for January
                    e_08 = 0.00023*0.408*Ra_08*sqrt(tmax_08-tmin_08)*(tmean_08+17.8), #ET for January
                    e_09 = 0.00023*0.408*Ra_09*sqrt(tmax_09-tmin_09)*(tmean_09+17.8), #ET for January
                    e_10 = 0.00023*0.408*Ra_10*sqrt(tmax_10-tmin_10)*(tmean_10+17.8), #ET for January
                    e_11 = 0.00023*0.408*Ra_11*sqrt(tmax_11-tmin_11)*(tmean_11+17.8), #ET for January
                    e_12 = 0.00023*0.408*Ra_12*sqrt(tmax_12-tmin_12)*(tmean_12+17.8), #ET for January
                    MAI_01 = pre_01/e_01, #monthly moisture availability index
                    MAI_02 = pre_02/e_02,
                    MAI_03 = pre_03/e_03,
                    MAI_04 = pre_04/e_04,
                    MAI_05 = pre_05/e_05,
                    MAI_06 = pre_06/e_06,
                    MAI_07 = pre_07/e_07,
                    MAI_08 = pre_08/e_08,
                    MAI_09 = pre_09/e_09,
                    MAI_10 = pre_10/e_10,
                    MAI_11 = pre_11/e_11,
                    MAI_12 = pre_12/e_12,
                    ET = (e_01+e_02+e_03+e_04+e_05+e_06+e_07+e_08+e_09+e_10+e_11+e_12)*365, # en mm/daye_01/p_01
                    AI = pre/ET)

# Classification from Hargreaves 1974

hg.fra$cat.AI <- with(hg.fra, 
                         ifelse(MAI_01 > 0.34 & MAI_02 > 0.34 & MAI_03 > 0.34 & MAI_04 > 0.34 & MAI_05 > 0.34 |
                           MAI_02 > 0.34 & MAI_03 > 0.34 & MAI_04 > 0.34 & MAI_05 > 0.34 & MAI_06 > 0.34 |
                           MAI_03 > 0.34 & MAI_04 > 0.34 & MAI_05 > 0.34 & MAI_06 > 0.34 & MAI_07 > 0.34 |
                           MAI_04 > 0.34 & MAI_05 > 0.34 & MAI_06 > 0.34 & MAI_07 > 0.34 & MAI_08 > 0.34 |
                           MAI_05 > 0.34 & MAI_06 > 0.34 & MAI_07 > 0.34 & MAI_08 > 0.34 & MAI_09 > 0.34 |
                           MAI_06 > 0.34 & MAI_07 > 0.34 & MAI_08 > 0.34 & MAI_09 > 0.34 & MAI_10 > 0.34 |
                           MAI_07 > 0.34 & MAI_08 > 0.34 & MAI_09 > 0.34 & MAI_10 > 0.34 & MAI_11 > 0.34 |
                           MAI_08 > 0.34 & MAI_09 > 0.34 & MAI_10 > 0.34 & MAI_11 > 0.34 & MAI_12 > 0.34 |
                           MAI_09 > 0.34 & MAI_10 > 0.34 & MAI_11 > 0.34 & MAI_12 > 0.34 & MAI_01 > 0.34 |
                           MAI_10 > 0.34 & MAI_11 > 0.34 & MAI_12 > 0.34 & MAI_01 > 0.34 & MAI_02 > 0.34 |
                           MAI_11 > 0.34 & MAI_12 > 0.34 & MAI_01 > 0.34 & MAI_02 > 0.34 & MAI_03 > 0.34 |
                           MAI_12 > 0.34 & MAI_01 > 0.34 & MAI_02 > 0.34 & MAI_03 > 0.34 & MAI_04 > 0.34,
                           "Wet-dry", 
                           ifelse(MAI_01 > 0.34 & MAI_02 > 0.34 & MAI_03 > 0.34|
                                  MAI_02 > 0.34 & MAI_03 > 0.34 & MAI_04 > 0.34|
                                  MAI_03 > 0.34 & MAI_04 > 0.34 & MAI_05 > 0.34|
                                  MAI_04 > 0.34 & MAI_05 > 0.34 & MAI_06 > 0.34|
                                  MAI_05 > 0.34 & MAI_06 > 0.34 & MAI_07 > 0.34|
                                  MAI_06 > 0.34 & MAI_07 > 0.34 & MAI_08 > 0.34|
                                  MAI_07 > 0.34 & MAI_08 > 0.34 & MAI_09 > 0.34|
                                  MAI_08 > 0.34 & MAI_09 > 0.34 & MAI_10 > 0.34|
                                  MAI_09 > 0.34 & MAI_10 > 0.34 & MAI_11 > 0.34|
                                  MAI_10 > 0.34 & MAI_11 > 0.34 & MAI_12 > 0.34|
                                  MAI_11 > 0.34 & MAI_12 > 0.34 & MAI_01 > 0.34|
                                  MAI_12 > 0.34 & MAI_01 > 0.34 & MAI_02 > 0.34,
                            "Semi-arid",
                            ifelse(MAI_01 > 0.34 & MAI_02 > 0.34| 
                                  MAI_02 > 0.34 & MAI_04 > 0.34|
                                  MAI_03 > 0.34 & MAI_04 > 0.34|
                                  MAI_04 > 0.34 & MAI_05 > 0.34|
                                  MAI_05 > 0.34 & MAI_06 > 0.34|
                                  MAI_06 > 0.34 & MAI_07 > 0.34|
                                  MAI_07 > 0.34 & MAI_08 > 0.34|
                                  MAI_08 > 0.34 & MAI_09 > 0.34|
                                  MAI_09 > 0.34 & MAI_10 > 0.34|
                                  MAI_10 > 0.34 & MAI_11 > 0.34|
                                  MAI_11 > 0.34 & MAI_12 > 0.34|
                                  MAI_12 > 0.34 & MAI_01 > 0.34,
                                "Arid",
                               ifelse(MAI_01 < 0.33 & MAI_02 < 0.33 & MAI_03 < 0.33 & MAI_04 < 0.33 & MAI_05 < 0.33 & MAI_06 < 0.33  & 
                                      MAI_07 < 0.33 & MAI_08 < 0.33 & MAI_09 < 0.33 & MAI_10 < 0.33 & MAI_11 < 0.33 & MAI_12< 0.33, 
                                      "Very Arid",
                                      NA)))))
                         

g0f <- ggplot(hg.fra)+geom_raster(aes(x = lon, y = lat, fill = cat.AI))+
  borders(regions = "France")+
  labs(title = "AI (Hargreaves)", fill = "")+
  scale_fill_viridis_d(direction = -1, na.translate = F)+
  theme_void(base_size = 10)+theme(legend.position = "bottom")+guides(fill = guide_legend(nrow = 1))

g01f <- ggplot(hg.fra)+geom_raster(aes(x = lon, y = lat, fill = AI))+
  borders(regions = "France")+
  labs(title = "AI (Hargreaves)", fill = "")+
  scale_fill_viridis_c(direction = -1)+
  theme_void(base_size = 10)+theme(legend.position = "bottom")+guides(fill = guide_legend(nrow = 1))

hg.fra$cat.AI2 <- cut(hg.fra$AI, breaks = breaks.har, include.lowest = T) %>% revalue(cat.har) # cuts from Tsakiris2005

g1f <- ggplot(hg.fra)+geom_raster(aes(x = lon, y = lat, fill = cat.AI2))+
  borders(regions = "France")+
  labs(title = "AI (Hargreaves)", fill = "")+
  scale_fill_manual(values = col.cat)+
  theme_void(base_size = 10)+theme(legend.position = "bottom")+guides(fill = guide_legend(nrow = 1))
```

```{r plot-hargreaves, fig.dim = c(8,4)}
ggarrange(g1c,g1f, common.legend = T, legend = "bottom")

```

```{r har-world}

hg.w <- world.df 

hg.w$tmax <- apply(dplyr::select(world.df, c("tmax_01", "tmax_02", "tmax_03", "tmax_04", "tmax_05", "tmax_06", "tmax_07", "tmax_08", "tmax_09", "tmax_10", "tmax_11", "tmax_12")), 1, max, na.rm = T)
hg.w$tmin <- apply(dplyr::select(world.df, c("tmin_01", "tmin_02", "tmin_03", "tmin_04", "tmin_05", "tmin_06", "tmin_07", "tmin_08", "tmin_09", "tmin_10", "tmin_11", "tmin_12")), 1, min, na.rm = T)

hg.w <- hg.w %>% mutate(psi = pi/180*lat, # latitude in radian
                    delta_01 = 0.409 * sin(2*pi/365*yday("2000-01-15")-1.39), #solar declination
                    delta_02 = 0.409 * sin(2*pi/365*yday("2000-02-15")-1.39), #solar declination
                    delta_03 = 0.409 * sin(2*pi/365*yday("2000-03-15")-1.39), #solar declination
                    delta_04 = 0.409 * sin(2*pi/365*yday("2000-04-15")-1.39), #solar declination
                    delta_05 = 0.409 * sin(2*pi/365*yday("2000-05-15")-1.39), #solar declination
                    delta_06 = 0.409 * sin(2*pi/365*yday("2000-06-15")-1.39), #solar declination
                    delta_07 = 0.409 * sin(2*pi/365*yday("2000-07-15")-1.39), #solar declination                    
                    delta_08 = 0.409 * sin(2*pi/365*yday("2000-08-15")-1.39), #solar declination
                    delta_09 = 0.409 * sin(2*pi/365*yday("2000-09-15")-1.39), #solar declination                    
                    delta_10 = 0.409 * sin(2*pi/365*yday("2000-10-15")-1.39), #solar declination
                    delta_11 = 0.409 * sin(2*pi/365*yday("2000-11-15")-1.39), #solar declination                    
                    delta_12 = 0.409 * sin(2*pi/365*yday("2000-12-15")-1.39), #solar declination                    
                    ws_01 = acos(-tan(psi)*tan(delta_01)), #sunset hour angle
                    ws_02 = acos(-tan(psi)*tan(delta_02)), #sunset hour angle
                    ws_03 = acos(-tan(psi)*tan(delta_03)), #sunset hour angle                    
                    ws_04 = acos(-tan(psi)*tan(delta_04)), #sunset hour angle                    
                    ws_05 = acos(-tan(psi)*tan(delta_05)), #sunset hour angle                    
                    ws_06 = acos(-tan(psi)*tan(delta_06)), #sunset hour angle                    
                    ws_07 = acos(-tan(psi)*tan(delta_07)), #sunset hour angle                    
                    ws_08 = acos(-tan(psi)*tan(delta_08)), #sunset hour angle
                    ws_09 = acos(-tan(psi)*tan(delta_09)), #sunset hour angle                    
                    ws_10 = acos(-tan(psi)*tan(delta_10)), #sunset hour angle
                    ws_11 = acos(-tan(psi)*tan(delta_11)), #sunset hour angle
                    ws_12 = acos(-tan(psi)*tan(delta_12)), #sunset hour angle                    
                    dr_01 = 1+0.033*cos(2*pi/365*yday("2000-01-15")), # inverse relative distance Earth-Sun
                    dr_02 = 1+0.033*cos(2*pi/365*yday("2000-02-15")), # inverse relative distance Earth-Sun
                    dr_03 = 1+0.033*cos(2*pi/365*yday("2000-03-15")), # inverse relative distance Earth-Sun                    
                    dr_04 = 1+0.033*cos(2*pi/365*yday("2000-04-15")), # inverse relative distance Earth-Sun                    
                    dr_05 = 1+0.033*cos(2*pi/365*yday("2000-05-15")), # inverse relative distance Earth-Sun                    
                    dr_06 = 1+0.033*cos(2*pi/365*yday("2000-06-15")), # inverse relative distance Earth-Sun                    
                    dr_07 = 1+0.033*cos(2*pi/365*yday("2000-07-15")), # inverse relative distance Earth-Sun                    
                    dr_08 = 1+0.033*cos(2*pi/365*yday("2000-08-15")), # inverse relative distance Earth-Sun
                    dr_09 = 1+0.033*cos(2*pi/365*yday("2000-09-15")), # inverse relative distance Earth-Sun                    
                    dr_10 = 1+0.033*cos(2*pi/365*yday("2000-10-15")), # inverse relative distance Earth-Sun                    
                    dr_11 = 1+0.033*cos(2*pi/365*yday("2000-11-15")), # inverse relative distance Earth-Sun                    
                    dr_12 = 1+0.033*cos(2*pi/365*yday("2000-12-15")), # inverse relative distance Earth-Sun                    
                    Ra_01 = 24*60/pi * 0.0820 * dr_01 * ((ws_01*sin(psi)*sin(delta_01))+cos(psi)*cos(delta_01)*sin(ws_01)), # external radiation MJ/m2/day
                    Ra_02 = 24*60/pi * 0.0820 * dr_02 * ((ws_01*sin(psi)*sin(delta_02))+cos(psi)*cos(delta_02)*sin(ws_02)), # external radiation MJ/m2/day                
                    Ra_03 = 24*60/pi * 0.0820 * dr_03 * ((ws_01*sin(psi)*sin(delta_03))+cos(psi)*cos(delta_03)*sin(ws_03)), # external radiation MJ/m2/day              
                    Ra_04 = 24*60/pi * 0.0820 * dr_04 * ((ws_01*sin(psi)*sin(delta_04))+cos(psi)*cos(delta_04)*sin(ws_04)), # external radiation MJ/m2/day                
                    Ra_05 = 24*60/pi * 0.0820 * dr_05 * ((ws_01*sin(psi)*sin(delta_05))+cos(psi)*cos(delta_05)*sin(ws_05)), # external radiation MJ/m2/day    
                    Ra_06 = 24*60/pi * 0.0820 * dr_06 * ((ws_01*sin(psi)*sin(delta_06))+cos(psi)*cos(delta_06)*sin(ws_06)), # external radiation MJ/m2/day                
                    Ra_07 = 24*60/pi * 0.0820 * dr_07 * ((ws_01*sin(psi)*sin(delta_07))+cos(psi)*cos(delta_07)*sin(ws_07)), # external radiation MJ/m2/day  
                    Ra_08 = 24*60/pi * 0.0820 * dr_08 * ((ws_01*sin(psi)*sin(delta_08))+cos(psi)*cos(delta_08)*sin(ws_08)), # external radiation MJ/m2/day
                    Ra_09 = 24*60/pi * 0.0820 * dr_09 * ((ws_01*sin(psi)*sin(delta_09))+cos(psi)*cos(delta_09)*sin(ws_09)), # external radiation MJ/m2/day              
                    Ra_10 = 24*60/pi * 0.0820 * dr_10 * ((ws_01*sin(psi)*sin(delta_10))+cos(psi)*cos(delta_10)*sin(ws_10)), # external radiation MJ/m2/day
                    Ra_11 = 24*60/pi * 0.0820 * dr_11 * ((ws_01*sin(psi)*sin(delta_11))+cos(psi)*cos(delta_11)*sin(ws_11)), # external radiation MJ/m2/day
                    Ra_12 = 24*60/pi * 0.0820 * dr_12 * ((ws_01*sin(psi)*sin(delta_12))+cos(psi)*cos(delta_12)*sin(ws_12)), # external radiation MJ/m2/day
                    e_01 = 0.00023*0.408*Ra_01*sqrt(tmax_01-tmin_01)*(tmean_01+17.8), #ET for January
                    e_02 = 0.00023*0.408*Ra_02*sqrt(tmax_02-tmin_02)*(tmean_02+17.8), #ET for January
                    e_03 = 0.00023*0.408*Ra_03*sqrt(tmax_03-tmin_03)*(tmean_03+17.8), #ET for January
                    e_04 = 0.00023*0.408*Ra_04*sqrt(tmax_04-tmin_04)*(tmean_04+17.8), #ET for January
                    e_05 = 0.00023*0.408*Ra_05*sqrt(tmax_05-tmin_05)*(tmean_05+17.8), #ET for January
                    e_06 = 0.00023*0.408*Ra_06*sqrt(tmax_06-tmin_06)*(tmean_06+17.8), #ET for January
                    e_07 = 0.00023*0.408*Ra_07*sqrt(tmax_07-tmin_07)*(tmean_07+17.8), #ET for January
                    e_08 = 0.00023*0.408*Ra_08*sqrt(tmax_08-tmin_08)*(tmean_08+17.8), #ET for January
                    e_09 = 0.00023*0.408*Ra_09*sqrt(tmax_09-tmin_09)*(tmean_09+17.8), #ET for January
                    e_10 = 0.00023*0.408*Ra_10*sqrt(tmax_10-tmin_10)*(tmean_10+17.8), #ET for January
                    e_11 = 0.00023*0.408*Ra_11*sqrt(tmax_11-tmin_11)*(tmean_11+17.8), #ET for January
                    e_12 = 0.00023*0.408*Ra_12*sqrt(tmax_12-tmin_12)*(tmean_12+17.8), #ET for January
                    MAI_01 = pre_01/e_01, #monthly moisture availability index
                    MAI_02 = pre_02/e_02,
                    MAI_03 = pre_03/e_03,
                    MAI_04 = pre_04/e_04,
                    MAI_05 = pre_05/e_05,
                    MAI_06 = pre_06/e_06,
                    MAI_07 = pre_07/e_07,
                    MAI_08 = pre_08/e_08,
                    MAI_09 = pre_09/e_09,
                    MAI_10 = pre_10/e_10,
                    MAI_11 = pre_11/e_11,
                    MAI_12 = pre_12/e_12,
                    ET = (e_01+e_02+e_03+e_04+e_05+e_06+e_07+e_08+e_09+e_10+e_11+e_12)*365, # en mm/daye_01/p_01
                    AI = pre/ET)

# Classification from Hargreaves 1974

hg.w$cat.AI <- with(hg.w, 
                         ifelse(MAI_01 > 0.34 & MAI_02 > 0.34 & MAI_03 > 0.34 & MAI_04 > 0.34 & MAI_05 > 0.34 |
                           MAI_02 > 0.34 & MAI_03 > 0.34 & MAI_04 > 0.34 & MAI_05 > 0.34 & MAI_06 > 0.34 |
                           MAI_03 > 0.34 & MAI_04 > 0.34 & MAI_05 > 0.34 & MAI_06 > 0.34 & MAI_07 > 0.34 |
                           MAI_04 > 0.34 & MAI_05 > 0.34 & MAI_06 > 0.34 & MAI_07 > 0.34 & MAI_08 > 0.34 |
                           MAI_05 > 0.34 & MAI_06 > 0.34 & MAI_07 > 0.34 & MAI_08 > 0.34 & MAI_09 > 0.34 |
                           MAI_06 > 0.34 & MAI_07 > 0.34 & MAI_08 > 0.34 & MAI_09 > 0.34 & MAI_10 > 0.34 |
                           MAI_07 > 0.34 & MAI_08 > 0.34 & MAI_09 > 0.34 & MAI_10 > 0.34 & MAI_11 > 0.34 |
                           MAI_08 > 0.34 & MAI_09 > 0.34 & MAI_10 > 0.34 & MAI_11 > 0.34 & MAI_12 > 0.34 |
                           MAI_09 > 0.34 & MAI_10 > 0.34 & MAI_11 > 0.34 & MAI_12 > 0.34 & MAI_01 > 0.34 |
                           MAI_10 > 0.34 & MAI_11 > 0.34 & MAI_12 > 0.34 & MAI_01 > 0.34 & MAI_02 > 0.34 |
                           MAI_11 > 0.34 & MAI_12 > 0.34 & MAI_01 > 0.34 & MAI_02 > 0.34 & MAI_03 > 0.34 |
                           MAI_12 > 0.34 & MAI_01 > 0.34 & MAI_02 > 0.34 & MAI_03 > 0.34 & MAI_04 > 0.34,
                           "Wet-dry", 
                           ifelse(MAI_01 > 0.34 & MAI_02 > 0.34 & MAI_03 > 0.34|
                                  MAI_02 > 0.34 & MAI_03 > 0.34 & MAI_04 > 0.34|
                                  MAI_03 > 0.34 & MAI_04 > 0.34 & MAI_05 > 0.34|
                                  MAI_04 > 0.34 & MAI_05 > 0.34 & MAI_06 > 0.34|
                                  MAI_05 > 0.34 & MAI_06 > 0.34 & MAI_07 > 0.34|
                                  MAI_06 > 0.34 & MAI_07 > 0.34 & MAI_08 > 0.34|
                                  MAI_07 > 0.34 & MAI_08 > 0.34 & MAI_09 > 0.34|
                                  MAI_08 > 0.34 & MAI_09 > 0.34 & MAI_10 > 0.34|
                                  MAI_09 > 0.34 & MAI_10 > 0.34 & MAI_11 > 0.34|
                                  MAI_10 > 0.34 & MAI_11 > 0.34 & MAI_12 > 0.34|
                                  MAI_11 > 0.34 & MAI_12 > 0.34 & MAI_01 > 0.34|
                                  MAI_12 > 0.34 & MAI_01 > 0.34 & MAI_02 > 0.34,
                            "Semi-arid",
                            ifelse(MAI_01 > 0.34 & MAI_02 > 0.34| 
                                  MAI_02 > 0.34 & MAI_04 > 0.34|
                                  MAI_03 > 0.34 & MAI_04 > 0.34|
                                  MAI_04 > 0.34 & MAI_05 > 0.34|
                                  MAI_05 > 0.34 & MAI_06 > 0.34|
                                  MAI_06 > 0.34 & MAI_07 > 0.34|
                                  MAI_07 > 0.34 & MAI_08 > 0.34|
                                  MAI_08 > 0.34 & MAI_09 > 0.34|
                                  MAI_09 > 0.34 & MAI_10 > 0.34|
                                  MAI_10 > 0.34 & MAI_11 > 0.34|
                                  MAI_11 > 0.34 & MAI_12 > 0.34|
                                  MAI_12 > 0.34 & MAI_01 > 0.34,
                                "Arid",
                               ifelse(MAI_01 < 0.33 & MAI_02 < 0.33 & MAI_03 < 0.33 & MAI_04 < 0.33 & MAI_05 < 0.33 & MAI_06 < 0.33  & 
                                      MAI_07 < 0.33 & MAI_08 < 0.33 & MAI_09 < 0.33 & MAI_10 < 0.33 & MAI_11 < 0.33 & MAI_12< 0.33, 
                                      "Very Arid",
                                      NA)))))
                         

ggplot(hg.w)+geom_raster(aes(x = lon, y = lat, fill = cat.AI))+
  labs(title = "AI (Hargreaves)", fill = "")+
  scale_fill_viridis_d(direction = -1, na.translate = F)+
  theme_void(base_size = 10)+theme(legend.position = "bottom")+guides(fill = guide_legend(nrow = 1))

ggplot(hg.w)+geom_raster(aes(x = lon, y = lat, fill = AI))+
  labs(title = "AI (Hargreaves)", fill = "")+
  scale_fill_viridis_c(direction = -1)+
  theme_void(base_size = 10)+theme(legend.position = "bottom")+guides(fill = guide_legend(nrow = 1))

hg.w$cat.AI2 <- cut(hg.w$AI, breaks = breaks.har, include.lowest = T) %>% revalue(cat.har) # cuts from Tsakiris2005

ggplot(hg.w)+geom_raster(aes(x = lon, y = lat, fill = cat.AI2))+
  labs(title = "AI (Hargreaves)", fill = "")+
  scale_fill_manual(values = col.cat)+
  theme_void(base_size = 10)+theme(legend.position = "bottom")+guides(fill = guide_legend(nrow = 1))

saveRDS(hg.w,"Worldclim/hg.w.rds")
```



# Compare categories

```{r all-indices}
all.indices <- world.df %>% dplyr::select(c("lon","lat","pre","temp"))

lang.w <- readRDS("Worldclim/lang.w.rds")
all.indices$lang <- lang.w$RF
all.indices$lang.cat <- lang.w$cat.AI
all.indices$lang.catu <- all.indices$lang.cat %>% revalue(c("Hyperhumid" = "Humid"))

emberger.w <- readRDS("Worldclim/emberger.w.rds")
all.indices$emberger <- emberger.w$Em
all.indices$emberger.cat <- emberger.w$cat.AI
all.indices$emberger.catu <- all.indices$emberger.cat %>% revalue(c("Hyperhumid" = "Humid"))

martonne.w <- readRDS("Worldclim/martonne.w.rds")
all.indices$martonne <- martonne.w$Am
all.indices$baltas.cat <- martonne.w$cat.baltas
all.indices$baltas.catu <- all.indices$baltas.cat %>% revalue(c("Desert"="Hyperarid", "Dry"="Arid","Semi-dry"="Semi-arid","Mediterranean" = "Semi-arid", "Very humid (a)" = "Humid", "Very humid (b)" = "Humid"))
all.indices$martonne.cat <- martonne.w$cat.martonne
all.indices$martonne.catu <- all.indices$martonne.cat %>% revalue(c("Desert"="Hyperarid", "Temperate" = "Semi-humid", "Forest" = "Humid"))


unesco.w <- readRDS("Worldclim/unesco.w.rds")
all.indices$unesco <- unesco.w$AI_FAO
all.indices$unesco.cat <- unesco.w$cat.AI_FAO
all.indices$unesco.catu <- all.indices$unesco.cat %>% revalue(c("Dry subhumid" = "Semi-humid"))

thorn.w <- readRDS("Worldclim/thorn.w.rds")
all.indices$unep <- thorn.w$AI
all.indices$unep.cat <- thorn.w$cat.AI 
all.indices$unep.catu <- all.indices$unep.cat %>% revalue(c("Dry subhumid" = "Semi-humid"))

ggplot(all.indices)+geom_raster(aes(x = lon, y = lat, fill = martonne.catu))+
  labs(title = "Martonne - uniform", fill = "")+scale_fill_viridis_d(direction = -1, na.value = "gray90")+
  theme_void(base_size = 10)+theme(legend.position = "bottom")+guides(fill = guide_legend(nrow = 1))

ggplot(all.indices)+geom_raster(aes(x = lon, y = lat, fill = emberger.catu))+
  labs(title = "Emberger - uniform", fill = "")+scale_fill_viridis_d(direction = -1, na.value = "gray90")+
  theme_void(base_size = 10)+theme(legend.position = "bottom")+guides(fill = guide_legend(nrow = 1))

ggplot(all.indices)+geom_raster(aes(x = lon, y = lat, fill = unesco.catu))+
  labs(title = "Unesco - uniform", fill = "")+scale_fill_viridis_d(direction = -1)+
  theme_void(base_size = 10)+theme(legend.position = "bottom")+guides(fill = guide_legend(nrow = 1))

ggplot(all.indices)+geom_raster(aes(x = lon, y = lat, fill = unep.catu))+
  labs(title = "Unep - uniform", fill = "")+scale_fill_viridis_d(direction = -1, na.value = "gray90")+
  theme_void(base_size = 10)+theme(legend.position = "bottom")+guides(fill = guide_legend(nrow = 1))
```

```{r compare-cat}
b1 <- ggplot()+
  ylim(0,140)+
  geom_hline(yintercept = c(5,10,20,24,28,35,55))+
  geom_rect(aes(xmin = -Inf, xmax = + Inf, ymin = 0, ymax = 5, fill = "1. Desert"))+
  geom_rect(aes(xmin = -Inf, xmax = + Inf, ymin = 5, ymax = 10, fill = "2.Dry"))+
  geom_rect(aes(xmin = -Inf, xmax = + Inf, ymin = 10, ymax = 20, fill = "3. Semi-dry"))+
  geom_rect(aes(xmin = -Inf, xmax = + Inf, ymin = 20, ymax = 24, fill = "4. Mediterranean"))+
  geom_rect(aes(xmin = -Inf, xmax = + Inf, ymin = 24, ymax = 28, fill = "5. Semi-humid"))+
  geom_rect(aes(xmin = -Inf, xmax = + Inf, ymin = 28, ymax = 35, fill = "6. Humid"))+
  geom_rect(aes(xmin = -Inf, xmax = + Inf, ymin = 35, ymax = 55, fill = "7. Very humid (a)"))+
  geom_rect(aes(xmin = -Inf, xmax = + Inf, ymin = 55, ymax = 140, fill = "8. Very humid (a)"))+
  geom_boxplot(data = filter(all.indices, unesco.cat == "Hyperarid"), aes(x="1. Hyperarid", y = martonne), col = "white")+
  geom_boxplot(data = filter(all.indices, unesco.cat == "Arid"), aes(x="2. Arid", y = martonne))+
  geom_boxplot(data = filter(all.indices, unesco.cat == "Semi-arid"), aes(x="3. Semi-arid", y = martonne))+
  geom_boxplot(data = filter(all.indices, unesco.cat == "Dry subhumid"), aes(x="4. Semi-humid", y = martonne))+
  geom_boxplot(data = filter(all.indices, unesco.cat == "Humid"), aes(x="5. Humid", y = martonne))+
  scale_fill_viridis_d()+labs(x="Unesco categories",y="De Martonne, Baltas categories", title = "Comparison De Martonne/Unesco")+
  theme_minimal()

b2 <- ggplot()+
  ylim(0,140)+
  geom_rect(aes(xmin = -Inf, xmax = + Inf, ymin = 0, ymax = 5, fill = "1. Desert"))+
  geom_rect(aes(xmin = -Inf, xmax = + Inf, ymin = 5, ymax = 10, fill = "2.Arid"))+
  geom_rect(aes(xmin = -Inf, xmax = + Inf, ymin = 10, ymax = 20, fill = "3. Semi-arid"))+
  geom_rect(aes(xmin = -Inf, xmax = + Inf, ymin = 20, ymax = 30, fill = "4. Temperate"))+
  geom_rect(aes(xmin = -Inf, xmax = + Inf, ymin = 30, ymax = 40, fill = "5. Humid"))+
  geom_rect(aes(xmin = -Inf, xmax = + Inf, ymin = 40, ymax = 140, fill = "6. Forest"))+
  geom_boxplot(data = filter(all.indices, unesco.cat == "Hyperarid"), aes(x="1. Hyperarid", y = martonne), col = "white")+
  geom_boxplot(data = filter(all.indices, unesco.cat == "Arid"), aes(x="2. Arid", y = martonne))+
  geom_boxplot(data = filter(all.indices, unesco.cat == "Semi-arid"), aes(x="3. Semi-arid", y = martonne))+
  geom_boxplot(data = filter(all.indices, unesco.cat == "Dry subhumid"), aes(x="4. Semi-humid", y = martonne))+
  geom_boxplot(data = filter(all.indices, unesco.cat == "Humid"), aes(x="5. Humid", y = martonne))+
  scale_fill_viridis_d()+labs(x="Unesco categories",y="De Martonne", title = "Comparison De Martonn/Unesco")+
  theme_minimal()

b3 <- ggplot()+
  ylim(0,5)+
  geom_rect(aes(xmin = -Inf, xmax = + Inf, ymin = 0, ymax = 0.03, fill = "1. Hyperarid"))+
  geom_rect(aes(xmin = -Inf, xmax = + Inf, ymin = 0.03, ymax = 0.2, fill = "2.Arid"))+
  geom_rect(aes(xmin = -Inf, xmax = + Inf, ymin = 0.2, ymax = 0.5, fill = "3. Semi-arid"))+
  geom_rect(aes(xmin = -Inf, xmax = + Inf, ymin = 0.5, ymax = 0.65, fill = "4. Semi-humid"))+
  geom_rect(aes(xmin = -Inf, xmax = + Inf, ymin = 0.65, ymax = 5, fill = "5. Humid"))+
  geom_boxplot(data = filter(all.indices, martonne.cat == "Desert"), aes(x="1. Hyperarid", y = unesco), col = "white")+
  geom_boxplot(data = filter(all.indices, martonne.cat == "Arid"), aes(x="2. Arid", y = unesco))+
  geom_boxplot(data = filter(all.indices, martonne.cat == "Semi-arid"), aes(x="3. Semi-arid", y = unesco))+
  geom_boxplot(data = filter(all.indices, martonne.cat == "Temperate"), aes(x="4. Temperate", y = unesco))+
  geom_boxplot(data = filter(all.indices, martonne.cat == "Humid"), aes(x="5. Humid", y = unesco))+
  geom_boxplot(data = filter(all.indices, martonne.cat == "Forest"), aes(x="6. Forest", y = unesco))+
  scale_fill_viridis_d()+labs(x="De Martonne",y="Unesco", title = "Comparison De MartonnE/Unesco")+
  theme_minimal()

b4 <- ggplot()+
  ylim(0,5)+
  geom_rect(aes(xmin = -Inf, xmax = + Inf, ymin = 0, ymax = 0.03, fill = "1. Hyperarid"))+
  geom_rect(aes(xmin = -Inf, xmax = + Inf, ymin = 0.03, ymax = 0.2, fill = "2.Arid"))+
  geom_rect(aes(xmin = -Inf, xmax = + Inf, ymin = 0.2, ymax = 0.5, fill = "3. Semi-arid"))+
  geom_rect(aes(xmin = -Inf, xmax = + Inf, ymin = 0.5, ymax = 0.75, fill = "4. Semi-humid"))+
  geom_rect(aes(xmin = -Inf, xmax = + Inf, ymin = 0.75, ymax = 5, fill = "5. Humid"))+
  geom_boxplot(data = filter(all.indices, unesco.cat == "Hyperarid"), aes(x="1. Hyperarid", y = unep), col = "white")+
  geom_boxplot(data = filter(all.indices, unesco.cat == "Arid"), aes(x="2. Arid", y = unep))+
  geom_boxplot(data = filter(all.indices, unesco.cat == "Semi-arid"), aes(x="3. Semi-arid", y = unep))+
  geom_boxplot(data = filter(all.indices, unesco.cat == "Dry subhumid"), aes(x="4. Dry subhumid", y = unep))+
  geom_boxplot(data = filter(all.indices, unesco.cat == "Humid"), aes(x="5. Humid", y = unep))+
  scale_fill_viridis_d()+labs(x="UNESCO",y="Unep", title = "Comparison Unep/Unesco", fill = "Unep categories")+
  theme_minimal()

b5 <- ggplot()+
  ylim(0,5)+
  geom_rect(aes(xmin = -Inf, xmax = + Inf, ymin = 0, ymax = 0.03, fill = "1. Hyperarid"))+
  geom_rect(aes(xmin = -Inf, xmax = + Inf, ymin = 0.03, ymax = 0.2, fill = "2.Arid"))+
  geom_rect(aes(xmin = -Inf, xmax = + Inf, ymin = 0.2, ymax = 0.5, fill = "3. Semi-arid"))+
  geom_rect(aes(xmin = -Inf, xmax = + Inf, ymin = 0.5, ymax = 0.65, fill = "4. Semi-humid"))+
  geom_rect(aes(xmin = -Inf, xmax = + Inf, ymin = 0.65, ymax = 5, fill = "5. Humid"))+
  geom_boxplot(data = filter(all.indices, unep.cat == "Hyperarid"), aes(x="1. Hyperarid", y = unesco), col = "white")+
  geom_boxplot(data = filter(all.indices, unep.cat == "Arid"), aes(x="2. Arid", y = unesco), col = "white")+
  geom_boxplot(data = filter(all.indices, unep.cat == "Semi-arid"), aes(x="3. Semi-arid", y = unesco))+
  geom_boxplot(data = filter(all.indices, unep.cat == "Dry subhumid"), aes(x="4. Dry subhumid", y = unesco))+
  geom_boxplot(data = filter(all.indices, unep.cat == "Humid"), aes(x="5. Humid", y = unesco))+
  scale_fill_viridis_d()+labs(x="UNESCO",y="UNEP", title = "Comparison Unep/Unesco", fill = "Unep categories")+
  theme_minimal()

b6 <- ggplot()+
  ylim(0,5)+
  geom_rect(aes(xmin = -Inf, xmax = + Inf, ymin = 0, ymax = 0.03, fill = "1. Hyperarid"))+
  geom_rect(aes(xmin = -Inf, xmax = + Inf, ymin = 0.03, ymax = 0.2, fill = "2.Arid"))+
  geom_rect(aes(xmin = -Inf, xmax = + Inf, ymin = 0.2, ymax = 0.5, fill = "3. Semi-arid"))+
  geom_rect(aes(xmin = -Inf, xmax = + Inf, ymin = 0.5, ymax = 0.65, fill = "4. Semi-humid"))+
  geom_rect(aes(xmin = -Inf, xmax = + Inf, ymin = 0.65, ymax = 5, fill = "5. Humid"))+
  geom_boxplot(data = filter(all.indices, emberger.cat == "Hyperarid"), aes(x="1. Hyperarid", y = unesco), col = "white")+
  geom_boxplot(data = filter(all.indices, emberger.cat == "Arid"), aes(x="2. Arid", y = unesco), col = "white")+
  geom_boxplot(data = filter(all.indices, emberger.cat == "Semi-arid"), aes(x="3. Semi-arid", y = unesco))+
  geom_boxplot(data = filter(all.indices, emberger.cat == "Subhumid"), aes(x="4. Dry subhumid", y = unesco))+
  geom_boxplot(data = filter(all.indices, emberger.cat == "Humid"), aes(x="5. Humid", y = unesco))+
  geom_boxplot(data = filter(all.indices, emberger.cat == "Hyper-humid"), aes(x="5. Hyper-humid", y = unesco))+
  scale_fill_viridis_d()+labs(x="Emberger",y="unesco", title = "Comparison Emberger/Unesco", fill = "Unesco categories")+
  theme_minimal()

b7 <- ggplot()+
  ylim(0,5)+
  geom_rect(aes(xmin = -Inf, xmax = + Inf, ymin = 0, ymax = 0.03, fill = "1. Hyperarid"))+
  geom_rect(aes(xmin = -Inf, xmax = + Inf, ymin = 0.03, ymax = 0.2, fill = "2.Arid"))+
  geom_rect(aes(xmin = -Inf, xmax = + Inf, ymin = 0.2, ymax = 0.5, fill = "3. Semi-arid"))+
  geom_rect(aes(xmin = -Inf, xmax = + Inf, ymin = 0.5, ymax = 0.65, fill = "4. Semi-humid"))+
  geom_rect(aes(xmin = -Inf, xmax = + Inf, ymin = 0.65, ymax = 5, fill = "5. Humid"))+
  geom_boxplot(data = filter(all.indices, lang.cat == "Deserts"), aes(x="1. Deserts", y = unesco), col = "white")+
  geom_boxplot(data = filter(all.indices, lang.cat == "Arid"), aes(x="2. Arid", y = unesco), col = "white")+
  geom_boxplot(data = filter(all.indices, lang.cat == "Semi-arid"), aes(x="3. Semi-arid", y = unesco))+
  geom_boxplot(data = filter(all.indices, lang.cat == "Semi-humid"), aes(x="4. Semi-humid", y = unesco))+
  geom_boxplot(data = filter(all.indices, lang.cat == "Humid"), aes(x="5. Humid", y = unesco))+
  geom_boxplot(data = filter(all.indices, lang.cat == "Hyper humid"), aes(x="6. Hyper humid", y = unesco))+
  scale_fill_viridis_d()+labs(x="Lang",y="UNESCO", title = "Comparison Lang/Unesco", fill = "Unesco categories")+
  theme_minimal()

b8 <- ggplot()+
  ylim(0,5)+
  geom_rect(aes(xmin = -Inf, xmax = + Inf, ymin = 0, ymax = 0.03, fill = "1. Hyperarid"))+
  geom_rect(aes(xmin = -Inf, xmax = + Inf, ymin = 0.03, ymax = 0.2, fill = "2.Arid"))+
  geom_rect(aes(xmin = -Inf, xmax = + Inf, ymin = 0.2, ymax = 0.5, fill = "3. Semi-arid"))+
  geom_rect(aes(xmin = -Inf, xmax = + Inf, ymin = 0.5, ymax = 0.75, fill = "4. Semi-humid"))+
  geom_rect(aes(xmin = -Inf, xmax = + Inf, ymin = 0.75, ymax = 5, fill = "5. Humid"))+
  geom_boxplot(data = filter(all.indices, emberger.cat == "Hyperarid"), aes(x="1. Hyperarid", y = unep), col = "white")+
  geom_boxplot(data = filter(all.indices, emberger.cat == "Arid"), aes(x="2. Arid", y = unep), col = "white")+
  geom_boxplot(data = filter(all.indices, emberger.cat == "Semi-arid"), aes(x="3. Semi-arid", y = unep))+
  geom_boxplot(data = filter(all.indices, emberger.cat == "Subhumid"), aes(x="4. Dry subhumid", y = unep))+
  geom_boxplot(data = filter(all.indices, emberger.cat == "Humid"), aes(x="5. Humid", y = unep))+
  geom_boxplot(data = filter(all.indices, emberger.cat == "Hyper-humid"), aes(x="5. Hyper-humid", y = unep))+
  scale_fill_viridis_d()+labs(x="Emberger",y="UNEP", title = "Comparison Emberger/UNEP", fill = "UNEP categories")+
  theme_minimal()



b9 <- ggplot()+
  ylim(0,5)+
  geom_rect(aes(xmin = -Inf, xmax = + Inf, ymin = 0, ymax = 0.03, fill = "1. Hyperarid"))+
  geom_rect(aes(xmin = -Inf, xmax = + Inf, ymin = 0.03, ymax = 0.2, fill = "2.Arid"))+
  geom_rect(aes(xmin = -Inf, xmax = + Inf, ymin = 0.2, ymax = 0.5, fill = "3. Semi-arid"))+
  geom_rect(aes(xmin = -Inf, xmax = + Inf, ymin = 0.5, ymax = 0.75, fill = "4. Semi-humid"))+
  geom_rect(aes(xmin = -Inf, xmax = + Inf, ymin = 0.75, ymax = 5, fill = "5. Humid"))+
  geom_boxplot(data = filter(all.indices, martonne.cat == "Desert"), aes(x="1. Hyperarid", y = unep), col = "white")+
  geom_boxplot(data = filter(all.indices, martonne.cat == "Arid"), aes(x="2. Arid", y = unep))+
  geom_boxplot(data = filter(all.indices, martonne.cat == "Semi-arid"), aes(x="3. Semi-arid", y = unep))+
  geom_boxplot(data = filter(all.indices, martonne.cat == "Temperate"), aes(x="4. Temperate", y = unep))+
  geom_boxplot(data = filter(all.indices, martonne.cat == "Humid"), aes(x="5. Humid", y = unep))+
  geom_boxplot(data = filter(all.indices, martonne.cat == "Forest"), aes(x="6. Forest", y = unep))+
  scale_fill_viridis_d()+labs(x="De Martonne",y="UNEP", title = "Comparison De Martonne/UNEP")+
  theme_minimal()

b10 <- ggplot()+
  ylim(0,5)+
  geom_rect(aes(xmin = -Inf, xmax = + Inf, ymin = 0, ymax = 0.03, fill = "1. Hyperarid"))+
  geom_rect(aes(xmin = -Inf, xmax = + Inf, ymin = 0.03, ymax = 0.2, fill = "2.Arid"))+
  geom_rect(aes(xmin = -Inf, xmax = + Inf, ymin = 0.2, ymax = 0.5, fill = "3. Semi-arid"))+
  geom_rect(aes(xmin = -Inf, xmax = + Inf, ymin = 0.5, ymax = 0.75, fill = "4. Semi-humid"))+
  geom_rect(aes(xmin = -Inf, xmax = + Inf, ymin = 0.75, ymax = 5, fill = "5. Humid"))+
  geom_boxplot(data = filter(all.indices, lang.cat == "Deserts"), aes(x="1. Deserts", y = unep), col = "white")+
  geom_boxplot(data = filter(all.indices, lang.cat == "Arid"), aes(x="2. Arid", y = unep), col = "white")+
  geom_boxplot(data = filter(all.indices, lang.cat == "Semi-arid"), aes(x="3. Semi-arid", y = unep))+
  geom_boxplot(data = filter(all.indices, lang.cat == "Semi-humid"), aes(x="4. Semi-humid", y = unep))+
  geom_boxplot(data = filter(all.indices, lang.cat == "Humid"), aes(x="5. Humid", y = unep))+
  geom_boxplot(data = filter(all.indices, lang.cat == "Hyper humid"), aes(x="6. Hyper humid", y = unep))+
  scale_fill_viridis_d()+labs(x="Lang",y="UNEP", title = "Comparison Lang/UNEP", fill = "UNEP categories")+
  theme_minimal()

b11 <- ggplot()+
  ylim(0,200)+
  geom_rect(aes(xmin = -Inf, xmax = + Inf, ymin = 0, ymax = 10, fill = "1. Hyperarid"))+
  geom_rect(aes(xmin = -Inf, xmax = + Inf, ymin = 10, ymax = 45, fill = "2.Arid"))+
  geom_rect(aes(xmin = -Inf, xmax = + Inf, ymin = 45, ymax = 70, fill = "3. Semi-arid"))+
  geom_rect(aes(xmin = -Inf, xmax = + Inf, ymin = 70, ymax = 110, fill = "4. Subhumid"))+
  geom_rect(aes(xmin = -Inf, xmax = + Inf, ymin = 110, ymax = 150, fill = "5. Humid"))+
  geom_rect(aes(xmin = -Inf, xmax = + Inf, ymin = 150, ymax = 200, fill = "6. Hyperhumid"))+
  geom_boxplot(data = filter(all.indices, unesco.cat == "Hyperarid"), aes(x="1. Hyperarid", y = emberger), col = "white")+
  geom_boxplot(data = filter(all.indices, unesco.cat == "Arid"), aes(x="2. Arid", y = emberger))+
  geom_boxplot(data = filter(all.indices, unesco.cat == "Semi-arid"), aes(x="3. Semi-arid", y = emberger))+
  geom_boxplot(data = filter(all.indices, unesco.cat == "Dry subhumid"), aes(x="4. Dry subhumid", y = emberger))+
  geom_boxplot(data = filter(all.indices, unesco.cat == "Humid"), aes(x="5. Humid", y = emberger))+
  scale_fill_viridis_d()+labs(x="UNESCO",y="Emberger", title = "Comparison Unesco/Emberger", fill = "Emberger categories")+
  theme_minimal()

b12 <- ggplot()+
  ylim(0,200)+
  geom_rect(aes(xmin = -Inf, xmax = + Inf, ymin = 0, ymax = 10, fill = "1. Hyperarid"))+
  geom_rect(aes(xmin = -Inf, xmax = + Inf, ymin = 10, ymax = 45, fill = "2.Arid"))+
  geom_rect(aes(xmin = -Inf, xmax = + Inf, ymin = 45, ymax = 70, fill = "3. Semi-arid"))+
  geom_rect(aes(xmin = -Inf, xmax = + Inf, ymin = 70, ymax = 110, fill = "4. Subhumid"))+
  geom_rect(aes(xmin = -Inf, xmax = + Inf, ymin = 110, ymax = 150, fill = "5. Humid"))+
  geom_rect(aes(xmin = -Inf, xmax = + Inf, ymin = 150, ymax = 200, fill = "6. Hyperhumid"))+
  geom_boxplot(data = filter(all.indices, unep.cat == "Hyperarid"), aes(x="1. Hyperarid", y = emberger), col = "white")+
  geom_boxplot(data = filter(all.indices, unep.cat == "Arid"), aes(x="2. Arid", y = emberger))+
  geom_boxplot(data = filter(all.indices, unep.cat == "Semi-arid"), aes(x="3. Semi-arid", y = emberger))+
  geom_boxplot(data = filter(all.indices, unep.cat == "Dry subhumid"), aes(x="4. Dry subhumid", y = emberger))+
  geom_boxplot(data = filter(all.indices, unep.cat == "Humid"), aes(x="5. Humid", y = emberger))+
  scale_fill_viridis_d()+labs(x="UNEP",y="Emberger", title = "Comparison UNEP/Emberger", fill = "Emberger categories")+
  theme_minimal()

b13 <- ggplot()+
  ylim(0,200)+
  geom_rect(aes(xmin = -Inf, xmax = + Inf, ymin = 0, ymax = 10, fill = "1. Hyperarid"))+
  geom_rect(aes(xmin = -Inf, xmax = + Inf, ymin = 10, ymax = 45, fill = "2.Arid"))+
  geom_rect(aes(xmin = -Inf, xmax = + Inf, ymin = 45, ymax = 70, fill = "3. Semi-arid"))+
  geom_rect(aes(xmin = -Inf, xmax = + Inf, ymin = 70, ymax = 110, fill = "4. Subhumid"))+
  geom_rect(aes(xmin = -Inf, xmax = + Inf, ymin = 110, ymax = 150, fill = "5. Humid"))+
  geom_rect(aes(xmin = -Inf, xmax = + Inf, ymin = 150, ymax = 200, fill = "6. Hyperhumid"))+
  geom_boxplot(data = filter(all.indices, martonne.cat == "Desert"), aes(x="1. Desert", y = emberger), col = "white")+
  geom_boxplot(data = filter(all.indices, martonne.cat == "Arid"), aes(x="2. Arid", y = emberger))+
  geom_boxplot(data = filter(all.indices, martonne.cat == "Semi-arid"), aes(x="3. Semi-arid", y = emberger))+
  geom_boxplot(data = filter(all.indices, martonne.cat == "Temperate"), aes(x="4. Temperate", y = emberger))+
  geom_boxplot(data = filter(all.indices, martonne.cat == "Humid"), aes(x="5. Humid", y = emberger))+
    geom_boxplot(data = filter(all.indices, martonne.cat == "Forest"), aes(x="6. Forest", y = emberger))+
  scale_fill_viridis_d()+labs(x="Martonne",y="Emberger", title = "Comparison Martonne/Emberger", fill = "Emberger categories")+
  theme_minimal()

b14 <- ggplot()+
  ylim(0,400)+
  geom_rect(aes(xmin = -Inf, xmax = + Inf, ymin = 0, ymax = 10, fill = "1. Hyperarid"))+
  geom_rect(aes(xmin = -Inf, xmax = + Inf, ymin = 10, ymax = 45, fill = "2.Arid"))+
  geom_rect(aes(xmin = -Inf, xmax = + Inf, ymin = 45, ymax = 70, fill = "3. Semi-arid"))+
  geom_rect(aes(xmin = -Inf, xmax = + Inf, ymin = 70, ymax = 110, fill = "4. Subhumid"))+
  geom_rect(aes(xmin = -Inf, xmax = + Inf, ymin = 110, ymax = 150, fill = "5. Humid"))+
  geom_rect(aes(xmin = -Inf, xmax = + Inf, ymin = 150, ymax = 400, fill = "6. Hyperhumid"))+
  geom_boxplot(data = filter(all.indices, lang.cat == "Deserts"), aes(x="1. Desert", y = emberger), col = "white")+
  geom_boxplot(data = filter(all.indices, lang.cat == "Arid"), aes(x="2. Arid", y = emberger))+
  geom_boxplot(data = filter(all.indices, lang.cat == "Semi-arid"), aes(x="3. Semi-arid", y = emberger))+
  geom_boxplot(data = filter(all.indices, lang.cat == "Semi-humid"), aes(x="4. Semi-humid", y = emberger))+
  geom_boxplot(data = filter(all.indices, lang.cat == "Humid"), aes(x="5. Humid", y = emberger))+
    geom_boxplot(data = filter(all.indices, lang.cat == "Hyper humid"), aes(x="6. Hyper-humid", y = emberger))+
  scale_fill_viridis_d()+labs(x="Lang",y="Emberger", title = "Comparison Lang/Emberger", fill = "Emberger categories")+
  theme_minimal()

``` 

# References

`r knitr::knit_exit()`


# SPEI

Can be calculated at a given location for a time series of months with the SPEI package @SPEI.
Otherwise, SPEI has been calculated by the creators for time scales of 1 to 48 months worldwide. https://digital.csic.es/handle/10261/153475

```{r spei-nc }
library(ncdf4)
spei <- nc_open("spei12.nc")

lon <- ncvar_get(spei,"lon")
lat <- ncvar_get(spei,"lat")
t <- ncvar_get(spei,"time")
spei.array <- ncvar_get(spei, "spei")
fillvalue <- ncatt_get(spei, "spei", "_FillValue") # fill value is 1e30
spei.array[spei.array == fillvalue$value] <- NA
spei.slice <- spei.array[,,1200]  # for December 2000
spei.raster <- raster(t(spei.slice), xmn = min(lon), xmx = max(lon), ymn = min(lat), ymx = max(lat), crs = CRS("+proj=longlat +ellps=WGS84 +datum=WGS84 +no_defs+ towgs84=0,0,0")) %>% flip(direction = "y")

plot(spei.raster)

spei.2020 <- spei.raster %>% as("SpatialPixelsDataFrame") %>% as.data.frame()
ggplot(spei.2020)+geom_raster(aes(x = x, y = y, fill = layer))+ 
  borders(regions = "Ivory Coast") + ylim(3.5,11) + xlim(-9,-2)+
  labs(title="SPEI December 2000, 12 months\nIvory Coast", fill = "SPEI")+
  scale_fill_viridis_c(direction = -1)+theme_void(base_size = 10)+theme(legend.position = "bottom")

ggplot(spei.2020)+geom_raster(aes(x = x, y = y, fill = layer))+ 
  borders(regions = "France") + ylim(41.5,51.5) + xlim(-5,8.5)+
  labs(title="SPEI December 2000, 12 months\nFrance", fill = "SPEI")+
  scale_fill_viridis_c(direction = -1)+theme_void(base_size = 10)+theme(legend.position = "bottom")
```



# Extra

```{r mensual-AI}
elev <- raster("wc2.1_country/CIV_wc2.1_30s_elev.tif") %>% as("SpatialPixelsDataFrame") %>% as.data.frame()

newvalues <- c("(0,0.03]"= "Hyperarid", "(0.03,0.2]" = "Arid", "(0.2,0.5]" = "Semi-arid", "(0.5,0.65]" = "Dry subhumid", "NA" = "")
mycolors <- viridisLite::viridis(n = length(newvalues), direction = -1)
names(mycolors) <- newvalues

for(i in 1:12){
precip <- raster("wc2.1_country/CIV_wc2.1_30s_prec.tif", band = i) %>% as("SpatialPixelsDataFrame") %>% as.data.frame()

srad <- raster("wc2.1_country/CIV_wc2.1_30s_srad.tif", band = i) %>% as("SpatialPixelsDataFrame") %>% as.data.frame()

tmin <- raster("wc2.1_country/CIV_wc2.1_30s_tmin.tif", band = i) %>% as("SpatialPixelsDataFrame") %>% as.data.frame()  # month tmin 

tmax <- raster("wc2.1_country/CIV_wc2.1_30s_tmax.tif", band = i) %>% as("SpatialPixelsDataFrame") %>% as.data.frame()

wind <- raster("wc2.1_country/CIV_wc2.1_30s_wind.tif") %>% as("SpatialPixelsDataFrame") %>% as.data.frame()

PMref <- ETo_FPM(R_n = srad$CIV_wc2.1_30s_srad_1, #from kJ/m2/day to MJ/m2/day
                 elev = elev$CIV_wc2.1_30s_elev, 
                 T_min = tmin$CIV_wc2.1_30s_tmin_1, 
                 T_max = tmax$CIV_wc2.1_30s_tmax_1, 
                 u_2 = wind$CIV_wc2.1_30s_wind_1)

AI.df <- precip %>% mutate(ET = PMref, AI = CIV_wc2.1_30s_prec_1*12/PMref)
head(AI.df)
AI.df$cat <- cut(AI.df$AI, breaks = c(0,0.03,0.2,0.5,0.65))
AI.df$cat.AI <- revalue(AI.df$cat, newvalues)

g <- ggplot(AI.df)+geom_raster(aes(x = x, y = y, fill = AI))+
    borders(regions = "Ivory Coast")+
  labs(fill = "", subtitle = i)+scale_fill_viridis_c(direction = -1, option = "A")+theme_void(base_size = 8)+theme(legend.position = "bottom")
ggsave(plot = g, filename = paste("AIref",i,".civ.jpg", sep =""), width = 3, height = 3)

g <- ggplot(AI.df)+geom_raster(aes(x = x, y = y, fill = cat.AI))+
    borders(regions = "Ivory Coast")+
  labs(subtitle = i, fill = "")+scale_fill_manual(values = mycolors)+theme_void(base_size = 8)+theme(legend.position = "bottom")
ggsave(plot = g, filename = paste("cat.AIref",i,".civ.jpg", sep =""), width = 3, height = 3)
}

```
