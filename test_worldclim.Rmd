---
title: "test AI"
output: 
  html_document:
    toc: true
    toc_float: true
    number_sections: true
    code_folding: hide
date: "2023-09-13"
bibliography: AI.bib

---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = F, warning = F, error = F, fig.align = "center", collapse = T)
```

```{r testing-worldclim}
library(geodata)
library(plyr)
library(dplyr)

library(raster)
library(sf)
library(ggplot2)

library(reshape2)

library(lubridate)
```

# Download worldclim

```{r dowload-worldclim, eval = F}
worldclim_country("Côte d'Ivoire", var = "prec", res = 0.5, path = ".") # average monthly precipitation in Ivory Coast, reference period 1970-2000). Res: 1km
worldclim_country("France", var = "prec", res = 0.5, path = ".") # average monthly precipitation in France, reference period 1970-2000). Res: 1km

worldclim_country("Côte d'Ivoire", var = "tavg", res = 0.5, path = ".") # average monthly temperature in Ivory Coast, reference period 1970-2000)
worldclim_country("France", var = "tavg", res = 0.5, path = ".") # average monthly temperature in France, reference period 1970-2000)

worldclim_country("Côte d'Ivoire", var = "tmin", res = 0.5, path = ".") # monthly minimum temperature in Ivory Coast, reference period 1970-2000)
worldclim_country("France", var = "tmin", res = 0.5, path = ".") # monthly minimum temperature in France, reference period 1970-2000)

worldclim_country("Côte d'Ivoire", var = "tmax", res = 0.5, path = ".") # monthly minimum temperature in Ivory Coast, reference period 1970-2000)
worldclim_country("France", var = "tmax", res = 0.5, path = ".") # monthly minimum temperature in Ivory Coast, reference period 1970-2000)


worldclim_country("Côte d'Ivoire", var = "srad", res = 0.5, path = ".") # average monthly solar radiation in Ivory Coast, reference period 1970-2000)
worldclim_country("France", var = "srad", res = 0.5, path = ".") # average monthly solar radiation in France, reference period 1970-2000)

worldclim_country("Côte d'Ivoire", var = "bio", res = 0.5, path = ".") # Bioclimatic variablesreference period 1970-2000)
worldclim_country("France", var = "bio", res = 0.5, path = ".") # Bioclimatic variables France, reference period 1970-2000)

worldclim_country("Côte d'Ivoire", var = "elev", res = 0.5, path = ".") # elevation in Ivory Coast, reference period 1970-2000
worldclim_country("France", var = "elev", res = 0.5, path = ".") # elevation in France, reference period 1970-2000

worldclim_country("Côte d'Ivoire", var = "wind", res = 0.5, path = ".") # elevation in Ivory Coast, reference period 1970-2000
worldclim_country("France", var = "wind", res = 0.5, path = ".") # elevation in France, reference period 1970-2000

worldclim_global(var = "prec", res = 10, path = ".")
worldclim_global(var = "tavg", res = 10, path = ".")
worldclim_global(var = "tmin", res = 10, path = ".")
worldclim_global(var = "tmax", res = 10, path = ".")
worldclim_global(var = "srad", res = 10, path = ".")
worldclim_global(var = "elev", res = 10, path = ".")
worldclim_global(var = "wind", res = 10, path = ".")
worldclim_global(var = "bio", res = 10, path = ".")
```

```{r merge-france, eval = F}
monthly.tavg <- raster::stack("wc2.1_country/FRA_wc2.1_30s_tavg.tif") %>% as("SpatialPixelsDataFrame") %>% as.data.frame() %>% 
  setNames( c("tmean_01","tmean_02","tmean_03","tmean_04","tmean_05","tmean_06","tmean_07","tmean_08","tmean_09","tmean_10","tmean_11","tmean_12","lon","lat"))

monthly.tmax <- raster::stack("wc2.1_country/FRA_wc2.1_30s_tmax.tif") %>% as("SpatialPixelsDataFrame") %>% as.data.frame() %>%
  setNames(c("tmax_01","tmax_02","tmax_03","tmax_04","tmax_05","tmax_06","tmax_07","tmax_08","tmax_09","tmax_10","tmax_11","tmax_12","lon","lat"))

monthly.tmin <- raster::stack("wc2.1_country/FRA_wc2.1_30s_tmin.tif") %>% as("SpatialPixelsDataFrame") %>% as.data.frame() %>%
  setNames(c("tmin_01","tmin_02","tmin_03","tmin_04","tmin_05","tmin_06","tmin_07","tmin_08","tmin_09","tmin_10","tmin_11","tmin_12","lon","lat"))

monthly.p <- raster::stack("wc2.1_country/FRA_wc2.1_30s_prec.tif") %>% as("SpatialPixelsDataFrame") %>% as.data.frame() %>%
  setNames(c("pre_01","pre_02","pre_03","pre_04","pre_05","pre_06","pre_07","pre_08","pre_09","pre_10","pre_11","pre_12","lon","lat"))

annual.p <- raster("wc2.1_country/FRA_wc2.1_30s_bio.tif", band = 12) %>% as("SpatialPixelsDataFrame") %>% as.data.frame() %>% setNames(c("pre","lon","lat"))

annual.t<- raster("wc2.1_country/FRA_wc2.1_30s_bio.tif", band = 1) %>% as("SpatialPixelsDataFrame") %>% as.data.frame() %>%
  setNames(c("temp","lon","lat"))

elev <- raster("wc2.1_country/FRA_wc2.1_30s_elev.tif") %>% as("SpatialPixelsDataFrame") %>% as.data.frame() %>% setNames(c("z","lon","lat"))

annual.wind <- raster::stack("wc2.1_country/FRA_wc2.1_30s_wind.tif") %>% mean(na.rm = T) %>% as("SpatialPixelsDataFrame") %>% as.data.frame() %>% setNames(c("u2","lon","lat"))

annual.srad <- raster::stack("wc2.1_country/FRA_wc2.1_30s_srad.tif") %>% raster::mean(na.rm = T) %>% as("SpatialPixelsDataFrame") %>% as.data.frame() %>% setNames(c("Rn","lon","lat")) #Rn en kJ/m2/day

fra <- monthly.tavg %>% merge(monthly.tmax, by = c("lon","lat")) %>% merge(monthly.tmin, by = c("lon","lat")) %>% 
  merge(monthly.p, by = c("lon","lat")) %>% merge(annual.p, by = c("lon","lat"))  %>% merge(annual.t, by = c("lon","lat")) %>% 
  merge(annual.wind, by = c("lon","lat")) %>% merge(annual.srad, by = c("lon","lat")) %>%
  merge(elev, by = c("lon","lat"))

saveRDS(fra, "fra.rds")
``` 

```{r merge-civ, eval = F}
monthly.tavg <- raster::stack("wc2.1_country/CIV_wc2.1_30s_tavg.tif") %>% as("SpatialPixelsDataFrame") %>% as.data.frame() %>% 
  setNames( c("tmean_01","tmean_02","tmean_03","tmean_04","tmean_05","tmean_06","tmean_07","tmean_08","tmean_09","tmean_10","tmean_11","tmean_12","lon","lat"))

monthly.tmax <- raster::stack("wc2.1_country/CIV_wc2.1_30s_tmax.tif") %>% as("SpatialPixelsDataFrame") %>% as.data.frame() %>%
  setNames(c("tmax_01","tmax_02","tmax_03","tmax_04","tmax_05","tmax_06","tmax_07","tmax_08","tmax_09","tmax_10","tmax_11","tmax_12","lon","lat"))

monthly.tmin <- raster::stack("wc2.1_country/CIV_wc2.1_30s_tmin.tif") %>% as("SpatialPixelsDataFrame") %>% as.data.frame() %>%
  setNames(c("tmin_01","tmin_02","tmin_03","tmin_04","tmin_05","tmin_06","tmin_07","tmin_08","tmin_09","tmin_10","tmin_11","tmin_12","lon","lat"))

monthly.p <- raster::stack("wc2.1_country/CIV_wc2.1_30s_prec.tif") %>% as("SpatialPixelsDataFrame") %>% as.data.frame() %>%
  setNames(c("pre_01","pre_02","pre_03","pre_04","pre_05","pre_06","pre_07","pre_08","pre_09","pre_10","pre_11","pre_12","lon","lat"))

annual.p <- raster("wc2.1_country/CIV_wc2.1_30s_bio.tif", band = 12) %>% as("SpatialPixelsDataFrame") %>% as.data.frame() %>% setNames(c("pre","lon","lat"))

annual.t<- raster("wc2.1_country/CIV_wc2.1_30s_bio.tif", band = 1) %>% as("SpatialPixelsDataFrame") %>% as.data.frame() %>%
  setNames(c("temp","lon","lat"))

elev <- raster("wc2.1_country/CIV_wc2.1_30s_elev.tif") %>% as("SpatialPixelsDataFrame") %>% as.data.frame() %>% setNames(c("z","lon","lat"))

annual.wind <- raster::stack("wc2.1_country/CIV_wc2.1_30s_wind.tif") %>% mean(na.rm = T) %>% as("SpatialPixelsDataFrame") %>% as.data.frame() %>% setNames(c("u2","lon","lat"))

annual.srad <- raster::stack("wc2.1_country/CIV_wc2.1_30s_srad.tif") %>% raster::mean(na.rm = T) %>% as("SpatialPixelsDataFrame") %>% as.data.frame() %>% setNames(c("Rn","lon","lat")) #Rn en kJ/m2/day
 
civ <- monthly.tavg %>% merge(monthly.tmax, by = c("lon","lat")) %>% merge(monthly.tmin, by = c("lon","lat")) %>% 
  merge(monthly.p, by = c("lon","lat")) %>% merge(annual.p, by = c("lon","lat"))  %>% merge(annual.t, by = c("lon","lat")) %>% 
  merge(annual.wind, by = c("lon","lat")) %>% merge(annual.srad, by = c("lon","lat")) %>%
  merge(elev, by = c("lon","lat"))

saveRDS(civ, "civ.rds")
```

```{r merge-world, eval = F}

list.prec <- list.files(path = "wc2.1_10m", pattern = "wc2.1_10m_prec_", full.names = T) 
monthly.prec <- raster::stack(list.prec) %>% as("SpatialPixelsDataFrame") %>% as.data.frame() %>%
  setNames(c("pre_01","pre_02","pre_03","pre_04","pre_05","pre_06","pre_07","pre_08","pre_09","pre_10","pre_11","pre_12","lon","lat"))

list.tavg <- list.files(path = "wc2.1_10m", pattern = "wc2.1_10m_tavg_", full.names = T) 
monthly.tavg <- raster::stack(list.tavg) %>% as("SpatialPixelsDataFrame") %>% as.data.frame() %>% 
  setNames(c("tmean_01","tmean_02","tmean_03","tmean_04","tmean_05","tmean_06","tmean_07","tmean_08","tmean_09","tmean_10","tmean_11","tmean_12","lon","lat"))

list.tmax <- list.files(path = "wc2.1_10m", pattern = "wc2.1_10m_tmax_", full.names = T) 
monthly.tmax <- raster::stack(list.tmax) %>% as("SpatialPixelsDataFrame") %>% as.data.frame() %>%
  setNames(c("tmax_01","tmax_02","tmax_03","tmax_04","tmax_05","tmax_06","tmax_07","tmax_08","tmax_09","tmax_10","tmax_11","tmax_12","lon","lat"))

list.tmin <- list.files(path = "wc2.1_10m", pattern = "wc2.1_10m_tmin_", full.names = T) 
monthly.tmin <- raster::stack(list.tmin) %>% as("SpatialPixelsDataFrame") %>% as.data.frame() %>%
  setNames(c("tmin_01","tmin_02","tmin_03","tmin_04","tmin_05","tmin_06","tmin_07","tmin_08","tmin_09","tmin_10","tmin_11","tmin_12","lon","lat"))

list.pre <- list.files(path = "wc2.1_10m", pattern = "wc2.1_10m_prec_", full.names = T) 
monthly.p <- raster::stack(list.pre) %>% as("SpatialPixelsDataFrame") %>% as.data.frame() %>%
  setNames(c("pre_01","pre_02","pre_03","pre_04","pre_05","pre_06","pre_07","pre_08","pre_09","pre_10","pre_11","pre_12","lon","lat"))

annual.p <- raster("wc2.1_10m/wc2.1_10m_bio_12.tif") %>% as("SpatialPixelsDataFrame") %>% as.data.frame() %>%
  setNames(c("pre","lon","lat"))

annual.t<- raster("wc2.1_10m/wc2.1_10m_bio_1.tif") %>% as("SpatialPixelsDataFrame") %>% as.data.frame() %>%
  setNames(c("temp","lon","lat"))

elev <- raster("wc2.1_10m/wc2.1_10m_elev.tif") %>% as("SpatialPixelsDataFrame") %>% as.data.frame() %>% setNames(c("z","lon","lat"))

list.wind <- list.files(path = "wc2.1_10m", pattern = "wc2.1_10m_wind_", full.names = T) 
monthly.wind <- raster::stack(list.wind) %>% as("SpatialPixelsDataFrame") %>% as.data.frame() %>%
  setNames(c("u_01","u_02","u_03","u_04","u_05","u_06","u_07","u_08","u_09","u_10","u_11","u_12","lon","lat"))

list.srad <- list.files(path = "wc2.1_10m", pattern = "wc2.1_10m_srad_", full.names = T) 
monthly.srad <- raster::stack(list.srad) %>% as("SpatialPixelsDataFrame") %>% as.data.frame() %>%
  setNames(c("srad_01","srad_02","srad_03","srad_04","srad_05","srad_06","srad_07","srad_08","srad_09","srad_10","srad_11","srad_12","lon","lat"))

world.df <- monthly.tavg %>% merge(monthly.tmax, by = c("lon","lat")) %>% merge(monthly.tmin, by = c("lon","lat")) %>% 
  merge(monthly.p, by = c("lon","lat")) %>% merge(annual.p, by = c("lon","lat"))  %>% merge(annual.t, by = c("lon","lat")) %>% 
  merge(monthly.wind, by = c("lon","lat")) %>% merge(monthly.srad, by = c("lon","lat")) %>%
   merge(elev, by = c("lon","lat"))

saveRDS(world.df, "world.df.rds")
```


```{r load-data}
fra <- readRDS("fra.rds")
civ <- readRDS("civ.rds")
world.df <- readRDS("world.df.rds")
```

# Lang Rain Factor

Detailed in @Thornthwaite1948 and [here]<https://iast.univ-setif.dz/documents/Cours/Cours6BioclimatologieL2GAT21.pdf> 

```{r lang-civ }
lang.civ <- civ %>% mutate(RF = pre/temp)

lang.civ$cat.AI <- cut(lang.civ$RF, breaks = c(0,20,40,60,100,160,200)) %>% revalue(c("(0,20]"= "Deserts", "(20,40]" = "Arid", "(40,60]" = "Semi-arid", "(60,100]" = "Semi-humid","(100,160]" = "Humid", "(160,200]"="Hyper humid"))

ggplot(lang.civ)+geom_tile(aes(x = lon, y = lat, fill = RF))+
    borders(regions = "Ivory Coast")+
  labs(title = "Lang Rain Factor", fill = "")+scale_fill_viridis_c(direction = -1)+theme_void(base_size = 10)+theme(legend.position = "bottom")

ggplot(lang.civ)+geom_tile(aes(x = lon, y = lat, fill = cat.AI))+
    borders(regions = "Ivory Coast")+
  labs(title = "Lang Rain Factor", fill = "")+scale_fill_viridis_d(direction = -1, na.translate = F)+theme_void(base_size = 10)+theme(legend.position = "bottom")

```

```{r lang-france}
lang.fra <- fra %>% mutate(RF = pre/temp)

lang.fra$cat.AI <- cut(lang.fra$RF, breaks = c(0,20,40,60,100,160,500,Inf)) %>% revalue(c("(0,20]"= "Deserts", "(20,40]" = "Arid", "(40,60]" = "Semi-arid", "(60,100]" = "Semi-humid","(100,160]" = "Humid", "(160,500]"="Hyper humid", "(500,Inf]" = "Annual temp near 0"))

ggplot(lang.fra)+geom_tile(aes(x = lon, y = lat, fill = RF))+
    borders(regions = "France")+
  labs(title = "Lang Rain Factor", fill = "")+scale_fill_viridis_c(direction = -1, lim = c(-0, 200))+theme_void(base_size = 10)+theme(legend.position = "bottom")

ggplot(lang.fra)+geom_tile(aes(x = lon, y = lat, fill = cat.AI))+
    borders(regions = "France")+
  labs(title = "Lang Rain Factor", fill = "")+scale_fill_viridis_d(direction = -1, na.translate = F)+theme_void(base_size = 10)+theme(legend.position = "bottom")

```

# AI De Martonne

Defined by @Martonne1926, used and detailed by @Baltas2007.

```{r martonne-civ }
martonne.civ <- civ %>% mutate(Am = pre/(temp+10)) # pre en mm
martonne.civ$cat.AI <- martonne.civ$Am %>% cut(c(0,10,20,24,28,35,55,100)) %>% revalue(c("(0,10]"= "Dry", "(10,20]" = "Semi-dry","(20,24]" = "Meditarranean", "(24,28]" = "Semi-humid", "(28,35]" = "Semi-humid","(35,55]" = "Very humid (a)", "(55,100]" = "Very humid (b)"))


ggplot(martonne.civ)+geom_tile(aes(x = lon, y = lat, fill = cat.AI))+
    borders(regions = "Ivory Coast")+
  labs(title = "De Martonne Aridity Index", fill = "")+
  scale_fill_viridis_d(direction = -1, na.translate = F)+theme_void(base_size = 10)+theme(legend.position = "bottom")+guides(fill = guide_legend(nrow = 2))

ggplot(martonne.civ)+geom_tile(aes(x = lon, y = lat, fill = Am))+
    borders(regions = "Ivory Coast")+
  labs(title = "De Martonne Aridity Index", fill = "")+
  scale_fill_viridis_c(direction = -1)+theme_void(base_size = 10)+theme(legend.position = "bottom")+guides(fill = guide_legend(nrow = 1))
```

```{r martonne-fra }

martonne.fra <- fra %>% mutate(Am = pre/(temp+10)) # pre en mm
martonne.fra$cat.AI <- martonne.fra$Am %>% cut(c(0,10,20,24,28,35,55,100)) %>% revalue(c("(0,10]"= "Dry", "(10,20]" = "Semi-dry","(20,24]" = "Meditarranean", "(24,28]" = "Semi-humid", "(28,35]" = "Semi-humid","(35,55]" = "Very humid (a)", "(55,100]" = "Very humid (b)"))


ggplot(martonne.fra)+geom_tile(aes(x = lon, y = lat, fill = cat.AI))+
    borders(regions = "France")+
  labs(title = "De Martonne Aridity Index", fill = "")+
  scale_fill_viridis_d(direction = -1, na.translate = F)+theme_void(base_size = 10)+theme(legend.position = "bottom")+guides(fill = guide_legend(nrow = 2))

ggplot(martonne.fra)+geom_tile(aes(x = lon, y = lat, fill = Am))+
    borders(regions = "France")+
  labs(title = "De Martonne Aridity Index", fill = "")+
  scale_fill_viridis_c(direction = -1, lim = c(0,100))+theme_void(base_size = 10)+theme(legend.position = "bottom")+guides(fill = guide_legend(nrow = 1))
```
```{r martonne-world }

martonne.w <- world.df %>% mutate(Am = pre/(temp+10)) # pre en mm
martonne.w$cat.AI <- martonne.w$Am %>% cut(c(0,10,20,24,28,35,55,100)) %>% revalue(c("(0,10]"= "Dry", "(10,20]" = "Semi-dry","(20,24]" = "Meditarranean", "(24,28]" = "Semi-humid", "(28,35]" = "Semi-humid","(35,55]" = "Very humid (a)", "(55,100]" = "Very humid (b)"))


ggplot(martonne.w)+geom_tile(aes(x = lon, y = lat, fill = cat.AI))+
  labs(title = "De Martonne Aridity Index", fill = "")+
  scale_fill_viridis_d(direction = -1, na.translate = F)+theme_void(base_size = 10)+theme(legend.position = "bottom")+guides(fill = guide_legend(nrow = 2))

ggplot(martonne.w)+geom_tile(aes(x = lon, y = lat, fill = Am))+
  labs(title = "De Martonne Aridity Index", fill = "")+
  scale_fill_viridis_c(direction = -1, lim = c(0,100))+theme_void(base_size = 10)+theme(legend.position = "bottom")+guides(fill = guide_legend(nrow = 1))
```

# Emberger

Defined by Emberger in 1932, and explained in @Marres1972.

Used by @Baldy1972 for Liban. 

Used by @Shaban2019, who modified the original formula to use the average monthly rainfall instead of the cumulated annual rainfall AND END UP WITH THE WEIRDEST EQUATION

Problème: je ne prends pas les bons max/min? Pas de consensus sur la formule dans la littérature. Les fonctions R prédéfinies utilisent 100P/(T2-t2) en K, alors que  Baldy utilise un facteur 1000 et Marres parle en °C. Shaban utilisent des °C. 
STILL NOT SURE

T and t in K. 100P

```{r emberger-civ }

emberger.civ <- civ 
emberger.civ$tmax <- apply(dplyr::select(civ, c("tmean_01", "tmean_02", "tmean_03", "tmean_04", "tmean_05", "tmean_06", "tmean_07", "tmean_08", "tmean_09", "tmean_10", "tmean_11", "tmean_12")), 1, max, na.rm = T)
emberger.civ$tmin <- apply(dplyr::select(civ, c("tmean_01", "tmean_02", "tmean_03", "tmean_04", "tmean_05", "tmean_06", "tmean_07", "tmean_08", "tmean_09", "tmean_10", "tmean_11", "tmean_12")), 1, min, na.rm = T)
emberger.civ$Em <- with(emberger.civ, pre*100/(tmax^2-tmin^2)) # Formulation from Marres1972. 

ggplot(emberger.civ)+geom_tile(aes(x = lon, y = lat, fill = Em))+
    borders(regions = "Ivory Coast")+
  labs(fill = "Em")+scale_fill_viridis_c(direction = -1)+theme_void(base_size = 10)+theme(legend.position = "bottom")

emberger.civ$cat.AI <- cut(emberger.civ$Em, breaks = c(0,10,45,70,110,150,760)) %>% revalue(c("(0,10]"= "Hyperarid", "(10,45]" = "Arid", "(45,70]" = "Semi-arid", "(70,110]" = "Subhumid","(110,150]" = "Humid","(150,760]" = "Hyper-humid"))

ggplot(emberger.civ)+geom_tile(aes(x = lon, y = lat, fill = cat.AI))+
    borders(regions = "Ivory Coast")+
  labs(title = "Emberger Aridity Index", fill = "")+scale_fill_viridis_d(direction = -1, na.translate = F)+theme_void(base_size = 10)+theme(legend.position = "bottom")+guides(fill = guide_legend(nrow = 1))

```

```{r emberger-fra }

emberger.fra <- fra 
emberger.fra$tmax <- apply(dplyr::select(fra, c("tmean_01", "tmean_02", "tmean_03", "tmean_04", "tmean_05", "tmean_06", "tmean_07", "tmean_08", "tmean_09", "tmean_10", "tmean_11", "tmean_12")), 1, max, na.rm = T)
emberger.fra$tmin <- apply(dplyr::select(fra, c("tmean_01", "tmean_02", "tmean_03", "tmean_04", "tmean_05", "tmean_06", "tmean_07", "tmean_08", "tmean_09", "tmean_10", "tmean_11", "tmean_12")), 1, min, na.rm = T)
emberger.fra$Em <- with(emberger.fra, pre*100/(tmax^2-tmin^2)) # Formulation from Marres1972. 

ggplot(emberger.fra)+geom_tile(aes(x = lon, y = lat, fill = Em))+
    borders(regions = "France")+
  labs(fill = "Em")+scale_fill_viridis_c(direction = -1)+theme_void(base_size = 10)+theme(legend.position = "bottom")

emberger.fra$cat.AI <- cut(emberger.fra$Em, breaks = c(0,10,45,70,110,150,760)) %>% revalue(c("(0,10]"= "Hyperarid", "(10,45]" = "Arid", "(45,70]" = "Semi-arid", "(70,110]" = "Subhumid","(110,150]" = "Humid","(150,760]" = "Hyper-humid"))

ggplot(emberger.fra)+geom_tile(aes(x = lon, y = lat, fill = cat.AI))+
    borders(regions = "France")+
  labs(title = "Emberger Aridity Index", fill = "")+scale_fill_viridis_d(direction = -1, na.translate = F)+theme_void(base_size = 10)+theme(legend.position = "bottom")+guides(fill = guide_legend(nrow = 2))

```
```{r emberger-w}

emberger.w <- world.df

emberger.w$tmax <-apply(dplyr::select(world.df, c("tmean_01", "tmean_02", "tmean_03", "tmean_04", "tmean_05", "tmean_06", "tmean_07", "tmean_08", "tmean_09", "tmean_10", "tmean_11", "tmean_12")), 1, max, na.rm = T)
emberger.w$tmin <- apply(dplyr::select(world.df, c("tmean_01", "tmean_02", "tmean_03", "tmean_04", "tmean_05", "tmean_06", "tmean_07", "tmean_08", "tmean_09", "tmean_10", "tmean_11", "tmean_12")), 1, min, na.rm = T)
emberger.w$Em <- with(emberger.w, pre*100/(tmax^2-tmin^2)) # Formulation from Marres1972. 


ggplot(emberger.w)+geom_tile(aes(x = lon, y = lat, fill = Em))+
  labs(fill = "Em")+scale_fill_viridis_c(direction = -1)+theme_void(base_size = 10)+theme(legend.position = "bottom")

emberger.w$cat.AI <- cut(emberger.w$Em, breaks = c(-Inf, 0,10,45,70,110,150, +Inf)) %>% revalue(c("(-Inf,0]" = NA,"(0,10]"= "Hyperarid", "(10,45]" = "Arid", "(45,70]" = "Semi-arid", "(70,110]" = "Subhumid","(110,150]" = "Humid","(150, Inf]" = "Hyper-humid"))

ggplot(emberger.w)+geom_tile(aes(x = lon, y = lat, fill = cat.AI))+
  labs(title = "Emberger Aridity Index", fill = "")+scale_fill_viridis_d(direction = -1,   na.value = "grey50", na.translate = T)+theme_void(base_size = 10)+theme(legend.position = "bottom")+guides(fill = guide_legend(nrow = 2))

```

Encore une fois, ne fonctionne pas si la température annuelle moyenne (ou tmax-tmin) est < 0: l'indice devient négatif
# Ångström

Same categorization as Martonne?

```{r angstrom-civ}

ang.civ <- civ %>% mutate(AI = pre/(1.07^temp))

ang.civ$cat.AI <- ang.civ$AI %>% cut(breaks = c(0,20,40,60,100,160,700)) %>% revalue(c("(0,20]"= "Deserts", "(20,40]" = "Arid", "(40,60]" = "Semi-arid", "(60,100]" = "Semi-humid","(100,160]" = "Humid", "(160,700]"="Hyper humid"))
#martonne.df$cat.AI <- revalue(martonne.df$cat, c("(0,10]"= "Dry", "(10,20]" = "Semi-dry","(20,24]" = "Meditarranean", "(24,28]" = "Semi-humid", "(28,35]" = "Semi-humid","(35,55]" = "Very humid (a)", "(55,100]" = "Very humid (b)"))

ggplot(ang.civ)+geom_tile(aes(x = lon, y = lat, fill = cat.AI))+
    borders(regions = "Ivory Coast")+
  labs(title = "Ångström Aridity Index", fill = "")+scale_fill_viridis_d(direction = -1, na.translate = F)+theme_void(base_size = 10)+theme(legend.position = "bottom")+guides(fill = guide_legend(nrow = 1))

ggplot(ang.civ)+geom_tile(aes(x = lon, y = lat, fill = AI))+
    borders(regions = "Ivory Coast")+
  labs(title = "Ångström Aridity Index", fill = "")+scale_fill_viridis_c(direction = -1)+theme_void(base_size = 10)+theme(legend.position = "bottom")+guides(fill = guide_legend(nrow = 1))
```
```{r angstrom-fra }

ang.fra <- fra %>% mutate(AI = pre/(1.07^temp))

ang.fra$cat.AI <- ang.fra$AI %>% cut(breaks = c(0,20,40,60,100,160,700, 2000)) %>% 
  revalue(c("(0,20]"= "Deserts", "(20,40]" = "Arid", "(40,60]" = "Semi-arid", "(60,100]" = "Semi-humid","(100,160]" = "Humid", "(160,700]"= "Hyper humid", "(700,2e+03]" = "Even more humid"))
#martonne.df$cat.AI <- revalue(martonne.df$cat, c("(0,10]"= "Dry", "(10,20]" = "Semi-dry","(20,24]" = "Meditarranean", "(24,28]" = "Semi-humid", "(28,35]" = "Semi-humid","(35,55]" = "Very humid (a)", "(55,100]" = "Very humid (b)"))

ggplot(ang.fra)+geom_tile(aes(x = lon, y = lat, fill = cat.AI))+
  borders(regions = "France")+
  labs(title = "Ångström Aridity Index", fill = "")+
  scale_fill_viridis_d(direction = -1, na.translate = F)+theme_void(base_size = 10)+theme(legend.position = "bottom")+guides(fill = guide_legend(nrow = 1))

ggplot(ang.fra)+geom_tile(aes(x = lon, y = lat, fill = AI))+
  borders(regions = "France")+
  labs(title = "Ångström Aridity Index", fill = "")+scale_fill_viridis_c(direction = -1)+theme_void(base_size = 10)+theme(legend.position = "bottom")+guides(fill = guide_legend(nrow = 1))
```

```{r angstrom-world }

ang.w <- world.df %>% mutate(AI = pre/(1.07^temp))

ang.w$cat.AI <- ang.w$AI %>% cut(breaks = c(0,20,40,60,100,160,700)) %>% revalue(c("(0,20]"= "Deserts", "(20,40]" = "Arid", "(40,60]" = "Semi-arid", "(60,100]" = "Semi-humid","(100,160]" = "Humid", "(160,700]"="Hyper humid"))
#martonne.df$cat.AI <- revalue(martonne.df$cat, c("(0,10]"= "Dry", "(10,20]" = "Semi-dry","(20,24]" = "Meditarranean", "(24,28]" = "Semi-humid", "(28,35]" = "Semi-humid","(35,55]" = "Very humid (a)", "(55,100]" = "Very humid (b)"))

ggplot(ang.w)+geom_tile(aes(x = lon, y = lat, fill = cat.AI))+
  labs(title = "Ångström Aridity Index", fill = "")+scale_fill_viridis_d(direction = -1, na.translate = T, na.value = "grey50")+theme_void(base_size = 10)+theme(legend.position = "bottom")+guides(fill = guide_legend(nrow = 1))

ggplot(ang.w)+geom_tile(aes(x = lon, y = lat, fill = AI))+
  labs(title = "Ångström Aridity Index", fill = "")+scale_fill_viridis_c(direction = -1)+theme_void(base_size = 10)+theme(legend.position = "bottom")+guides(fill = guide_legend(nrow = 1))
```

# AI UNESCO (PM, FAO)

Index established by UNESCO1979, used and detailed by @Tsakiris2005

Formulas available at: https://www.fao.org/3/x0490E/x0490e0k.htm#annex%203.%20background%20on%20physical%20parameters%20used%20in%20evapotranspiration%20computatio 


```{r PM-perso-civ} 
unesco.civ <- civ %>% mutate(P = 101.3 * ((293-0.0065*z)/293)^(5.26)) #atm P based on Burman et al. 1987

unesco.civ$tmax <- apply(dplyr::select(civ, c("tmax_01", "tmax_02", "tmax_03", "tmax_04", "tmax_05", "tmax_06", "tmax_07", "tmax_08", "tmax_09", "tmax_10", "tmax_11", "tmax_12")), 1, max, na.rm = T)
unesco.civ$tmin <- apply(dplyr::select(civ, c("tmin_01", "tmin_02", "tmin_03", "tmin_04", "tmin_05", "tmin_06", "tmin_07", "tmin_08", "tmin_09", "tmin_10", "tmin_11", "tmin_12")), 1, min, na.rm = T)

unesco.civ$es <- with(unesco.civ, ifelse(temp > 0, 0.61078*exp(17.27*temp/(temp+237.3)),  0.61078*exp(21.875*temp/(temp+265.5)))) # saturation vapor pressure Monteith-Unsworth pour >0, Murray pour T < 0
unesco.civ$delta <- with(unesco.civ, 4098*es/(temp+237.3)^2) #slope vapor pressure
unesco.civ$gamma <- with(unesco.civ, 0.00163*P/(2.501-52.6361e-3*temp)) #psychrometric constant
unesco.civ$ea <- with(unesco.civ, with(unesco.civ, ifelse(tmin > 0, 0.61078*exp(17.27*tmin/(tmin+237.3)),  0.61078*exp(21.875*tmin/(tmin+265.5))))) # actual vapor pressur; when relative humidity is not availabmle, ea is obtained by estimating that when the air temp is close to Tmin, it is nearly saturated
unesco.civ$ET0 <-with(unesco.civ, (0.408*delta*Rn*1e-3+gamma*900/(temp+273)*u2*(es-ea)/(delta+gamma*(1+0.34*u2)))) # Evapotranspiration, G considered to be negligible. in mm/day
unesco.civ$AI_FAO <- with(unesco.civ, pre/(ET0*365))

unesco.civ$cat.AI_FAO <- unesco.civ$AI_FAO %>% cut(breaks = c(0,0.03,0.2,0.5,0.75,3)) %>% 
  revalue(c("(0,0.03]"= "Hyperarid", "(0.03,0.2]" = "Arid", "(0.2,0.5]" = "Semi-arid", "(0.5,0.75]" = "Dry subhumid","(0.75,3]" = "Humid"))

ggplot(unesco.civ)+geom_tile(aes(x = lon, y = lat, fill = cat.AI_FAO))+
  borders(regions = "Ivory Coast")+
  labs(title = "Unesco Aridity Index", fill = "")+scale_fill_viridis_d(direction = -1, na.translate = F)+
  theme_void(base_size = 10)+theme(legend.position = "bottom")+guides(fill = guide_legend(nrow = 2))

```

```{r PM-perso-fra} 
unesco.fra <- fra %>% mutate(P = 101.3 * ((293-0.0065*z)/293)^(5.26)) #atm P based on Burman et al. 1987

unesco.fra$tmax <- apply(dplyr::select(fra, c("tmax_01", "tmax_02", "tmax_03", "tmax_04", "tmax_05", "tmax_06", "tmax_07", "tmax_08", "tmax_09", "tmax_10", "tmax_11", "tmax_12")), 1, max, na.rm = T)
unesco.fra$tmin <- apply(dplyr::select(fra, c("tmin_01", "tmin_02", "tmin_03", "tmin_04", "tmin_05", "tmin_06", "tmin_07", "tmin_08", "tmin_09", "tmin_10", "tmin_11", "tmin_12")), 1, min, na.rm = T)

unesco.fra$es <- with(unesco.fra, ifelse(temp > 0, 0.61078*exp(17.27*temp/(temp+237.3)),  0.61078*exp(21.875*temp/(temp+265.5)))) # saturation vapor pressure Monteith-Unsworth pour >0, Murray pour T < 0
unesco.fra$delta <- with(unesco.fra, 4098*es/(temp+237.3)^2) #slope vapor pressure
unesco.fra$gamma <- with(unesco.fra, 0.00163*P/(2.501-52.6361e-3*temp)) #psychrometric constant
unesco.fra$ea <- with(unesco.fra, with(unesco.fra, ifelse(tmin > 0, 0.61078*exp(17.27*tmin/(tmin+237.3)),  0.61078*exp(21.875*tmin/(tmin+265.5))))) # actual vapor pressur; when relative humidity is not availabmle, ea is obtained by estimating that when the air temp is close to Tmin, it is nearly saturated
unesco.fra$ET0 <-with(unesco.fra, (0.408*delta*Rn*1e-3+gamma*900/(temp+273)*u2*(es-ea)/(delta+gamma*(1+0.34*u2)))) # Evapotranspiration, G considered to be negligible. in mm/day
unesco.fra$AI_FAO <- with(unesco.fra, pre/(ET0*365))

unesco.fra$cat.AI_FAO <- unesco.fra$AI_FAO %>% cut(breaks = c(0,0.03,0.2,0.5,0.75,4)) %>% 
  revalue(c("(0,0.03]"= "Hyperarid", "(0.03,0.2]" = "Arid", "(0.2,0.5]" = "Semi-arid", "(0.5,0.75]" = "Dry subhumid","(0.75,4]" = "Humid"))

ggplot(unesco.fra)+geom_tile(aes(x = lon, y = lat, fill = cat.AI_FAO))+
  borders(regions = "France")+
  labs(title = "Unesco Aridity Index", fill = "")+scale_fill_viridis_d(direction = -1, na.translate = F)+
  theme_void(base_size = 10)+theme(legend.position = "bottom")+guides(fill = guide_legend(nrow = 1))

ggplot(unesco.fra)+geom_tile(aes(x = lon, y = lat, fill = AI_FAO))+
    borders(regions = "France")+
  labs(title = "Unesco Aridity Index", fill = "")+
  scale_fill_viridis_c(direction = -1)+theme_void(base_size = 10)+theme(legend.position = "bottom")+guides(fill = guide_legend(nrow = 1))

```
```{r PM-perso-world} 
unesco.w <- world.df %>% mutate(P = 101.3 * ((293-0.0065*z)/293)^(5.26)) #atm P based on Burman et al. 1987

unesco.w$tmax <- apply(dplyr::select(world.df, c("tmax_01", "tmax_02", "tmax_03", "tmax_04", "tmax_05", "tmax_06", "tmax_07", "tmax_08", "tmax_09", "tmax_10", "tmax_11", "tmax_12")), 1, max, na.rm = T)
unesco.w$tmin <- apply(dplyr::select(world.df, c("tmin_01", "tmin_02", "tmin_03", "tmin_04", "tmin_05", "tmin_06", "tmin_07", "tmin_08", "tmin_09", "tmin_10", "tmin_11", "tmin_12")), 1, min, na.rm = T)
unesco.w$Rn <- apply(dplyr::select(world.df, c("srad_01", "srad_02", "srad_03", "srad_04", "srad_05", "srad_06", "srad_07", "srad_08", "srad_09", "srad_10", "srad_11", "srad_12")), 1, mean, na.rm = T)
unesco.w$u2 <- apply(dplyr::select(world.df, c("u_01", "u_02", "u_03", "u_04", "u_05", "u_06", "u_07", "u_08", "u_09", "u_10", "u_11", "u_12")), 1, mean, na.rm = T)

unesco.w$es <- with(unesco.w, ifelse(temp > 0, 0.61078*exp(17.27*temp/(temp+237.3)),  0.61078*exp(21.875*temp/(temp+265.5)))) # saturation vapor pressure Monteith-Unsworth pour >0, Murray pour T < 0
unesco.w$delta <- with(unesco.w, 4098*es/(temp+237.3)^2) #slope vapor pressure
unesco.w$gamma <- with(unesco.w, 0.00163*P/(2.501-52.6361e-3*temp)) #psychrometric constant
unesco.w$ea <- with(unesco.w, with(unesco.w, ifelse(tmin > 0, 0.61078*exp(17.27*tmin/(tmin+237.3)),  0.61078*exp(21.875*tmin/(tmin+265.5))))) # actual vapor pressur; when relative humidity is not availabmle, ea is obtained by estimating that when the air temp is close to Tmin, it is nearly saturated
unesco.w$ET0 <-with(unesco.w, (0.408*delta*Rn*1e-3+gamma*900/(temp+273)*u2*(es-ea)/(delta+gamma*(1+0.34*u2)))) # Evapotranspiration, G considered to be negligible. in mm/day
unesco.w$AI_FAO <- with(unesco.w, pre/(ET0*365))

unesco.w$cat.AI_FAO <- unesco.w$AI_FAO %>% cut(breaks = c(0,0.03,0.2,0.5,0.75,14), include.lowest = T) %>% # otherwise regions in  which pre = 0 are excluded 
  revalue(c("[0,0.03]"= "Hyperarid", "(0.03,0.2]" = "Arid", "(0.2,0.5]" = "Semi-arid", "(0.5,0.75]" = "Dry subhumid","(0.75,14]" = "Humid"))

ggplot(unesco.w)+geom_tile(aes(x = lon, y = lat, fill = cat.AI_FAO))+
  labs(title = "Unesco Aridity Index)", fill = "")+scale_fill_viridis_d(direction = -1, na.translate = F)+
  theme_void(base_size = 10)+theme(legend.position = "bottom")+guides(fill = guide_legend(nrow = 1))

ggplot(unesco.w)+geom_tile(aes(x = lon, y = lat, fill = AI_FAO))+
  labs(title = "Unesco Aridity Index", fill = "")+
  scale_fill_viridis_c(direction = -1)+theme_void(base_size = 10)+theme(legend.position = "bottom")+guides(fill = guide_legend(nrow = 1))

```

# AI UNEP (Thornthwaite)

1. Extraire la température mensuelle pur les 12 mois. 
2. calculer tho pour chaque point. Résultat: PET par mois
3. Additionner les PET pour obtenir annual PET. 

Catégorisation @Tsakiris2005


```{r thornthwaite-civ-by-hand }
thorn.civ <- mutate(civ, i_01 = (tmean_01/5)^1.514,
                    i_02 = (tmean_02/5)^1.514,
                    i_03 = (tmean_03/5)^1.514,
                    i_04 = (tmean_04/5)^1.514,
                    i_05 = (tmean_05/5)^1.514,
                    i_06 = (tmean_06/5)^1.514,
                    i_07 = (tmean_07/5)^1.514,
                    i_08 = (tmean_08/5)^1.514,
                    i_09 = (tmean_09/5)^1.514,
                    i_10 = (tmean_10/5)^1.514,
                    i_11 = (tmean_11/5)^1.514,
                    i_12 = (tmean_12/5)^1.514,
                    I = i_01+i_02+i_03+i_04+i_05+i_06+i_07+i_08+i_09+i_10+i_11+i_12,
                    a = (6.751e-7)*I^3 - (7.7e-5)*I^2 + 0.01729*I + 0.49239,
                    e_01 = 16* geosphere::daylength(lat,"2000-01-15")/12* 31 /30*(10*tmean_01/I)^a, #Ep = 16 * L/12 * N/30 * (10T/I) ^a, L is length of daylight, N number of days in month
                    e_02 = 16* geosphere::daylength(lat,"2000-02-15")/12* 28 /30*(10*tmean_02/I)^a,
                    e_03 = 16* geosphere::daylength(lat,"2000-03-15")/12* 31 /30*(10*tmean_03/I)^a,
                    e_04 = 16* geosphere::daylength(lat,"2000-04-15")/12* 30 /30*(10*tmean_04/I)^a,
                    e_05 = 16* geosphere::daylength(lat,"2000-05-15")/12* 31 /30*(10*tmean_05/I)^a,
                    e_06 = 16* geosphere::daylength(lat,"2000-06-15")/12* 30 /30*(10*tmean_06/I)^a,
                    e_07 = 16* geosphere::daylength(lat,"2000-07-15")/12* 31 /30*(10*tmean_07/I)^a,
                    e_08 = 16* geosphere::daylength(lat,"2000-08-15")/12* 31 /30*(10*tmean_08/I)^a,
                    e_09 = 16* geosphere::daylength(lat,"2000-09-15")/12* 30 /30*(10*tmean_09/I)^a,
                    e_10 = 16* geosphere::daylength(lat,"2000-10-15")/12* 31 /30*(10*tmean_10/I)^a,
                    e_11 = 16* geosphere::daylength(lat,"2000-11-15")/12* 30 /30*(10*tmean_11/I)^a,
                    e_12 = 16* geosphere::daylength(lat,"2000-12-15")/12* 31 /30*(10*tmean_12/I)^a,
                    ET = e_01+e_02+e_03+e_04+e_05+e_06+e_07+e_08+e_09+e_10+e_11,e_12, # en mm
                    AI = pre/ET)

thorn.civ$cat.AI <- cut(thorn.civ$AI, breaks = c(0,0.05,0.2,0.5,0.65,4)) %>% revalue(c("(0,0.05]"= "Hyperarid", "(0.05,0.2]" = "Arid", "(0.2,0.5]" = "Semi-arid", "(0.5,0.65]" = "Dry subhumid","(0.65,4]" = "Humid")) # cuts from Tsakiris2005

ggplot(thorn.civ)+geom_tile(aes(x = lon, y = lat, fill = cat.AI))+
  borders(regions = "Ivory Coast")+
  labs(title = "UNEP AI (Thornthwaite)", fill = "")+scale_fill_viridis_d(direction = -1, na.translate = F)+
  theme_void(base_size = 10)+theme(legend.position = "bottom")+guides(fill = guide_legend(nrow = 1))

ggplot(thorn.civ)+geom_tile(aes(x = lon, y = lat, fill = AI))+
    borders(regions = "Ivory Coast")+
  labs(title = "UNEP Aridity Index", fill = "")+
  scale_fill_viridis_c(direction = -1)+theme_void(base_size = 10)+theme(legend.position = "bottom")+guides(fill = guide_legend(nrow = 1))

```

```{r thornthwaite-fra-by-hand }
thorn.fra <- mutate(fra, i_01 = (tmean_01/5)^1.514,
                    i_02 = (tmean_02/5)^1.514,
                    i_03 = (tmean_03/5)^1.514,
                    i_04 = (tmean_04/5)^1.514,
                    i_05 = (tmean_05/5)^1.514,
                    i_06 = (tmean_06/5)^1.514,
                    i_07 = (tmean_07/5)^1.514,
                    i_08 = (tmean_08/5)^1.514,
                    i_09 = (tmean_09/5)^1.514,
                    i_10 = (tmean_10/5)^1.514,
                    i_11 = (tmean_11/5)^1.514,
                    i_12 = (tmean_12/5)^1.514,
                    I = i_01+i_02+i_03+i_04+i_05+i_06+i_07+i_08+i_09+i_10+i_11+i_12,
                    a = (6.751e-7)*I^3 - (7.7e-5)*I^2 + 0.01729*I + 0.49239,
                    e_01 = 16* geosphere::daylength(lat,"2000-01-15")/12* 31 /30*(10*tmean_01/I)^a, #Ep = 16 * L/12 * N/30 * (10T/I) ^a, L is length of daylight, N number of days in month
                    e_02 = 16* geosphere::daylength(lat,"2000-02-15")/12* 28 /30*(10*tmean_02/I)^a,
                    e_03 = 16* geosphere::daylength(lat,"2000-03-15")/12* 31 /30*(10*tmean_03/I)^a,
                    e_04 = 16* geosphere::daylength(lat,"2000-04-15")/12* 30 /30*(10*tmean_04/I)^a,
                    e_05 = 16* geosphere::daylength(lat,"2000-05-15")/12* 31 /30*(10*tmean_05/I)^a,
                    e_06 = 16* geosphere::daylength(lat,"2000-06-15")/12* 30 /30*(10*tmean_06/I)^a,
                    e_07 = 16* geosphere::daylength(lat,"2000-07-15")/12* 31 /30*(10*tmean_07/I)^a,
                    e_08 = 16* geosphere::daylength(lat,"2000-08-15")/12* 31 /30*(10*tmean_08/I)^a,
                    e_09 = 16* geosphere::daylength(lat,"2000-09-15")/12* 30 /30*(10*tmean_09/I)^a,
                    e_10 = 16* geosphere::daylength(lat,"2000-10-15")/12* 31 /30*(10*tmean_10/I)^a,
                    e_11 = 16* geosphere::daylength(lat,"2000-11-15")/12* 30 /30*(10*tmean_11/I)^a,
                    e_12 = 16* geosphere::daylength(lat,"2000-12-15")/12* 31 /30*(10*tmean_12/I)^a,
                    ET = e_01+e_02+e_03+e_04+e_05+e_06+e_07+e_08+e_09+e_10+e_11,e_12, # en mm
                    AI = pre/ET)

thorn.fra$cat.AI <- cut(thorn.fra$AI, breaks = c(0,0.05,0.2,0.5,0.65,4)) %>% revalue(c("(0,0.05]"= "Hyperarid", "(0.05,0.2]" = "Arid", "(0.2,0.5]" = "Semi-arid", "(0.5,0.65]" = "Dry subhumid","(0.65,4]" = "Humid")) # cuts from Tsakiris2005

ggplot(thorn.fra)+geom_tile(aes(x = lon, y = lat, fill = cat.AI))+
  borders(regions = "France")+
  labs(title = "UNEP AI (Thornthwaite)", fill = "")+scale_fill_viridis_d(direction = -1, na.translate = F)+
  theme_void(base_size = 10)+theme(legend.position = "bottom")+guides(fill = guide_legend(nrow = 1))

ggplot(thorn.fra)+geom_tile(aes(x = lon, y = lat, fill = AI))+
    borders(regions = "France")+
  labs(title = "UNEP Aridity Index", fill = "")+
  scale_fill_viridis_c(direction = -1)+theme_void(base_size = 10)+theme(legend.position = "bottom")+guides(fill = guide_legend(nrow = 1))
```
```{r thornthwaite-w-by-hand }
thorn.w <- mutate(world.df, 
                    i_01 = (tmean_01/5)^1.514,
                    i_02 = (tmean_02/5)^1.514,
                    i_03 = (tmean_03/5)^1.514,
                    i_04 = (tmean_04/5)^1.514,
                    i_05 = (tmean_05/5)^1.514,
                    i_06 = (tmean_06/5)^1.514,
                    i_07 = (tmean_07/5)^1.514,
                    i_08 = (tmean_08/5)^1.514,
                    i_09 = (tmean_09/5)^1.514,
                    i_10 = (tmean_10/5)^1.514,
                    i_11 = (tmean_11/5)^1.514,
                    i_12 = (tmean_12/5)^1.514,
                    I = i_01+i_02+i_03+i_04+i_05+i_06+i_07+i_08+i_09+i_10+i_11+i_12,
                    a = (6.751e-7)*I^3 - (7.7e-5)*I^2 + 0.01729*I + 0.49239,
                    e_01 = 16* geosphere::daylength(lat,"2000-01-15")/12* 31 /30*(10*tmean_01/I)^a, #Ep = 16 * L/12 * N/30 * (10T/I) ^a, L is length of daylight, N number of days in month
                    e_02 = 16* geosphere::daylength(lat,"2000-02-15")/12* 28 /30*(10*tmean_02/I)^a,
                    e_03 = 16* geosphere::daylength(lat,"2000-03-15")/12* 31 /30*(10*tmean_03/I)^a,
                    e_04 = 16* geosphere::daylength(lat,"2000-04-15")/12* 30 /30*(10*tmean_04/I)^a,
                    e_05 = 16* geosphere::daylength(lat,"2000-05-15")/12* 31 /30*(10*tmean_05/I)^a,
                    e_06 = 16* geosphere::daylength(lat,"2000-06-15")/12* 30 /30*(10*tmean_06/I)^a,
                    e_07 = 16* geosphere::daylength(lat,"2000-07-15")/12* 31 /30*(10*tmean_07/I)^a,
                    e_08 = 16* geosphere::daylength(lat,"2000-08-15")/12* 31 /30*(10*tmean_08/I)^a,
                    e_09 = 16* geosphere::daylength(lat,"2000-09-15")/12* 30 /30*(10*tmean_09/I)^a,
                    e_10 = 16* geosphere::daylength(lat,"2000-10-15")/12* 31 /30*(10*tmean_10/I)^a,
                    e_11 = 16* geosphere::daylength(lat,"2000-11-15")/12* 30 /30*(10*tmean_11/I)^a,
                    e_12 = 16* geosphere::daylength(lat,"2000-12-15")/12* 31 /30*(10*tmean_12/I)^a,
                    ET = e_01+e_02+e_03+e_04+e_05+e_06+e_07+e_08+e_09+e_10+e_11,e_12, # en mm
                    AI = pre/ET)

thorn.w$cat.AI <- cut(thorn.w$AI, breaks = c(0,0.05,0.2,0.5,0.65,4)) %>% revalue(c("(0,0.05]"= "Hyperarid", "(0.05,0.2]" = "Arid", "(0.2,0.5]" = "Semi-arid", "(0.5,0.65]" = "Dry subhumid","(0.65,4]" = "Humid")) # cuts from Tsakiris2005

ggplot(thorn.w)+geom_tile(aes(x = lon, y = lat, fill = cat.AI))+
  labs(title = "UNEP AI (Thornthwaite)", fill = "")+scale_fill_viridis_d(direction = -1, na.translate = F)+
  theme_void(base_size = 10)+theme(legend.position = "bottom")+guides(fill = guide_legend(nrow = 1))

ggplot(thorn.w)+geom_tile(aes(x = lon, y = lat, fill = AI))+
  labs(title = "UNEP Aridity Index", fill = "")+
  scale_fill_viridis_c(direction = -1)+theme_void(base_size = 10)+theme(legend.position = "bottom")+guides(fill = guide_legend(nrow = 1))
```
NA pour températures annuelles moyennes < 0, car les indices de chaleur mensuels sont calculés à partir de la température moyenne mensuelle élevé à la puissance 1.514

# AI with Hargreave evapotranspiration 

Hargreaves formula: @Hargreaves1985

Ra formula: https://www.agraria.unirc.it/documentazione/materiale_didattico/1462_2016_412_24509.pdf

```{r hargreaves-civ-by-hand}

hg.civ <- civ %>% mutate(psi = pi/180*lat, # latitude in radian
                    delta_01 = 0.409 * sin(2*pi/365*yday("2000-01-15")-1.39), #solar declination
                    delta_02 = 0.409 * sin(2*pi/365*yday("2000-02-15")-1.39), #solar declination
                    delta_03 = 0.409 * sin(2*pi/365*yday("2000-03-15")-1.39), #solar declination
                    delta_04 = 0.409 * sin(2*pi/365*yday("2000-04-15")-1.39), #solar declination
                    delta_05 = 0.409 * sin(2*pi/365*yday("2000-05-15")-1.39), #solar declination
                    delta_06 = 0.409 * sin(2*pi/365*yday("2000-06-15")-1.39), #solar declination
                    delta_07 = 0.409 * sin(2*pi/365*yday("2000-07-15")-1.39), #solar declination                    
                    delta_08 = 0.409 * sin(2*pi/365*yday("2000-08-15")-1.39), #solar declination
                    delta_09 = 0.409 * sin(2*pi/365*yday("2000-09-15")-1.39), #solar declination                    
                    delta_10 = 0.409 * sin(2*pi/365*yday("2000-10-15")-1.39), #solar declination
                    delta_11 = 0.409 * sin(2*pi/365*yday("2000-11-15")-1.39), #solar declination                    
                    delta_12 = 0.409 * sin(2*pi/365*yday("2000-12-15")-1.39), #solar declination                    
                    ws_01 = acos(-tan(psi)*tan(delta_01)), #sunset hour angle
                    ws_02 = acos(-tan(psi)*tan(delta_02)), #sunset hour angle
                    ws_03 = acos(-tan(psi)*tan(delta_03)), #sunset hour angle                    
                    ws_04 = acos(-tan(psi)*tan(delta_04)), #sunset hour angle                    
                    ws_05 = acos(-tan(psi)*tan(delta_05)), #sunset hour angle                    
                    ws_06 = acos(-tan(psi)*tan(delta_06)), #sunset hour angle                    
                    ws_07 = acos(-tan(psi)*tan(delta_07)), #sunset hour angle                    
                    ws_08 = acos(-tan(psi)*tan(delta_08)), #sunset hour angle
                    ws_09 = acos(-tan(psi)*tan(delta_09)), #sunset hour angle                    
                    ws_10 = acos(-tan(psi)*tan(delta_10)), #sunset hour angle
                    ws_11 = acos(-tan(psi)*tan(delta_11)), #sunset hour angle
                    ws_12 = acos(-tan(psi)*tan(delta_12)), #sunset hour angle                    
                    dr_01 = 1+0.033*cos(2*pi/365*yday("2000-01-15")), # inverse relative distance Earth-Sun
                    dr_02 = 1+0.033*cos(2*pi/365*yday("2000-02-15")), # inverse relative distance Earth-Sun
                    dr_03 = 1+0.033*cos(2*pi/365*yday("2000-03-15")), # inverse relative distance Earth-Sun                    
                    dr_04 = 1+0.033*cos(2*pi/365*yday("2000-04-15")), # inverse relative distance Earth-Sun                    
                    dr_05 = 1+0.033*cos(2*pi/365*yday("2000-05-15")), # inverse relative distance Earth-Sun                    
                    dr_06 = 1+0.033*cos(2*pi/365*yday("2000-06-15")), # inverse relative distance Earth-Sun                    
                    dr_07 = 1+0.033*cos(2*pi/365*yday("2000-07-15")), # inverse relative distance Earth-Sun                    
                    dr_08 = 1+0.033*cos(2*pi/365*yday("2000-08-15")), # inverse relative distance Earth-Sun
                    dr_09 = 1+0.033*cos(2*pi/365*yday("2000-09-15")), # inverse relative distance Earth-Sun                    
                    dr_10 = 1+0.033*cos(2*pi/365*yday("2000-10-15")), # inverse relative distance Earth-Sun                    
                    dr_11 = 1+0.033*cos(2*pi/365*yday("2000-11-15")), # inverse relative distance Earth-Sun                    
                    dr_12 = 1+0.033*cos(2*pi/365*yday("2000-12-15")), # inverse relative distance Earth-Sun                    
                    Ra_01 = 24*60/pi * 0.0820 * dr_01 * ((ws_01*sin(psi)*sin(delta_01))+cos(psi)*cos(delta_01)*sin(ws_01)), # external radiation MJ/m2/day
                    Ra_02 = 24*60/pi * 0.0820 * dr_02 * ((ws_01*sin(psi)*sin(delta_02))+cos(psi)*cos(delta_02)*sin(ws_02)), # external radiation MJ/m2/day                
                    Ra_03 = 24*60/pi * 0.0820 * dr_03 * ((ws_01*sin(psi)*sin(delta_03))+cos(psi)*cos(delta_03)*sin(ws_03)), # external radiation MJ/m2/day              
                    Ra_04 = 24*60/pi * 0.0820 * dr_04 * ((ws_01*sin(psi)*sin(delta_04))+cos(psi)*cos(delta_04)*sin(ws_04)), # external radiation MJ/m2/day                
                    Ra_05 = 24*60/pi * 0.0820 * dr_05 * ((ws_01*sin(psi)*sin(delta_05))+cos(psi)*cos(delta_05)*sin(ws_05)), # external radiation MJ/m2/day    
                    Ra_06 = 24*60/pi * 0.0820 * dr_06 * ((ws_01*sin(psi)*sin(delta_06))+cos(psi)*cos(delta_06)*sin(ws_06)), # external radiation MJ/m2/day                
                    Ra_07 = 24*60/pi * 0.0820 * dr_07 * ((ws_01*sin(psi)*sin(delta_07))+cos(psi)*cos(delta_07)*sin(ws_07)), # external radiation MJ/m2/day  
                    Ra_08 = 24*60/pi * 0.0820 * dr_08 * ((ws_01*sin(psi)*sin(delta_08))+cos(psi)*cos(delta_08)*sin(ws_08)), # external radiation MJ/m2/day
                    Ra_09 = 24*60/pi * 0.0820 * dr_09 * ((ws_01*sin(psi)*sin(delta_09))+cos(psi)*cos(delta_09)*sin(ws_09)), # external radiation MJ/m2/day              
                    Ra_10 = 24*60/pi * 0.0820 * dr_10 * ((ws_01*sin(psi)*sin(delta_10))+cos(psi)*cos(delta_10)*sin(ws_10)), # external radiation MJ/m2/day
                    Ra_11 = 24*60/pi * 0.0820 * dr_11 * ((ws_01*sin(psi)*sin(delta_11))+cos(psi)*cos(delta_11)*sin(ws_11)), # external radiation MJ/m2/day
                    Ra_12 = 24*60/pi * 0.0820 * dr_12 * ((ws_01*sin(psi)*sin(delta_12))+cos(psi)*cos(delta_12)*sin(ws_12)), # external radiation MJ/m2/day
                    e_01 = 0.00023*0.408*Ra_01*sqrt(tmax_01-tmin_01)*(tmean_01+17.8), #ET for January
                    e_02 = 0.00023*0.408*Ra_02*sqrt(tmax_02-tmin_02)*(tmean_02+17.8), #ET for January
                    e_03 = 0.00023*0.408*Ra_03*sqrt(tmax_03-tmin_03)*(tmean_03+17.8), #ET for January
                    e_04 = 0.00023*0.408*Ra_04*sqrt(tmax_04-tmin_04)*(tmean_04+17.8), #ET for January
                    e_05 = 0.00023*0.408*Ra_05*sqrt(tmax_05-tmin_05)*(tmean_05+17.8), #ET for January
                    e_06 = 0.00023*0.408*Ra_06*sqrt(tmax_06-tmin_06)*(tmean_06+17.8), #ET for January
                    e_07 = 0.00023*0.408*Ra_07*sqrt(tmax_07-tmin_07)*(tmean_07+17.8), #ET for January
                    e_08 = 0.00023*0.408*Ra_08*sqrt(tmax_08-tmin_08)*(tmean_08+17.8), #ET for January
                    e_09 = 0.00023*0.408*Ra_09*sqrt(tmax_09-tmin_09)*(tmean_09+17.8), #ET for January
                    e_10 = 0.00023*0.408*Ra_10*sqrt(tmax_10-tmin_10)*(tmean_10+17.8), #ET for January
                    e_11 = 0.00023*0.408*Ra_11*sqrt(tmax_11-tmin_11)*(tmean_11+17.8), #ET for January
                    e_12 = 0.00023*0.408*Ra_12*sqrt(tmax_12-tmin_12)*(tmean_12+17.8), #ET for January
                    MAI_01 = pre_01/e_01, #monthly moisture availability index
                    MAI_02 = pre_02/e_02,
                    MAI_03 = pre_03/e_03,
                    MAI_04 = pre_04/e_04,
                    MAI_05 = pre_05/e_05,
                    MAI_06 = pre_06/e_06,
                    MAI_07 = pre_07/e_07,
                    MAI_08 = pre_08/e_08,
                    MAI_09 = pre_09/e_09,
                    MAI_10 = pre_10/e_10,
                    MAI_11 = pre_11/e_11,
                    MAI_12 = pre_12/e_12,
                    ET = (e_01+e_02+e_03+e_04+e_05+e_06+e_07+e_08+e_09+e_10+e_11+e_12)*365, # en mm/daye_01/p_01
                    AI = pre/ET)

# Classification from Hargreaves 1974

hg.civ$cat.AI <- with(hg.civ, 
                         ifelse(MAI_01 > 0.34 & MAI_02 > 0.34 & MAI_03 > 0.34 & MAI_04 > 0.34 & MAI_05 > 0.34 |
                           MAI_02 > 0.34 & MAI_03 > 0.34 & MAI_04 > 0.34 & MAI_05 > 0.34 & MAI_06 > 0.34 |
                           MAI_03 > 0.34 & MAI_04 > 0.34 & MAI_05 > 0.34 & MAI_06 > 0.34 & MAI_07 > 0.34 |
                           MAI_04 > 0.34 & MAI_05 > 0.34 & MAI_06 > 0.34 & MAI_07 > 0.34 & MAI_08 > 0.34 |
                           MAI_05 > 0.34 & MAI_06 > 0.34 & MAI_07 > 0.34 & MAI_08 > 0.34 & MAI_09 > 0.34 |
                           MAI_06 > 0.34 & MAI_07 > 0.34 & MAI_08 > 0.34 & MAI_09 > 0.34 & MAI_10 > 0.34 |
                           MAI_07 > 0.34 & MAI_08 > 0.34 & MAI_09 > 0.34 & MAI_10 > 0.34 & MAI_11 > 0.34 |
                           MAI_08 > 0.34 & MAI_09 > 0.34 & MAI_10 > 0.34 & MAI_11 > 0.34 & MAI_12 > 0.34 |
                           MAI_09 > 0.34 & MAI_10 > 0.34 & MAI_11 > 0.34 & MAI_12 > 0.34 & MAI_01 > 0.34 |
                           MAI_10 > 0.34 & MAI_11 > 0.34 & MAI_12 > 0.34 & MAI_01 > 0.34 & MAI_02 > 0.34 |
                           MAI_11 > 0.34 & MAI_12 > 0.34 & MAI_01 > 0.34 & MAI_02 > 0.34 & MAI_03 > 0.34 |
                           MAI_12 > 0.34 & MAI_01 > 0.34 & MAI_02 > 0.34 & MAI_03 > 0.34 & MAI_04 > 0.34,
                           "Wet-dry", 
                           ifelse(MAI_01 > 0.34 & MAI_02 > 0.34 & MAI_03 > 0.34|
                                  MAI_02 > 0.34 & MAI_03 > 0.34 & MAI_04 > 0.34|
                                  MAI_03 > 0.34 & MAI_04 > 0.34 & MAI_05 > 0.34|
                                  MAI_04 > 0.34 & MAI_05 > 0.34 & MAI_06 > 0.34|
                                  MAI_05 > 0.34 & MAI_06 > 0.34 & MAI_07 > 0.34|
                                  MAI_06 > 0.34 & MAI_07 > 0.34 & MAI_08 > 0.34|
                                  MAI_07 > 0.34 & MAI_08 > 0.34 & MAI_09 > 0.34|
                                  MAI_08 > 0.34 & MAI_09 > 0.34 & MAI_10 > 0.34|
                                  MAI_09 > 0.34 & MAI_10 > 0.34 & MAI_11 > 0.34|
                                  MAI_10 > 0.34 & MAI_11 > 0.34 & MAI_12 > 0.34|
                                  MAI_11 > 0.34 & MAI_12 > 0.34 & MAI_01 > 0.34|
                                  MAI_12 > 0.34 & MAI_01 > 0.34 & MAI_02 > 0.34,
                            "Semi-arid",
                            ifelse(MAI_01 > 0.34 & MAI_02 > 0.34| 
                                  MAI_02 > 0.34 & MAI_04 > 0.34|
                                  MAI_03 > 0.34 & MAI_04 > 0.34|
                                  MAI_04 > 0.34 & MAI_05 > 0.34|
                                  MAI_05 > 0.34 & MAI_06 > 0.34|
                                  MAI_06 > 0.34 & MAI_07 > 0.34|
                                  MAI_07 > 0.34 & MAI_08 > 0.34|
                                  MAI_08 > 0.34 & MAI_09 > 0.34|
                                  MAI_09 > 0.34 & MAI_10 > 0.34|
                                  MAI_10 > 0.34 & MAI_11 > 0.34|
                                  MAI_11 > 0.34 & MAI_12 > 0.34|
                                  MAI_12 > 0.34 & MAI_01 > 0.34,
                                "Arid",
                               ifelse(MAI_01 < 0.33 & MAI_02 < 0.33 & MAI_03 < 0.33 & MAI_04 < 0.33 & MAI_05 < 0.33 & MAI_06 < 0.33  & 
                                      MAI_07 < 0.33 & MAI_08 < 0.33 & MAI_09 < 0.33 & MAI_10 < 0.33 & MAI_11 < 0.33 & MAI_12< 0.33, 
                                      "Very Arid",
                                      NA)))))
                         

ggplot(hg.civ)+geom_tile(aes(x = lon, y = lat, fill = cat.AI))+
  borders(regions = "Ivory Coast")+
  labs(title = "AI (Hargreaves)", fill = "")+
  scale_fill_viridis_d(direction = -1, na.translate = F)+
  theme_void(base_size = 10)+theme(legend.position = "bottom")+guides(fill = guide_legend(nrow = 1))

ggplot(hg.civ)+geom_tile(aes(x = lon, y = lat, fill = AI))+
  borders(regions = "Ivory Coast")+
  labs(title = "AI (Hargreaves)", fill = "")+
  scale_fill_viridis_c(direction = -1)+
  theme_void(base_size = 10)+theme(legend.position = "bottom")+guides(fill = guide_legend(nrow = 1))

hg.civ$cat.AI2 <- cut(hg.civ$AI, breaks = c(0,0.05,0.2,0.5,0.65,4)) %>% revalue(c("(0,0.05]"= "Hyperarid", "(0.05,0.2]" = "Arid", "(0.2,0.5]" = "Semi-arid", "(0.5,0.65]" = "Dry subhumid","(0.65,4]" = "Humid")) # cuts from Tsakiris2005

ggplot(hg.civ)+geom_tile(aes(x = lon, y = lat, fill = cat.AI2))+
  borders(regions = "Ivory Coast")+
  labs(title = "AI (Hargreaves)", fill = "")+
  scale_fill_viridis_d(direction = -1, na.translate = F)+
  theme_void(base_size = 10)+theme(legend.position = "bottom")+guides(fill = guide_legend(nrow = 1))

```


```{r hargreaves-fra-by-hand }

hg.fra <- fra %>% mutate(psi = pi/180*lat, # latitude in radian
                    delta_01 = 0.409 * sin(2*pi/365*yday("2000-01-15")-1.39), #solar declination
                    delta_02 = 0.409 * sin(2*pi/365*yday("2000-02-15")-1.39), #solar declination
                    delta_03 = 0.409 * sin(2*pi/365*yday("2000-03-15")-1.39), #solar declination
                    delta_04 = 0.409 * sin(2*pi/365*yday("2000-04-15")-1.39), #solar declination
                    delta_05 = 0.409 * sin(2*pi/365*yday("2000-05-15")-1.39), #solar declination
                    delta_06 = 0.409 * sin(2*pi/365*yday("2000-06-15")-1.39), #solar declination
                    delta_07 = 0.409 * sin(2*pi/365*yday("2000-07-15")-1.39), #solar declination                    
                    delta_08 = 0.409 * sin(2*pi/365*yday("2000-08-15")-1.39), #solar declination
                    delta_09 = 0.409 * sin(2*pi/365*yday("2000-09-15")-1.39), #solar declination                    
                    delta_10 = 0.409 * sin(2*pi/365*yday("2000-10-15")-1.39), #solar declination
                    delta_11 = 0.409 * sin(2*pi/365*yday("2000-11-15")-1.39), #solar declination                    
                    delta_12 = 0.409 * sin(2*pi/365*yday("2000-12-15")-1.39), #solar declination                    
                    ws_01 = acos(-tan(psi)*tan(delta_01)), #sunset hour angle
                    ws_02 = acos(-tan(psi)*tan(delta_02)), #sunset hour angle
                    ws_03 = acos(-tan(psi)*tan(delta_03)), #sunset hour angle                    
                    ws_04 = acos(-tan(psi)*tan(delta_04)), #sunset hour angle                    
                    ws_05 = acos(-tan(psi)*tan(delta_05)), #sunset hour angle                    
                    ws_06 = acos(-tan(psi)*tan(delta_06)), #sunset hour angle                    
                    ws_07 = acos(-tan(psi)*tan(delta_07)), #sunset hour angle                    
                    ws_08 = acos(-tan(psi)*tan(delta_08)), #sunset hour angle
                    ws_09 = acos(-tan(psi)*tan(delta_09)), #sunset hour angle                    
                    ws_10 = acos(-tan(psi)*tan(delta_10)), #sunset hour angle
                    ws_11 = acos(-tan(psi)*tan(delta_11)), #sunset hour angle
                    ws_12 = acos(-tan(psi)*tan(delta_12)), #sunset hour angle                    
                    dr_01 = 1+0.033*cos(2*pi/365*yday("2000-01-15")), # inverse relative distance Earth-Sun
                    dr_02 = 1+0.033*cos(2*pi/365*yday("2000-02-15")), # inverse relative distance Earth-Sun
                    dr_03 = 1+0.033*cos(2*pi/365*yday("2000-03-15")), # inverse relative distance Earth-Sun                    
                    dr_04 = 1+0.033*cos(2*pi/365*yday("2000-04-15")), # inverse relative distance Earth-Sun                    
                    dr_05 = 1+0.033*cos(2*pi/365*yday("2000-05-15")), # inverse relative distance Earth-Sun                    
                    dr_06 = 1+0.033*cos(2*pi/365*yday("2000-06-15")), # inverse relative distance Earth-Sun                    
                    dr_07 = 1+0.033*cos(2*pi/365*yday("2000-07-15")), # inverse relative distance Earth-Sun                    
                    dr_08 = 1+0.033*cos(2*pi/365*yday("2000-08-15")), # inverse relative distance Earth-Sun
                    dr_09 = 1+0.033*cos(2*pi/365*yday("2000-09-15")), # inverse relative distance Earth-Sun                    
                    dr_10 = 1+0.033*cos(2*pi/365*yday("2000-10-15")), # inverse relative distance Earth-Sun                    
                    dr_11 = 1+0.033*cos(2*pi/365*yday("2000-11-15")), # inverse relative distance Earth-Sun                    
                    dr_12 = 1+0.033*cos(2*pi/365*yday("2000-12-15")), # inverse relative distance Earth-Sun                    
                    Ra_01 = 24*60/pi * 0.0820 * dr_01 * ((ws_01*sin(psi)*sin(delta_01))+cos(psi)*cos(delta_01)*sin(ws_01)), # external radiation MJ/m2/day
                    Ra_02 = 24*60/pi * 0.0820 * dr_02 * ((ws_01*sin(psi)*sin(delta_02))+cos(psi)*cos(delta_02)*sin(ws_02)), # external radiation MJ/m2/day                
                    Ra_03 = 24*60/pi * 0.0820 * dr_03 * ((ws_01*sin(psi)*sin(delta_03))+cos(psi)*cos(delta_03)*sin(ws_03)), # external radiation MJ/m2/day              
                    Ra_04 = 24*60/pi * 0.0820 * dr_04 * ((ws_01*sin(psi)*sin(delta_04))+cos(psi)*cos(delta_04)*sin(ws_04)), # external radiation MJ/m2/day                
                    Ra_05 = 24*60/pi * 0.0820 * dr_05 * ((ws_01*sin(psi)*sin(delta_05))+cos(psi)*cos(delta_05)*sin(ws_05)), # external radiation MJ/m2/day    
                    Ra_06 = 24*60/pi * 0.0820 * dr_06 * ((ws_01*sin(psi)*sin(delta_06))+cos(psi)*cos(delta_06)*sin(ws_06)), # external radiation MJ/m2/day                
                    Ra_07 = 24*60/pi * 0.0820 * dr_07 * ((ws_01*sin(psi)*sin(delta_07))+cos(psi)*cos(delta_07)*sin(ws_07)), # external radiation MJ/m2/day  
                    Ra_08 = 24*60/pi * 0.0820 * dr_08 * ((ws_01*sin(psi)*sin(delta_08))+cos(psi)*cos(delta_08)*sin(ws_08)), # external radiation MJ/m2/day
                    Ra_09 = 24*60/pi * 0.0820 * dr_09 * ((ws_01*sin(psi)*sin(delta_09))+cos(psi)*cos(delta_09)*sin(ws_09)), # external radiation MJ/m2/day              
                    Ra_10 = 24*60/pi * 0.0820 * dr_10 * ((ws_01*sin(psi)*sin(delta_10))+cos(psi)*cos(delta_10)*sin(ws_10)), # external radiation MJ/m2/day
                    Ra_11 = 24*60/pi * 0.0820 * dr_11 * ((ws_01*sin(psi)*sin(delta_11))+cos(psi)*cos(delta_11)*sin(ws_11)), # external radiation MJ/m2/day
                    Ra_12 = 24*60/pi * 0.0820 * dr_12 * ((ws_01*sin(psi)*sin(delta_12))+cos(psi)*cos(delta_12)*sin(ws_12)), # external radiation MJ/m2/day
                    e_01 = 0.00023*0.408*Ra_01*sqrt(tmax_01-tmin_01)*(tmean_01+17.8), #ET for January
                    e_02 = 0.00023*0.408*Ra_02*sqrt(tmax_02-tmin_02)*(tmean_02+17.8), #ET for January
                    e_03 = 0.00023*0.408*Ra_03*sqrt(tmax_03-tmin_03)*(tmean_03+17.8), #ET for January
                    e_04 = 0.00023*0.408*Ra_04*sqrt(tmax_04-tmin_04)*(tmean_04+17.8), #ET for January
                    e_05 = 0.00023*0.408*Ra_05*sqrt(tmax_05-tmin_05)*(tmean_05+17.8), #ET for January
                    e_06 = 0.00023*0.408*Ra_06*sqrt(tmax_06-tmin_06)*(tmean_06+17.8), #ET for January
                    e_07 = 0.00023*0.408*Ra_07*sqrt(tmax_07-tmin_07)*(tmean_07+17.8), #ET for January
                    e_08 = 0.00023*0.408*Ra_08*sqrt(tmax_08-tmin_08)*(tmean_08+17.8), #ET for January
                    e_09 = 0.00023*0.408*Ra_09*sqrt(tmax_09-tmin_09)*(tmean_09+17.8), #ET for January
                    e_10 = 0.00023*0.408*Ra_10*sqrt(tmax_10-tmin_10)*(tmean_10+17.8), #ET for January
                    e_11 = 0.00023*0.408*Ra_11*sqrt(tmax_11-tmin_11)*(tmean_11+17.8), #ET for January
                    e_12 = 0.00023*0.408*Ra_12*sqrt(tmax_12-tmin_12)*(tmean_12+17.8), #ET for January
                    MAI_01 = pre_01/e_01, #monthly moisture availability index
                    MAI_02 = pre_02/e_02,
                    MAI_03 = pre_03/e_03,
                    MAI_04 = pre_04/e_04,
                    MAI_05 = pre_05/e_05,
                    MAI_06 = pre_06/e_06,
                    MAI_07 = pre_07/e_07,
                    MAI_08 = pre_08/e_08,
                    MAI_09 = pre_09/e_09,
                    MAI_10 = pre_10/e_10,
                    MAI_11 = pre_11/e_11,
                    MAI_12 = pre_12/e_12,
                    ET = (e_01+e_02+e_03+e_04+e_05+e_06+e_07+e_08+e_09+e_10+e_11+e_12)*365, # en mm/daye_01/p_01
                    AI = pre/ET)

# Classification from Hargreaves 1974

hg.fra$cat.AI <- with(hg.fra, 
                         ifelse(MAI_01 > 0.34 & MAI_02 > 0.34 & MAI_03 > 0.34 & MAI_04 > 0.34 & MAI_05 > 0.34 |
                           MAI_02 > 0.34 & MAI_03 > 0.34 & MAI_04 > 0.34 & MAI_05 > 0.34 & MAI_06 > 0.34 |
                           MAI_03 > 0.34 & MAI_04 > 0.34 & MAI_05 > 0.34 & MAI_06 > 0.34 & MAI_07 > 0.34 |
                           MAI_04 > 0.34 & MAI_05 > 0.34 & MAI_06 > 0.34 & MAI_07 > 0.34 & MAI_08 > 0.34 |
                           MAI_05 > 0.34 & MAI_06 > 0.34 & MAI_07 > 0.34 & MAI_08 > 0.34 & MAI_09 > 0.34 |
                           MAI_06 > 0.34 & MAI_07 > 0.34 & MAI_08 > 0.34 & MAI_09 > 0.34 & MAI_10 > 0.34 |
                           MAI_07 > 0.34 & MAI_08 > 0.34 & MAI_09 > 0.34 & MAI_10 > 0.34 & MAI_11 > 0.34 |
                           MAI_08 > 0.34 & MAI_09 > 0.34 & MAI_10 > 0.34 & MAI_11 > 0.34 & MAI_12 > 0.34 |
                           MAI_09 > 0.34 & MAI_10 > 0.34 & MAI_11 > 0.34 & MAI_12 > 0.34 & MAI_01 > 0.34 |
                           MAI_10 > 0.34 & MAI_11 > 0.34 & MAI_12 > 0.34 & MAI_01 > 0.34 & MAI_02 > 0.34 |
                           MAI_11 > 0.34 & MAI_12 > 0.34 & MAI_01 > 0.34 & MAI_02 > 0.34 & MAI_03 > 0.34 |
                           MAI_12 > 0.34 & MAI_01 > 0.34 & MAI_02 > 0.34 & MAI_03 > 0.34 & MAI_04 > 0.34,
                           "Wet-dry", 
                           ifelse(MAI_01 > 0.34 & MAI_02 > 0.34 & MAI_03 > 0.34|
                                  MAI_02 > 0.34 & MAI_03 > 0.34 & MAI_04 > 0.34|
                                  MAI_03 > 0.34 & MAI_04 > 0.34 & MAI_05 > 0.34|
                                  MAI_04 > 0.34 & MAI_05 > 0.34 & MAI_06 > 0.34|
                                  MAI_05 > 0.34 & MAI_06 > 0.34 & MAI_07 > 0.34|
                                  MAI_06 > 0.34 & MAI_07 > 0.34 & MAI_08 > 0.34|
                                  MAI_07 > 0.34 & MAI_08 > 0.34 & MAI_09 > 0.34|
                                  MAI_08 > 0.34 & MAI_09 > 0.34 & MAI_10 > 0.34|
                                  MAI_09 > 0.34 & MAI_10 > 0.34 & MAI_11 > 0.34|
                                  MAI_10 > 0.34 & MAI_11 > 0.34 & MAI_12 > 0.34|
                                  MAI_11 > 0.34 & MAI_12 > 0.34 & MAI_01 > 0.34|
                                  MAI_12 > 0.34 & MAI_01 > 0.34 & MAI_02 > 0.34,
                            "Semi-arid",
                            ifelse(MAI_01 > 0.34 & MAI_02 > 0.34| 
                                  MAI_02 > 0.34 & MAI_04 > 0.34|
                                  MAI_03 > 0.34 & MAI_04 > 0.34|
                                  MAI_04 > 0.34 & MAI_05 > 0.34|
                                  MAI_05 > 0.34 & MAI_06 > 0.34|
                                  MAI_06 > 0.34 & MAI_07 > 0.34|
                                  MAI_07 > 0.34 & MAI_08 > 0.34|
                                  MAI_08 > 0.34 & MAI_09 > 0.34|
                                  MAI_09 > 0.34 & MAI_10 > 0.34|
                                  MAI_10 > 0.34 & MAI_11 > 0.34|
                                  MAI_11 > 0.34 & MAI_12 > 0.34|
                                  MAI_12 > 0.34 & MAI_01 > 0.34,
                                "Arid",
                               ifelse(MAI_01 < 0.33 & MAI_02 < 0.33 & MAI_03 < 0.33 & MAI_04 < 0.33 & MAI_05 < 0.33 & MAI_06 < 0.33  & 
                                      MAI_07 < 0.33 & MAI_08 < 0.33 & MAI_09 < 0.33 & MAI_10 < 0.33 & MAI_11 < 0.33 & MAI_12< 0.33, 
                                      "Very Arid",
                                      NA)))))
                         

ggplot(hg.fra)+geom_tile(aes(x = lon, y = lat, fill = cat.AI))+
  borders(regions = "France")+
  labs(title = "AI (Hargreaves)", fill = "")+
  scale_fill_viridis_d(direction = -1, na.translate = F)+
  theme_void(base_size = 10)+theme(legend.position = "bottom")+guides(fill = guide_legend(nrow = 1))

ggplot(hg.fra)+geom_tile(aes(x = lon, y = lat, fill = AI))+
  borders(regions = "France")+
  labs(title = "AI (Hargreaves)", fill = "")+
  scale_fill_viridis_c(direction = -1)+
  theme_void(base_size = 10)+theme(legend.position = "bottom")+guides(fill = guide_legend(nrow = 1))

hg.fra$cat.AI2 <- cut(hg.fra$AI, breaks = c(0,0.05,0.2,0.5,0.65,4)) %>% revalue(c("(0,0.05]"= "Hyperarid", "(0.05,0.2]" = "Arid", "(0.2,0.5]" = "Semi-arid", "(0.5,0.65]" = "Dry subhumid","(0.65,4]" = "Humid")) # cuts from Tsakiris2005

ggplot(hg.fra)+geom_tile(aes(x = lon, y = lat, fill = cat.AI2))+
  borders(regions = "France")+
  labs(title = "AI (Hargreaves)", fill = "")+
  scale_fill_viridis_d(direction = -1, na.translate = F)+
  theme_void(base_size = 10)+theme(legend.position = "bottom")+guides(fill = guide_legend(nrow = 1))
```

```{r har-world}

hg.w <- world.df 

hg.w$tmax <- apply(dplyr::select(world.df, c("tmax_01", "tmax_02", "tmax_03", "tmax_04", "tmax_05", "tmax_06", "tmax_07", "tmax_08", "tmax_09", "tmax_10", "tmax_11", "tmax_12")), 1, max, na.rm = T)
hg.w$tmin <- apply(dplyr::select(world.df, c("tmin_01", "tmin_02", "tmin_03", "tmin_04", "tmin_05", "tmin_06", "tmin_07", "tmin_08", "tmin_09", "tmin_10", "tmin_11", "tmin_12")), 1, min, na.rm = T)

hg.w <- hg.w %>% mutate(psi = pi/180*lat, # latitude in radian
                    delta_01 = 0.409 * sin(2*pi/365*yday("2000-01-15")-1.39), #solar declination
                    delta_02 = 0.409 * sin(2*pi/365*yday("2000-02-15")-1.39), #solar declination
                    delta_03 = 0.409 * sin(2*pi/365*yday("2000-03-15")-1.39), #solar declination
                    delta_04 = 0.409 * sin(2*pi/365*yday("2000-04-15")-1.39), #solar declination
                    delta_05 = 0.409 * sin(2*pi/365*yday("2000-05-15")-1.39), #solar declination
                    delta_06 = 0.409 * sin(2*pi/365*yday("2000-06-15")-1.39), #solar declination
                    delta_07 = 0.409 * sin(2*pi/365*yday("2000-07-15")-1.39), #solar declination                    
                    delta_08 = 0.409 * sin(2*pi/365*yday("2000-08-15")-1.39), #solar declination
                    delta_09 = 0.409 * sin(2*pi/365*yday("2000-09-15")-1.39), #solar declination                    
                    delta_10 = 0.409 * sin(2*pi/365*yday("2000-10-15")-1.39), #solar declination
                    delta_11 = 0.409 * sin(2*pi/365*yday("2000-11-15")-1.39), #solar declination                    
                    delta_12 = 0.409 * sin(2*pi/365*yday("2000-12-15")-1.39), #solar declination                    
                    ws_01 = acos(-tan(psi)*tan(delta_01)), #sunset hour angle
                    ws_02 = acos(-tan(psi)*tan(delta_02)), #sunset hour angle
                    ws_03 = acos(-tan(psi)*tan(delta_03)), #sunset hour angle                    
                    ws_04 = acos(-tan(psi)*tan(delta_04)), #sunset hour angle                    
                    ws_05 = acos(-tan(psi)*tan(delta_05)), #sunset hour angle                    
                    ws_06 = acos(-tan(psi)*tan(delta_06)), #sunset hour angle                    
                    ws_07 = acos(-tan(psi)*tan(delta_07)), #sunset hour angle                    
                    ws_08 = acos(-tan(psi)*tan(delta_08)), #sunset hour angle
                    ws_09 = acos(-tan(psi)*tan(delta_09)), #sunset hour angle                    
                    ws_10 = acos(-tan(psi)*tan(delta_10)), #sunset hour angle
                    ws_11 = acos(-tan(psi)*tan(delta_11)), #sunset hour angle
                    ws_12 = acos(-tan(psi)*tan(delta_12)), #sunset hour angle                    
                    dr_01 = 1+0.033*cos(2*pi/365*yday("2000-01-15")), # inverse relative distance Earth-Sun
                    dr_02 = 1+0.033*cos(2*pi/365*yday("2000-02-15")), # inverse relative distance Earth-Sun
                    dr_03 = 1+0.033*cos(2*pi/365*yday("2000-03-15")), # inverse relative distance Earth-Sun                    
                    dr_04 = 1+0.033*cos(2*pi/365*yday("2000-04-15")), # inverse relative distance Earth-Sun                    
                    dr_05 = 1+0.033*cos(2*pi/365*yday("2000-05-15")), # inverse relative distance Earth-Sun                    
                    dr_06 = 1+0.033*cos(2*pi/365*yday("2000-06-15")), # inverse relative distance Earth-Sun                    
                    dr_07 = 1+0.033*cos(2*pi/365*yday("2000-07-15")), # inverse relative distance Earth-Sun                    
                    dr_08 = 1+0.033*cos(2*pi/365*yday("2000-08-15")), # inverse relative distance Earth-Sun
                    dr_09 = 1+0.033*cos(2*pi/365*yday("2000-09-15")), # inverse relative distance Earth-Sun                    
                    dr_10 = 1+0.033*cos(2*pi/365*yday("2000-10-15")), # inverse relative distance Earth-Sun                    
                    dr_11 = 1+0.033*cos(2*pi/365*yday("2000-11-15")), # inverse relative distance Earth-Sun                    
                    dr_12 = 1+0.033*cos(2*pi/365*yday("2000-12-15")), # inverse relative distance Earth-Sun                    
                    Ra_01 = 24*60/pi * 0.0820 * dr_01 * ((ws_01*sin(psi)*sin(delta_01))+cos(psi)*cos(delta_01)*sin(ws_01)), # external radiation MJ/m2/day
                    Ra_02 = 24*60/pi * 0.0820 * dr_02 * ((ws_01*sin(psi)*sin(delta_02))+cos(psi)*cos(delta_02)*sin(ws_02)), # external radiation MJ/m2/day                
                    Ra_03 = 24*60/pi * 0.0820 * dr_03 * ((ws_01*sin(psi)*sin(delta_03))+cos(psi)*cos(delta_03)*sin(ws_03)), # external radiation MJ/m2/day              
                    Ra_04 = 24*60/pi * 0.0820 * dr_04 * ((ws_01*sin(psi)*sin(delta_04))+cos(psi)*cos(delta_04)*sin(ws_04)), # external radiation MJ/m2/day                
                    Ra_05 = 24*60/pi * 0.0820 * dr_05 * ((ws_01*sin(psi)*sin(delta_05))+cos(psi)*cos(delta_05)*sin(ws_05)), # external radiation MJ/m2/day    
                    Ra_06 = 24*60/pi * 0.0820 * dr_06 * ((ws_01*sin(psi)*sin(delta_06))+cos(psi)*cos(delta_06)*sin(ws_06)), # external radiation MJ/m2/day                
                    Ra_07 = 24*60/pi * 0.0820 * dr_07 * ((ws_01*sin(psi)*sin(delta_07))+cos(psi)*cos(delta_07)*sin(ws_07)), # external radiation MJ/m2/day  
                    Ra_08 = 24*60/pi * 0.0820 * dr_08 * ((ws_01*sin(psi)*sin(delta_08))+cos(psi)*cos(delta_08)*sin(ws_08)), # external radiation MJ/m2/day
                    Ra_09 = 24*60/pi * 0.0820 * dr_09 * ((ws_01*sin(psi)*sin(delta_09))+cos(psi)*cos(delta_09)*sin(ws_09)), # external radiation MJ/m2/day              
                    Ra_10 = 24*60/pi * 0.0820 * dr_10 * ((ws_01*sin(psi)*sin(delta_10))+cos(psi)*cos(delta_10)*sin(ws_10)), # external radiation MJ/m2/day
                    Ra_11 = 24*60/pi * 0.0820 * dr_11 * ((ws_01*sin(psi)*sin(delta_11))+cos(psi)*cos(delta_11)*sin(ws_11)), # external radiation MJ/m2/day
                    Ra_12 = 24*60/pi * 0.0820 * dr_12 * ((ws_01*sin(psi)*sin(delta_12))+cos(psi)*cos(delta_12)*sin(ws_12)), # external radiation MJ/m2/day
                    e_01 = 0.00023*0.408*Ra_01*sqrt(tmax_01-tmin_01)*(tmean_01+17.8), #ET for January
                    e_02 = 0.00023*0.408*Ra_02*sqrt(tmax_02-tmin_02)*(tmean_02+17.8), #ET for January
                    e_03 = 0.00023*0.408*Ra_03*sqrt(tmax_03-tmin_03)*(tmean_03+17.8), #ET for January
                    e_04 = 0.00023*0.408*Ra_04*sqrt(tmax_04-tmin_04)*(tmean_04+17.8), #ET for January
                    e_05 = 0.00023*0.408*Ra_05*sqrt(tmax_05-tmin_05)*(tmean_05+17.8), #ET for January
                    e_06 = 0.00023*0.408*Ra_06*sqrt(tmax_06-tmin_06)*(tmean_06+17.8), #ET for January
                    e_07 = 0.00023*0.408*Ra_07*sqrt(tmax_07-tmin_07)*(tmean_07+17.8), #ET for January
                    e_08 = 0.00023*0.408*Ra_08*sqrt(tmax_08-tmin_08)*(tmean_08+17.8), #ET for January
                    e_09 = 0.00023*0.408*Ra_09*sqrt(tmax_09-tmin_09)*(tmean_09+17.8), #ET for January
                    e_10 = 0.00023*0.408*Ra_10*sqrt(tmax_10-tmin_10)*(tmean_10+17.8), #ET for January
                    e_11 = 0.00023*0.408*Ra_11*sqrt(tmax_11-tmin_11)*(tmean_11+17.8), #ET for January
                    e_12 = 0.00023*0.408*Ra_12*sqrt(tmax_12-tmin_12)*(tmean_12+17.8), #ET for January
                    MAI_01 = pre_01/e_01, #monthly moisture availability index
                    MAI_02 = pre_02/e_02,
                    MAI_03 = pre_03/e_03,
                    MAI_04 = pre_04/e_04,
                    MAI_05 = pre_05/e_05,
                    MAI_06 = pre_06/e_06,
                    MAI_07 = pre_07/e_07,
                    MAI_08 = pre_08/e_08,
                    MAI_09 = pre_09/e_09,
                    MAI_10 = pre_10/e_10,
                    MAI_11 = pre_11/e_11,
                    MAI_12 = pre_12/e_12,
                    ET = (e_01+e_02+e_03+e_04+e_05+e_06+e_07+e_08+e_09+e_10+e_11+e_12)*365, # en mm/daye_01/p_01
                    AI = pre/ET)

# Classification from Hargreaves 1974

hg.w$cat.AI <- with(hg.w, 
                         ifelse(MAI_01 > 0.34 & MAI_02 > 0.34 & MAI_03 > 0.34 & MAI_04 > 0.34 & MAI_05 > 0.34 |
                           MAI_02 > 0.34 & MAI_03 > 0.34 & MAI_04 > 0.34 & MAI_05 > 0.34 & MAI_06 > 0.34 |
                           MAI_03 > 0.34 & MAI_04 > 0.34 & MAI_05 > 0.34 & MAI_06 > 0.34 & MAI_07 > 0.34 |
                           MAI_04 > 0.34 & MAI_05 > 0.34 & MAI_06 > 0.34 & MAI_07 > 0.34 & MAI_08 > 0.34 |
                           MAI_05 > 0.34 & MAI_06 > 0.34 & MAI_07 > 0.34 & MAI_08 > 0.34 & MAI_09 > 0.34 |
                           MAI_06 > 0.34 & MAI_07 > 0.34 & MAI_08 > 0.34 & MAI_09 > 0.34 & MAI_10 > 0.34 |
                           MAI_07 > 0.34 & MAI_08 > 0.34 & MAI_09 > 0.34 & MAI_10 > 0.34 & MAI_11 > 0.34 |
                           MAI_08 > 0.34 & MAI_09 > 0.34 & MAI_10 > 0.34 & MAI_11 > 0.34 & MAI_12 > 0.34 |
                           MAI_09 > 0.34 & MAI_10 > 0.34 & MAI_11 > 0.34 & MAI_12 > 0.34 & MAI_01 > 0.34 |
                           MAI_10 > 0.34 & MAI_11 > 0.34 & MAI_12 > 0.34 & MAI_01 > 0.34 & MAI_02 > 0.34 |
                           MAI_11 > 0.34 & MAI_12 > 0.34 & MAI_01 > 0.34 & MAI_02 > 0.34 & MAI_03 > 0.34 |
                           MAI_12 > 0.34 & MAI_01 > 0.34 & MAI_02 > 0.34 & MAI_03 > 0.34 & MAI_04 > 0.34,
                           "Wet-dry", 
                           ifelse(MAI_01 > 0.34 & MAI_02 > 0.34 & MAI_03 > 0.34|
                                  MAI_02 > 0.34 & MAI_03 > 0.34 & MAI_04 > 0.34|
                                  MAI_03 > 0.34 & MAI_04 > 0.34 & MAI_05 > 0.34|
                                  MAI_04 > 0.34 & MAI_05 > 0.34 & MAI_06 > 0.34|
                                  MAI_05 > 0.34 & MAI_06 > 0.34 & MAI_07 > 0.34|
                                  MAI_06 > 0.34 & MAI_07 > 0.34 & MAI_08 > 0.34|
                                  MAI_07 > 0.34 & MAI_08 > 0.34 & MAI_09 > 0.34|
                                  MAI_08 > 0.34 & MAI_09 > 0.34 & MAI_10 > 0.34|
                                  MAI_09 > 0.34 & MAI_10 > 0.34 & MAI_11 > 0.34|
                                  MAI_10 > 0.34 & MAI_11 > 0.34 & MAI_12 > 0.34|
                                  MAI_11 > 0.34 & MAI_12 > 0.34 & MAI_01 > 0.34|
                                  MAI_12 > 0.34 & MAI_01 > 0.34 & MAI_02 > 0.34,
                            "Semi-arid",
                            ifelse(MAI_01 > 0.34 & MAI_02 > 0.34| 
                                  MAI_02 > 0.34 & MAI_04 > 0.34|
                                  MAI_03 > 0.34 & MAI_04 > 0.34|
                                  MAI_04 > 0.34 & MAI_05 > 0.34|
                                  MAI_05 > 0.34 & MAI_06 > 0.34|
                                  MAI_06 > 0.34 & MAI_07 > 0.34|
                                  MAI_07 > 0.34 & MAI_08 > 0.34|
                                  MAI_08 > 0.34 & MAI_09 > 0.34|
                                  MAI_09 > 0.34 & MAI_10 > 0.34|
                                  MAI_10 > 0.34 & MAI_11 > 0.34|
                                  MAI_11 > 0.34 & MAI_12 > 0.34|
                                  MAI_12 > 0.34 & MAI_01 > 0.34,
                                "Arid",
                               ifelse(MAI_01 < 0.33 & MAI_02 < 0.33 & MAI_03 < 0.33 & MAI_04 < 0.33 & MAI_05 < 0.33 & MAI_06 < 0.33  & 
                                      MAI_07 < 0.33 & MAI_08 < 0.33 & MAI_09 < 0.33 & MAI_10 < 0.33 & MAI_11 < 0.33 & MAI_12< 0.33, 
                                      "Very Arid",
                                      NA)))))
                         

ggplot(hg.w)+geom_tile(aes(x = lon, y = lat, fill = cat.AI))+
  labs(title = "AI (Hargreaves)", fill = "")+
  scale_fill_viridis_d(direction = -1, na.translate = F)+
  theme_void(base_size = 10)+theme(legend.position = "bottom")+guides(fill = guide_legend(nrow = 1))

ggplot(hg.w)+geom_tile(aes(x = lon, y = lat, fill = AI))+
  labs(title = "AI (Hargreaves)", fill = "")+
  scale_fill_viridis_c(direction = -1)+
  theme_void(base_size = 10)+theme(legend.position = "bottom")+guides(fill = guide_legend(nrow = 1))

hg.w$cat.AI2 <- cut(hg.w$AI, breaks = c(0,0.05,0.2,0.5,0.65,4)) %>% revalue(c("(0,0.05]"= "Hyperarid", "(0.05,0.2]" = "Arid", "(0.2,0.5]" = "Semi-arid", "(0.5,0.65]" = "Dry subhumid","(0.65,4]" = "Humid")) # cuts from Tsakiris2005

ggplot(hg.w)+geom_tile(aes(x = lon, y = lat, fill = cat.AI2))+
  labs(title = "AI (Hargreaves)", fill = "")+
  scale_fill_viridis_d(direction = -1, na.translate = F)+
  theme_void(base_size = 10)+theme(legend.position = "bottom")+guides(fill = guide_legend(nrow = 1))

ggplot(hg.w)+geom_point(aes(x=lat, y = psi, col = AI))+scale_color_viridis_c()
```
# References

`r knitr::knit_exit()`


# SPEI

Can be calculated at a given location for a time series of months with the SPEI package @SPEI.
Otherwise, SPEI has been calculated by the creators for time scales of 1 to 48 months worldwide. https://digital.csic.es/handle/10261/153475

```{r spei-nc }
library(ncdf4)
spei <- nc_open("spei12.nc")

lon <- ncvar_get(spei,"lon")
lat <- ncvar_get(spei,"lat")
t <- ncvar_get(spei,"time")
spei.array <- ncvar_get(spei, "spei")
fillvalue <- ncatt_get(spei, "spei", "_FillValue") # fill value is 1e30
spei.array[spei.array == fillvalue$value] <- NA
spei.slice <- spei.array[,,1200]  # for December 2000
spei.raster <- raster(t(spei.slice), xmn = min(lon), xmx = max(lon), ymn = min(lat), ymx = max(lat), crs = CRS("+proj=longlat +ellps=WGS84 +datum=WGS84 +no_defs+ towgs84=0,0,0")) %>% flip(direction = "y")

plot(spei.raster)

spei.2020 <- spei.raster %>% as("SpatialPixelsDataFrame") %>% as.data.frame()
ggplot(spei.2020)+geom_tile(aes(x = x, y = y, fill = layer))+ 
  borders(regions = "Ivory Coast") + ylim(3.5,11) + xlim(-9,-2)+
  labs(title="SPEI December 2000, 12 months\nIvory Coast", fill = "SPEI")+
  scale_fill_viridis_c(direction = -1)+theme_void(base_size = 10)+theme(legend.position = "bottom")

ggplot(spei.2020)+geom_tile(aes(x = x, y = y, fill = layer))+ 
  borders(regions = "France") + ylim(41.5,51.5) + xlim(-5,8.5)+
  labs(title="SPEI December 2000, 12 months\nFrance", fill = "SPEI")+
  scale_fill_viridis_c(direction = -1)+theme_void(base_size = 10)+theme(legend.position = "bottom")
```



# Extra

```{r mensual-AI}
elev <- raster("wc2.1_country/CIV_wc2.1_30s_elev.tif") %>% as("SpatialPixelsDataFrame") %>% as.data.frame()

newvalues <- c("(0,0.03]"= "Hyperarid", "(0.03,0.2]" = "Arid", "(0.2,0.5]" = "Semi-arid", "(0.5,0.65]" = "Dry subhumid", "NA" = "")
mycolors <- viridisLite::viridis(n = length(newvalues), direction = -1)
names(mycolors) <- newvalues

for(i in 1:12){
precip <- raster("wc2.1_country/CIV_wc2.1_30s_prec.tif", band = i) %>% as("SpatialPixelsDataFrame") %>% as.data.frame()

srad <- raster("wc2.1_country/CIV_wc2.1_30s_srad.tif", band = i) %>% as("SpatialPixelsDataFrame") %>% as.data.frame()

tmin <- raster("wc2.1_country/CIV_wc2.1_30s_tmin.tif", band = i) %>% as("SpatialPixelsDataFrame") %>% as.data.frame()  # month tmin 

tmax <- raster("wc2.1_country/CIV_wc2.1_30s_tmax.tif", band = i) %>% as("SpatialPixelsDataFrame") %>% as.data.frame()

wind <- raster("wc2.1_country/CIV_wc2.1_30s_wind.tif") %>% as("SpatialPixelsDataFrame") %>% as.data.frame()

PMref <- ETo_FPM(R_n = srad$CIV_wc2.1_30s_srad_1, #from kJ/m2/day to MJ/m2/day
                 elev = elev$CIV_wc2.1_30s_elev, 
                 T_min = tmin$CIV_wc2.1_30s_tmin_1, 
                 T_max = tmax$CIV_wc2.1_30s_tmax_1, 
                 u_2 = wind$CIV_wc2.1_30s_wind_1)

AI.df <- precip %>% mutate(ET = PMref, AI = CIV_wc2.1_30s_prec_1*12/PMref)
head(AI.df)
AI.df$cat <- cut(AI.df$AI, breaks = c(0,0.03,0.2,0.5,0.65))
AI.df$cat.AI <- revalue(AI.df$cat, newvalues)

g <- ggplot(AI.df)+geom_tile(aes(x = x, y = y, fill = AI))+
    borders(regions = "Ivory Coast")+
  labs(fill = "", subtitle = i)+scale_fill_viridis_c(direction = -1, option = "A")+theme_void(base_size = 8)+theme(legend.position = "bottom")
ggsave(plot = g, filename = paste("AIref",i,".civ.jpg", sep =""), width = 3, height = 3)

g <- ggplot(AI.df)+geom_tile(aes(x = x, y = y, fill = cat.AI))+
    borders(regions = "Ivory Coast")+
  labs(subtitle = i, fill = "")+scale_fill_manual(values = mycolors)+theme_void(base_size = 8)+theme(legend.position = "bottom")
ggsave(plot = g, filename = paste("cat.AIref",i,".civ.jpg", sep =""), width = 3, height = 3)
}

```
