---
title: "test AI"
output: html_document
date: "2023-09-13"
bibliography: AI.bib
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r testing-worldclim}
library(geodata)
library(plyr)
library(dplyr)

library(raster)
library(sf)
library(ggplot2)

library(reshape2)
```

# Download worldclim

```{r dowload-worldclim, eval = F}
worldclim_country("Côte d'Ivoire", var = "prec", res = 0.5, path = ".") # average monthly precipitation in Ivory Coast, reference period 1970-2000). Res: 1km
worldclim_country("France", var = "prec", res = 0.5, path = ".") # average monthly precipitation in France, reference period 1970-2000). Res: 1km

worldclim_country("Côte d'Ivoire", var = "tavg", res = 0.5, path = ".") # average monthly temperature in Ivory Coast, reference period 1970-2000)
worldclim_country("France", var = "tavg", res = 0.5, path = ".") # average monthly temperature in France, reference period 1970-2000)

worldclim_country("Côte d'Ivoire", var = "tmin", res = 0.5, path = ".") # monthly minimum temperature in Ivory Coast, reference period 1970-2000)
worldclim_country("France", var = "tmin", res = 0.5, path = ".") # monthly minimum temperature in France, reference period 1970-2000)

worldclim_country("Côte d'Ivoire", var = "tmax", res = 0.5, path = ".") # monthly minimum temperature in Ivory Coast, reference period 1970-2000)
worldclim_country("France", var = "tmax", res = 0.5, path = ".") # monthly minimum temperature in Ivory Coast, reference period 1970-2000)


worldclim_country("Côte d'Ivoire", var = "srad", res = 0.5, path = ".") # average monthly solar radiation in Ivory Coast, reference period 1970-2000)
worldclim_country("France", var = "srad", res = 0.5, path = ".") # average monthly solar radiation in France, reference period 1970-2000)

worldclim_country("Côte d'Ivoire", var = "bio", res = 0.5, path = ".") # Bioclimatic variablesreference period 1970-2000)
worldclim_country("France", var = "bio", res = 0.5, path = ".") # Bioclimatic variables France, reference period 1970-2000)

worldclim_country("Côte d'Ivoire", var = "elev", res = 0.5, path = ".") # elevation in Ivory Coast, reference period 1970-2000
worldclim_country("France", var = "elev", res = 0.5, path = ".") # elevation in France, reference period 1970-2000

worldclim_country("Côte d'Ivoire", var = "wind", res = 0.5, path = ".") # elevation in Ivory Coast, reference period 1970-2000
worldclim_country("France", var = "wind", res = 0.5, path = ".") # elevation in France, reference period 1970-2000

worldclim_global(var = "prec", res = 0.5, path = ".")
```

# Lang Rain Factor

Detailed in @Thornthwaite1948 and [here]<https://iast.univ-setif.dz/documents/Cours/Cours6BioclimatologieL2GAT21.pdf> 

```{r lang-civ, fig.dim = c(3,3)}
annual.t <- raster("wc2.1_country/CIV_wc2.1_30s_bio.tif", band = 1) %>% as("SpatialPixelsDataFrame") %>% as.data.frame()
annual.p <- raster("wc2.1_country/CIV_wc2.1_30s_bio.tif", band = 12) %>% as("SpatialPixelsDataFrame") %>% as.data.frame()

lang.df <- merge(annual.t, annual.p, by = c("x","y")) %>% setNames(c("x","y","temp", "pre")) %>% mutate(lang = pre/temp)

lang.df$cat <- cut(lang.df$lang, breaks = c(0,20,40,60,100,160,200))
lang.df$cat.AI <- revalue(lang.df$cat, c("(0,20]"= "Deserts", "(20,40]" = "Arid", "(40,60]" = "Semi-arid", "(60,100]" = "Semi-humid","(100,160]" = "Humid", "(160,200]"="Hyper humid"))

ggplot(lang.df)+geom_tile(aes(x = x, y = y, fill = cat.AI))+
    borders(regions = "Ivory Coast")+
  labs(title = "Lang Rain Factor", fill = "")+scale_fill_viridis_d(direction = -1, na.translate = F)+theme_void(base_size = 10)+theme(legend.position = "bottom")


```
```{r lang-france, fig.dim = c(3,4)}
annual.t <- raster("wc2.1_country/FRA_wc2.1_30s_bio.tif", band = 1) %>% as("SpatialPixelsDataFrame") %>% as.data.frame()
annual.p <- raster("wc2.1_country/FRA_wc2.1_30s_bio.tif", band = 12) %>% as("SpatialPixelsDataFrame") %>% as.data.frame()

lang.df <- merge(annual.t, annual.p, by = c("x","y")) %>% setNames(c("x","y","temp", "pre")) %>% mutate(lang = pre/temp)

lang.df$cat <- cut(lang.df$lang, breaks = c(0,20,40,60,100,160,200))
lang.df$cat.AI <- revalue(lang.df$cat, c("(0,20]"= "Deserts", "(20,40]" = "Arid", "(40,60]" = "Semi-arid", "(60,100]" = "Semi-humid","(100,160]" = "Humid", "(160,200]"="Hyper humid"))

ggplot(lang.df)+geom_tile(aes(x = x, y = y, fill = cat.AI))+
    borders(regions = "France")+
  labs(title = "Lang Rain Factor", fill = "")+scale_fill_viridis_d(direction = -1, na.translate = F)+theme_void(base_size = 10)+theme(legend.position = "bottom")


```

# AI De Martonne

Defined by @Martonne1926, used and detailed by @Baltas2007.

```{r martonne-civ, fig.dim = c(3,3)}

annual.t <- raster("wc2.1_country/CIV_wc2.1_30s_bio.tif", band = 1) %>% as("SpatialPixelsDataFrame") %>% as.data.frame()
annual.p <- raster("wc2.1_country/CIV_wc2.1_30s_bio.tif", band = 12) %>% as("SpatialPixelsDataFrame") %>% as.data.frame()

martonne.df <- merge(annual.p, annual.t, by = c("x","y"))
names(martonne.df) <- c("x","y","pre","temp")
martonne.df$Am <- with(martonne.df, (pre)/(temp+10)) #precipitations in mm

martonne.df$cat <- cut(martonne.df$Am, c(0,10,20,24,28,35,55,100))

martonne.df$cat.AI <- revalue(martonne.df$cat, c("(0,10]"= "Dry", "(10,20]" = "Semi-dry","(20,24]" = "Meditarranean", "(24,28]" = "Semi-humid", "(28,35]" = "Semi-humid","(35,55]" = "Very humid (a)", "(55,100]" = "Very humid (b)"))

ggplot(martonne.df)+geom_tile(aes(x = x, y = y, fill = cat.AI))+
    borders(regions = "Ivory Coast")+
  labs(title = "De Martonne Aridity Index", fill = "")+scale_fill_viridis_d(direction = -1, na.translate = F)+theme_void(base_size = 10)+theme(legend.position = "bottom")+guides(fill = guide_legend(nrow = 2))

```
```{r martonne-fra, fig.dim = c(3,3)}

annual.t <- raster("wc2.1_country/FRA_wc2.1_30s_bio.tif", band = 1) %>% as("SpatialPixelsDataFrame") %>% as.data.frame()
annual.p <- raster("wc2.1_country/FRA_wc2.1_30s_bio.tif", band = 12) %>% as("SpatialPixelsDataFrame") %>% as.data.frame()

martonne.df <- merge(annual.p, annual.t, by = c("x","y"))
names(martonne.df) <- c("x","y","pre","temp")
martonne.df$Am <- with(martonne.df, (pre)/(temp+10)) #precipitations in mm

martonne.df$cat <- cut(martonne.df$Am, c(0,10,20,24,28,35,55,100))

martonne.df$cat.AI <- revalue(martonne.df$cat, c("(0,10]"= "Dry", "(10,20]" = "Semi-dry","(20,24]" = "Meditarranean", "(24,28]" = "Semi-humid", "(28,35]" = "Semi-humid","(35,55]" = "Very humid (a)", "(55,100]" = "Very humid (b)"))

ggplot(martonne.df)+geom_tile(aes(x = x, y = y, fill = cat.AI))+
    borders(regions = "France")+
  labs(title = "De Martonne Aridity Index", fill = "")+scale_fill_viridis_d(direction = -1, na.translate = F)+theme_void(base_size = 10)+theme(legend.position = "bottom")+guides(fill = guide_legend(nrow = 2))

```

# Emberger

Defined by Emberger in 1932, and explained in @Marres1972.

Used by @Baldy1972 for Liban. 

Used by @Shaban2019, who modified the original formula to use the average monthly rainfall instead of the cumulated annual rainfall AND END UP WITH THE WEIRDEST EQUATION

Problème: je ne prends pas les bons max/min? Pas de consensus sur la formule dans la littérature. Les fonctions R prédéfinies utilisent 100P/(T2-t2) en K, alors que  Baldy utilise un facteur 1000 et Marres parle en °C. Shaban utilisent des °C. 
STILL NOT SURE

```{r emberger-civ, fig.dim = c(3,3)}
#mean temperature of the warmest month
t.max <- raster::stack("wc2.1_country/CIV_wc2.1_30s_tavg.tif") %>% max()  %>% as("SpatialPixelsDataFrame") %>% as.data.frame() #cette formule est censée prendre la température maximum (qui est une moyenne mensuelle) parmi les 12 layers du raster
ggplot(t.max)+geom_tile(aes(x = x, y = y, fill = layer))+
    borders(regions = "Ivory Coast")+
  labs(fill = "Average temperature of warmest month")+scale_fill_viridis_c(direction = -1, option = "A")+theme_void(base_size = 10)+theme(legend.position = "bottom")

#mean temperature of the coolest month
t.min <- raster::stack("wc2.1_country/CIV_wc2.1_30s_tavg.tif") %>% min()  %>% as("SpatialPixelsDataFrame") %>% as.data.frame()
ggplot(t.min)+geom_tile(aes(x = x, y = y, fill = layer))+
    borders(regions = "Ivory Coast")+
  labs(fill = "Average temperature of coldest month")+scale_fill_viridis_c(direction = -1, option = "A")+theme_void(base_size = 10)+theme(legend.position = "bottom")


#annual rainfall
annual.p <- raster("wc2.1_country/CIV_wc2.1_30s_bio.tif", band = 12) %>% as("SpatialPixelsDataFrame") %>% as.data.frame()
ggplot(annual.p)+geom_tile(aes(x = x, y = y, fill = wc2.1_30s_bio_1))+
    borders(regions = "Ivory Coast")+
  labs(fill = "Annual precipiation mm")+scale_fill_viridis_c(direction = -1, option = "A")+theme_void(base_size = 10)+theme(legend.position = "bottom")

monthly.p <- raster::stack("wc2.1_country/CIV_wc2.1_30s_prec.tif") %>% mean(na.rm = T) %>% as("SpatialPixelsDataFrame") %>% as.data.frame()
ggplot(monthly.p)+geom_tile(aes(x = x, y = y, fill = layer))+
    borders(regions = "Ivory Coast")+
  labs(fill = "Annual precipiation mm")+scale_fill_viridis_c(direction = -1, option = "A")+theme_void(base_size = 10)+theme(legend.position = "bottom")


Em <- (annual.p$wc2.1_30s_bio_1*100)/((t.max$layer+273)^2-(t.min$layer+273)^2) # Formulation from Marres1972. 

Em.df <- annual.p %>% mutate(Em = Em)

ggplot(Em.df)+geom_tile(aes(x = x, y = y, fill = Em))+
    borders(regions = "Ivory Coast")+
  labs(fill = "Em")+scale_fill_viridis_c(direction = -1, option = "A")+theme_void(base_size = 10)+theme(legend.position = "bottom")

Em.df$cat <- cut(Em.df$Em, breaks = c(0,10,45,70,110,150,760))
Em.df$cat.AI <- revalue(Em.df$cat, c("(0,10]"= "Hyperarid", "(10,45]" = "Arid", "(45,70]" = "Semi-arid", "(70,110]" = "Subhumid","(110,150]" = "Humid","(150,760]" = "Hyper-humid"))

ggplot(Em.df)+geom_tile(aes(x = x, y = y, fill = cat.AI))+
    borders(regions = "Ivory Coast")+
  labs(title = "Emberger Aridity Index", fill = "")+scale_fill_viridis_d(direction = -1, na.translate = F)+theme_void(base_size = 10)+theme(legend.position = "bottom")+guides(fill = guide_legend(nrow = 2))

```

```{r emberger-fra, fig.dim = c(3,3)}
#mean temperature of the warmest month
t.max <- raster::stack("wc2.1_country/FRA_wc2.1_30s_tavg.tif") %>% max()  %>% as("SpatialPixelsDataFrame") %>% as.data.frame() #cette formule est censée prendre la température maximum (qui est une moyenne mensuelle) parmi les 12 layers du raster

#mean temperature of the coolest month
t.min <- raster::stack("wc2.1_country/FRA_wc2.1_30s_tavg.tif") %>% min()  %>% as("SpatialPixelsDataFrame") %>% as.data.frame()

#annual rainfall
annual.p <- raster("wc2.1_country/FRA_wc2.1_30s_bio.tif", band = 12) %>% as("SpatialPixelsDataFrame") %>% as.data.frame()


Em <- (annual.p$wc2.1_30s_bio_1*100)/((t.max$layer)^2-(t.min$layer)^2) # Formulation from Marres1972. 

Em.df <- annual.p %>% mutate(Em = Em)

Em.df$cat <- cut(Em.df$Em, breaks = c(0,10,45,70,110,150,760))
Em.df$cat.AI <- revalue(Em.df$cat, c("(0,10]"= "Hyperarid", "(10,45]" = "Arid", "(45,70]" = "Semi-arid", "(70,110]" = "Subhumid","(110,150]" = "Humid","(150,760]" = "Hyper-humid"))

ggplot(Em.df)+geom_tile(aes(x = x, y = y, fill = cat.AI))+
    borders(regions = "France")+
  labs(title = "Emberger Aridity Index", fill = "")+scale_fill_viridis_d(direction = -1, na.translate = F)+theme_void(base_size = 10)+theme(legend.position = "bottom")+guides(fill = guide_legend(nrow = 2))

```
# Ångström

Je ne connais pas la catégorisation

```{r angstrom-civ, fig.dim = c(3,3)}

annual.t <- raster("wc2.1_country/CIV_wc2.1_30s_bio.tif", band = 1) %>% as("SpatialPixelsDataFrame") %>% as.data.frame()
annual.p <- raster("wc2.1_country/CIV_wc2.1_30s_bio.tif", band = 12) %>% as("SpatialPixelsDataFrame") %>% as.data.frame()

ang.df <- merge(annual.t, annual.p, by = c("x","y")) %>% setNames(c("x","y","temp", "pre")) %>% mutate(ang = pre/(1.07^temp))


ang.df$cat <- cut(ang.df$ang, breaks = c(0,20,40,60,100,160,700))
ang.df$cat.AI <- revalue(ang.df$cat, c("(0,20]"= "Deserts", "(20,40]" = "Arid", "(40,60]" = "Semi-arid", "(60,100]" = "Semi-humid","(100,160]" = "Humid", "(160,700]"="Hyper humid"))
#martonne.df$cat.AI <- revalue(martonne.df$cat, c("(0,10]"= "Dry", "(10,20]" = "Semi-dry","(20,24]" = "Meditarranean", "(24,28]" = "Semi-humid", "(28,35]" = "Semi-humid","(35,55]" = "Very humid (a)", "(55,100]" = "Very humid (b)"))

ggplot(ang.df)+geom_tile(aes(x = x, y = y, fill = cat.AI))+
    borders(regions = "Ivory Coast")+
  labs(title = "Ångström Aridity Index", fill = "")+scale_fill_viridis_d(direction = -1, na.translate = F)+theme_void(base_size = 10)+theme(legend.position = "bottom")+guides(fill = guide_legend(nrow = 2))
```

```{r angstrom-fra, fig.dim = c(3,3)}

annual.t <- raster("wc2.1_country/FRA_wc2.1_30s_bio.tif", band = 1) %>% as("SpatialPixelsDataFrame") %>% as.data.frame()
annual.p <- raster("wc2.1_country/FRA_wc2.1_30s_bio.tif", band = 12) %>% as("SpatialPixelsDataFrame") %>% as.data.frame()

ang.df <- merge(annual.t, annual.p, by = c("x","y")) %>% setNames(c("x","y","temp", "pre")) %>% mutate(ang = pre/(1.07^temp))


ang.df$cat <- cut(ang.df$ang, breaks = c(0,20,40,60,100,160,700))
ang.df$cat.AI <- revalue(ang.df$cat, c("(0,20]"= "Deserts", "(20,40]" = "Arid", "(40,60]" = "Semi-arid", "(60,100]" = "Semi-humid","(100,160]" = "Humid", "(160,700]"="Hyper humid"))
#martonne.df$cat.AI <- revalue(martonne.df$cat, c("(0,10]"= "Dry", "(10,20]" = "Semi-dry","(20,24]" = "Meditarranean", "(24,28]" = "Semi-humid", "(28,35]" = "Semi-humid","(35,55]" = "Very humid (a)", "(55,100]" = "Very humid (b)"))

ggplot(ang.df)+geom_tile(aes(x = x, y = y, fill = cat.AI))+
    borders(regions = "France")+
  labs(title = "Ångström Aridity Index", fill = "")+scale_fill_viridis_d(direction = -1, na.translate = F)+theme_void(base_size = 10)+theme(legend.position = "bottom")+guides(fill = guide_legend(nrow = 2))
```

# AI standard

Index established by UNESCO1979, used and detailed by @Tsakiris2005

```{r AI-PMref, fig.dim = c(3,3)}
library(FAO56)

annual.p <- raster("wc2.1_country/CIV_wc2.1_30s_bio.tif", band = 12) %>% as("SpatialPixelsDataFrame") %>% as.data.frame()
# ggplot(annual.p)+geom_tile(aes(x = x, y = y, fill = wc2.1_30s_bio_1))+
#   borders(regions = "Ivory Coast")+
#   labs(title = "Precipitations", fill = "")+scale_fill_viridis_c(direction = -1)+theme_void(base_size = 10)+theme(legend.position = "bottom")+guides(fill = guide_legend(nrow = 2))

annual.srad <- raster::stack("wc2.1_country/CIV_wc2.1_30s_srad.tif") %>% raster::mean(na.rm = T) %>% as("SpatialPixelsDataFrame") %>% as.data.frame()
# ggplot(annual.srad)+geom_tile(aes(x = x, y = y, fill = layer))+
#   borders(regions = "Ivory Coast")+
#   labs(title = "Srad", fill = "")+scale_fill_viridis_c(direction = -1)+theme_void(base_size = 10)+theme(legend.position = "bottom")+guides(fill = guide_legend(nrow = 2))

annual.elev <- raster("wc2.1_country/CIV_wc2.1_30s_elev.tif") %>% as("SpatialPixelsDataFrame") %>% as.data.frame()
# ggplot(annual.elev)+geom_tile(aes(x = x, y = y, fill = CIV_wc2.1_30s_elev))+
#   borders(regions = "Ivory Coast")+
#   labs(title = "Elev", fill = "")+scale_fill_viridis_c(direction = -1)+theme_void(base_size = 10)+theme(legend.position = "bottom")+guides(fill = guide_legend(nrow = 2))

annual.tmin <- raster("wc2.1_country/CIV_wc2.1_30s_bio.tif", band = 6) %>% as("SpatialPixelsDataFrame") %>% as.data.frame()
# ggplot(annual.tmin)+geom_tile(aes(x = x, y = y, fill = wc2.1_30s_bio_1))+
#   borders(regions = "Ivory Coast")+
#   labs(title = "Tmin", fill = "")+scale_fill_viridis_c(direction = -1)+theme_void(base_size = 10)+theme(legend.position = "bottom")+guides(fill = guide_legend(nrow = 2))

annual.tmax <- raster("wc2.1_country/CIV_wc2.1_30s_bio.tif", band = 5) %>% as("SpatialPixelsDataFrame") %>% as.data.frame()
# ggplot(annual.tmax)+geom_tile(aes(x = x, y = y, fill = wc2.1_30s_bio_1))+
#   borders(regions = "Ivory Coast")+
#   labs(title = "Tmax", fill = "")+scale_fill_viridis_c(direction = -1)+theme_void(base_size = 10)+theme(legend.position = "bottom")+guides(fill = guide_legend(nrow = 2))

annual.wind <- raster::stack("wc2.1_country/CIV_wc2.1_30s_wind.tif") %>% mean(na.rm = T) %>% as("SpatialPixelsDataFrame") %>% as.data.frame()
# ggplot(annual.wind)+geom_tile(aes(x = x, y = y, fill = layer))+
#   borders(regions = "Ivory Coast")+
#   labs(title = "Wind", fill = "")+scale_fill_viridis_c(direction = -1)+theme_void(base_size = 10)+theme(legend.position = "bottom")+guides(fill = guide_legend(nrow = 2))

# ET in mm/day
PMref <- ETo_FPM(R_n = annual.srad$layer*1e-3, # from kJ/m2/day to MJ/m2/day
                 elev = annual.elev$CIV_wc2.1_30s_elev, # m
                 T_min = annual.tmin$wc2.1_30s_bio_1, #°C
                 T_max = annual.tmax$wc2.1_30s_bio_1, #°C
                 u_2 = annual.wind$layer) #m/s 


AI.df <- annual.p %>% mutate(ET = PMref*365, AI = wc2.1_30s_bio_1/ET)

ggplot(AI.df)+geom_tile(aes(x = x, y = y, fill = ET))+
  borders(regions = "Ivory Coast")+
  labs(title = "Wind", fill = "")+scale_fill_viridis_c(direction = -1)+theme_void(base_size = 10)+theme(legend.position = "bottom")+guides(fill = guide_legend(nrow = 2))

#AI.df <- avg.annual.p %>% mutate(ET = PMref, AI = layer/ET)
head(AI.df)
AI.df$cat <- cut(AI.df$AI, breaks = c(0,0.03,0.2,0.5,0.75,1))
AI.df$cat.AI <- revalue(AI.df$cat, c("(0,0.03]"= "Hyperarid", "(0.03,0.2]" = "Arid", "(0.2,0.5]" = "Semi-arid", "(0.5,0.75]" = "Dry subhumid","(0.75,1]" = "Humid"))

ggplot(AI.df)+geom_tile(aes(x = x, y = y, fill = cat.AI))+
  borders(regions = "Ivory Coast")+
  labs(title = "AI (Penmann-Monteith)", fill = "")+scale_fill_viridis_d(direction = -1, na.translate = F)+theme_void(base_size = 10)+theme(legend.position = "bottom")+guides(fill = guide_legend(nrow = 2))

```

```{r AI-PMref-fra, fig.dim = c(3,3)}
library(FAO56)

annual.p <- raster("wc2.1_country/FRA_wc2.1_30s_bio.tif", band = 12) %>% as("SpatialPixelsDataFrame") %>% as.data.frame()
# ggplot(annual.p)+geom_tile(aes(x = x, y = y, fill = wc2.1_30s_bio_1))+
#   borders(regions = "France")+
#   labs(title = "Precipitations", fill = "")+scale_fill_viridis_c(direction = -1)+theme_void(base_size = 10)+theme(legend.position = "bottom")+guides(fill = guide_legend(nrow = 2))

annual.srad <- raster::stack("wc2.1_country/FRA_wc2.1_30s_srad.tif") %>% raster::mean(na.rm = T) %>% as("SpatialPixelsDataFrame") %>% as.data.frame()
# ggplot(annual.srad)+geom_tile(aes(x = x, y = y, fill = layer))+
#   borders(regions = "France")+
#   labs(title = "Srad", fill = "")+scale_fill_viridis_c(direction = -1)+theme_void(base_size = 10)+theme(legend.position = "bottom")+guides(fill = guide_legend(nrow = 2))

annual.elev <- raster("wc2.1_country/FRA_wc2.1_30s_elev.tif") %>% as("SpatialPixelsDataFrame") %>% as.data.frame()
# ggplot(annual.elev)+geom_tile(aes(x = x, y = y, fill = FRA_wc2.1_30s_elev))+
#   borders(regions = "France")+
#   labs(title = "Elev", fill = "")+scale_fill_viridis_c(direction = -1)+theme_void(base_size = 10)+theme(legend.position = "bottom")+guides(fill = guide_legend(nrow = 2))

annual.tmin <- raster("wc2.1_country/FRA_wc2.1_30s_bio.tif", band = 6) %>% as("SpatialPixelsDataFrame") %>% as.data.frame()
# ggplot(annual.tmin)+geom_tile(aes(x = x, y = y, fill = wc2.1_30s_bio_1))+
#   borders(regions = "France")+
#   labs(title = "Tmin", fill = "")+scale_fill_viridis_c(direction = -1)+theme_void(base_size = 10)+theme(legend.position = "bottom")+guides(fill = guide_legend(nrow = 2))

annual.tmax <- raster("wc2.1_country/FRA_wc2.1_30s_bio.tif", band = 5) %>% as("SpatialPixelsDataFrame") %>% as.data.frame()
# ggplot(annual.tmax)+geom_tile(aes(x = x, y = y, fill = wc2.1_30s_bio_1))+
#   borders(regions = "France")+
#   labs(title = "Tmax", fill = "")+scale_fill_viridis_c(direction = -1)+theme_void(base_size = 10)+theme(legend.position = "bottom")+guides(fill = guide_legend(nrow = 2))

annual.wind <- raster::stack("wc2.1_country/FRA_wc2.1_30s_wind.tif") %>% mean(na.rm = T) %>% as("SpatialPixelsDataFrame") %>% as.data.frame()
# ggplot(annual.wind)+geom_tile(aes(x = x, y = y, fill = layer))+
#   borders(regions = "France")+
#   labs(title = "Wind", fill = "")+scale_fill_viridis_c(direction = -1)+theme_void(base_size = 10)+theme(legend.position = "bottom")+guides(fill = guide_legend(nrow = 2))

# ET in mm/day
PMref <- ETo_FPM(R_n = annual.srad$layer*1e-3, # from kJ/m2/day to MJ/m2/day
                 elev = annual.elev$FRA_wc2.1_30s_elev, # m
                 T_min = annual.tmin$wc2.1_30s_bio_1, #°C
                 T_max = annual.tmax$wc2.1_30s_bio_1, #°C
                 u_2 = annual.wind$layer) #m/s 


AI.df <- annual.p %>% mutate(ET = PMref*365, AI = wc2.1_30s_bio_1/ET)

ggplot(AI.df)+geom_tile(aes(x = x, y = y, fill = ET))+
  borders(regions = "France")+
  labs(title = "ET", fill = "")+scale_fill_viridis_c(direction = -1)+theme_void(base_size = 10)+theme(legend.position = "bottom")+guides(fill = guide_legend(nrow = 2))

#AI.df <- avg.annual.p %>% mutate(ET = PMref, AI = layer/ET)
head(AI.df)
AI.df$cat <- cut(AI.df$AI, breaks = c(0,0.03,0.2,0.5,0.75,1))
AI.df$cat.AI <- revalue(AI.df$cat, c("(0,0.03]"= "Hyperarid", "(0.03,0.2]" = "Arid", "(0.2,0.5]" = "Semi-arid", "(0.5,0.75]" = "Dry subhumid","(0.75,1]" = "Humid"))

ggplot(AI.df)+geom_tile(aes(x = x, y = y, fill = cat.AI))+
  borders(regions = "France")+
  labs(title = "AI (Penmann-Monteith)", fill = "")+scale_fill_viridis_d(direction = -1, na.translate = F)+theme_void(base_size = 10)+theme(legend.position = "bottom")+guides(fill = guide_legend(nrow = 2))

```









# Thornthwaite

1. Extraire la température mensuelle pur les 12 mois. 
2. calculer tho pour chaque point. Résultat: PET par mois
3. Additionner les PET pour obtenir annual PET. 


```{r thornthwaite, , fig.dim = c(3,3), eval = F}
library(bioclim)

annual.t <- raster("wc2.1_country/CIV_wc2.1_30s_bio.tif", band = 1) %>% as("SpatialPixelsDataFrame") %>% as.data.frame()
annual.p <- raster("wc2.1_country/CIV_wc2.1_30s_bio.tif", band = 12) %>% as("SpatialPixelsDataFrame") %>% as.data.frame()

tho.df <- merge(annual.t, annual.p, by = c("x","y")) %>% setNames(c("x","y","temp", "pre")) #%>% mutate(ET = thornthwaite(Tave = temp,lat = y), AI = pre/ET)
thornthwaite(Tave = head(tho.df)$temp, lat = head(tho.df)$y)

thornthwaite(rnorm(12, 18, 6), 35)

library(SPEI)
monthly.t <- raster::stack("wc2.1_country/CIV_wc2.1_30s_tavg.tif") %>% as("SpatialPixelsDataFrame") %>% as.data.frame()
names(monthly.t) <- c("t_01","t_02","t_03","t_04","t_05","t_06","t_07","t_08","t_09","t_10","t_11","t_12","long","lat")

#for 1 location
SPEI::thornthwaite(Tave = as.numeric(as.vector(monthly.t[1,c(1:12)])), lat = monthly.t[1,14]) %>% sum()


#Loop is too long
monthly.t$ETf <- NA
for(n in 1:614511){
  et <- SPEI::thornthwaite(Tave = as.numeric(as.vector(monthly.t[n,c(1:12)])), lat = monthly.t[n,14], verbose = F) 
  eta <- sum(et)
  monthly.t[n,"ETf"] <- eta
}


df <- monthly.t %>% mutate(nb = row_number()) %>% melt(id.vars = c("long","lat","nb")) %>% setNames(c("long","lat","nb","month","temp")) %>% arrange(nb)


df2 <- monthly.t[,c(1:12)] %>% as.matrix %>% t() %>% as.data.frame %>% setNames(monthly.t$lat)
lapply(df2, SPEI::thornthwaite, lat = as.numeric(colnames(df))

SPEI::thornthwaite(df$temp[1:12],lat= df$lat[1], verbose = F)


```

```{r thornthwaite-civ-by-hand}
monthly.t <- raster::stack("wc2.1_country/CIV_wc2.1_30s_tavg.tif") %>% as("SpatialPixelsDataFrame") %>% as.data.frame()
names(monthly.t) <- c("t_01","t_02","t_03","t_04","t_05","t_06","t_07","t_08","t_09","t_10","t_11","t_12","long","lat")

monthly.t <- mutate(monthly.t, i_01 = (t_01/5)^1.514,
                    i_02 = (t_02/5)^1.514,
                    i_03 = (t_03/5)^1.514,
                    i_04 = (t_04/5)^1.514,
                    i_05 = (t_05/5)^1.514,
                    i_06 = (t_06/5)^1.514,
                    i_07 = (t_07/5)^1.514,
                    i_08 = (t_08/5)^1.514,
                    i_09 = (t_09/5)^1.514,
                    i_10 = (t_10/5)^1.514,
                    i_11 = (t_11/5)^1.514,
                    i_12 = (t_12/5)^1.514,
                    I = i_01+i_02+i_03+i_04+i_05+i_06+i_07+i_08+i_09+i_10+i_11+i_12,
                    a = (6.751e-7)*I^3 - (7.7e-5)*I^2 + 0.01729*I + 0.49239,
                    e_01 = 16* geosphere::daylength(lat,"2000-01-15")/12* 31 /30*(10*t_01/I)^a, #Ep = 16 * L/12 * N/30 * (10T/I) ^a, L is length of daylight, N number of days in month
                    e_02 = 16* geosphere::daylength(lat,"2000-02-15")/12* 28 /30*(10*t_02/I)^a,
                    e_03 = 16* geosphere::daylength(lat,"2000-03-15")/12* 31 /30*(10*t_03/I)^a,
                    e_04 = 16* geosphere::daylength(lat,"2000-04-15")/12* 30 /30*(10*t_04/I)^a,
                    e_05 = 16* geosphere::daylength(lat,"2000-05-15")/12* 31 /30*(10*t_05/I)^a,
                    e_06 = 16* geosphere::daylength(lat,"2000-06-15")/12* 30 /30*(10*t_06/I)^a,
                    e_07 = 16* geosphere::daylength(lat,"2000-07-15")/12* 31 /30*(10*t_07/I)^a,
                    e_08 = 16* geosphere::daylength(lat,"2000-08-15")/12* 31 /30*(10*t_08/I)^a,
                    e_09 = 16* geosphere::daylength(lat,"2000-09-15")/12* 30 /30*(10*t_09/I)^a,
                    e_10 = 16* geosphere::daylength(lat,"2000-10-15")/12* 31 /30*(10*t_10/I)^a,
                    e_11 = 16* geosphere::daylength(lat,"2000-11-15")/12* 30 /30*(10*t_11/I)^a,
                    e_12 = 16* geosphere::daylength(lat,"2000-12-15")/12* 31 /30*(10*t_12/I)^a,
                    ET = e_01+e_02+e_03+e_04+e_05+e_06+e_07+e_08+e_09+e_10+e_11,e_12) # en mm
annual.p <- raster("wc2.1_country/CIV_wc2.1_30s_bio.tif", band = 12) %>% as("SpatialPixelsDataFrame") %>% as.data.frame() %>% setNames(c("pre","long","lat"))

tho <- merge(monthly.t, annual.p) %>% mutate(AI = pre/ET)

tho$cat <- cut(tho$AI, breaks = c(0,0.05,0.2,0.5,0.65,4)) # cuts from Tsakiris2005
tho$cat.AI <- revalue(tho$cat, c("(0,0.05]"= "Hyperarid", "(0.05,0.2]" = "Arid", "(0.2,0.5]" = "Semi-arid", "(0.5,0.65]" = "Dry subhumid","(0.65,4]" = "Humid"))

ggplot(tho)+geom_tile(aes(x = long, y = lat, fill = cat.AI))+
  borders(regions = "Ivory Coast")+
  labs(title = "UNEP AI (Thornthwaite)", fill = "")+scale_fill_viridis_d(direction = -1, na.translate = F)+theme_void(base_size = 10)+theme(legend.position = "bottom")+guides(fill = guide_legend(nrow = 1))

```

```{r thornthwaite-fra-by-hand}
monthly.t <- raster::stack("wc2.1_country/FRA_wc2.1_30s_tavg.tif") %>% as("SpatialPixelsDataFrame") %>% as.data.frame()
names(monthly.t) <- c("t_01","t_02","t_03","t_04","t_05","t_06","t_07","t_08","t_09","t_10","t_11","t_12","long","lat")

monthly.t <- mutate(monthly.t, i_01 = (t_01/5)^1.514,
                    i_02 = (t_02/5)^1.514,
                    i_03 = (t_03/5)^1.514,
                    i_04 = (t_04/5)^1.514,
                    i_05 = (t_05/5)^1.514,
                    i_06 = (t_06/5)^1.514,
                    i_07 = (t_07/5)^1.514,
                    i_08 = (t_08/5)^1.514,
                    i_09 = (t_09/5)^1.514,
                    i_10 = (t_10/5)^1.514,
                    i_11 = (t_11/5)^1.514,
                    i_12 = (t_12/5)^1.514,
                    I = i_01+i_02+i_03+i_04+i_05+i_06+i_07+i_08+i_09+i_10+i_11+i_12,
                    a = (6.751e-7)*I^3 - (7.7e-5)*I^2 + 0.01729*I + 0.49239,
                    e_01 = 16* geosphere::daylength(lat,"2000-01-15")/12* 31 /30*(10*t_01/I)^a, #Ep = 16 * L/12 * N/30 * (10T/I) ^a, L is length of daylight, N number of days in month
                    e_02 = 16* geosphere::daylength(lat,"2000-02-15")/12* 28 /30*(10*t_02/I)^a,
                    e_03 = 16* geosphere::daylength(lat,"2000-03-15")/12* 31 /30*(10*t_03/I)^a,
                    e_04 = 16* geosphere::daylength(lat,"2000-04-15")/12* 30 /30*(10*t_04/I)^a,
                    e_05 = 16* geosphere::daylength(lat,"2000-05-15")/12* 31 /30*(10*t_05/I)^a,
                    e_06 = 16* geosphere::daylength(lat,"2000-06-15")/12* 30 /30*(10*t_06/I)^a,
                    e_07 = 16* geosphere::daylength(lat,"2000-07-15")/12* 31 /30*(10*t_07/I)^a,
                    e_08 = 16* geosphere::daylength(lat,"2000-08-15")/12* 31 /30*(10*t_08/I)^a,
                    e_09 = 16* geosphere::daylength(lat,"2000-09-15")/12* 30 /30*(10*t_09/I)^a,
                    e_10 = 16* geosphere::daylength(lat,"2000-10-15")/12* 31 /30*(10*t_10/I)^a,
                    e_11 = 16* geosphere::daylength(lat,"2000-11-15")/12* 30 /30*(10*t_11/I)^a,
                    e_12 = 16* geosphere::daylength(lat,"2000-12-15")/12* 31 /30*(10*t_12/I)^a,
                    ET = e_01+e_02+e_03+e_04+e_05+e_06+e_07+e_08+e_09+e_10+e_11,e_12) # en mm
annual.p <- raster("wc2.1_country/FRA_wc2.1_30s_bio.tif", band = 12) %>% as("SpatialPixelsDataFrame") %>% as.data.frame() %>% setNames(c("pre","long","lat"))

tho <- merge(monthly.t, annual.p) %>% mutate(AI = pre/ET)

tho$cat <- cut(tho$AI, breaks = c(0,0.05,0.2,0.5,0.65,4)) # cuts from Tsakiris2005
tho$cat.AI <- revalue(tho$cat, c("(0,0.05]"= "Hyperarid", "(0.05,0.2]" = "Arid", "(0.2,0.5]" = "Semi-arid", "(0.5,0.65]" = "Dry subhumid","(0.65,4]" = "Humid"))

ggplot(tho)+geom_tile(aes(x = long, y = lat, fill = cat.AI))+
  borders(regions = "France")+
  labs(title = "UNEP AI (Thornthwaite)", fill = "")+scale_fill_viridis_d(direction = -1, na.translate = F)+theme_void(base_size = 10)+theme(legend.position = "bottom")+guides(fill = guide_legend(nrow = 1))

```
No adjustment for day length



# References

`r knitr::knit_exit()`

# Extra

```{r mensual-AI}
elev <- raster("wc2.1_country/CIV_wc2.1_30s_elev.tif") %>% as("SpatialPixelsDataFrame") %>% as.data.frame()

newvalues <- c("(0,0.03]"= "Hyperarid", "(0.03,0.2]" = "Arid", "(0.2,0.5]" = "Semi-arid", "(0.5,0.65]" = "Dry subhumid", "NA" = "")
mycolors <- viridisLite::viridis(n = length(newvalues), direction = -1)
names(mycolors) <- newvalues

for(i in 1:12){
precip <- raster("wc2.1_country/CIV_wc2.1_30s_prec.tif", band = i) %>% as("SpatialPixelsDataFrame") %>% as.data.frame()

srad <- raster("wc2.1_country/CIV_wc2.1_30s_srad.tif", band = i) %>% as("SpatialPixelsDataFrame") %>% as.data.frame()

tmin <- raster("wc2.1_country/CIV_wc2.1_30s_tmin.tif", band = i) %>% as("SpatialPixelsDataFrame") %>% as.data.frame()  # month tmin 

tmax <- raster("wc2.1_country/CIV_wc2.1_30s_tmax.tif", band = i) %>% as("SpatialPixelsDataFrame") %>% as.data.frame()

wind <- raster("wc2.1_country/CIV_wc2.1_30s_wind.tif") %>% as("SpatialPixelsDataFrame") %>% as.data.frame()

PMref <- ETo_FPM(R_n = srad$CIV_wc2.1_30s_srad_1, #from kJ/m2/day to MJ/m2/day
                 elev = elev$CIV_wc2.1_30s_elev, 
                 T_min = tmin$CIV_wc2.1_30s_tmin_1, 
                 T_max = tmax$CIV_wc2.1_30s_tmax_1, 
                 u_2 = wind$CIV_wc2.1_30s_wind_1)

AI.df <- precip %>% mutate(ET = PMref, AI = CIV_wc2.1_30s_prec_1*12/PMref)
head(AI.df)
AI.df$cat <- cut(AI.df$AI, breaks = c(0,0.03,0.2,0.5,0.65))
AI.df$cat.AI <- revalue(AI.df$cat, newvalues)

g <- ggplot(AI.df)+geom_tile(aes(x = x, y = y, fill = AI))+
    borders(regions = "Ivory Coast")+
  labs(fill = "", subtitle = i)+scale_fill_viridis_c(direction = -1, option = "A")+theme_void(base_size = 8)+theme(legend.position = "bottom")
ggsave(plot = g, filename = paste("AIref",i,".civ.jpg", sep =""), width = 3, height = 3)

g <- ggplot(AI.df)+geom_tile(aes(x = x, y = y, fill = cat.AI))+
    borders(regions = "Ivory Coast")+
  labs(subtitle = i, fill = "")+scale_fill_manual(values = mycolors)+theme_void(base_size = 8)+theme(legend.position = "bottom")
ggsave(plot = g, filename = paste("cat.AIref",i,".civ.jpg", sep =""), width = 3, height = 3)
}

```
